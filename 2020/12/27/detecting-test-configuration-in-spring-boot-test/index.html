<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon/manifest.json">
  <meta name="google-site-verification" content="yL1R2eDsKDqjPNaOBKp1usSDw8SQNzaO35svs1LKYWw">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"perfectacle.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"manual"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Spring Boot Reference의 Testing - Detecting Test Configuration 파트를 보면 다음과 같은 내용이 나온다.    If you are familiar with the Spring Test Framework, you may be used to using @ContextConfiguration(classes&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot Test에서 Test Configuration 감지하기">
<meta property="og:url" content="https://perfectacle.github.io/2020/12/27/detecting-test-configuration-in-spring-boot-test/index.html">
<meta property="og:site_name" content="오늘도 끄적끄적">
<meta property="og:description" content="Spring Boot Reference의 Testing - Detecting Test Configuration 파트를 보면 다음과 같은 내용이 나온다.    If you are familiar with the Spring Test Framework, you may be used to using @ContextConfiguration(classes&#x3D;">
<meta property="og:locale" content="ko_KR">
<meta property="article:published_time" content="2020-12-27T03:00:37.000Z">
<meta property="article:modified_time" content="2022-03-20T02:56:20.138Z">
<meta property="article:author" content="양권성">
<meta property="article:tag" content="Spring Boot">
<meta property="article:tag" content="JUnit">
<meta property="article:tag" content="Test">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://perfectacle.github.io/2020/12/27/detecting-test-configuration-in-spring-boot-test/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"ko","comments":true,"permalink":"https://perfectacle.github.io/2020/12/27/detecting-test-configuration-in-spring-boot-test/","path":"2020/12/27/detecting-test-configuration-in-spring-boot-test/","title":"Spring Boot Test에서 Test Configuration 감지하기"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spring Boot Test에서 Test Configuration 감지하기 | 오늘도 끄적끄적</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-87795455-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-87795455-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




<!--<script data-ad-client="ca-pub-3881550906962162" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="오늘도 끄적끄적" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">오늘도 끄적끄적</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">느리더라도 꾸준하게</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>홈</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>태그<span class="badge">251</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>카테고리<span class="badge">48</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>아카이브<span class="badge">215</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>검색
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          목차
        </li>
        <li class="sidebar-nav-overview">
          흝어보기
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#N%EC%A4%84-%EC%9A%94%EC%95%BD"><span class="nav-number">1.</span> <span class="nav-text">N줄 요약</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ContextConfiguration"><span class="nav-number">2.</span> <span class="nav-text">@ContextConfiguration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nested-Configuration"><span class="nav-number">3.</span> <span class="nav-text">Nested @Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBootConfiguration"><span class="nav-number">4.</span> <span class="nav-text">@SpringBootConfiguration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nested-TestConfiguration"><span class="nav-number">5.</span> <span class="nav-text">Nested @TestConfiguration</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="양권성" src="/images/avatar/avatar.png">
  <p class="site-author-name" itemprop="name">양권성</p>
  <div class="site-description" itemprop="description">Toss Server Developer</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">215</span>
          <span class="site-state-item-name">포스트</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">카테고리</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">251</span>
        <span class="site-state-item-name">태그</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/perfectacle" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;perfectacle" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:perfectacle@gmail.com" title="E-Mail → mailto:perfectacle@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/perfectacle" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;perfectacle" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://perfectacle.github.io/2020/12/27/detecting-test-configuration-in-spring-boot-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar/avatar.png">
      <meta itemprop="name" content="양권성">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="오늘도 끄적끄적">
      <meta itemprop="description" content="Toss Server Developer">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Spring Boot Test에서 Test Configuration 감지하기 | 오늘도 끄적끄적">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Boot Test에서 Test Configuration 감지하기
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">작성일</span>

      <time title="Post created: 2020-12-27 03:00:37" itemprop="dateCreated datePublished" datetime="2020-12-27T03:00:37+00:00">2020-12-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Updated at: 2022-03-20 02:56:20" itemprop="dateModified" datetime="2022-03-20T02:56:20+00:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/12/27/detecting-test-configuration-in-spring-boot-test/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/12/27/detecting-test-configuration-in-spring-boot-test/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-testing-spring-boot-applications-detecting-config">Spring Boot Reference의 Testing - Detecting Test Configuration 파트</a>를 보면 다음과 같은 내용이 나온다.  </p>
<blockquote>
<p>If you are familiar with the Spring Test Framework, you may be used to using @ContextConfiguration(classes&#x3D;…​) in order to specify which Spring @Configuration to load. Alternatively, you might have often used nested @Configuration classes within your test.<br>When testing Spring Boot applications, this is often not required. Spring Boot’s @*Test annotations search for your primary configuration automatically whenever you do not explicitly define one.<br>The search algorithm works up from the package that contains the test until it finds a class annotated with @SpringBootApplication or @SpringBootConfiguration.</p>
</blockquote>
<p>Detecting Test Configuration을 위해서 스프링에 친숙하다면 @ContextConfiguration이나 Nested @Configuration이 필요하다고 하고,<br>Spring Boot를 사용하면 @*Test(@SpringBootTest, @WebMvcTest, @DataJpaTest, etc.)에서 별다른 설정을 하지 않았다면 primary configuration을 찾아나간다고 한다.  </p>
<h2 id="N줄-요약"><a href="#N줄-요약" class="headerlink" title="N줄 요약"></a>N줄 요약</h2><p>글이 길어지다보니 아무도 안 볼 거 같고, 집중을 하고 소스코드를 따라가면서 읽어야해서 우선 먼저 요약을 적어놓는다.</p>
<p>TestContext를 로딩하기 위한 Test Configuaration은 다음과 같은 우선순위를 가진다.</p>
<ol>
<li>@ContextConfiguration 또는 @ContextHierarchy(여러 @ContextConfiguration을 포함)</li>
<li>Nested @Configuration</li>
<li>@SpringBootConfiguration (@SpringBootApplication 어노테이션이 @SpringBootConfiguration 어노테이션을 포함하고 있음)</li>
<li>Nested @TestConfiguration</li>
</ol>
<p>1, 2, 3 중 하나는 필수이며 셋 중에 하나만 적용된다.<br>Nested @TestConfiguration은 @ContextConfiguration을 사용했을 때는 적용되지 않고, Nested @Configuration이나 @SpringBootConfiguration에 추가로 적용된다고 보면 된다.<br>Nested @Configuration은 여러 개 만들어도 전부 적용되고, Nested @TestConfiguration도 여러 개 만들어도 전부 추가로 적용된다. </p>
<h2 id="ContextConfiguration"><a href="#ContextConfiguration" class="headerlink" title="@ContextConfiguration"></a>@ContextConfiguration</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://spring.io/blog/2011/06/21/spring-3-1-m2-testing-with-configuration-classes-and-profiles">Spring 3.1</a>에 추가된 기능으로 해당 블로그를 보면 아래와 같이 나와있다.</p>
<blockquote>
<p>At its core, the TestContext framework allows you to annotate test classes with @ContextConfiguration to specify which configuration files to use to load the ApplicationContext for your test.</p>
</blockquote>
<p>@ContextConfiguration 어노테이션에 기술한 configuration file들이 ApplicationContext에 로딩되는 걸 TestContext framework에서 해준다는 내용이다.<br>그럼 @ContextConfiguration에 기술할 수 있는 configuration file에는 무엇이 있을까?<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/context/ContextConfiguration.html">ContextConfiguration Javadoc</a>을 보면 다음과 같이 나와있다.  </p>
<blockquote>
<p>Component Classes<br>  The term component class can refer to any of the following.<br>  -A class annotated with @Configuration<br>  -A component (i.e., a class annotated with @Component, @Service, @Repository, etc.)<br>  -A JSR-330 compliant class that is annotated with javax.inject annotations<br>  -Any class that contains @Bean-methods<br>  -Any other class that is intended to be registered as a Spring component (i.e., a Spring bean in the ApplicationContext), potentially taking advantage of automatic autowiring of a single constructor without the use of Spring annotations</p>
</blockquote>
<p>빈에 관련된 설정(@Configuration) 파일이나 빈에 등록될 수 있는 어노테이션(@Component, @Service, @Repository 등등)은 기본적으로 기술할 수 있다고 보면 된다.</p>
<p>테스트 코드를 통해 간단히 확인해보자<br>우선 src&#x2F;main에 인터페이스를 하나 만들자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SomeInterface</span></span></span><br></pre></td></tr></table></figure>

<p>그리고 src&#x2F;test에 구현체를 하나 만들어주자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeInterfaceInContextConfiguration</span> : <span class="type">SomeInterface</span></span></span><br></pre></td></tr></table></figure>

<p>이제 테스트 클래스를 작성해서 @ContextConfiguration의 간단한 동작을 검증해보자.<br>참고로 Spring Boot 2.1.x 미만에서는 @ExtendWith(SpringExtension::class)를 추가해줘야한다.<br>또한 Spring Boot 2.2.x 미만에서는 @TestConstructor 어노테이션이 없기 때문에 생성자 안의 파라미터 마다 @Autowired 어노테이션을 추가해줘야한다.<br>그리고 JUnit 4에서는 Field Injection 밖에 지원하지 않기 때문에 Constructor Injection을 사용하려면 JUnit 5를 사용해야한다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = [SomeInterfaceInContextConfiguration::class])</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextConfigurationTest2</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface: SomeInterface</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@ContextConfiguration에 기술된 Component Classes들이 Test Configuration으로 사용된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface).isExactlyInstanceOf(SomeInterfaceInContextConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>실제 어떻게 동작하는지 하나씩 찾아나가보자.<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTest.java#L81">@SpringBootTest 어노테이션</a>을 보면 그 안에 @ExtendWith(SpringExtension.class) 어노테이션이 포함돼있다.<br>또한 @BootstrapWith 어노테이션을 통해 어떤 클래스를 통해 Spring TestContext Framework를 부트스트랩할 지 명시하고 있다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@BootstrapWith(SpringBootTestContextBootstrapper.class)</span></span><br><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootTest &#123;</span><br></pre></td></tr></table></figure>

<p>그리고 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/junit/jupiter/SpringExtension.java#L113">SpringExtension 클래스의 beforeAll 메서드</a>를 보면 testContextManager를 가져오고 있다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAll</span><span class="params">(ExtensionContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    getTestContextManager(context).beforeTestClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그리고 그 안에서 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/junit/jupiter/SpringExtension.java#L294">TestContextManager를 초기화</a>하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> TestContextManager <span class="title function_">getTestContextManager</span><span class="params">(ExtensionContext context)</span> &#123;</span><br><span class="line">    Assert.notNull(context, <span class="string">&quot;ExtensionContext must not be null&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; testClass = context.getRequiredTestClass();</span><br><span class="line">    <span class="type">Store</span> <span class="variable">store</span> <span class="operator">=</span> getStore(context);</span><br><span class="line">    <span class="keyword">return</span> store.getOrComputeIfAbsent(testClass, TestContextManager::<span class="keyword">new</span>, TestContextManager.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/TestContextManager.java#L122">TestContextManager 생성자</a>에서는 TestContextBootstrapper를 resolving하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TestContextManager</span><span class="params">(Class&lt;?&gt; testClass)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(BootstrapUtils.resolveTestContextBootstrapper(BootstrapUtils.createBootstrapContext(testClass)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/BootstrapUtils.java#L130">BootstrapUtils.resolveTestContextBootstrapper 메서드 안에서는 resolveExplicitTestContextBootstrapper 메서드를 호출</a>하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> TestContextBootstrapper <span class="title function_">resolveTestContextBootstrapper</span><span class="params">(BootstrapContext bootstrapContext)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; testClass = bootstrapContext.getTestClass();</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        clazz = resolveExplicitTestContextBootstrapper(testClass);</span><br></pre></td></tr></table></figure>

<p>resolveExplicitTestContextBootstrapper 메서드를 보면 testClass에 달려있는 BootstrapWith 어노테이션을 사용하는 걸 볼 수 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; resolveExplicitTestContextBootstrapper(Class&lt;?&gt; testClass) &#123;</span><br><span class="line">    Set&lt;BootstrapWith&gt; annotations = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">    AnnotationDescriptor&lt;BootstrapWith&gt; descriptor =</span><br><span class="line">            TestContextAnnotationUtils.findAnnotationDescriptor(testClass, BootstrapWith.class);</span><br><span class="line">    <span class="keyword">while</span> (descriptor != <span class="literal">null</span>) &#123;</span><br><span class="line">        annotations.addAll(descriptor.findAllLocalMergedAnnotations());</span><br><span class="line">        descriptor = descriptor.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (annotations.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (annotations.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> annotations.iterator().next().value();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow directly-present annotation to override annotations that are meta-present.</span></span><br><span class="line">    <span class="type">BootstrapWith</span> <span class="variable">bootstrapWith</span> <span class="operator">=</span> testClass.getDeclaredAnnotation(BootstrapWith.class);</span><br><span class="line">    <span class="keyword">if</span> (bootstrapWith != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> bootstrapWith.value();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(</span><br><span class="line">            <span class="string">&quot;Configuration error: found multiple declarations of @BootstrapWith for test class [%s]: %s&quot;</span>,</span><br><span class="line">            testClass.getName(), annotations));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>testClass에 BootstrapWith 어노테이션을 찾는다.  </li>
<li>없으면 null을 반환한다.</li>
<li>하나만 있으면 어노테이션의 value에 기술된 TestContextBootstrapper 클래스를 반환한다.</li>
<li>두 개 이상이면 테스트 클래스에 직접적으로 기술된 BootstrapWith 어노테이션을 찾는다.</li>
<li>있으면 value에 기술된 TestContextBootstrapper 클래스를 반환한다.</li>
<li>없으면 우선순위 충돌로 인해 multiple @BootstrapWith 어노테이션을 발견했다는 에러를 반환한다.</li>
</ol>
<p>우리는 @SpringBootTest 어노테이션에 있는 @BootstrapWith(SpringBootTestContextBootstrapper.class) 하나만 기술돼있기 때문에 SpringBootTestContextBootstrapper가 반환된다 </p>
<p>이제 testContextBootstrapper를 구했으면 인자로 넘겨서 TestContextManager를 초기화 하고 있는데 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/TestContextManager.java#L136">TestContextManager 생성자</a> 안에서는 testContext를 만들고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TestContextManager</span><span class="params">(TestContextBootstrapper testContextBootstrapper)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.testContext = testContextBootstrapper.buildTestContext();</span><br><span class="line">    registerTestExecutionListeners(testContextBootstrapper.getTestExecutionListeners());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그리고 메서드를 쭉쭉 타고 들어가다보면 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/support/AbstractTestContextBootstrapper.java#L265">AbstractTestContextBootstrapper 클래스의 buildMergedContextConfiguration 메서드에서 ContextConfiguration 어노테이션 유무를 판단</a>하고 처리하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> MergedContextConfiguration <span class="title function_">buildMergedContextConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    Class&lt;?&gt; testClass = getBootstrapContext().getTestClass();</span><br><span class="line">    <span class="type">CacheAwareContextLoaderDelegate</span> <span class="variable">cacheAwareContextLoaderDelegate</span> <span class="operator">=</span> getCacheAwareContextLoaderDelegate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TestContextAnnotationUtils.findAnnotationDescriptorForTypes(</span><br><span class="line">            testClass, ContextConfiguration.class, ContextHierarchy.class) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> buildDefaultMergedContextConfiguration(testClass, cacheAwareContextLoaderDelegate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TestContextAnnotationUtils.findAnnotationDescriptor(testClass, ContextHierarchy.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buildMergedContextConfiguration(testClass,</span><br><span class="line">                            ContextLoaderUtils.resolveContextConfigurationAttributes(testClass),</span><br><span class="line">                            <span class="literal">null</span>, cacheAwareContextLoaderDelegate, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>testClass에 ContextConfiguration 어노테이션이나 ContextHierarchy 어노테이션이 포함됐는지 확인한다.</li>
<li>포함됐으면 ContextHierarchy 어노테이션이 포함됐는지 확인 후에 처리한 걸 반환한다.</li>
<li>ContextConfiguration 어노테이션이 포함됐는지 확인 후에 처리한 걸 반환한다.</li>
</ol>
<p>3번에 의해 동작이 되는 거라고 보면 된다.<br>@ContextHierarchy 어노테이션은 @ContextConfiguration을 배열로 가지는 어노테이션으로 여러 @ContextConfiguration이 필요할 때 사용하면 된다.</p>
<h2 id="Nested-Configuration"><a href="#Nested-Configuration" class="headerlink" title="Nested @Configuration"></a>Nested @Configuration</h2><p>우선 동작하는 코드를 간단히 살펴보자.<br>src&#x2F;test에 인터페이스의 구현체를 하나 더 추가해보자.  </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeInterfaceInNestedConfiguration</span> : <span class="type">SomeInterface</span></span></span><br></pre></td></tr></table></figure>

<p>그리고 테스트 코드를 통해 검증해보자</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">NestedConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface: SomeInterface</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">someInterface</span><span class="params">()</span></span> = SomeInterfaceInNestedConfiguration()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@ContextConfiguration 어노테이션 다음으로는 Nested @Configuration 클래스가 Test Configuration으로 사용된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface).isExactlyInstanceOf(SomeInterfaceInNestedConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 실제로 어떻게 동작하는지 또 알아보자.<br>기본적으로 위에 설정한 동작방식 그대로를 쫓아가다가 분기문에서 갈라진다고 보면 된다.<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/support/AbstractTestContextBootstrapper.java#L265">AbstractTestContextBootstrapper 클래스의 buildMergedContextConfiguration 메서드에서 ContextConfiguration 어노테이션 유무를 판단</a>하고 있는 걸 위에서 살펴보았다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> MergedContextConfiguration <span class="title function_">buildMergedContextConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    Class&lt;?&gt; testClass = getBootstrapContext().getTestClass();</span><br><span class="line">    <span class="type">CacheAwareContextLoaderDelegate</span> <span class="variable">cacheAwareContextLoaderDelegate</span> <span class="operator">=</span> getCacheAwareContextLoaderDelegate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TestContextAnnotationUtils.findAnnotationDescriptorForTypes(</span><br><span class="line">            testClass, ContextConfiguration.class, ContextHierarchy.class) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> buildDefaultMergedContextConfiguration(testClass, cacheAwareContextLoaderDelegate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>우리 클래스에서는 해당 어노테이션이 없기 때문에 buildDefaultMergedContextConfiguration 메서드를 쭉쭉 타고 보면 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/885f6dbab94712fa76545276058a62216e17881e/spring-test/src/main/java/org/springframework/test/context/support/AbstractTestContextBootstrapper.java#L338">buildMergedContextConfiguration 메서드</a>까지 가게 된다.  </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MergedContextConfiguration buildMergedContextConfiguration(Class&lt;?&gt; testClass,</span><br><span class="line">        List&lt;ContextConfigurationAttributes&gt; configAttributesList, <span class="meta">@Nullable</span> MergedContextConfiguration parentConfig,</span><br><span class="line">        CacheAwareContextLoaderDelegate cacheAwareContextLoaderDelegate,</span><br><span class="line">        boolean requireLocationsClassesOrInitializers) &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notEmpty(configAttributesList, <span class="string">&quot;ContextConfigurationAttributes list must not be null or empty&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @BootstrapWith(SpringBootTestContextBootstrapper.class)에 의해 SpringBootTestContextBootstrapper의 getDefaultContextLoaderClass 메서드를 호출하여</span></span><br><span class="line">    <span class="comment">// SpringBootContextLoader가 resolving 됨</span></span><br><span class="line">    ContextLoader contextLoader = resolveContextLoader(testClass, configAttributesList); </span><br><span class="line">    List&lt;String&gt; locations = new ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; initializers = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ContextConfigurationAttributes configAttributes : configAttributesList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(String.format(<span class="string">&quot;Processing locations and classes for context configuration attributes %s&quot;</span>,</span><br><span class="line">                    configAttributes));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (contextLoader instanceof SmartContextLoader) &#123;  <span class="comment">// SpringBootContextLoader는 SmartContextLoader의 구현체이다 </span></span><br><span class="line">            SmartContextLoader smartContextLoader = (SmartContextLoader) contextLoader;</span><br><span class="line">            smartContextLoader.processContextConfiguration(configAttributes);</span><br></pre></td></tr></table></figure>

<p>그리고 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootContextLoader.java#L204">SpringBootContextLoader의 processContextConfiguration 메서드를 보면 detectDefaultConfigurationClasses를 호출</a>하고 있다.<br>(우리의 테스트 코드에서는 resource가 비어있는데 그거까지 이 포스트에서 다루기에는 너무 방대해져서 생략했다.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processContextConfiguration</span><span class="params">(ContextConfigurationAttributes configAttributes)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.processContextConfiguration(configAttributes);</span><br><span class="line">    <span class="keyword">if</span> (!configAttributes.hasResources()) &#123;</span><br><span class="line">        Class&lt;?&gt;[] defaultConfigClasses = detectDefaultConfigurationClasses(configAttributes.getDeclaringClass());</span><br><span class="line">        configAttributes.setClasses(defaultConfigClasses);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>메서드를 또 쭉쭉 타고 들어가다 보면 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/support/AnnotationConfigContextLoaderUtils.java#L62">AnnotationConfigContextLoaderUtils 클래스의 detectDefaultConfigurationClasses 메서드</a>를 호출하고 있다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt;[] detectDefaultConfigurationClasses(Class&lt;?&gt; declaringClass) &#123;</span><br><span class="line">    Assert.notNull(declaringClass, <span class="string">&quot;Declaring class must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; configClasses = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; candidate : declaringClass.getDeclaredClasses()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isDefaultConfigurationClassCandidate(candidate)) &#123;</span><br><span class="line">            configClasses.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">    <span class="keyword">return</span> ClassUtils.toClassArray(configClasses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그리고 그 안에는 testClass(declaringClass)에 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getDeclaredClasses--">getDeclaredClasses 메서드</a>를 호출하고 있다.<br>해당 메서드는 클래스에 정의된 클래스 객체를 반환하는 메서드라고 보면 된다.<br>따라서 Nested class들을 전부 반환하게 되는데 이 class 들을 for-loop 돌면서 isDefaultConfigurationClassCandidate 메서드를 호출해서 DefaultConfigurationClassCandidate라면 추가한 후에 반환하고 있다.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/support/AnnotationConfigContextLoaderUtils.java#L107">isDefaultConfigurationClassCandidate 메서드</a>를 보면 static이면서 private이 아니고, final이 아닌 클래스인데 @Configuration 어노테이션이 붙어있는지 판단하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDefaultConfigurationClassCandidate</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (clazz != <span class="literal">null</span> &amp;&amp; isStaticNonPrivateAndNonFinal(clazz) &amp;&amp;</span><br><span class="line">            AnnotatedElementUtils.hasAnnotation(clazz, Configuration.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이렇게 Nested @Configuration 클래스를 추가했으면 그 다음에 또 메서드를 쭉쭉 타고 들어가다보면 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L229">SpringBootTestContextBootstrapper 클래스의 getOrFindConfigurationClasses 메서드</a>를 호출하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt;[] getOrFindConfigurationClasses(MergedContextConfiguration mergedConfig) &#123;</span><br><span class="line">    Class&lt;?&gt;[] classes = mergedConfig.getClasses();</span><br><span class="line">    <span class="keyword">if</span> (containsNonTestComponent(classes) || mergedConfig.hasLocations()) &#123;</span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그리고 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L242">containsNonTestComponent 메서드</a>에서는 Nested @Configuration classes 중에 @TestConfiguration 어노테이션이 붙지 않은 클래스가 하나라도 존재하면 Nested @Configuration classes들을 merge 하여 Test Configuration으로 사용하고 있다.<br>즉 Nested @Configuration 클래스가 2개여도 두 @Configuration을 하나로 머지하여 사용한다고 보면 된다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsNonTestComponent</span><span class="params">(Class&lt;?&gt;[] classes)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; candidate : classes) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!MergedAnnotations.from(candidate, SearchStrategy.INHERITED_ANNOTATIONS)</span><br><span class="line">                .isPresent(TestConfiguration.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a>@SpringBootConfiguration</h2><p>스프링 부트의 primary configuration은 @SpringBootConfiguration이다.<br>하지만 @SpringBootConfiguration을 직접 사용하는 경우는 아직까지 보지 못했고 @SpringBootApplication을 사용하면 그 안에 포함돼있다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br></pre></td></tr></table></figure>

<p>src&#x2F;main에 @SpringBootApplication 클래스를 하나 추가해주자.  </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span></span></span><br></pre></td></tr></table></figure>

<p>그리고 SomeInterface의 구현체도 하나 작성해주자</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeInterfaceInConfiguration</span> : <span class="type">SomeInterface</span></span></span><br></pre></td></tr></table></figure>

<p>해당 클래스를 빈으로 등록해줄 Config 클래스도 작성하자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeInterfaceConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">someInterface</span><span class="params">()</span></span> = SomeInterfaceInConfiguration()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그리고 테스트를 통해 해당 빈이 주입되는지 검증해보자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface: SomeInterface</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `테스트용 설정이 없으면 기본적으로 @SpringBootApplication 클래스가 Test Configuration으로 사용된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface).isExactlyInstanceOf(SomeInterfaceInConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 실제로 왜 이렇게 동작하는지 알아보자.<br>위에 살펴봤던 것과 같이 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L229">SpringBootTestContextBootstrapper 클래스의 getOrFindConfigurationClasses 메서드</a>를 호출하고 있다.<br>그리고 Nested @Configuration 클래스가 하나라도 존재하는지 containsNonTestComponent 메서드를 통해 검증했었다.<br>하지만 이번에는 하나도 설정한 게 없으므로 그 아래에 있는 부분을 탄다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt;[] getOrFindConfigurationClasses(MergedContextConfiguration mergedConfig) &#123;</span><br><span class="line">    Class&lt;?&gt;[] classes = mergedConfig.getClasses();</span><br><span class="line">    <span class="keyword">if</span> (containsNonTestComponent(classes) || mergedConfig.hasLocations()) &#123;</span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; found = <span class="keyword">new</span> <span class="title class_">AnnotatedClassFinder</span>(SpringBootConfiguration.class)</span><br><span class="line">            .findFromClass(mergedConfig.getTestClass());</span><br><span class="line">    Assert.state(found != <span class="literal">null</span>, <span class="string">&quot;Unable to find a @SpringBootConfiguration, you need to use &quot;</span></span><br><span class="line">            + <span class="string">&quot;@ContextConfiguration or @SpringBootTest(classes=...) with your test&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;Found @SpringBootConfiguration &quot;</span> + found.getName() + <span class="string">&quot; for test &quot;</span> + mergedConfig.getTestClass());</span><br><span class="line">    <span class="keyword">return</span> merge(found, classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>nested @Configuration 클래스를 가져온다.</li>
<li>nested @TestConfiguration이 아닌 nested @Configuration 클래스가 하나라도 존재한다면 nested @Configuration(nested @TestConfiguration 포함) 클래스들을 반환한다.</li>
<li>@SpringBootConfiguration 어노테이션이 붙은 클래스를 가져온다.  </li>
<li>3에서 클래스를 찾지 못했다면 @SpringBootConfiguration이 붙은 클래스를 찾지 못하여 @ContextConfiguration이나 @SpringBootTest에 component classes를 명시하라고 에러를 뱉는다.  </li>
<li>3에서 찾은 클래스와 nested @Configuration 클래스를 머지한다.</li>
</ol>
<p>이렇게 nested @Configuration 클래스가 없다면 디폴트로 @SpringBootConfiguration이 붙은 @SpringBootApplication이 붙은 클래스가 Test Configuration으로 사용된다고 보면 된다.</p>
<h2 id="Nested-TestConfiguration"><a href="#Nested-TestConfiguration" class="headerlink" title="Nested @TestConfiguration"></a>Nested @TestConfiguration</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L229">SpringBootTestContextBootstrapper 클래스의 getOrFindConfigurationClasses 메서드</a>를 보면 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L242">containsNonTestComponent</a> 메서드를 호출하고 있다.<br>즉, Nested @TestConfiguration이 아닌 Nested @Configuration 클래스가 하나라도 존재하는지 찾는 것인데…<br>Nested @TestConfiguration 클래스는 어떤 역할을 하는 걸까??</p>
<p>src&#x2F;test에 SomeInterface의 구현체를 하나 더 추가해보자</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeInterfaceInNestedTestConfiguration</span> : <span class="type">SomeInterface</span></span></span><br></pre></td></tr></table></figure>

<p>그리고 해당 빈이 주입되도록 Nested @TestConfiguration을 사용하여 테스트를 작성해보자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NestedTestConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface: SomeInterface,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface2: SomeInterface,</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@TestConfiguration</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">someInterface2</span><span class="params">()</span></span> = SomeInterfaceInNestedTestConfiguration()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@SpringBootConfiguration에 의해 src에 있는 @Configuration 클래스에 있는 빈이 주입된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface).isExactlyInstanceOf(SomeInterfaceInConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@SpringBootConfiguration에 없는 건 @TestConfiguration 클래스에 있는 빈이 주입된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface2).isExactlyInstanceOf(SomeInterfaceInNestedTestConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>실제로 src&#x2F;main에 있는 @Configuration도 주입되고, Nested @TestConfiguration도 주입된 걸 볼 수 있다.<br>Nested @TestConfiguration의 용도는 원래 Configuration(@SpringBootConfigurtion 또는 Nested @Configuration)에 추가적으로 설정할 Configuration을 위해 사용한다고 보면 된다.</p>
<p>위에 살펴봤던 것과 같이 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L229">SpringBootTestContextBootstrapper 클래스의 getOrFindConfigurationClasses 메서드</a>를 호출하고 있다.<br>그리고 Nested @Configuration 클래스가 하나라도 존재하는지 containsNonTestComponent 메서드를 통해 검증했었다.<br>이번에는 Nested @TestConfiguration 클래스를 설정했으므로 그 관점에서 바라보자.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt;[] getOrFindConfigurationClasses(MergedContextConfiguration mergedConfig) &#123;</span><br><span class="line">    Class&lt;?&gt;[] classes = mergedConfig.getClasses();</span><br><span class="line">    <span class="keyword">if</span> (containsNonTestComponent(classes) || mergedConfig.hasLocations()) &#123;</span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; found = <span class="keyword">new</span> <span class="title class_">AnnotatedClassFinder</span>(SpringBootConfiguration.class)</span><br><span class="line">            .findFromClass(mergedConfig.getTestClass());</span><br><span class="line">    Assert.state(found != <span class="literal">null</span>, <span class="string">&quot;Unable to find a @SpringBootConfiguration, you need to use &quot;</span></span><br><span class="line">            + <span class="string">&quot;@ContextConfiguration or @SpringBootTest(classes=...) with your test&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;Found @SpringBootConfiguration &quot;</span> + found.getName() + <span class="string">&quot; for test &quot;</span> + mergedConfig.getTestClass());</span><br><span class="line">    <span class="keyword">return</span> merge(found, classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>nested @Configuration 클래스를 가져온다.</li>
<li>nested @TestConfiguration이 아닌 nested @Configuration 클래스가 하나라도 존재한다면 nested @Configuration(nested @TestConfiguration 포함) 클래스들을 반환한다.</li>
<li>@SpringBootConfiguration 어노테이션이 붙은 클래스를 가져온다.  </li>
<li>3에서 클래스를 찾지 못했다면 @SpringBootConfiguration이 붙은 클래스를 찾지 못하여 @ContextConfiguration이나 @SpringBootTest에 component classes를 명시하라고 에러를 뱉는다.  </li>
<li>3에서 찾은 클래스와 nested @Configuration 클래스를 머지한다.</li>
</ol>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/TestConfiguration.java#L45">@TestConfiguration 어노테이션</a>이 @Configuration을 포함하고 있으므로 <code>mergedConfig.getClasses()</code>에서는 Nested @Configuration과 Nested @TestConfiguration 클래스가 나온다고 보면 된다.  </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@TestComponent</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TestConfiguration &#123;</span><br></pre></td></tr></table></figure>

<p>그리고 우리는 Nested @Configuration 클래스는 하나도 없으므로 <code>containsNonTestComponent(classes)</code>에서 false를 뱉고<br>그 아래에서 <code>Class&lt;?&gt; found = new AnnotatedClassFinder(SpringBootConfiguration.class).findFromClass(mergedConfig.getTestClass());</code>로 찾아온 @SpringBootApplication 클래스와 Nested @TestConfiguration 클래스가 머지된다고 보면 된다.<br>실제로 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-boot/blob/8cd07dbc60f6146891a686967c9209edb053dd38/spring-boot-project/spring-boot-test/src/main/java/org/springframework/boot/test/context/SpringBootTestContextBootstrapper.java#L252">merge()</a> 메서드에서는 두 Configuration들을 머지하고 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt;[] merge(Class&lt;?&gt; head, Class&lt;?&gt;[] existing) &#123;</span><br><span class="line">    Class&lt;?&gt;[] result = <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[existing.length + <span class="number">1</span>];</span><br><span class="line">    result[<span class="number">0</span>] = head;</span><br><span class="line">    System.arraycopy(existing, <span class="number">0</span>, result, <span class="number">1</span>, existing.length);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>참고로 @ContextConfiguration을 사용할 때는 Nested @Configuration&#x2F;@TestConfiuration이 먹히지 않는다. (물론 @SpringBootConfiguration도 씹힌다.)</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = [SomeInterfaceInContextConfiguration::class])</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface: SomeInterface,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface2: SomeInterface,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> someInterface3: SomeInterface,</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">NestConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">someInterface2</span><span class="params">()</span></span> = SomeInterfaceInNestedConfiguration()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TestConfiguration</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">NestedTestConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">someInterface3</span><span class="params">()</span></span> = SomeInterfaceInNestedTestConfiguration()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@ContextConfiguration에 기술된 Component Classes들이 Test Configuration으로 사용된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface).isExactlyInstanceOf(SomeInterfaceInContextConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@ContextConfiguratio을 적용했으면 Nested @Configuration은 무시된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface2).isNotExactlyInstanceOf(SomeInterfaceInNestedConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">        assertThat(someInterface2).isExactlyInstanceOf(SomeInterfaceInContextConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@ContextConfiguratio을 적용했으면 Nested @TestConfiguration은 무시된다`<span class="params">()</span></span> &#123;</span><br><span class="line">        assertThat(someInterface3).isNotExactlyInstanceOf(SomeInterfaceInNestedTestConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">        assertThat(someInterface3).isExactlyInstanceOf(SomeInterfaceInContextConfiguration::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spring-Boot/" rel="tag"># Spring Boot</a>
              <a href="/tags/JUnit/" rel="tag"># JUnit</a>
              <a href="/tags/Test/" rel="tag"># Test</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/12/26/intellij-vs-gradle-in-classpath/" rel="prev" title="IntelliJ (Spring Boot) vs Gradle (bootRun)에서 클래스패스의 차이점">
                  <i class="fa fa-chevron-left"></i> IntelliJ (Spring Boot) vs Gradle (bootRun)에서 클래스패스의 차이점
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/02/14/simple-client-http-request-factory-connection-pool/" rel="next" title="(Spring Boot) SimpleClientHttpRequestFactory와 Connection Pool">
                  (Spring Boot) SimpleClientHttpRequestFactory와 Connection Pool <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">양권성</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"exobud","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
