<!doctypehtml><html lang=ko><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.2.0" name=generator><link href=/images/favicon/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/favicon/safari-pinned-tab.svg rel=mask-icon><link href=/images/favicon/manifest.json rel=manifest><meta content=yL1R2eDsKDqjPNaOBKp1usSDw8SQNzaO35svs1LKYWw name=google-site-verification><style>:root{--body-bg-color:#f5f7f9;--content-bg-color:#fff;--card-bg-color:#f5f5f5;--text-color:#555;--blockquote-color:#666;--link-color:#555;--link-hover-color:#222;--brand-color:#fff;--brand-hover-color:#fff;--table-row-odd-bg-color:#f9f9f9;--table-row-hover-bg-color:#f5f5f5;--menu-item-bg-color:#f5f5f5;--theme-color:#222;--btn-default-bg:#fff;--btn-default-color:#555;--btn-default-border-color:#555;--btn-default-hover-bg:#222;--btn-default-hover-color:#fff;--btn-default-hover-border-color:#222;--highlight-background:#f3f3f3;--highlight-foreground:#444;--highlight-gutter-background:#e1e1e1;--highlight-gutter-foreground:#555;color-scheme:light}@media (prefers-color-scheme:dark){:root{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--theme-color:#222;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#1c1b1b;--highlight-foreground:#fff;--highlight-gutter-background:#323131;--highlight-gutter-foreground:#e8e8e8;color-scheme:dark}img{opacity:.75}img:hover{opacity:.9}iframe{color-scheme:light}}html{line-height:1.15;-webkit-text-size-adjust:100%}details,main{display:block}pre{font-size:1em;overflow:auto;padding:10px}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}.table-container,textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}summary{display:list-item}[hidden],template{display:none}::selection{background:#262a30;color:#eee}body,html{height:100%}body{margin:0;background:var(--body-bg-color);box-sizing:border-box;color:var(--text-color);font-family:Lato,'PingFang SC','Microsoft YaHei',sans-serif;font-size:1em;line-height:2;min-height:100%;position:relative;transition:padding .2s ease-in-out}h1,h2,h3,h4,h5,h6{font-family:Lato,'PingFang SC','Microsoft YaHei',sans-serif;font-weight:700;line-height:1.5;margin:30px 0 15px}h1{font-size:1.5em}h2{font-size:1.375em}h3{font-size:1.25em}h4{font-size:1.125em}h5{font-size:1em}h6{font-size:.875em}p{margin:0 0 20px}a{background:0 0;border-bottom:1px solid #999;color:var(--link-color);cursor:pointer;outline:0;text-decoration:none;overflow-wrap:break-word}a:hover{border-bottom-color:var(--link-hover-color);color:var(--link-hover-color)}embed,iframe,img,video{display:block;margin-left:auto;margin-right:auto;max-width:100%}hr{box-sizing:content-box;overflow:visible;background-image:repeating-linear-gradient(-45deg,#ddd,#ddd 4px,transparent 4px,transparent 8px);border:0;height:3px;margin:40px 0}blockquote{border-left:4px solid #ddd;color:var(--blockquote-color);margin:0;padding:0 15px}blockquote cite::before{content:'-';padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0;font-size:.875em;margin:0 0 20px;width:100%}tbody tr:nth-of-type(odd){background:var(--table-row-odd-bg-color)}tbody tr:hover{background:var(--table-row-hover-bg-color)}caption,td,th{padding:8px}td,th{border:1px solid #ddd;border-bottom:3px solid #ddd}th{font-weight:700;padding-bottom:10px}td{border-bottom-width:1px}.btn{background:var(--btn-default-bg);border:2px solid var(--btn-default-border-color);border-radius:2px;color:var(--btn-default-color);display:inline-block;font-size:.875em;line-height:2;padding:0 20px;transition:background-color .2s ease-in-out}.btn:hover{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{text-align:left;width:1.285714285714286em}.toggle{line-height:0}.toggle .toggle-line{background:#fff;display:block;height:2px;left:0;position:relative;top:0;transition:.4s;width:100%}.toggle .toggle-line:first-child{margin-top:1px}.toggle .toggle-line:not(:first-child){margin-top:4px}.toggle.toggle-arrow :first-child{left:50%;top:2px;transform:rotate(45deg);width:50%}.toggle.toggle-arrow :last-child{left:50%;top:-2px;transform:rotate(-45deg);width:50%}.toggle.toggle-close :nth-child(2){opacity:0}.toggle.toggle-close :first-child{top:6px;transform:rotate(45deg)}.toggle.toggle-close :last-child{top:-6px;transform:rotate(-45deg)}/*!
  Theme: Default
  Description: Original highlight.js style
  Author: (c) Ivan Sagalaev <maniac@softwaremaniacs.org>
  Maintainer: @highlightjs/core-team
  Website: https://highlightjs.org/
  License: see project LICENSE
  Touched: 2021
*/pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{background:#f3f3f3;color:#444}.hljs-comment{color:#697070}.hljs-punctuation,.hljs-tag{color:#444a}.hljs-tag .hljs-attr,.hljs-tag .hljs-name{color:#444}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-operator,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#ab5656}.hljs-literal{color:#695}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta .hljs-string{color:#38a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media (prefers-color-scheme:dark){pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!
  Theme: StackOverflow Dark
  Description: Dark theme as used on stackoverflow.com
  Author: stackoverflow.com
  Maintainer: @Hirse
  Website: https://github.com/StackExchange/Stacks
  License: MIT
  Updated: 2021-05-15

  Updated for @stackoverflow/stacks v0.64.0
  Code Blocks: /blob/v0.64.0/lib/css/components/_stacks-code-blocks.less
  Colors: /blob/v0.64.0/lib/css/exports/_stacks-constants-colors.less
*/.hljs{color:#fff;background:#1c1b1b}.hljs-subst{color:#fff}.hljs-comment{color:#999}.hljs-attr,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-section,.hljs-selector-tag{color:#88aece}.hljs-attribute{color:#c59bc1}.hljs-name,.hljs-number,.hljs-quote,.hljs-selector-id,.hljs-template-tag,.hljs-type{color:#f08d49}.hljs-selector-class{color:#88aece}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-string,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#b5bd68}.hljs-meta,.hljs-selector-pseudo{color:#88aece}.hljs-built_in,.hljs-literal,.hljs-title{color:#f08d49}.hljs-bullet,.hljs-code{color:#ccc}.hljs-meta .hljs-string{color:#b5bd68}.hljs-deletion{color:#de7176}.hljs-addition{color:#76c490}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}}.code-container:hover .copy-btn,.highlight:hover .copy-btn{opacity:1}.code-container{position:relative}.copy-btn{color:#333;cursor:pointer;line-height:1.6;opacity:0;padding:2px 6px;position:absolute;transition:opacity .2s ease-in-out;color:var(--highlight-foreground);font-size:14px;right:0;top:2px}figure.highlight{border-radius:5px;box-shadow:0 10px 30px 0 rgba(0,0,0,.4);padding-top:30px;overflow:auto;position:relative}figure.highlight .table-container{border-radius:0 0 5px 5px}figure.highlight::before{background:#fc625d;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;left:12px;margin-top:-20px;position:absolute;border-radius:50%;content:' ';height:12px;width:12px}code,figure.highlight,kbd,pre{background:var(--highlight-background);color:var(--highlight-foreground)}figure.highlight,pre{line-height:1.6;margin:0 auto 20px}figure.highlight figcaption,pre .caption,pre figcaption{background:var(--highlight-gutter-background);color:var(--highlight-foreground);display:flow-root;font-size:.875em;line-height:1.2;padding:.5em}figure.highlight figcaption a,pre .caption a,pre figcaption a{color:var(--highlight-foreground);float:right}figure.highlight figcaption a:hover,pre .caption a:hover,pre figcaption a:hover{border-bottom-color:var(--highlight-foreground)}code,pre{font-family:consolas,Menlo,monospace,'PingFang SC','Microsoft YaHei'}code{border-radius:3px;font-size:.875em;padding:2px 4px;overflow-wrap:break-word}kbd{border:2px solid #ccc;border-radius:.2em;box-shadow:.1em .1em .2em rgba(0,0,0,.1);font-family:inherit;padding:.1em .3em;white-space:nowrap}figure.highlight pre{border:0;margin:0;padding:10px 0}figure.highlight table{border:0;margin:0;width:auto}figure.highlight td{border:0;padding:0}figure.highlight .gutter{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;user-select:none}figure.highlight .gutter pre{background:var(--highlight-gutter-background);color:var(--highlight-gutter-foreground);padding-left:10px;padding-right:10px;text-align:right}figure.highlight .code pre{padding-left:10px;width:100%}figure.highlight .marked{background:rgba(0,0,0,.3)}pre .caption,pre figcaption{margin-bottom:10px}.gist table{width:auto}.gist table td{border:0}pre code{background:0 0;padding:0;text-shadow:none}.blockquote-center{border-left:0;margin:40px 0;padding:0;position:relative;text-align:center}.blockquote-center::after,.blockquote-center::before{left:0;line-height:1;opacity:.6;position:absolute;width:100%}.blockquote-center::before{border-top:1px solid #ccc;text-align:left;top:-20px;content:'\f10d';font-family:'Font Awesome 6 Free';font-weight:900}.blockquote-center::after{border-bottom:1px solid #ccc;bottom:-20px;text-align:right;content:'\f10e';font-family:'Font Awesome 6 Free';font-weight:900}.blockquote-center div,.blockquote-center p{text-align:center}.group-picture{margin-bottom:20px}.group-picture .group-picture-row{display:flex;gap:3px;margin-bottom:3px}.group-picture .group-picture-column{flex:1}.group-picture .group-picture-column img{height:100%;margin:0;object-fit:cover;width:100%}.post-body .label{color:#555;padding:0 2px}.post-body .label.default{background:#f0f0f0}.post-body .label.primary{background:#efe6f7}.post-body .label.info{background:#e5f2f8}.post-body .label.success{background:#e7f4e9}.post-body .label.warning{background:#fcf6e1}.post-body .label.danger{background:#fae8eb}.post-body .link-grid{display:grid;grid-gap:1.5rem;gap:1.5rem;grid-template-columns:1fr 1fr;margin-bottom:20px;padding:1rem}.post-body .link-grid .link-grid-container{border:solid #ddd;box-shadow:1rem 1rem .5rem rgba(0,0,0,.5);min-height:5rem;min-width:0;padding:.5rem;position:relative;transition:background .3s}.post-body .link-grid .link-grid-container:hover{animation:.5s next-shake;background:var(--card-bg-color)}.post-body .link-grid .link-grid-container:active{box-shadow:.5rem .5rem .25rem rgba(0,0,0,.5);transform:translate(.2rem,.2rem)}.post-body .link-grid .link-grid-container .link-grid-image{border:1px solid #ddd;border-radius:50%;box-sizing:border-box;height:5rem;padding:3px;position:absolute;width:5rem}.post-body .link-grid .link-grid-container p{margin:0 1rem 0 6rem}.post-body .link-grid .link-grid-container p:first-of-type{font-size:1.2em}.post-body .link-grid .link-grid-container p:last-of-type{font-size:.8em;line-height:1.3rem;opacity:.7}.post-body .link-grid .link-grid-container a{border:0;height:100%;left:0;position:absolute;top:0;width:100%}@keyframes next-shake{0%{transform:translate(1pt,1pt) rotate(0)}10%{transform:translate(-1pt,-2pt) rotate(-1deg)}20%{transform:translate(-3pt,0) rotate(1deg)}30%{transform:translate(3pt,2pt) rotate(0)}40%{transform:translate(1pt,-1pt) rotate(1deg)}50%{transform:translate(-1pt,2pt) rotate(-1deg)}60%{transform:translate(-3pt,1pt) rotate(0)}70%{transform:translate(3pt,1pt) rotate(-1deg)}80%{transform:translate(-1pt,-1pt) rotate(1deg)}90%{transform:translate(1pt,2pt) rotate(0)}100%{transform:translate(1pt,-2pt) rotate(-1deg)}}.mermaid{margin-bottom:20px;text-align:center}.post-body .note{border-radius:3px;margin-bottom:20px;padding:1em;position:relative;border:1px solid #eee;border-left-width:5px}.post-body .note summary{cursor:pointer;outline:0}.post-body .note summary p{display:inline}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{border-bottom:initial;margin:0;padding-top:0}.post-body .note :first-child{margin-top:0}.post-body .note :last-child{margin-bottom:0}.post-body .note.default{border-left-color:#777}.post-body .note.default h2,.post-body .note.default h3,.post-body .note.default h4,.post-body .note.default h5,.post-body .note.default h6{color:#777}.post-body .note.primary{border-left-color:#6f42c1}.post-body .note.primary h2,.post-body .note.primary h3,.post-body .note.primary h4,.post-body .note.primary h5,.post-body .note.primary h6{color:#6f42c1}.post-body .note.info{border-left-color:#428bca}.post-body .note.info h2,.post-body .note.info h3,.post-body .note.info h4,.post-body .note.info h5,.post-body .note.info h6{color:#428bca}.post-body .note.success{border-left-color:#5cb85c}.post-body .note.success h2,.post-body .note.success h3,.post-body .note.success h4,.post-body .note.success h5,.post-body .note.success h6{color:#5cb85c}.post-body .note.warning{border-left-color:#f0ad4e}.post-body .note.warning h2,.post-body .note.warning h3,.post-body .note.warning h4,.post-body .note.warning h5,.post-body .note.warning h6{color:#f0ad4e}.post-body .note.danger{border-left-color:#d9534f}.post-body .note.danger h2,.post-body .note.danger h3,.post-body .note.danger h4,.post-body .note.danger h5,.post-body .note.danger h6{color:#d9534f}.post-body .tabs{margin-bottom:20px}.post-body .tabs,.tabs-comment{padding-top:10px}.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{background:var(--content-bg-color);display:flex;display:flex;flex-wrap:wrap;justify-content:center;margin:0;padding:0;position:-webkit-sticky;position:sticky;top:0;z-index:5}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid #ddd;border-left:1px solid transparent;border-right:1px solid transparent;border-radius:0;border-top:3px solid transparent;flex-grow:1;list-style-type:none}@media (max-width:413px){.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{display:block;margin-bottom:5px}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid transparent;border-left:3px solid transparent;border-right:1px solid transparent;border-top:1px solid transparent;border-radius:0}}.post-body .tabs ul.nav-tabs li.tab a,.tabs-comment ul.nav-tabs li.tab a{border-bottom:initial;display:block;line-height:1.8;padding:.25em .75em;text-align:center;transition:.2s ease-out}.post-body .tabs ul.nav-tabs li.tab a i[class^=fa],.tabs-comment ul.nav-tabs li.tab a i[class^=fa]{width:1.285714285714286em}.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#fc6423 #ddd transparent}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#ddd #ddd #ddd #fc6423}}.post-body .tabs ul.nav-tabs li.tab.active a,.tabs-comment ul.nav-tabs li.tab.active a{cursor:default}.post-body .tabs .tab-content,.tabs-comment .tab-content{border:1px solid #ddd;border-radius:0;border-top-color:transparent}@media (max-width:413px){.post-body .tabs .tab-content,.tabs-comment .tab-content{border-radius:0;border-top-color:#ddd}}.post-body .tabs .tab-content .tab-pane,.tabs-comment .tab-content .tab-pane{padding:20px 20px 0}.post-body .tabs .tab-content .tab-pane:not(.active),.tabs-comment .tab-content .tab-pane:not(.active){display:none}.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{display:inline-block;margin:-1px 10px 0;padding:0 10px}.pagination .page-number.current{background:#ccc;border-color:#ccc;color:var(--content-bg-color)}.pagination{border-top:1px solid #eee;margin:120px 0 0;text-align:center}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:0;border-top:1px solid #eee;transition:border-color .2s ease-in-out}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-top-color:var(--link-hover-color)}@media (max-width:767px){.post-body .link-grid{grid-template-columns:1fr}.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{margin:0 5px}.pagination{border-top:0}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:1px solid #eee;border-top:0}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-bottom-color:var(--link-hover-color)}.site-meta{text-align:center}}.pagination .space{margin:0;padding:0}.comments{margin-top:60px;overflow:hidden}.comment-button-group{display:flex;display:flex;flex-wrap:wrap;justify-content:center;justify-content:center;margin:1em 0}.comment-button-group .comment-button{margin:.1em .2em}.comment-button-group .comment-button.active{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.comment-position{display:none}.comment-position.active{display:block}.tabs-comment{margin-top:4em;padding-top:0}.tabs-comment .comments{margin-top:0;padding-top:0}.headband{background:var(--theme-color);height:3px}@media (max-width:991px){.headband{display:none}}.site-brand-container{display:flex;flex-shrink:0;padding:0 10px}.use-motion .column,.use-motion .site-brand-container .toggle{opacity:0}.site-meta{flex-grow:1;text-align:center}.custom-logo-image{margin-top:20px}@media (max-width:991px){.custom-logo-image{display:none}}.brand{border-bottom:0;color:var(--brand-color);display:inline-block;padding:0}.brand:hover{color:var(--brand-hover-color)}.site-title{font-family:Lato,'PingFang SC','Microsoft YaHei',sans-serif;font-size:1.375em;font-weight:400;line-height:1.5;margin:0}.site-subtitle{color:#ddd;font-size:.8125em;margin:10px 10px 0}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:0;position:relative;top:-10px}.site-nav-right,.site-nav-toggle{display:none}.site-nav-right .toggle,.site-nav-toggle .toggle{color:var(--text-color);padding:10px;width:22px}.site-nav-right .toggle .toggle-line,.site-nav-toggle .toggle .toggle-line{background:var(--text-color);border-radius:1px}@media (max-width:767px){.site-nav-right,.site-nav-toggle{display:flex;flex-direction:column;justify-content:center}.site-nav{--scroll-height:0;height:0;overflow:hidden;transition:height .2s ease-in-out,visibility .2s ease-in-out;visibility:hidden}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height);visibility:unset}}.menu{margin:0;padding:1em 0;text-align:center}.menu-item{display:inline-block;list-style:none;margin:0 10px}@media (max-width:767px){.menu-item{display:block;margin-top:10px}.menu-item.menu-item-search{display:none}}.menu-item a{border-bottom:0;display:block;font-size:.8125em;transition:border-color .2s ease-in-out}.menu-item a.menu-item-active,.menu-item a:hover{background:var(--menu-item-bg-color)}.menu-item i[class^=fa]{margin-right:8px}.menu-item .badge{background:#ccc;border-radius:10px;color:var(--content-bg-color);font-weight:700;line-height:1;margin-left:.35em;padding:2px 5px;text-shadow:1px 1px 0 rgba(0,0,0,.1)}.use-motion .menu-item{visibility:hidden}@media (max-width:991px){.sidebar{left:-320px;background:#222;bottom:0;box-shadow:inset 0 2px 6px #000;max-height:100vh;overflow-y:auto;position:fixed;top:0;transition:.2s ease-out;width:320px;z-index:20}.sidebar-active .sidebar{left:0}.sidebar a{border-bottom-color:#555;color:#999}.sidebar a:hover{border-bottom-color:#eee;color:#eee}.links-of-author:not(:first-child){margin-top:15px}.links-of-author a{border-bottom-color:#555;display:inline-block;margin-bottom:10px;margin-right:10px;vertical-align:middle;transition:.2s ease-in-out}.links-of-author a::before{background:#2affc2;display:inline-block;margin-right:3px;transform:translateY(-2px);border-radius:50%;content:' ';height:4px;width:4px}.links-of-blogroll-item{padding:2px 10px}.links-of-blogroll-item a{box-sizing:border-box;display:inline-block;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.popular-posts .popular-posts-item .popular-posts-link:hover{background:0 0}.sidebar-dimmer{background:#000;height:100%;left:0;opacity:0;position:fixed;top:0;transition:visibility .4s,opacity .4s;visibility:hidden;width:100%;z-index:10}.sidebar-active .sidebar-dimmer{opacity:.7;visibility:visible}}.sidebar-inner{color:#999;padding:18px 10px;text-align:center;display:flex;flex-direction:column;justify-content:center}.cc-license .cc-opacity{border-bottom:0;opacity:.7}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}.site-author-image{border:1px solid #eee;max-width:120px;padding:2px;border-radius:50%}.site-author-name{color:var(--text-color);font-weight:600;margin:0}.site-description{color:#999;font-size:.8125em;margin-top:0}.links-of-author a{font-size:.8125em}.sidebar .sidebar-button:not(:first-child){margin-top:15px}.sidebar .sidebar-button button{background:0 0;color:#fc6423;cursor:pointer;line-height:2;padding:0 15px;border:1px solid #fc6423;border-radius:4px}.sidebar .sidebar-button button:hover{background:#fc6423;color:#fff}.sidebar .sidebar-button button i[class^=fa]{margin-right:5px}.links-of-blogroll{font-size:.8125em}.links-of-blogroll-title{font-size:.875em;font-weight:600}.links-of-blogroll-list{list-style:none;margin:0;padding:0}.sidebar-nav{font-size:.875em;height:0;margin:0;overflow:hidden;padding-left:0;pointer-events:none;transition:height .2s ease-in-out,visibility .2s ease-in-out;visibility:hidden}.sidebar-nav-active .sidebar-nav{height:calc(2em + 1px);pointer-events:unset;visibility:unset}.sidebar-nav li{border-bottom:1px solid transparent;color:var(--text-color);cursor:pointer;display:inline-block;transition:border-bottom-color .2s ease-in-out,color .2s ease-in-out}.sidebar-nav li.sidebar-nav-overview{margin-left:10px}.sidebar-nav li:hover{color:#fc6423}.sidebar-overview-active .sidebar-nav-overview,.sidebar-toc-active .sidebar-nav-toc{border-bottom-color:#fc6423;color:#fc6423;transition-delay:0.2s}.sidebar-overview-active .sidebar-nav-overview:hover,.sidebar-toc-active .sidebar-nav-toc:hover{color:#fc6423}.sidebar-panel-container{align-items:start;display:grid;flex:1;overflow-x:hidden;overflow-y:auto;padding-top:0;transition:padding-top .2s ease-in-out}.sidebar-nav-active .sidebar-panel-container{padding-top:20px}.sidebar-panel{animation:.2s ease-in-out deactivate-sidebar-panel;grid-area:1/1;height:0;opacity:0;overflow:hidden;pointer-events:none;transform:translateY(0);transition:.2s ease-in-out;transition-property:opacity,transform,visibility;visibility:hidden}.sidebar-nav-active .sidebar-panel,.sidebar-overview-active .sidebar-panel.post-toc-wrap{transform:translateY(-20px)}.sidebar-overview-active:not(.sidebar-nav-active) .sidebar-panel.post-toc-wrap{transition-delay:0s,0.2s,0s}.sidebar-overview-active .sidebar-panel.site-overview-wrap,.sidebar-toc-active .sidebar-panel.post-toc-wrap{animation-name:activate-sidebar-panel;height:auto;opacity:1;pointer-events:unset;transform:translateY(0);transition-delay:0.2s,0.2s,0s;visibility:unset}.sidebar-panel.site-overview-wrap{display:flex;flex-direction:column;justify-content:center;gap:10px;justify-content:flex-start}@keyframes deactivate-sidebar-panel{from{height:var(--inactive-panel-height,0)}to{height:var(--active-panel-height,0)}}@keyframes activate-sidebar-panel{from{height:var(--inactive-panel-height,auto)}to{height:var(--active-panel-height,auto)}}.sidebar-toggle{bottom:61px;height:16px;padding:5px;width:16px;background:#222;cursor:pointer;opacity:.6;position:fixed;z-index:30;left:30px}.sidebar-toggle:hover{opacity:.8}@media (max-width:991px){.sidebar-toggle{left:20px;opacity:.8}}.sidebar-toggle:hover .toggle-line{background:#fc6423}@media (any-hover:hover){body:not(.sidebar-active) .sidebar-toggle:hover :first-child{left:50%;top:2px;transform:rotate(45deg);width:50%}body:not(.sidebar-active) .sidebar-toggle:hover :last-child{left:50%;top:-2px;transform:rotate(-45deg);width:50%}}.sidebar-active .sidebar-toggle :nth-child(2){opacity:0}.sidebar-active .sidebar-toggle :first-child{top:6px;transform:rotate(45deg)}.sidebar-active .sidebar-toggle :last-child{top:-6px;transform:rotate(-45deg)}.post-toc{font-size:.875em}.post-toc ol{list-style:none;margin:0;padding:0 2px 0 10px;text-align:left}.post-toc ol>:last-child{margin-bottom:5px}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition:.2s ease-in-out}.post-toc .nav-item{line-height:1.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.post-toc .nav .active>a{border-bottom-color:#fc6423;color:#fc6423}.post-toc .nav .active-current>a,.post-toc .nav .active-current>a:hover{color:#fc6423}.site-state{display:flex;flex-wrap:wrap;justify-content:center;line-height:1.4}.site-state-item{padding:0 15px}.site-state-item a{border-bottom:0;display:block}.site-state-item-count{display:block;font-size:1em;font-weight:600}.site-state-item-name{color:#999;font-size:.8125em}.footer{color:#999;font-size:.875em;padding:20px 0;transition:left .2s ease-in-out,right .2s ease-in-out}.footer.footer-fixed{bottom:0;left:0;position:absolute;right:0}.footer-inner{box-sizing:border-box;text-align:center;display:flex;flex-direction:column;justify-content:center;margin:0 auto;width:calc(100% - 20px)}@media (max-width:767px){.footer-inner{width:auto}}@media (min-width:1200px){.footer-inner{width:1160px}}@media (min-width:1600px){.footer-inner{width:73%}}.use-motion .footer{opacity:0}.languages{display:inline-block;font-size:1.125em;position:relative}.languages .lang-select-label span{margin:0 .5em}.languages .lang-select{height:100%;left:0;opacity:0;position:absolute;top:0;width:100%}.with-love{color:grey;display:inline-block;margin:0 5px}@keyframes icon-animate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,50%,60%,70%,80%{transform:scale(1.1)}}@media (max-width:567px){.main-inner{padding:initial!important}.posts-expand .post-header{margin-bottom:10px!important}.post-block{margin-top:initial!important;padding:8px 18px!important}.post-body h1,.post-body h2,.post-body h3,.post-body h4,.post-body h5,.post-body h6{margin:20px 0 8px}.post-body .note h1,.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6,.post-body .tabs .tab-content .tab-pane h1,.post-body .tabs .tab-content .tab-pane h2,.post-body .tabs .tab-content .tab-pane h3,.post-body .tabs .tab-content .tab-pane h4,.post-body .tabs .tab-content .tab-pane h5,.post-body .tabs .tab-content .tab-pane h6{margin:0 5px}.post-body>p{margin:0 0 10px}.post-body .note>p,.post-body .tabs .tab-content .tab-pane>p{padding:0 5px}.post-body img,.post-body video{margin-bottom:10px!important}.post-body .fancybox+figcaption,.post-body img+figcaption{margin:-5px auto 15px!important}.post-body .note{margin-bottom:10px!important;padding:10px!important}.post-body .tabs .tab-content .tab-pane{padding:10px 10px 0!important}.post-eof{margin:40px auto 20px!important}.pagination{margin-top:40px}}.back-to-top{font-size:12px;align-items:center;bottom:-100px;color:#fff;display:flex;height:26px;transition:bottom .2s ease-in-out;background:#222;cursor:pointer;opacity:.6;position:fixed;z-index:30;left:30px}.back-to-top span{margin-right:8px}.back-to-top .fa{text-align:center;width:26px}.back-to-top:hover{opacity:.8;color:#fc6423}@media (max-width:991px){.back-to-top{left:20px;opacity:.8}}.back-to-top.back-to-top-on{bottom:30px}.reading-progress-bar{--progress:0;background:#37c6c0;height:3px;position:fixed;z-index:50;width:var(--progress);left:0;top:0}.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ol,.rtl.post-body p,.rtl.post-body ul{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.post-button{margin-top:40px;text-align:center}.use-motion .collection-header,.use-motion .comments,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{visibility:hidden}.posts-collapse .post-content{margin-bottom:35px;margin-left:35px;position:relative}@media (max-width:767px){.posts-collapse .post-content{margin-left:0;margin-right:0}}.posts-collapse .post-content .collection-title{font-size:1.125em;position:relative}.posts-collapse .post-content .collection-title::before{background:#999;border:1px solid #fff;margin-left:-6px;margin-top:-4px;position:absolute;top:50%;border-radius:50%;content:' ';height:10px;width:10px}.posts-collapse .post-content .collection-year{font-size:1.5em;font-weight:700;margin:60px 0;position:relative}.posts-collapse .post-content .collection-year .collection-year-count{font-size:.75em;background:#ccc;border-radius:10px;color:var(--content-bg-color);font-weight:700;line-height:1;margin-left:.35em;padding:2px 5px;text-shadow:1px 1px 0 rgba(0,0,0,.1)}.posts-collapse .post-content .collection-year::before{background:#bbb;margin-left:-4px;margin-top:-4px;position:absolute;top:50%;border-radius:50%;content:' ';height:8px;width:8px}.posts-collapse .post-content .collection-header{display:block;margin-left:20px}.posts-collapse .post-content .collection-header small{color:#bbb;margin-left:5px}.posts-collapse .post-content .post-header{border-bottom:1px dashed #ccc;margin:30px 2px 0;padding-left:15px;position:relative;transition:border .2s ease-in-out}.posts-collapse .post-content .post-header::before{background:#bbb;border:1px solid #fff;left:-6px;position:absolute;top:.75em;transition:background .2s ease-in-out;border-radius:50%;content:' ';height:6px;width:6px}.posts-collapse .post-content .post-header:hover{border-bottom-color:#666}.posts-collapse .post-content .post-header:hover::before{background:#222}.posts-collapse .post-content .post-meta-container{display:inline;font-size:.75em;margin-right:10px}.posts-collapse .post-content .post-title{display:inline}.posts-collapse .post-content .post-title a{border-bottom:0;color:var(--link-color)}.posts-collapse .post-content .post-title .fa{font-size:.875em;margin-left:5px}.posts-collapse .post-content::before{background:#f5f5f5;content:' ';height:100%;margin-left:-2px;position:absolute;top:1.25em;width:4px}.post-body{font-family:Lato,'PingFang SC','Microsoft YaHei',sans-serif;overflow-wrap:break-word}@media (min-width:1200px){.post-body{font-size:1.125em}}@media (min-width:992px){.post-body{text-align:justify}}.post-body h1 .header-anchor,.post-body h1 .headerlink,.post-body h2 .header-anchor,.post-body h2 .headerlink,.post-body h3 .header-anchor,.post-body h3 .headerlink,.post-body h4 .header-anchor,.post-body h4 .headerlink,.post-body h5 .header-anchor,.post-body h5 .headerlink,.post-body h6 .header-anchor,.post-body h6 .headerlink{border-bottom-style:none;color:inherit;float:right;font-size:.875em;margin-left:10px;opacity:0}.post-body h1 .header-anchor::before,.post-body h1 .headerlink::before,.post-body h2 .header-anchor::before,.post-body h2 .headerlink::before,.post-body h3 .header-anchor::before,.post-body h3 .headerlink::before,.post-body h4 .header-anchor::before,.post-body h4 .headerlink::before,.post-body h5 .header-anchor::before,.post-body h5 .headerlink::before,.post-body h6 .header-anchor::before,.post-body h6 .headerlink::before{content:'\f0c1';font-family:'Font Awesome 6 Free';font-weight:900}.post-body h1:hover .header-anchor,.post-body h1:hover .headerlink,.post-body h2:hover .header-anchor,.post-body h2:hover .headerlink,.post-body h3:hover .header-anchor,.post-body h3:hover .headerlink,.post-body h4:hover .header-anchor,.post-body h4:hover .headerlink,.post-body h5:hover .header-anchor,.post-body h5:hover .headerlink,.post-body h6:hover .header-anchor,.post-body h6:hover .headerlink{opacity:.5}.post-body h1:hover .header-anchor:hover,.post-body h1:hover .headerlink:hover,.post-body h2:hover .header-anchor:hover,.post-body h2:hover .headerlink:hover,.post-body h3:hover .header-anchor:hover,.post-body h3:hover .headerlink:hover,.post-body h4:hover .header-anchor:hover,.post-body h4:hover .headerlink:hover,.post-body h5:hover .header-anchor:hover,.post-body h5:hover .headerlink:hover,.post-body h6:hover .header-anchor:hover,.post-body h6:hover .headerlink:hover{opacity:1}.post-body .exturl .fa{font-size:.875em;margin-left:4px}.post-body .fancybox+figcaption,.post-body img+figcaption{color:#999;font-size:.875em;font-weight:700;line-height:1;margin:-15px auto 15px;text-align:center}.post-body embed,.post-body iframe,.post-body img,.post-body video{margin-bottom:20px}.post-body .video-container{height:0;margin-bottom:20px;overflow:hidden;padding-top:75%;position:relative;width:100%}.post-body .video-container embed,.post-body .video-container iframe,.post-body .video-container object{height:100%;left:0;margin:0;position:absolute;top:0;width:100%}.post-gallery{display:flex;min-height:200px}.post-gallery .post-gallery-image{flex:1}.post-gallery .post-gallery-image:not(:first-child){clip-path:polygon(40px 0,100% 0,100% 100%,0 100%);margin-left:-20px}.post-gallery .post-gallery-image:not(:last-child){margin-right:-20px}.post-gallery .post-gallery-image img{height:100%;object-fit:cover;opacity:1;width:100%}.posts-expand .post-gallery{margin-bottom:60px}.posts-collapse .post-gallery{margin:15px 0}.posts-expand .post-header{font-size:1.125em;margin-bottom:60px;text-align:center}.posts-expand .post-title{font-size:1.5em;font-weight:400;margin:initial;overflow-wrap:break-word}.posts-expand .post-title-link{border-bottom:0;color:var(--link-color);display:inline-block;position:relative}.posts-expand .post-title-link::before{background:var(--link-color);bottom:0;content:'';height:2px;left:0;position:absolute;transform:scaleX(0);transition:transform .2s ease-in-out;width:100%}.posts-expand .post-title-link:hover::before{transform:scaleX(1)}.posts-expand .post-title-link .fa{font-size:.875em;margin-left:5px}.post-sticky-flag{display:inline-block;margin-right:8px;transform:rotate(30deg)}.posts-expand .post-meta-container{color:#999;font-family:Lato,'PingFang SC','Microsoft YaHei',sans-serif;font-size:.75em;margin-top:3px}.posts-expand .post-meta-container .post-description{font-size:.875em;margin-top:2px}.posts-expand .post-meta-container time{border-bottom:1px dashed #999}.post-meta{display:flex;flex-wrap:wrap;justify-content:center}:not(.post-meta-break)+.post-meta-item::before{content:'|';margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (max-width:991px){.post-body{text-align:justify}.post-meta-item-text{display:none}}.post-meta-break{flex-basis:100%;height:0}.post-nav{border-top:1px solid #eee;display:flex;gap:30px;justify-content:space-between;margin-top:1em;padding:10px 5px 0}.post-nav-item{flex:1}.post-nav-item a{border-bottom:0;display:block;font-size:.875em;line-height:1.6}.post-nav-item a:active{top:2px}.post-nav-item .fa{font-size:.75em}.post-nav-item:first-child .fa{margin-right:5px}.post-nav-item:last-child{text-align:right}.post-nav-item:last-child .fa{margin-left:5px}.post-footer{display:flex;flex-direction:column;justify-content:center}.post-eof{background:#ccc;height:1px;margin:80px auto 60px;width:8%}.post-block:last-of-type .post-eof{display:none}.post-tags{margin-top:40px;text-align:center}.post-tags a{display:inline-block;font-size:.8125em}.post-tags a:not(:last-child){margin-right:10px}.social-like{border-top:1px solid #eee;font-size:.875em;margin-top:1em;padding-top:1em;display:flex;flex-wrap:wrap;justify-content:center}.social-like a{border-bottom:none}.reward-container{margin:1em 0 0;padding:1em 0;text-align:center}.reward-container button{background:0 0;color:#fc6423;cursor:pointer;line-height:2;padding:0 15px;border:2px solid #fc6423;border-radius:2px;outline:0;transition:.2s ease-in-out;vertical-align:text-top}.reward-container button:hover{background:#fc6423;color:#fff}.post-reward{display:none;padding-top:20px}.post-reward.active{display:block}.post-reward div{display:inline-block}.post-reward div span{display:block}.post-reward img{display:inline-block;margin:.8em 2em 0;max-width:100%;width:180px}@keyframes next-roll{from{transform:rotateZ(30deg)}to{transform:rotateZ(-30deg)}}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{list-style:none;margin:0;padding:0}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{font-size:.75em;background:#ccc;border-radius:10px;color:var(--content-bg-color);font-weight:700;line-height:1;margin-left:.35em;padding:2px 5px;text-shadow:1px 1px 0 rgba(0,0,0,.1)}.category-all-page .category-list-child{padding-left:10px}.event-list hr{background:#222;margin:20px 0 45px}.event-list hr::after{background:#222;color:#fff;content:'NOW';display:inline-block;font-weight:700;padding:0 5px}.event-list .event{--event-background:#222;--event-foreground:#bbb;--event-title:#fff;background:var(--event-background);padding:15px}.event-list .event .event-summary{border-bottom:0;color:var(--event-title);margin:0;padding:0 0 0 35px;position:relative}.event-list .event .event-summary::before{animation:1s ease-in-out infinite alternate dot-flash;background:var(--event-title);left:0;margin-top:-6px;position:absolute;top:50%;border-radius:50%;content:' ';height:12px;width:12px}.event-list .event:nth-of-type(odd) .event-summary::before{animation-delay:.5s}.event-list .event:not(:last-child){margin-bottom:20px}.event-list .event .event-relative-time{color:var(--event-foreground);display:inline-block;font-size:12px;font-weight:400;padding-left:12px}.event-list .event .event-details{color:var(--event-foreground);display:block;line-height:18px;padding:6px 0 6px 35px}.event-list .event .event-details::before{color:var(--event-foreground);display:inline-block;margin-right:9px;width:14px;font-family:'Font Awesome 6 Free';font-weight:900}.event-list .event .event-details.event-location::before{content:'\f041'}.event-list .event .event-details.event-duration::before{content:'\f017'}.event-list .event .event-details.event-description::before{content:'\f024'}.event-list .event-past{--event-background:#f5f5f5;--event-foreground:#999;--event-title:#222}@keyframes dot-flash{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}ul.breadcrumb{font-size:.75em;list-style:none;margin:1em 0;padding:0 2em;text-align:center}ul.breadcrumb li{display:inline}ul.breadcrumb li:not(:first-child)::before{content:'/\00a0';font-weight:400;padding:.5em}ul.breadcrumb li:last-child{font-weight:700}.tag-cloud{text-align:center}.tag-cloud a{display:inline-block;margin:10px}.tag-cloud-0{border-bottom-color:#aaa;color:#aaa}.tag-cloud-1{border-bottom-color:#9a9a9a;color:#9a9a9a}.tag-cloud-2{border-bottom-color:#8b8b8b;color:#8b8b8b}.tag-cloud-3{border-bottom-color:#7c7c7c;color:#7c7c7c}.tag-cloud-4{border-bottom-color:#6c6c6c;color:#6c6c6c}.tag-cloud-5{border-bottom-color:#5d5d5d;color:#5d5d5d}.tag-cloud-6{border-bottom-color:#4e4e4e;color:#4e4e4e}.tag-cloud-7{border-bottom-color:#3e3e3e;color:#3e3e3e}.tag-cloud-8{border-bottom-color:#2f2f2f;color:#2f2f2f}.tag-cloud-9{border-bottom-color:#202020;color:#202020}.tag-cloud-10{border-bottom-color:#111;color:#111}.search-active{overflow:hidden}.search-pop-overlay{background:rgba(0,0,0,0);display:flex;height:100%;left:0;position:fixed;top:0;transition:visibility .4s,background .4s;visibility:hidden;width:100%;z-index:40}.search-active .search-pop-overlay{background:rgba(0,0,0,.3);visibility:visible}.search-popup{background:var(--card-bg-color);border-radius:5px;height:80%;margin:auto;transform:scale(0);transition:transform .4s;width:700px}.search-active .search-popup{transform:scale(1)}@media (max-width:767px){.search-popup{border-radius:0;height:100%;width:100%}}.search-popup .popup-btn-close,.search-popup .search-icon{color:#999;font-size:18px;padding:0 10px}.search-popup .popup-btn-close{cursor:pointer}.search-popup .popup-btn-close:hover .fa{color:#222}.search-popup .search-header{background:#eee;border-top-left-radius:5px;border-top-right-radius:5px;display:flex;padding:5px}@media (prefers-color-scheme:dark){.tag-cloud-0{border-bottom-color:#555;color:#555}.tag-cloud-1{border-bottom-color:#646464;color:#646464}.tag-cloud-2{border-bottom-color:#737373;color:#737373}.tag-cloud-3{border-bottom-color:#828282;color:#828282}.tag-cloud-4{border-bottom-color:#929292;color:#929292}.tag-cloud-5{border-bottom-color:#a1a1a1;color:#a1a1a1}.tag-cloud-6{border-bottom-color:#b0b0b0;color:#b0b0b0}.tag-cloud-7{border-bottom-color:silver;color:silver}.tag-cloud-8{border-bottom-color:#cfcfcf;color:#cfcfcf}.tag-cloud-9{border-bottom-color:#dedede;color:#dedede}.tag-cloud-10{border-bottom-color:#eee;color:#eee}.search-popup .search-header{background:#666}}.search-popup input.search-input{background:0 0;border:0;outline:0;width:100%}.search-popup input.search-input::-webkit-search-cancel-button{display:none}.search-popup .search-result-container{height:calc(100% - 55px);overflow:auto;padding:5px 25px}.search-popup .search-result-container hr{margin:5px 0 10px}.search-popup .search-result-container hr:first-child{display:none}.search-popup .search-result-list{margin:0 5px;padding:0;width:100%}.search-popup a.search-result-title{font-weight:700}.search-popup p.search-result{border-bottom:1px dashed #ccc;padding:5px 0}.search-popup .search-input-container{flex-grow:1;padding:2px}.search-popup .no-result{display:flex}.search-popup .search-result-icon{color:#ccc;margin:auto}mark.search-keyword{background:0 0;border-bottom:1px dashed #ff2a2a;color:#ff2a2a;font-weight:700}.use-motion .animated{animation-fill-mode:none;visibility:inherit}.use-motion .sidebar .animated{animation-fill-mode:both}header.header{background:var(--content-bg-color);border-radius:initial;box-shadow:initial}.main{align-items:stretch;display:flex;justify-content:space-between;margin:0 auto;width:calc(100% - 20px)}@media (max-width:767px){.main{width:auto}}@media (min-width:1200px){.main{width:1160px}}@media (min-width:1600px){.main{width:73%}}@media (max-width:991px){header.header{border-radius:initial}.main{display:block;width:auto}}.main-inner{border-radius:initial;box-sizing:border-box;width:calc(100% - 252px)}.footer-inner{padding-left:252px}@media (max-width:991px){.main-inner{border-radius:initial;width:100%}.footer-inner{padding-left:0;padding-right:0;width:auto}}.column{width:240px}.site-brand-container{background:var(--theme-color)}.site-meta{padding:20px 0}.site-nav-right .toggle,.site-nav-toggle .toggle{color:#fff}.site-nav-right .toggle .toggle-line,.site-nav-toggle .toggle .toggle-line{background:#fff}@media (min-width:768px) and (max-width:991px){.site-nav-right,.site-nav-toggle{display:flex;flex-direction:column;justify-content:center}.site-nav{--scroll-height:0;height:0;overflow:hidden;transition:height .2s ease-in-out,visibility .2s ease-in-out;visibility:hidden}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height);visibility:unset}}.menu .menu-item{display:block;margin:0}.menu .menu-item a{padding:5px 20px;transition-property:background-color;display:flex;align-items:center}.menu .menu-item a .badge{margin-left:auto}.sub-menu{margin:0;padding:6px 0}.sub-menu .menu-item{display:inline-block}.sub-menu .menu-item a{background:0 0;margin:5px 10px;padding:initial}.sub-menu .menu-item a:hover{background:0 0;color:#fc6423}.sub-menu .menu-item-active{border-bottom-color:#fc6423;color:#fc6423}.sub-menu .menu-item-active:hover{border-bottom-color:#fc6423}@media (min-width:992px){.sidebar{position:-webkit-sticky;position:sticky;top:12px}.sidebar-toggle{display:none}.sidebar-inner{background:var(--content-bg-color);border-radius:initial;box-shadow:initial;box-sizing:border-box;color:var(--text-color);margin-top:12px;max-height:calc(100vh - 24px)}.site-state-item{padding:0 10px}.sidebar .sidebar-button{border-bottom:1px dotted #ccc;border-top:1px dotted #ccc}.sidebar .sidebar-button button{border:0;color:#fc6423;display:block;width:100%}.sidebar .sidebar-button button:hover{background:0 0;border:0;color:#e34603}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author-item{margin:5px 0 0}.links-of-author-item a{box-sizing:border-box;max-width:100%;overflow:hidden;padding:0 5px;text-overflow:ellipsis;white-space:nowrap;border-bottom:0;border-radius:4px;display:block}.links-of-author-item a:hover{background:var(--body-bg-color)}}.main-inner{background:var(--content-bg-color);box-shadow:initial;padding:40px}@media (max-width:991px){.column{width:auto}.site-nav-on .site-brand-container{box-shadow:0 0 16px rgba(0,0,0,.5)}.menu .menu-item.menu-item-search{display:none}.main-inner{padding:20px}}.sub-menu{border-bottom:1px solid #ddd}.post-block:first-of-type{padding-top:40px}@media (max-width:767px){.pagination{margin-bottom:10px}}@media (min-width:992px) and (max-width:991px){.sidebar{display:none}}#disqus_recommendations,#disqus_thread>iframe{display:none}iframe[src*="https://disqus.com/embed/comments/?"]{display:block!important}img{max-width:50vh;height:auto;max-height:30vh;display:block;margin:0 auto 20px;object-fit:contain}.video-container{max-width:50vh;height:auto;max-height:30vh;display:block;margin:0 auto 20px;object-fit:contain;padding-top:30vh!important}@media (max-width:768px){.video-container,img{max-width:100%;max-height:none}}.fancybox__content img{max-width:100%;max-height:none;width:auto;height:auto}/*!* 비디오 컨테이너 스타일 설정 *!*/</style><link as=style href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css onload=this.rel='stylesheet' rel=preload><link crossorigin href=https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css integrity=sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"perfectacle.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"manual"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src=/js/config.js></script><meta content="Java의 Virtual Threads는 JDK 19에 Preview Features로 추가되었다.프로젝트 룸(Loom)에서 개발한 기능으로 알고있는데 사실 큰 관심도 없던(뭐하는 지도 모르던) 프로젝트였고, JDK 19가 LTS도 아니기 때문에 회사에서 바로 써볼 수도 없기에 JDK 19는 큰 관심도 가지고 있지 않았다.하지만 최근 스프링 블로그에서 Em" name=description><meta content=blog property=og:type><meta content="Java Virtual Threads 훑어보기" property=og:title><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/index.html property=og:url><meta content="오늘도 끄적끄적" property=og:site_name><meta content="Java의 Virtual Threads는 JDK 19에 Preview Features로 추가되었다.프로젝트 룸(Loom)에서 개발한 기능으로 알고있는데 사실 큰 관심도 없던(뭐하는 지도 모르던) 프로젝트였고, JDK 19가 LTS도 아니기 때문에 회사에서 바로 써볼 수도 없기에 JDK 19는 큰 관심도 가지고 있지 않았다.하지만 최근 스프링 블로그에서 Em" property=og:description><meta content=ko_KR property=og:locale><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-1.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-2.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-3.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-not-show-name.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-states.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-profiling.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-mount-unmount.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-interceptor.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-logging.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-interceptor.png property=og:image><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-async-thread.png property=og:image><meta content=2022-12-29T00:22:21.000Z property=article:published_time><meta content=2024-07-20T06:43:59.506Z property=article:modified_time><meta content=양권성 property=article:author><meta content=Java property=article:tag><meta content=Spring property=article:tag><meta content="Spring Boot" property=article:tag><meta content="Virtual Threads" property=article:tag><meta content=Loom property=article:tag><meta content=summary name=twitter:card><meta content=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-1.png name=twitter:image><link href=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"ko","comments":true,"permalink":"https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/","path":"2022/12/29/look-over-java-virtual-threads/","title":"Java Virtual Threads 훑어보기"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>Java Virtual Threads 훑어보기 | 오늘도 끄적끄적</title><script async src=https://www.googletagmanager.com/gtag/js?id=UA-87795455-1></script><script class=next-config data-name=google_analytics type=application/json>{"tracking_id":"UA-87795455-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src=/js/third-party/analytics/google-analytics.js></script><!--<script data-ad-client="ca-pub-3881550906962162" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>--><noscript><link href=/css/noscript.css rel=stylesheet></noscript><link title="오늘도 끄적끄적" href=/atom.xml rel=alternate type=application/atom+xml><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label="Toggle navigation bar" class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>오늘도 끄적끄적</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>느리더라도 꾸준하게</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=검색 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>홈</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>정보</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>태그<span class=badge>258</span></a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>카테고리<span class=badge>50</span></a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>아카이브<span class=badge>219</span></a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>검색 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=Searching... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>목차<li class=sidebar-nav-overview>흝어보기</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#Platform-Threads><span class=nav-number>1.</span> <span class=nav-text>Platform Threads</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Virtual-Threads><span class=nav-number>2.</span> <span class=nav-text>Virtual Threads</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Virtual-Threads-%EC%8A%A4%EC%BC%80%EC%A5%B4%EB%A7%81><span class=nav-number>2.1.</span> <span class=nav-text>Virtual Threads 스케쥴링</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%EA%B8%B0%EC%A1%B4-%EC%BD%94%EB%93%9C%EC%99%80%EC%9D%98-%ED%98%B8%ED%99%98%EC%84%B1><span class=nav-number>2.2.</span> <span class=nav-text>기존 코드와의 호환성</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Thread-%ED%81%B4%EB%9E%98%EC%8A%A4%EC%9D%98-%ED%98%B8%ED%99%98%EC%84%B1><span class=nav-number>2.2.1.</span> <span class=nav-text>Thread 클래스의 호환성</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Socket-API%EC%99%80%EC%9D%98-%ED%98%B8%ED%99%98%EC%84%B1><span class=nav-number>2.2.2.</span> <span class=nav-text>Socket API와의 호환성</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Spring%EA%B3%BC%EC%9D%98-%ED%98%B8%ED%99%98%EC%84%B1><span class=nav-number>2.2.3.</span> <span class=nav-text>Spring과의 호환성</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%EC%BD%94%ED%8B%80%EB%A6%B0%EA%B3%BC%EC%9D%98-%ED%98%B8%ED%99%98%EC%84%B1><span class=nav-number>2.2.4.</span> <span class=nav-text>코틀린과의 호환성</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD><span class=nav-number>2.3.</span> <span class=nav-text>주의사항</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%EB%A7%88%EC%B9%98%EB%A9%B0><span class=nav-number>3.</span> <span class=nav-text>마치며</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%EC%B0%B8%EA%B3%A0-%EB%A7%81%ED%81%AC><span class=nav-number>4.</span> <span class=nav-text>참고 링크</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=양권성 class=site-author-image itemprop=image src=/images/avatar/avatar.png><p class=site-author-name itemprop=name>양권성<div class=site-description itemprop=description>Toss Server Developer</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>219</span> <span class=site-state-item-name>포스트</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>50</span> <span class=site-state-item-name>카테고리</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>258</span> <span class=site-state-item-name>태그</span></a></div></nav></div><div class="links-of-author animated"><span class=links-of-author-item> <a rel="external nofollow noopener noreferrer" title="GitHub → https://github.com/perfectacle" href=https://github.com/perfectacle target=_blank><i class="fab fa-github fa-fw"></i></a> </span><span class=links-of-author-item> <a rel="external nofollow noopener noreferrer" title="E-Mail → mailto:perfectacle@gmail.com" href=mailto:perfectacle@gmail.com target=_blank><i class="fa fa-envelope fa-fw"></i></a> </span><span class=links-of-author-item> <a rel="external nofollow noopener noreferrer" title="FB Page → https://www.facebook.com/perfectacle" href=https://www.facebook.com/perfectacle target=_blank><i class="fab fa-facebook fa-fw"></i></a> </span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=ko><link href=https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar/avatar.png itemprop=image> <meta content=양권성 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="오늘도 끄적끄적" itemprop=name> <meta content="Toss Server Developer" itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="Java Virtual Threads 훑어보기 | 오늘도 끄적끄적" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Java Virtual Threads 훑어보기</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>작성일</span> <time itemprop="dateCreated datePublished" title="Post created: 2022-12-29 00:22:21" datetime=2022-12-29T00:22:21+00:00>2022-12-29</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>In</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Note/ itemprop=url rel=index><span itemprop=name>Note</span></a> </span> , <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Note/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a> </span> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-comment"></i> </span> <span class=post-meta-item-text>Disqus: </span> <a href=/2022/12/29/look-over-java-virtual-threads/#disqus_thread itemprop=discussionUrl title=disqus> <span class="post-comments-count disqus-comment-count" data-disqus-identifier=2022/12/29/look-over-java-virtual-threads/ itemprop=commentCount></span> </a> </span></div></div></header><div class=post-body itemprop=articleBody><p>Java의 <a rel="external nofollow noopener noreferrer" href=https://openjdk.org/jeps/425 target=_blank>Virtual Threads</a>는 JDK 19에 <a rel="external nofollow noopener noreferrer" href=https://openjdk.org/jeps/12 target=_blank>Preview Features</a>로 추가되었다.<br><a rel="external nofollow noopener noreferrer" href=https://wiki.openjdk.org/display/loom/Main target=_blank>프로젝트 룸(Loom)</a>에서 개발한 기능으로 알고있는데 사실 큰 관심도 없던(뭐하는 지도 모르던) 프로젝트였고, JDK 19가 LTS도 아니기 때문에 회사에서 바로 써볼 수도 없기에 JDK 19는 큰 관심도 가지고 있지 않았다.<br>하지만 최근 스프링 블로그에서 <a rel="external nofollow noopener noreferrer" href=https://spring.io/blog/2022/10/11/embracing-virtual-threads target=_blank>Embracing Virtual Threads</a> 라는 포스트가 올라온 걸 보고 살짝 관심 가지게 되었다.<p><a rel="external nofollow noopener noreferrer" href=https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc target=_blank>Spring Web MVC</a>와 같이 전형적인 1 Request per 1 Thread 모델의 한계(쓰레드 자체가 많은 메모리를 소비하고, 컨텍스트 스위칭에 따른 불필요한 시간 소요 등등)를 극복하기 위해<br><a rel="external nofollow noopener noreferrer" href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#spring-webflux target=_blank>Spring Webflux</a>(가 의존하는 <a rel="external nofollow noopener noreferrer" href=https://netty.io/ target=_blank>Netty</a>)에서는 코어 갯수 * 2개만의 쓰레드를 만듦으로 인해 그 한계를 극복하였지만 하나의 요청을 하나의 쓰레드가 온전히 처리하는 것이 아니기 때문에 스택트레이스를 봐도 파편화된 정보가 남아 트러블 슈팅에 문제가 있었고,<br><a rel="external nofollow noopener noreferrer" href=https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html target=_blank>Mono</a>나 <a rel="external nofollow noopener noreferrer" href=https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html target=_blank>Flux</a>와 같은 Publisher 타입으로 값을 감싸야 하기 때문에 코드가 매우 보기 힘들고, 어디서 쓰레드를 블락하는 코드를 호출하는 건 아닌지 항상 불안에 떨었어야했다.<p>그러다보니 Webflux가 더 고성능을 보장하더라도 유지보수하기가 힘들고 러닝커브 또한 존재하기 때문에 어지간한 경우가 아니면 Web MVC로 프로젝트를 만들었다.<br>사실 프로덕션에서 RDBMS를 안 쓰는 곳이 거의 없는데 <a rel="external nofollow noopener noreferrer" href=https://r2dbc.io/ target=_blank>R2DBC</a>를 사용하기에는 너무 불안정해 보이기도 했고, 그리고 TPS가 안 나오면 대부분 스케일 아웃하는 형태로 해결을 많이 했다.<br>서버보다는 사람이 가장 비싼 자원이라고 생각되기에 유지보수 측면으로만 생각하다보니 Webflux는 거의 사용한 적이 없는 것 같다.<br>결정적으로 Web MVC(Spring Boot를 사용한다면 톰캣의 최대 쓰레드인 200개)만으로도 부족함이 없는 서비스도 많았고, 단일 서버가 아닌 이중화 등등으로 인해 서버가 다중으로 뜨기에 Webflux를 써야할 만큼의 처리를 단일서버에서 하지 않는 경우가 대다수였다.<p>그럼에도 불구하고 Virtual Threads는 어떠한 문제를 해결해주는 것인지, Spring과 함께 사용하면 어떤 시너지를 낼 수 있을지 궁금해서 살짝만 훑어보았다.<h2 id=Platform-Threads><a title="Platform Threads" class=headerlink href=#Platform-Threads></a>Platform Threads</h2><pre><code class="highlight mermaid">graph TD;
    subgraph OS
    A[OS Scheduler] -- schedule --> B[OS Thread 1];
    A[OS Scheduler] -- schedule --> C[OS Thread 2];
    end
    subgraph JVM
    B --> D[Platform Thread 1];
    C --> E[Platform Thread 2];
    end</code></pre><p>우리가 일반적으로 자바에서 쓰레드라고 부르는 것은 OS에서 생성한 쓰레드를 래핑해서 JVM에서 사용하기 쉽게 만든 Platform Threads라는 것을 말한다.<br>OS에 의해 스케쥴링 되기 때문에 쓰레드 간 전환을 위해 컨텍스트 스위칭이 발생하기도 하고, Platform Thread 하나를 생성하는 것은 OS에도 쓰레드를 하나 생성하는 것이기 때문에 일반적인 객체 생성과는 비교 불가능할 정도로 느리기 때문에 기본적으로 쓰레드 풀이라는 것을 만들고 거기에 미리 쓰레드들을 생성해두게 된다.<br>그러다보면 쓰레드 풀을 또 관리해야하는데 많은 양의 쓰레드를 만들다보면 또 메모리를 너무 많이 사용해서 문제가 발생하기도 한다.<h2 id=Virtual-Threads><a title="Virtual Threads" class=headerlink href=#Virtual-Threads></a>Virtual Threads</h2><pre><code class="highlight mermaid">graph TD;
    subgraph OS
    A[OS Scheduler] -- schedule --> B[OS Thread 1];
    A[OS Scheduler] -- schedule --> C[OS Thread 2];
    end
    subgraph JVM
    B --> D[ForkJoinPool];
    C --> D[ForkJoinPool];
    D -- schedule --> E["Carrier Thread 1 (Worker Thread 1)"];
    D -- schedule --> F["Carrier Thread 2 (Worker Thread 2)"];
    E --> G[Queue 1];
    F --> H[Queue 2];
    G --  schedule --> I["Virtual Thread 1 (Task 1)"];
    G --  schedule --> J["Virtual Thread 2 (Task 2)"];
    H --  schedule --> K["Virtual Thread 3 (Task 3)"];
    end</code></pre><p>그에 반해 Virtual Threads는 OS의 Thread와 1:1로 대응되지 않는다.<br>OS와 1:1로 대응되던 Platform Threads는 Carrier Threads라고 부른다.<p>Carrier Thread는 <a rel="external nofollow noopener noreferrer" href=https://docs.oracle.com/en/java/javase/19/docs/api/java.base/java/util/concurrent/ForkJoinPool.html target=_blank>ForkJoinPool</a> 안에 Worker Thread로 생성이 되어 스케쥴링이 되고, 각 Worker Thread들은 Queue를 가지고 있어서 Task를 스케쥴링하는데 Virtual Thread 자체(좀 더 정확히는 Virtual Thread의 runContinuation 메서드를 실행하는 Runnable 타입)가 Task가 되어서 Queue에 들어가게 된다.</p><img src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-1.png><img src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-2.png><img src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-3.png><blockquote><p>initially, carrier threads for virtual threads are threads in a ForkJoinPool that operates in FIFO mode. The size of this pool defaults to the number of available processors.<br><a rel="external nofollow noopener noreferrer" href=https://www.infoq.com/articles/java-virtual-threads target=_blank>https://www.infoq.com/articles/java-virtual-threads</a></blockquote><p>Queue 안에 있는 Virtual Thread 쓰레드들은 FIFO 방식으로 스케쥴링 되고, ForkJoinPool 안의 Worker Thread인 Carrier Thread는 기본적으로 CPU 코어 갯수(정확히는 available processor)만큼의 Carrier Threads를 생성한다. (아마 컨텍스트 스위칭 비용 때문이 아닐까 싶다.)<blockquote><p>We dont have to guess how much stack space a thread might need, or make a one-size-fits-all estimate for all threads;<br>the memory footprint for a virtual thread starts out at only a few hundred bytes, and is expanded and shrunk automatically as the call stack expands and shrinks.<br><a rel="external nofollow noopener noreferrer" href=https://www.infoq.com/articles/java-virtual-threads target=_blank>https://www.infoq.com/articles/java-virtual-threads</a></blockquote><p>그리고 Virtual Threads는 OS의 쓰레드와 대응되는 개념도 아니고, JVM에서 직접 쓰레드를 생성하기 때문에 생성 비용(용량/시간 등등의 측면에서)이 비싸지도 않고, 크기가 자동으로 조절되기 때문에 쓰레드 풀처럼 갯수를 관리할 필요도 없다.<blockquote><p>The difference with virtual threads is that, due to them being under the control of the JVM, the thread stack is stored in the heap memory and not in the stack.<br>This means that allocating the thread stack for an awakened virtual thread becomes much cheaper.<br><a rel="external nofollow noopener noreferrer" href=https://theboreddev.com/understanding-java-virtual-threads/ target=_blank>https://theboreddev.com/understanding-java-virtual-threads/</a></blockquote><p>JVM에서 쓰레드를 스케쥴링 해야하기 때문에 stack이 아닌 Heap 메모리 영역에 쓰레드의 스택이 저장되고 관리되기 때문에 우리가 알고있는 컨텍스트 스위칭에 대한 비용이 OS 레벨이 아닌 JVM 레벨에서 끝나기 때문에 훨씬 값싼 것이다.<h3 id=Virtual-Threads-스케쥴링><a title="Virtual Threads 스케쥴링" class=headerlink href=#Virtual-Threads-스케쥴링></a>Virtual Threads 스케쥴링</h3><blockquote><p>The operating system schedules OS threads, and thus platform threads, but virtual threads are scheduled by the JDK.<br>The JDK does so indirectly by assigning virtual threads to platform threads in a process called mounting.<br>The JDK unassigns the platform threads later; this is called unmounting.<br>…<br>To implement this process, the JDK uses a dedicated ForkJoinPool in first-in-first-out (FIFO) mode as a virtual thread scheduler.<br>(Note: This is distinct from the common pool used by parallel streams.)<br>…<br>The JDK could mount a virtual thread by copying all its frames from heap to stack.<br>When the virtual thread is unmounted, most frames are left on the heap and copied lazily as needed.<br><a rel="external nofollow noopener noreferrer" href=https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads target=_blank>https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads</a></blockquote><p>Carrier Threads(Platform Threads)와 달리 Virtual Threads는 JDK에 의해 스케쥴링 되는데 ForkJoinPool을 이용하여 구현하였다. (parallel streams에서 사용하는 common pool과는 별개의 ForkJoinPool이라고 함.)<br>Virtual Threads 내에서는 CPU를 사용하지 않는 블로킹 메서드(네트워크 I/O, 파일 I/O 등등)를 만나게 되면 <strong>stack frames를 Heap 메모리에 저장(복사)</strong> 해놓는데 이 과정을 <strong>unmounting</strong>이라고 부른다.<br>그리고 블로킹 메서드가 종료되면 <strong>Heap 메모리에 저장된 stack frames를 다시 Virtual Threads로 불러오는데</strong> 이 과정을 <strong>mounting</strong>이라고 부른다.<p>이렇게 JVM 내에서 Virtual Threads 간 컨텍스트 스위칭이 이루어지기 때문에 Platform Threads를 사용할 때 비해서 컨텍스트 스위칭 비용이 매우 싸고, 스택트레이스를 찍었을 때 유실없이 모든 정보를 남길 수 있는 것이다.<p>코드를 통해 어떻게 Virtual Threads가 스케쥴링 되는지 좀 더 자세히 보자.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">VirtualThreadExample</span> {</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>Logger</span> <span class=variable>log</span> <span class=operator>=</span> Logger.getAnonymousLogger();</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> InterruptedException {</span><br><span class=line>        <span class=comment>// Dec 29, 2022 2:39:08 AM org.example.VirtualThreadExample main</span></span><br><span class=line>        <span class=comment>// INFO:</span></span><br><span class=line>        <span class=comment>// threadName: main</span></span><br><span class=line>        <span class=comment>// availableProcessors: 10</span></span><br><span class=line>        log.info(<span class=string>"\nthreadName: "</span> + Thread.currentThread().getName() + <span class=string>"\navailableProcessors: "</span> + Runtime.getRuntime().availableProcessors());</span><br><span class=line></span><br><span class=line>        <span class=keyword>final</span> <span class=type>long</span> <span class=variable>start</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>        <span class=keyword>final</span> <span class=type>AtomicLong</span> <span class=variable>index</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">AtomicLong</span>();</span><br><span class=line>        <span class=keyword>final</span> <span class=type>int</span> <span class=variable>count</span> <span class=operator>=</span> <span class=number>100</span>;</span><br><span class=line>        <span class=keyword>final</span> <span class=type>CountDownLatch</span> <span class=variable>countDownLatch</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">CountDownLatch</span>(count);</span><br><span class=line></span><br><span class=line>        <span class=keyword>final</span> <span class=type>Runnable</span> <span class=variable>runnable</span> <span class=operator>=</span> () -> {</span><br><span class=line>            <span class=keyword>try</span> {</span><br><span class=line>                <span class=keyword>final</span> <span class=type>long</span> <span class=variable>indexValue</span> <span class=operator>=</span> index.incrementAndGet();</span><br><span class=line>                Thread.sleep(<span class=number>1000L</span>);</span><br><span class=line>                </span><br><span class=line>                <span class=comment>// INFO: </span></span><br><span class=line>                <span class=comment>// threadName:</span></span><br><span class=line>                <span class=comment>// value: xx</span></span><br><span class=line>                <span class=comment>// Dec 29, 2022 2:39:09 AM org.example.VirtualThreadExample lambda$main$0</span></span><br><span class=line>                log.info(<span class=string>"\nthreadName: "</span> + Thread.currentThread().getName() + <span class=string>"\nvalue: "</span> + indexValue);</span><br><span class=line>                </span><br><span class=line>                countDownLatch.countDown();</span><br><span class=line>            } <span class=keyword>catch</span> (<span class=keyword>final</span> InterruptedException e) {</span><br><span class=line>                countDownLatch.countDown();</span><br><span class=line>            }</span><br><span class=line>        };</span><br><span class=line></span><br><span class=line>        <span class=comment>// 일반적으로 쓰레드 풀의 갯수를 지정하는 것과는 달리 쓰레드의 갯수를 지정할 필요가 없다.</span></span><br><span class=line>        <span class=keyword>try</span> (<span class=keyword>final</span> <span class=type>ExecutorService</span> <span class=variable>executorService</span> <span class=operator>=</span> Executors.newVirtualThreadPerTaskExecutor()) {</span><br><span class=line>            <span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>0</span>; i < count; i++) {</span><br><span class=line>                executorService.submit(runnable);</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line></span><br><span class=line>        countDownLatch.await();</span><br><span class=line>        <span class=keyword>final</span> <span class=type>long</span> <span class=variable>finish</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>        <span class=keyword>final</span> <span class=type>long</span> <span class=variable>timeElapsed</span> <span class=operator>=</span> finish - start;</span><br><span class=line>        </span><br><span class=line>        <span class=comment>// Dec 29, 2022 2:39:09 AM org.example.VirtualThreadExample main</span></span><br><span class=line>        <span class=comment>// INFO:</span></span><br><span class=line>        <span class=comment>// threadName: main</span></span><br><span class=line>        <span class=comment>// Run time: 1022</span></span><br><span class=line>        log.info(<span class=string>"\nthreadName: "</span> + Thread.currentThread().getName() + <span class=string>"\nRun time: "</span> + timeElapsed);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><img title="Virtual Threads는 이름을 표시하지 않는다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-not-show-name.png><p>Virtual Thread로 실행하는 블럭 내에 브레이크 포인트를 걸고 디버그 모드로 실행해서 확인해보면 Carrier Thread가 뭔지 볼 수 있다.</p><img title="Virtual Thread의 상태도 확인해볼 수 있다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-states.png><p>Virtual Threads는 Platform Threads와 달리 더 많은 상태들을 가지고 있다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre><td class=code><pre><span class=line> <span class=comment>/*</span></span><br><span class=line><span class=comment> * Virtual thread state and transitions:</span></span><br><span class=line><span class=comment> *</span></span><br><span class=line><span class=comment> *      NEW -> STARTED         // Thread.start</span></span><br><span class=line><span class=comment> *  STARTED -> TERMINATED      // failed to start</span></span><br><span class=line><span class=comment> *  STARTED -> RUNNING         // first run</span></span><br><span class=line><span class=comment> *</span></span><br><span class=line><span class=comment> *  RUNNING -> PARKING         // Thread attempts to park</span></span><br><span class=line><span class=comment> *  PARKING -> PARKED          // cont.yield successful, thread is parked</span></span><br><span class=line><span class=comment> *  PARKING -> PINNED          // cont.yield failed, thread is pinned</span></span><br><span class=line><span class=comment> *</span></span><br><span class=line><span class=comment> *   PARKED -> RUNNABLE        // unpark or interrupted</span></span><br><span class=line><span class=comment> *   PINNED -> RUNNABLE        // unpark or interrupted</span></span><br><span class=line><span class=comment> *</span></span><br><span class=line><span class=comment> * RUNNABLE -> RUNNING         // continue execution</span></span><br><span class=line><span class=comment> *</span></span><br><span class=line><span class=comment> *  RUNNING -> YIELDING        // Thread.yield</span></span><br><span class=line><span class=comment> * YIELDING -> RUNNABLE        // yield successful</span></span><br><span class=line><span class=comment> * YIELDING -> RUNNING         // yield failed</span></span><br><span class=line><span class=comment> *</span></span><br><span class=line><span class=comment> *  RUNNING -> TERMINATED      // done</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>NEW</span>      <span class=operator>=</span> <span class=number>0</span>;</span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>STARTED</span>  <span class=operator>=</span> <span class=number>1</span>;</span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>RUNNABLE</span> <span class=operator>=</span> <span class=number>2</span>;     <span class=comment>// runnable-unmounted</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>RUNNING</span>  <span class=operator>=</span> <span class=number>3</span>;     <span class=comment>// runnable-mounted</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>PARKING</span>  <span class=operator>=</span> <span class=number>4</span>;</span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>PARKED</span>   <span class=operator>=</span> <span class=number>5</span>;     <span class=comment>// unmounted</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>PINNED</span>   <span class=operator>=</span> <span class=number>6</span>;     <span class=comment>// mounted</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>YIELDING</span> <span class=operator>=</span> <span class=number>7</span>;     <span class=comment>// Thread.yield</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>TERMINATED</span> <span class=operator>=</span> <span class=number>99</span>;  <span class=comment>// final state</span></span><br><span class=line></span><br><span class=line><span class=comment>// can be suspended from scheduling when unmounted</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>SUSPENDED</span> <span class=operator>=</span> <span class=number>1</span> << <span class=number>8</span>;</span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>RUNNABLE_SUSPENDED</span> <span class=operator>=</span> (RUNNABLE | SUSPENDED);</span><br><span class=line><span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>PARKED_SUSPENDED</span>   <span class=operator>=</span> (PARKED | SUSPENDED);</span><br></pre></table></figure><img title="cpu 코어 갯수인 10개의 ForkJoinPool Worker 쓰레드가 생성되었다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-profiling.png><p>무조건 cpu 코어 갯수만큼 생기는 건 아니고, Virtual Threads 갯수가 적다면 더 적은 Carrier Threads(ForkJoinPool Worker 쓰레드)가 생성된다.<p>그리고 실행 결과를 보면 100번의 Thread.sleep(1초)가 발생했고, 실제로 OS Thread와 매칭되는 Carrier Thread는 10개 밖에 사용하지 않았는데 1초 만에 모든 연산이 종료된 걸 볼 수 있다.<br>동일하게 10개의 Platform Threads를 사용하면 10초가 걸린다. (<code>Executors.newFixedThreadPool(10)</code>)<h3 id=기존-코드와의-호환성><a title="기존 코드와의 호환성" class=headerlink href=#기존-코드와의-호환성></a>기존 코드와의 호환성</h3><p>Virtual Thread를 사용하면 100%는 아니지만 기존 코드의 변경없이 Virtual Thread를 사용할 수 있다고 한다.<br>어떻게 그게 가능한지 살펴보자.<h4 id=Thread-클래스의-호환성><a title="Thread 클래스의 호환성" class=headerlink href=#Thread-클래스의-호환성></a>Thread 클래스의 호환성</h4><p><a rel="external nofollow noopener noreferrer" href=https://github.com/openjdk/loom/blob/fibers/src/java.base/share/classes/java/lang/VirtualThread.java target=_blank>VirtualThread</a>의 부모 타입인 <a rel="external nofollow noopener noreferrer" href=https://github.com/openjdk/loom/blob/fibers/src/java.base/share/classes/java/lang/BaseVirtualThread.java target=_blank>BaseVirtualThread</a>가 <a rel="external nofollow noopener noreferrer" href=https://docs.oracle.com/en/java/javase/19/docs/api/java.base/java/lang/Thread.html target=_blank>Thread 클래스</a>를 상속받았기 때문에 기존 Thread 구현의 변경 없이 Virtual Threads를 사용할 수 있다.<p>실제로 Thread.sleep(long millis) 메서드를 보면 아래와 같이 구현돼있다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">sleep</span><span class=params>(<span class=type>long</span> millis)</span> <span class=keyword>throws</span> InterruptedException {</span><br><span class=line>    <span class=keyword>if</span> (millis < <span class=number>0</span>) {</span><br><span class=line>        <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">IllegalArgumentException</span>(<span class=string>"timeout value is negative"</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (currentThread() <span class=keyword>instanceof</span> VirtualThread vthread) {</span><br><span class=line>        <span class=type>long</span> <span class=variable>nanos</span> <span class=operator>=</span> MILLISECONDS.toNanos(millis);</span><br><span class=line>        vthread.sleepNanos(nanos);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (ThreadSleepEvent.isTurnedOn()) {</span><br><span class=line>        <span class=type>ThreadSleepEvent</span> <span class=variable>event</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">ThreadSleepEvent</span>();</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            event.time = MILLISECONDS.toNanos(millis);</span><br><span class=line>            event.begin();</span><br><span class=line>            sleep0(millis);</span><br><span class=line>        } <span class=keyword>finally</span> {</span><br><span class=line>            event.commit();</span><br><span class=line>        }</span><br><span class=line>    } <span class=keyword>else</span> {</span><br><span class=line>        sleep0(millis);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>내부에서 VirtualThread인지 아닌지 판단하고 있다.<br>그리고 VirtualThread라면 <a rel="external nofollow noopener noreferrer" href=https://github.com/openjdk/loom/blob/fibers/src/java.base/share/classes/java/lang/VirtualThread.java#L728-L785 target=_blank>sleepNanos(long nanos) 메서드</a>를 호출하고 있다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br></pre><td class=code><pre><span class=line><span class=keyword>final</span> <span class=keyword>class</span> <span class="title class_">VirtualThread</span> <span class=keyword>extends</span> <span class="title class_">BaseVirtualThread</span> {</span><br><span class=line>    <span class=comment>// ...</span></span><br><span class=line>    </span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Sleep the current virtual thread for the given sleep time.</span></span><br><span class=line><span class=comment>     *</span></span><br><span class=line><span class=comment>     * <span class=doctag>@param</span> nanos the maximum number of nanoseconds to sleep</span></span><br><span class=line><span class=comment>     * <span class=doctag>@throws</span> InterruptedException if interrupted while sleeping</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">sleepNanos</span><span class=params>(<span class=type>long</span> nanos)</span> <span class=keyword>throws</span> InterruptedException {</span><br><span class=line>        <span class=keyword>assert</span> Thread.currentThread() == <span class=built_in>this</span>;</span><br><span class=line>        <span class=keyword>if</span> (nanos >= <span class=number>0</span>) {</span><br><span class=line>            <span class=keyword>if</span> (ThreadSleepEvent.isTurnedOn()) {</span><br><span class=line>                <span class=type>ThreadSleepEvent</span> <span class=variable>event</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">ThreadSleepEvent</span>();</span><br><span class=line>                <span class=keyword>try</span> {</span><br><span class=line>                    event.time = nanos;</span><br><span class=line>                    event.begin();</span><br><span class=line>                    doSleepNanos(nanos);</span><br><span class=line>                } <span class=keyword>finally</span> {</span><br><span class=line>                    event.commit();</span><br><span class=line>                }</span><br><span class=line>            } <span class=keyword>else</span> {</span><br><span class=line>                doSleepNanos(nanos);</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Sleep the current thread for the given sleep time (in nanoseconds). If</span></span><br><span class=line><span class=comment>     * nanos is 0 then the thread will attempt to yield.</span></span><br><span class=line><span class=comment>     *</span></span><br><span class=line><span class=comment>     * <span class=doctag>@implNote</span> This implementation parks the thread for the given sleeping time</span></span><br><span class=line><span class=comment>     * and will therefore be observed in PARKED state during the sleep. Parking</span></span><br><span class=line><span class=comment>     * will consume the parking permit so this method makes available the parking</span></span><br><span class=line><span class=comment>     * permit after the sleep. This may be observed as a spurious, but benign,</span></span><br><span class=line><span class=comment>     * wakeup when the thread subsequently attempts to park.</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">doSleepNanos</span><span class=params>(<span class=type>long</span> nanos)</span> <span class=keyword>throws</span> InterruptedException {</span><br><span class=line>        <span class=keyword>assert</span> nanos >= <span class=number>0</span>;</span><br><span class=line>        <span class=keyword>if</span> (getAndClearInterrupt())</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">InterruptedException</span>();</span><br><span class=line>        <span class=keyword>if</span> (nanos == <span class=number>0</span>) {</span><br><span class=line>            tryYield();</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            <span class=comment>// park for the sleep time</span></span><br><span class=line>            <span class=keyword>try</span> {</span><br><span class=line>                <span class=type>long</span> <span class=variable>remainingNanos</span> <span class=operator>=</span> nanos;</span><br><span class=line>                <span class=type>long</span> <span class=variable>startNanos</span> <span class=operator>=</span> System.nanoTime();</span><br><span class=line>                <span class=keyword>while</span> (remainingNanos > <span class=number>0</span>) {</span><br><span class=line>                    parkNanos(remainingNanos);</span><br><span class=line>                    <span class=keyword>if</span> (getAndClearInterrupt()) {</span><br><span class=line>                        <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">InterruptedException</span>();</span><br><span class=line>                    }</span><br><span class=line>                    remainingNanos = nanos - (System.nanoTime() - startNanos);</span><br><span class=line>                }</span><br><span class=line>            } <span class=keyword>finally</span> {</span><br><span class=line>                <span class=comment>// may have been unparked while sleeping</span></span><br><span class=line>                setParkPermit(<span class=literal>true</span>);</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Parks up to the given waiting time or until unparked or interrupted.</span></span><br><span class=line><span class=comment>     * If already unparked then the parking permit is consumed and this method</span></span><br><span class=line><span class=comment>     * completes immediately (meaning it doesn't yield). It also completes immediately</span></span><br><span class=line><span class=comment>     * if the interrupt status is set or the waiting time is {<span class=doctag>@code</span> <= 0}.</span></span><br><span class=line><span class=comment>     *</span></span><br><span class=line><span class=comment>     * <span class=doctag>@param</span> nanos the maximum number of nanoseconds to wait.</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">parkNanos</span><span class=params>(<span class=type>long</span> nanos)</span> {</span><br><span class=line>        <span class=keyword>assert</span> Thread.currentThread() == <span class=built_in>this</span>;</span><br><span class=line></span><br><span class=line>        <span class=comment>// complete immediately if parking permit available or interrupted</span></span><br><span class=line>        <span class=keyword>if</span> (getAndSetParkPermit(<span class=literal>false</span>) || interrupted)</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line></span><br><span class=line>        <span class=comment>// park the thread for the waiting time</span></span><br><span class=line>        <span class=keyword>if</span> (nanos > <span class=number>0</span>) {</span><br><span class=line>            <span class=type>long</span> <span class=variable>startTime</span> <span class=operator>=</span> System.nanoTime();</span><br><span class=line></span><br><span class=line>            <span class=type>boolean</span> yielded;</span><br><span class=line>            Future&LT?> unparker = scheduleUnpark(<span class=built_in>this</span>::unpark, nanos);</span><br><span class=line>            setState(PARKING);</span><br><span class=line>            <span class=keyword>try</span> {</span><br><span class=line>                yielded = yieldContinuation();</span><br><span class=line>            } <span class=keyword>finally</span> {</span><br><span class=line>                <span class=keyword>assert</span> (Thread.currentThread() == <span class=built_in>this</span>)</span><br><span class=line>                    && (state() == RUNNING || state() == PARKING);</span><br><span class=line>                cancel(unparker);</span><br><span class=line>            }</span><br><span class=line></span><br><span class=line>            <span class=comment>// park on carrier thread for remaining time when pinned</span></span><br><span class=line>            <span class=keyword>if</span> (!yielded) {</span><br><span class=line>                <span class=type>long</span> <span class=variable>deadline</span> <span class=operator>=</span> startTime + nanos;</span><br><span class=line>                <span class=keyword>if</span> (deadline < <span class=number>0L</span>)</span><br><span class=line>                    deadline = Long.MAX_VALUE;</span><br><span class=line>                parkOnCarrierThread(<span class=literal>true</span>, deadline - System.nanoTime());</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Unmounts this virtual thread, invokes Continuation.yield, and re-mounts the</span></span><br><span class=line><span class=comment>     * thread when continued. When enabled, JVMTI must be notified from this method.</span></span><br><span class=line><span class=comment>     * <span class=doctag>@return</span> true if the yield was successful</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@ChangesCurrentThread</span></span><br><span class=line>    <span class=keyword>private</span> <span class=type>boolean</span> <span class="title function_">yieldContinuation</span><span class=params>()</span> {</span><br><span class=line>        <span class=comment>// unmount</span></span><br><span class=line>        <span class=keyword>if</span> (notifyJvmtiEvents) notifyJvmtiUnmountBegin(<span class=literal>false</span>);</span><br><span class=line>        unmount();</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            <span class=keyword>return</span> Continuation.<span class=keyword>yield</span>(VTHREAD_SCOPE);</span><br><span class=line>        } <span class=keyword>finally</span> {</span><br><span class=line>            <span class=comment>// re-mount</span></span><br><span class=line>            mount();</span><br><span class=line>            <span class=keyword>if</span> (notifyJvmtiEvents) notifyJvmtiMountEnd(<span class=literal>false</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>    </span><br><span class=line>    <span class=comment>// ...</span></span><br><span class=line>}</span><br></pre></table></figure><p>sleepNanos -> doSleepNanos -> parkNanos -> yieldContinuation 메서드를 순차적으로 호출하게 되는데<br>yieldContinuation 메서드 안에서 unmount 메서드를 호출해서 virtual thread를 block 시키고, 지정한 시간이 지나면 다시 mount 메서드를 호출해서 block 된 virtual thread를 깨워서 해당 지점부터 다시 task를 진행하도록 한다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * Unmounts this virtual thread from the carrier. On return, the</span></span><br><span class=line><span class=comment> * current thread is the current platform thread.</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@ChangesCurrentThread</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">unmount</span><span class=params>()</span> {</span><br><span class=line>    <span class=comment>// set Thread.currentThread() to return the platform thread</span></span><br><span class=line>    <span class=type>Thread</span> <span class=variable>carrier</span> <span class=operator>=</span> <span class=built_in>this</span>.carrierThread;</span><br><span class=line>    carrier.setCurrentThread(carrier);</span><br><span class=line></span><br><span class=line>    <span class=comment>// break connection to carrier thread, synchronized with interrupt</span></span><br><span class=line>    <span class=keyword>synchronized</span> (interruptLock) {</span><br><span class=line>        setCarrierThread(<span class=literal>null</span>);</span><br><span class=line>    }</span><br><span class=line>    carrier.clearInterrupt();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * Mounts this virtual thread onto the current platform thread. On</span></span><br><span class=line><span class=comment> * return, the current thread is the virtual thread.</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@ChangesCurrentThread</span></span><br><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">mount</span><span class=params>()</span> {</span><br><span class=line>    <span class=comment>// sets the carrier thread</span></span><br><span class=line>    <span class=type>Thread</span> <span class=variable>carrier</span> <span class=operator>=</span> Thread.currentCarrierThread();</span><br><span class=line>    setCarrierThread(carrier);</span><br><span class=line></span><br><span class=line>    <span class=comment>// sync up carrier thread interrupt status if needed</span></span><br><span class=line>    <span class=keyword>if</span> (interrupted) {</span><br><span class=line>        carrier.setInterrupt();</span><br><span class=line>    } <span class=keyword>else</span> <span class=keyword>if</span> (carrier.isInterrupted()) {</span><br><span class=line>        <span class=keyword>synchronized</span> (interruptLock) {</span><br><span class=line>            <span class=comment>// need to recheck interrupt status</span></span><br><span class=line>            <span class=keyword>if</span> (!interrupted) {</span><br><span class=line>                carrier.clearInterrupt();</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// set Thread.currentThread() to return this virtual thread</span></span><br><span class=line>    carrier.setCurrentThread(<span class=built_in>this</span>);</span><br><span class=line>}</span><br></pre></table></figure><img title="Virtual Thread의 Carrier Thread와 Carrier Thread의 currentThread" src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-mount-unmount.png><p>unmount 메서드에서는 Virtual Thread의 Carrier Thread(ForkJoinPool Worker 쓰레드)의 currentThread(VirtualThread)를 Carrier Thread 그 자체로 할당해버림으로써 VirtualThread는 할당된 Carrier Thread가 없기 때문에 남은 연산을 수행하지 못하게 만들어버리고(blocking),<br>mount 메서드에서는 Virtual Thread의 Carrier Thread(ForkJoinPool Worker 쓰레드)의 currentThread(ForkJoinPool Worker 쓰레드)를 다시 자기 자신인 Virtual Thread 그 자체로 할당해버림으로써 VirtualThread의 남은 연산을 다시 Carrier Thread에서 수행하게 끔 만든다.<p>이렇게 되면 실제로 OS Thread와 매칭되는 Carrier Thread 그 자체가 블로킹 된 건 아니기 때문에 OS 레벨에서는 컨텍스트 스위칭이 발생하지 않고, JVM 레벨에서만 Carrier Thread에 다른 Virtual Thread를 할당하는 컨텍스트 스위칭만 발생하게 된다.<h4 id=Socket-API와의-호환성><a title="Socket API와의 호환성" class=headerlink href=#Socket-API와의-호환성></a>Socket API와의 호환성</h4><p>기존 코드와의 호환성을 위해 <a rel="external nofollow noopener noreferrer" href=https://openjdk.org/jeps/353 target=_blank>JEP 353 (Reimplement the legacy Socket API)</a>, <a rel="external nofollow noopener noreferrer" href=https://openjdk.org/jeps/373 target=_blank>JEP 373 (Reimplement the legacy DatagramSocket API)</a>에서 Socket API들을 재구현함으로써 코드의 변경없이 Virtual Thread를 사용할 수 있도록 하였다.<p>JDK 11로 실행시킨 Apache HTTP Client 4.5의 stacktrace<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>at java.base/java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class=line>at java.base/java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class=number>115</span>)</span><br><span class=line>at java.base/java.net.SocketInputStream.read(SocketInputStream.java:<span class=number>168</span>)</span><br><span class=line>at java.base/java.net.SocketInputStream.read(SocketInputStream.java:<span class=number>140</span>)</span><br><span class=line>at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class=number>137</span>)</span><br><span class=line>at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class=number>153</span>)</span><br><span class=line>at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class=number>280</span>)</span><br><span class=line>at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class=number>138</span>)</span><br><span class=line>at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class=number>56</span>)</span><br><span class=line>at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class=number>259</span>)</span><br><span class=line>at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class=number>163</span>)</span><br><span class=line>at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class=number>157</span>)</span><br><span class=line>at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class=number>273</span>)</span><br><span class=line>at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class=number>125</span>)</span><br><span class=line>at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class=number>272</span>)</span><br><span class=line>at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class=number>186</span>)</span><br><span class=line>at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class=number>89</span>)</span><br><span class=line>at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class=number>110</span>)</span><br><span class=line>at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class=number>185</span>)</span><br><span class=line>at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class=number>83</span>)</span><br><span class=line>at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class=number>108</span>)</span><br></pre></table></figure><p>JDK 19로 실행시킨 Apache HTTP Client 4.5의 stacktrace<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>at java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:<span class=number>313</span>)</span><br><span class=line>at java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:<span class=number>340</span>)</span><br><span class=line>at java.base/sun.nio.ch.NioSocketImpl$<span class=number>1.</span>read(NioSocketImpl.java:<span class=number>789</span>)</span><br><span class=line>at java.base/java.net.Socket$SocketInputStream.read(Socket.java:<span class=number>1025</span>)</span><br><span class=line>at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class=number>137</span>)</span><br><span class=line>at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class=number>153</span>)</span><br><span class=line>at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class=number>280</span>)</span><br><span class=line>at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class=number>138</span>)</span><br><span class=line>at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class=number>56</span>)</span><br><span class=line>at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class=number>259</span>)</span><br><span class=line>at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class=number>163</span>)</span><br><span class=line>at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class=number>157</span>)</span><br><span class=line>at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class=number>273</span>)</span><br><span class=line>at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class=number>125</span>)</span><br><span class=line>at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class=number>272</span>)</span><br><span class=line>at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class=number>186</span>)</span><br><span class=line>at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class=number>89</span>)</span><br><span class=line>at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class=number>110</span>)</span><br><span class=line>at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class=number>185</span>)</span><br><span class=line>at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class=number>83</span>)</span><br><span class=line>at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class=number>108</span>)</span><br></pre></table></figure><p>둘의 가장 큰 차이는 JDK 19에서는 NioSocket을 사용한다는 것이다.<br>기본적으로 SocketImpl의 구현체로 NioSocketImpl을 사용하는 건 JDK 13부터 변경된 사항이지만, JDK 19부터 Virtual Threads의 지원을 위해 내부에서 VirtualThread의 park 메서드를 호출하고 있다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>final</span> <span class=keyword>class</span> <span class="title class_">NioSocketImpl</span> <span class=keyword>extends</span> <span class="title class_">SocketImpl</span> <span class=keyword>implements</span> <span class="title class_">PlatformSocketImpl</span> {</span><br><span class=line>    <span class=comment>// ...</span></span><br><span class=line>    </span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Reads bytes from the socket into the given byte array.</span></span><br><span class=line><span class=comment>     * <span class=doctag>@return</span> the number of bytes read or -1 at EOF</span></span><br><span class=line><span class=comment>     * <span class=doctag>@throws</span> SocketException if the socket is closed or a socket I/O error occurs</span></span><br><span class=line><span class=comment>     * <span class=doctag>@throws</span> SocketTimeoutException if the read timeout elapses</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=type>int</span> <span class="title function_">implRead</span><span class=params>(<span class=type>byte</span>[] b, <span class=type>int</span> off, <span class=type>int</span> len)</span> <span class=keyword>throws</span> IOException {</span><br><span class=line>        <span class=type>int</span> <span class=variable>n</span> <span class=operator>=</span> <span class=number>0</span>;</span><br><span class=line>        <span class=type>FileDescriptor</span> <span class=variable>fd</span> <span class=operator>=</span> beginRead();</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            <span class=keyword>if</span> (connectionReset)</span><br><span class=line>                <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">SocketException</span>(<span class=string>"Connection reset"</span>);</span><br><span class=line>            <span class=keyword>if</span> (isInputClosed)</span><br><span class=line>                <span class=keyword>return</span> -<span class=number>1</span>;</span><br><span class=line>            <span class=type>int</span> <span class=variable>timeout</span> <span class=operator>=</span> <span class=built_in>this</span>.timeout;</span><br><span class=line>            configureNonBlockingIfNeeded(fd, timeout > <span class=number>0</span>);</span><br><span class=line>            <span class=keyword>if</span> (timeout > <span class=number>0</span>) {</span><br><span class=line>                <span class=comment>// read with timeout</span></span><br><span class=line>                n = timedRead(fd, b, off, len, MILLISECONDS.toNanos(timeout));</span><br><span class=line>            } <span class=keyword>else</span> {</span><br><span class=line>                <span class=comment>// read, no timeout</span></span><br><span class=line>                n = tryRead(fd, b, off, len);</span><br><span class=line>                <span class=keyword>while</span> (IOStatus.okayToRetry(n) && isOpen()) {</span><br><span class=line>                    park(fd, Net.POLLIN);</span><br><span class=line>                    n = tryRead(fd, b, off, len);</span><br><span class=line>                }</span><br><span class=line>            }</span><br><span class=line>            <span class=keyword>return</span> n;</span><br><span class=line>        } <span class=keyword>catch</span> (InterruptedIOException e) {</span><br><span class=line>            <span class=keyword>throw</span> e;</span><br><span class=line>        } <span class=keyword>catch</span> (ConnectionResetException e) {</span><br><span class=line>            connectionReset = <span class=literal>true</span>;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">SocketException</span>(<span class=string>"Connection reset"</span>);</span><br><span class=line>        } <span class=keyword>catch</span> (IOException ioe) {</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">SocketException</span>(ioe.getMessage());</span><br><span class=line>        } <span class=keyword>finally</span> {</span><br><span class=line>            endRead(n > <span class=number>0</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Disables the current thread for scheduling purposes until the</span></span><br><span class=line><span class=comment>     * socket is ready for I/O or is asynchronously closed, for up to the</span></span><br><span class=line><span class=comment>     * specified waiting time.</span></span><br><span class=line><span class=comment>     * <span class=doctag>@throws</span> IOException if an I/O error occurs</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">park</span><span class=params>(FileDescriptor fd, <span class=type>int</span> event, <span class=type>long</span> nanos)</span> <span class=keyword>throws</span> IOException {</span><br><span class=line>        <span class=type>Thread</span> <span class=variable>t</span> <span class=operator>=</span> Thread.currentThread();</span><br><span class=line>        <span class=keyword>if</span> (t.isVirtual()) {</span><br><span class=line>            Poller.poll(fdVal(fd), event, nanos, <span class=built_in>this</span>::isOpen);</span><br><span class=line>            <span class=keyword>if</span> (t.isInterrupted()) {</span><br><span class=line>                <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">InterruptedIOException</span>();</span><br><span class=line>            }</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            <span class=type>long</span> millis;</span><br><span class=line>            <span class=keyword>if</span> (nanos == <span class=number>0</span>) {</span><br><span class=line>                millis = -<span class=number>1</span>;</span><br><span class=line>            } <span class=keyword>else</span> {</span><br><span class=line>                millis = NANOSECONDS.toMillis(nanos);</span><br><span class=line>            }</span><br><span class=line>            Net.poll(fd, event, millis);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>    </span><br><span class=line>    <span class=comment>// ...</span></span><br><span class=line>}</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>abstract</span> <span class=keyword>class</span> <span class="title class_">Poller</span> {</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Parks the current thread until a file descriptor is ready for the given op.</span></span><br><span class=line><span class=comment>     * <span class=doctag>@param</span> fdVal the file descriptor</span></span><br><span class=line><span class=comment>     * <span class=doctag>@param</span> event POLLIN or POLLOUT</span></span><br><span class=line><span class=comment>     * <span class=doctag>@param</span> nanos the waiting time or 0 to wait indefinitely</span></span><br><span class=line><span class=comment>     * <span class=doctag>@param</span> supplier supplies a boolean to indicate if the enclosing object is open</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">poll</span><span class=params>(<span class=type>int</span> fdVal, <span class=type>int</span> event, <span class=type>long</span> nanos, BooleanSupplier supplier)</span></span><br><span class=line>        <span class=keyword>throws</span> IOException</span><br><span class=line>    {</span><br><span class=line>        <span class=keyword>assert</span> nanos >= <span class=number>0L</span>;</span><br><span class=line>        <span class=keyword>if</span> (event == Net.POLLIN) {</span><br><span class=line>            readPoller(fdVal).poll(fdVal, nanos, supplier);</span><br><span class=line>        } <span class=keyword>else</span> <span class=keyword>if</span> (event == Net.POLLOUT) {</span><br><span class=line>            writePoller(fdVal).poll(fdVal, nanos, supplier);</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            <span class=keyword>assert</span> <span class=literal>false</span>;</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Parks the current thread until a file descriptor is ready.</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">poll</span><span class=params>(<span class=type>int</span> fdVal, <span class=type>long</span> nanos, BooleanSupplier supplier)</span> <span class=keyword>throws</span> IOException {</span><br><span class=line>        <span class=keyword>if</span> (USE_DIRECT_REGISTER) {</span><br><span class=line>            poll1(fdVal, nanos, supplier);</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            poll2(fdVal, nanos, supplier);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Parks the current thread until a file descriptor is ready. This implementation</span></span><br><span class=line><span class=comment>     * registers the file descriptor, then parks until the file descriptor is polled.</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">poll1</span><span class=params>(<span class=type>int</span> fdVal, <span class=type>long</span> nanos, BooleanSupplier supplier)</span> <span class=keyword>throws</span> IOException {</span><br><span class=line>        register(fdVal);</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            <span class=type>boolean</span> <span class=variable>isOpen</span> <span class=operator>=</span> supplier.getAsBoolean();</span><br><span class=line>            <span class=keyword>if</span> (isOpen) {</span><br><span class=line>                <span class=keyword>if</span> (nanos > <span class=number>0</span>) {</span><br><span class=line>                    LockSupport.parkNanos(nanos);</span><br><span class=line>                } <span class=keyword>else</span> {</span><br><span class=line>                    LockSupport.park();</span><br><span class=line>                }</span><br><span class=line>            }</span><br><span class=line>        } <span class=keyword>finally</span> {</span><br><span class=line>            deregister(fdVal);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * Parks the current thread until a file descriptor is ready. This implementation</span></span><br><span class=line><span class=comment>     * queues the file descriptor to the update thread, then parks until the file</span></span><br><span class=line><span class=comment>     * descriptor is polled.</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">poll2</span><span class=params>(<span class=type>int</span> fdVal, <span class=type>long</span> nanos, BooleanSupplier supplier)</span> {</span><br><span class=line>        <span class=type>Request</span> <span class=variable>request</span> <span class=operator>=</span> registerAsync(fdVal);</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            <span class=type>boolean</span> <span class=variable>isOpen</span> <span class=operator>=</span> supplier.getAsBoolean();</span><br><span class=line>            <span class=keyword>if</span> (isOpen) {</span><br><span class=line>                <span class=keyword>if</span> (nanos > <span class=number>0</span>) {</span><br><span class=line>                    LockSupport.parkNanos(nanos);</span><br><span class=line>                } <span class=keyword>else</span> {</span><br><span class=line>                    LockSupport.park();</span><br><span class=line>                }</span><br><span class=line>            }</span><br><span class=line>        } <span class=keyword>finally</span> {</span><br><span class=line>            request.awaitFinish();</span><br><span class=line>            deregister(fdVal);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">LockSupport</span> {</span><br><span class=line>    <span class=comment>// ...</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">park</span><span class=params>()</span> {</span><br><span class=line>        <span class=keyword>if</span> (Thread.currentThread().isVirtual()) {</span><br><span class=line>            VirtualThreads.park();</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            U.park(<span class=literal>false</span>, <span class=number>0L</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// ...</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">parkNanos</span><span class=params>(<span class=type>long</span> nanos)</span> {</span><br><span class=line>        <span class=keyword>if</span> (nanos > <span class=number>0</span>) {</span><br><span class=line>            <span class=keyword>if</span> (Thread.currentThread().isVirtual()) {</span><br><span class=line>                VirtualThreads.park(nanos);</span><br><span class=line>            } <span class=keyword>else</span> {</span><br><span class=line>                U.park(<span class=literal>false</span>, nanos);</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>코드의 변경이 없기 때문에 마치 Thread(Carrier Threads/Platform Threads)가 블로킹 될 것처럼 보이지만, 내부를 들여다보면 Virtual Threads만 unmounting 되는 걸 볼 수 있다.<br>따라서 Carrier Threads에서는 블로킹 없이 다른 연산들을 처리할 수 있게 된다.<h4 id=Spring과의-호환성><a title="Spring과의 호환성" class=headerlink href=#Spring과의-호환성></a>Spring과의 호환성</h4><p><a rel="external nofollow noopener noreferrer" href=https://spring.io/blog/2022/10/11/embracing-virtual-threads target=_blank>스프링 블로그 포스트</a>에서 가장 최신 버전을 기준으로 설명하기 때문에 Spring Boot 3.0.1(Spring 6.0.3)을 기준으로 설명한다.<br><a rel="external nofollow noopener noreferrer" href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html target=_blank>Spring Boot Starter Web</a>을 사용하게 되면 Embedded Tomcat을 사용하게 되므로 아래와 같이 Virtual Threads를 사용하도록 설정해주면 된다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=keyword>public</span> TomcatProtocolHandlerCustomizer&LT?> protocolHandlerVirtualThreadExecutorCustomizer() {</span><br><span class=line>    <span class=keyword>return</span> protocolHandler -> protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class=line>}</span><br></pre></table></figure><p>쓰레드 풀의 갯수를 신경 쓸 필요 없는 것도 엄청난 장점같다.<p>그리고 혹시나 MDC도 정상적으로 동작하는지 궁금했다.<br>Webflux에서는 <a rel="external nofollow noopener noreferrer" href=https://projectreactor.io/docs/core/release/reference/#context target=_blank>Context</a>라는 것에 넣어야해서 매우 번거로웠던 기억이 있는데 한 번 MDC에 값을 넣는 인터셉터를 설정해보자.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>class</span> <span class="title class_">MdcInterceptor</span> <span class=keyword>implements</span> <span class="title class_">HandlerInterceptor</span> {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=type>boolean</span> <span class="title function_">preHandle</span><span class=params>(<span class=keyword>final</span> HttpServletRequest request, <span class=keyword>final</span> HttpServletResponse response, <span class=keyword>final</span> Object handler)</span> <span class=keyword>throws</span> Exception {</span><br><span class=line>        MDC.put(<span class=string>"a"</span>, <span class=string>"a"</span>);</span><br><span class=line></span><br><span class=line>        <span class=keyword>return</span> HandlerInterceptor.<span class=built_in>super</span>.preHandle(request, response, handler);</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">WebMvcConfiguration</span> <span class=keyword>implements</span> <span class="title class_">WebMvcConfigurer</span> {</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> MdcInterceptor mdcInterceptor;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class="title function_">WebMvcConfiguration</span><span class=params>(<span class=keyword>final</span> MdcInterceptor mdcInterceptor)</span> {</span><br><span class=line>        <span class=built_in>this</span>.mdcInterceptor = mdcInterceptor;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">addInterceptors</span><span class=params>(<span class=keyword>final</span> InterceptorRegistry registry)</span> {</span><br><span class=line>        registry.addInterceptor(mdcInterceptor);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><img title="Interceptor에 진입했을 때부터 Virtual Thread를 사용하는 걸 볼 수 있다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-interceptor.png><p>우리가 위에서 <code>protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor())</code>로 세팅을 해놨기 때문에 요청을 받아들이는 부분부터 Virtual Threads를 사용하기 때문에 당연히 Interceptor에서도 Virtual Threads를 사용하게 된다.</p><img title="Controller에서도 Interceptor와 동일한 Virtual Thread를 사용하는 걸 볼 수 있다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-logging.png><p>동일한 Virtual Thread이기 때문에 ThreadLocal 값인 MDC의 값이 그대로 유지되는 걸 볼 수 있다.<figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>2022-12-29T05:35:27.085+09:00  INFO 12707 --- [               ] c.e.p.controller.MdcController           : MDC.a: a</span><br></pre></table></figure><p>참고로 Virtual Thread이기 때문에 쓰레드의 이름은 찍히지 않는다.<p>그리고 아래와 같이 @Async 어노테이션에서 사용할 쓰레드 풀에도 Virtual Thread를 사용할 수 있다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@EnableAsync</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">AsyncConfig</span> {</span><br><span class=line>    <span class=meta>@Bean(TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME)</span></span><br><span class=line>    <span class=keyword>public</span> Executor <span class="title function_">asyncTaskExecutor</span><span class=params>()</span> {</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> <span class="title class_">TaskExecutorAdapter</span>(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>@Async 어노테이션을 사용했을 때는 MDC가 어떻게 동작하는지 한 번 살펴보자.</p><img title="Interceptor에 진입했을 때부터 Virtual Thread를 사용하는 걸 볼 수 있다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-interceptor.png><img title="Async Thread에서는 Interceptor에서 사용한 Virtual Thread와 다른 Virtual Thread를 사용하는 걸 볼 수 있다." src=/2022/12/29/look-over-java-virtual-threads/virtual-threads-async-thread.png><p>Virtual Thread가 달라졌기 때문에 ThreadLocal 값인 MDC의 값은 유지되지 않는 걸 볼 수 있다.<figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>2022-12-29T05:55:02.257+09:00  INFO 14591 --- [               ] c.e.p.controller.VirtualThreadService    : MDC.a: null</span><br></pre></table></figure><p>이는 Platform Threads를 사용했을 때도 마찬가지이므로 <a rel="external nofollow noopener noreferrer" href=https://blog.gangnamunni.com/post/mdc-context-task-decorator/ target=_blank>MDCTaskDecorator</a> 같은 걸 만들면 쉽게 해결할 수 있다.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">MdcTaskDecorator</span> <span class=keyword>implements</span> <span class="title class_">TaskDecorator</span> {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> Runnable <span class="title function_">decorate</span><span class=params>(<span class=keyword>final</span> Runnable runnable)</span> {</span><br><span class=line>        <span class=keyword>final</span> Map&LTString, String> mdcContext = MDC.getCopyOfContextMap();</span><br><span class=line>        <span class=keyword>return</span> () -> {</span><br><span class=line>            <span class=keyword>if</span>(mdcContext != <span class=literal>null</span>){</span><br><span class=line>                MDC.setContextMap(mdcContext);</span><br><span class=line>            }</span><br><span class=line>            runnable.run();</span><br><span class=line></span><br><span class=line>            MDC.clear();</span><br><span class=line>        };</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean(TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME)</span></span><br><span class=line><span class=keyword>public</span> Executor <span class="title function_">asyncTaskExecutor</span><span class=params>()</span> {</span><br><span class=line>    <span class=keyword>final</span> <span class=type>TaskExecutorAdapter</span> <span class=variable>taskExecutorAdapter</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">TaskExecutorAdapter</span>(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class=line>    taskExecutorAdapter.setTaskDecorator(<span class=keyword>new</span> <span class="title class_">MdcTaskDecorator</span>());</span><br><span class=line>    <span class=keyword>return</span> taskExecutorAdapter;</span><br><span class=line>}</span><br></pre></table></figure><h4 id=코틀린과의-호환성><a title="코틀린과의 호환성" class=headerlink href=#코틀린과의-호환성></a>코틀린과의 호환성</h4><p>코틀린 최신 버전인 1.8.0에서 JDK 19를 지원하긴 하지만, JDK 19에서도 Preview Features인 Virtual Threads를 코틀린으로 한 번 더 컴파일까지 거쳐야하면 의도대로 동작한다는 보장이 없어서 아직은 시기상조인 것 같다.<h3 id=주의사항><a class=headerlink href=#주의사항 title=주의사항></a>주의사항</h3><p>아무리 Virtual Threads가 기존 코드와의 호환성을 최대한 지켰다고는 하지만 100% 호환성을 가진 건 아니다.<br>코드가 돌아가는 측면에서는 호환성을 지켰을지 몰라도 아래 주의사항 같은 걸 지키지 않으면 시스템에 심각한 성능저하를 유발할 수도 있다.<p><a rel="external nofollow noopener noreferrer" href=https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads target=_blank>Coming to Java 19: Virtual threads and platform threads</a>의 마지막 부분인 Three pieces of practical advice 파트를 눈여겨보면 된다.<ul><li><p>Virtual Threads를 풀링하지 말고 Semaphore를 사용해라.<br>Virtual Threads는 생성 비용도 굉장히 싸기 때문에 굳이 풀링할 필요가 없고, 기존 방식대로 풀링하게 되면 Virtual Threads가 아닌 Platform Threads를 아마 사용하게 되는 것 같다.<br>따라서 만약 풀링해야하는 일이 있다면 Semaphore 방식을 권장하고 있다.</p><li><p>synchronized 키워드를 사용해서 Carrier Thread까지 Blocking 되는 현상(이걸 보고 Thread가 Pinning 됐다고 말하는 듯)을 피해라</p> <blockquote><p>Fortunately, future work may make synchronization nonpinning.</blockquote></ul><p>다만 추후에는 synchronized 키워드를 사용해도 쓰레드가 pinning 되는 현상은 사라질 듯 하다.<ul><li>쓰레드 로컬을 조심해서 사용해라<br>Virtual Thread는 굉장히 많은 갯수일 수 있다보니 어디선가 오염이 될 수 있다는 뜻인가? 이건 왜 얘기한 건지 모르겠음.</ul><h2 id=마치며><a class=headerlink href=#마치며 title=마치며></a>마치며</h2><p>기존의 비동기 모델이 거의 끝판왕이라고 생각하고 성능을 얻으려면 코드의 퀄리티는 포기해야할 줄 알았는데 이렇게 내가 생각한 한계를 깨부시는 아키텍처가 나오는 걸 보면 정말 흥미롭다.<br>얼른 Virtual Threads를 실무에서 사용할 날이 왔으면 좋겠는데 <a rel="external nofollow noopener noreferrer" href=https://openjdk.org/jeps/428 target=_blank>JEP 428: Structured Concurrency</a>, <a rel="external nofollow noopener noreferrer" href=https://openjdk.org/jeps/429 target=_blank>JEP 429: Scoped Values</a>까지 완료시키려면 한참 멀었나… 싶다.<br>다음 LTS인 JDK 21(2023/09월에 릴리즈)에 포함되면 참 좋을 것만 같다.<h2 id=참고-링크><a title="참고 링크" class=headerlink href=#참고-링크></a>참고 링크</h2><p>해당 포스트는 아래 링크들을 참고하여 짜집기한 글이므로 보다 자세한 정보들은 아래 링크를 참고하는 걸 추천한다.<ul><li><a rel="external nofollow noopener noreferrer" href=https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads target=_blank>Coming to Java 19: Virtual threads and platform threads</a><li><a rel="external nofollow noopener noreferrer" href=https://www.infoq.com/articles/java-virtual-threads/ target=_blank>Virtual Threads: New Foundations for High-Scale Java Applications</a><li><a rel="external nofollow noopener noreferrer" href=https://theboreddev.com/understanding-java-virtual-threads/ target=_blank>Understanding Java Virtual Threads – The Death of Async Programming</a><li><a rel="external nofollow noopener noreferrer" href=https://www.infoworld.com/article/3678148/intro-to-virtual-threads-a-new-approach-to-java-concurrency.html target=_blank>Intro to virtual threads: A new approach to Java concurrency</a><li><a rel="external nofollow noopener noreferrer" href=https://www.baeldung.com/java-virtual-thread-vs-thread target=_blank>Difference Between Thread and Virtual Thread in Java</a><li><a rel="external nofollow noopener noreferrer" href=https://spring.io/blog/2022/10/11/embracing-virtual-threads target=_blank>Embracing Virtual Threads</a><li><a rel="external nofollow noopener noreferrer" href=https://homoefficio.github.io/2020/12/11/Java-Concurrency-Evolution/ target=_blank>Java Concurrency Evolution</a><li><a rel="external nofollow noopener noreferrer" href=http://gunsdevlog.blogspot.com/2020/09/java-project-loom-reactive-streams.html target=_blank>Java의 동시성 개선을 위한 Project Loom은 reactive streams를 대체할 것인가?</a><li><a rel="external nofollow noopener noreferrer" href=https://jakewharton.com/report-card-java-19-and-the-end-of-kotlin/#virtual-threads target=_blank>Report card: Java 19 and the end of Kotlin</a><li><a rel="external nofollow noopener noreferrer" href=https://blog.gangnamunni.com/post/mdc-context-task-decorator/ target=_blank>Spring 의 동기, 비동기, 배치 처리시 항상 context 를 유지하고 로깅하기</a></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag># Java</a><a href=/tags/Spring/ rel=tag># Spring</a><a href=/tags/Spring-Boot/ rel=tag># Spring Boot</a><a href=/tags/Virtual-Threads/ rel=tag># Virtual Threads</a><a href=/tags/Loom/ rel=tag># Loom</a></div><div class=post-nav><div class=post-nav-item><a title="히카리 CP에서 다양한 시간 설정해보기" href=/2022/09/25/hikari-cp-time-config/ rel=prev> <i class="fa fa-angle-left"></i> 히카리 CP에서 다양한 시간 설정해보기 </a></div><div class=post-nav-item><a title="자바의 Virtual Thread가 나와도 코틀린의 코루틴은 여전히 살아남을까?" href=/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/ rel=next> 자바의 Virtual Thread가 나와도 코틀린의 코루틴은 여전히 살아남을까? <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div><div class=comments id=disqus_thread><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© 2016 – <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-user"></i> </span><span class=author itemprop=copyrightHolder>양권성</span></div><div class=powered-by>Powered by <a rel="external nofollow noopener noreferrer" href=https://hexo.io/ target=_blank>Hexo</a> & <a rel="external nofollow noopener noreferrer" href=https://theme-next.js.org/pisces/ target=_blank>NexT.Pisces</a></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label="Back to top" class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js></script><script crossorigin integrity=sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8= src=https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script><script crossorigin integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js></script><script src=/js/third-party/search/local-search.js></script><script class=next-config data-name=mermaid type=application/json>{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src=/js/third-party/tags/mermaid.js></script><script src=/js/third-party/fancybox.js></script><script class=next-config data-name=disqus type=application/json>{"enable":true,"shortname":"exobud","count":true,"i18n":{"disqus":"disqus"}}</script><script src=/js/third-party/comments/disqus.js></script>