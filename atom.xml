<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>오늘도 끄적끄적</title>
  
  <subtitle>느리더라도 꾸준하게</subtitle>
  <link href="https://perfectacle.github.io/atom.xml" rel="self"/>
  
  <link href="https://perfectacle.github.io/"/>
  <updated>2025-12-09T17:06:50.367Z</updated>
  <id>https://perfectacle.github.io/</id>
  
  <author>
    <name>양권성</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>해외여행 1편 - 케냐</title>
    <link href="https://perfectacle.github.io/2025/12/02/travel-001-kenya-01/"/>
    <id>https://perfectacle.github.io/2025/12/02/travel-001-kenya-01/</id>
    <published>2025-12-02T21:56:25.000Z</published>
    <updated>2025-12-09T17:06:50.367Z</updated>
    
    <content type="html"><![CDATA[<img src="/2025/12/02/travel-001-kenya-01/end-kenya.jpeg" class="">  <p>케냐의 강렬한 햇빛 때문에 팔토시를 한 부분과 안 한 부분의 경계가 명확하게 나뉘었다.</p><hr><p>회사에서는 3년 근속을 하면 1달 휴가를 주는 리프레시 제도가 있다.<br>원래 입사했을 당시에는 유럽에 대한 로망이 있고, 살면서 한번 쯤은 가보고 싶단 생각에 막연하게 ‘3년 채우면 1달 유럽 여행 가야지~’라는 생각이 있었다.<br>하지만 <a href="/2021/12/31/las-vegas-aws-reinvent-01/">라스베가스</a>를 한 번 다녀오고 나서 생각이 많이 바뀌었다.<br>고작 4박 5일만 다녀왔을 뿐인데도 ‘이렇게 내가 한 곳에 오래 있을 수 있을까?? 너무 지루한데??’ 라는 생각이 들었고, ‘만약 한달동안 갔는데 재미없으면 어떡하지??’ 라는 생각이 머릿속을 뒤덮었다.<br>그러다보니 3년을 채우고도 어떻게 해야할 줄을 몰라서 계속 미루기만 했었다.</p><h2 id="케냐로-떠나기까지"><a href="#케냐로-떠나기까지" class="headerlink" title="케냐로 떠나기까지"></a>케냐로 떠나기까지</h2><iframe width="560" height="315" src="https://www.youtube.com/embed/G3sbCAv0gBE?si=mu860hnbor6Hwmko&amp;start=512" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>  우연히 침착맨 유튜브 채널에서 다이나믹 듀오의 최자가 탄자니아에 있는 세렝게티로 신혼여행을 다녀왔다는 걸 보았다.  내가 미국을 지루해했던 이유는 똑같은 호텔 풍경들, 광활하지만 비슷한 풍경의 연속인 그랜드 캐니언이었다.  하지만 야생동물은 달랐다, 역동적이고 계속 새로운 자극을 주기 때문에 내 눈이 심심할 틈이 없을 것 같다고 생각했다.  <iframe width="560" height="315" src="https://www.youtube.com/embed/LZ46yyDDADQ?si=cbdRn0EAp-DDONWd&amp;start=912" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>  그리고 관련 다큐멘터리를 보다보니 열기구를 타고도 사파리 투어를 할 수 있다는 것이었다.  하늘 위에서 본 세렝게티의 모습은 어떨까? 초식동물을 사냥하는 치타의 모습을 볼 수도 있지는 않을까?? 하는 설렘이 가득했다.<img src="/2025/12/02/travel-001-kenya-01/serengeti-masai-mara-map.png" class=""><p>야생동물들의 서식지는 탄자니아의 세렝게티 국립공원, 케냐의 마사이 마라 국립공원에 걸쳐있다.<br>아마 국경이 이렇게 된 이유는 과거 열강 식민지들이 자로 줄재듯 영토를 그어서 독립을 시켜줬기 때문으로 얼핏 알고 있다. 다만 동물들은 국경이 없기 때문에 국경을 넘나드는 것으로 알고 있다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/T1DXbP1vWPI" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>날짜 별로 동물들의 이동 경로가 다르고, 10월에는 마라 강을 건너가는 누떼의 대이동을 볼 수 있어서 이 때가 극성수기로 알고 있다.<br>나도 다큐멘터리에서 누떼 대이동을 본 적이 있는데 이 때 악어가 누를 사냥하기도 하며 굉장히 흥미로운 장면들이 연출되는 것으로 알고 있다.</p><p>그래서 원래는 10월에 누떼 대이동 시기에 맞춰서 탄자니아로 가려고 했는데 이놈의 귀챠니즘 때문에 계속 미루었다.<br>이렇게 뇌 빼고 쉬다가 휴가가 다 갈 것 같아서 부랴부랴 11월이 다 되어 예약을 하려고 하다보니 탄자니아는 e-visa가 있어야 입국이 가능한 것을 알게되어 <a href="https://visa.immigration.go.tz/">탄자니아 eVisa 신청 사이트</a>에 들어갔더니 접속이 안 되는 것이었다. (지금 구글에 검색해보니 <a href="https://www.mofa.go.kr/tz-ko/brd/m_27501/view.do?seq=1347268">탄자니아 eVisa 허위사이트가 많다고 하니</a> 꼭 공식 사이트가 맞는지 주소를 확인하세요.)<br>찾아보니 탄자니아에서 정치 이슈로 인해 시위가 발생하여 인터넷까지 다운이 됐던 것이다.<br>이로인해 <a href="https://www.mofa.go.kr/www/brd/m_4080/view.do?seq=376590">우리나라에서는 탄자니아를 특별여행주의보로 발령</a>하는 등 뭔가 여행하기 심상치 않은 기운이 느껴졌다.  </p><p>그래서 뭔가 탄자니아로 여행하기는 힘들 거 같고, 대안으로 케냐의 마사이마라 국립공원으로 떠나기로 계획했다.<br>탄자니아로 가기 위해 황열병 예방 접종, 말라리아 예방약까지 산 게 뭔가 아쉬웠지만 그래도 동물을 봐야겠다는 집념으로 케냐로 떠나기로 마음 먹었다.<br>케냐는 비자 대신에 전자여행허가(ETA) 제도를 운영 중이라서 <a href="https://etakenya.go.ke/">케냐 ETA 신청 사이트</a>에 신청을 해야만 한다.  </p><p>그리고 정~~말 귀찮고 어려운 사파리 투어 예약을 해야했다. 너무 귀찮아서 현장가서 발품을 팔까(미래의 나에게 맡겨두지~)하는 생각도 있었는데 영어도 안 통하는데 괜히 호갱당할 거 같은 생각에 인터넷으로 예약하기로 마음 먹었다.<br>이 과정들이 MBTI P인 나에게는 너무 고통이어서 패키지 여행 같은 것도 생각했지만, 또 자유롭게 내가 원하는 곳에서 원하는 만큼 즐기고 싶다는 생각이 있어서 귀찮지만 직접 예약을 하기로 했다.<br><a href="https://blog.naver.com/ramrami__/223780994365">블로그</a>도 보고, 아래와 같은 유튜브 영상도 보았는데 왓츠앱으로 따로 연락해서 발품 파는 것도 굉장히 까다롭고 귀찮아보였다.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/372UvvmJlXs?si=Wzp8in_mLaj61lF9&amp;start=309" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>  <p>나한테는 싸게 가는 게 중요한 게 아니라 일단 야생동물을 보는 게 제일 중요했기 때문에 좀 비싸더라도 적당하고 신뢰있는 업체라면 그냥 이메일로만 계약을 끝내기로 마음 먹었다.<br><a href="http://safaribookings.com/">Safari Bookings</a>에서 찾아보니 확실히 마사이 마라보다는 세렝게티가 많았고, 마사이 마라에 열기구까지 포함된 투어는 없었다.<br>그래도 야생동물 보는 게 제일 중요했기 때문에 4박 5일 투어로 몇군데 연락을 돌려봤는데 <a href="https://www.safaribookings.com/p1891">한 곳</a>만 연락이 왔고, 연락을 하면서 관광 라이센스 같은 걸 요구하니 라이센스를 공유할 수 없다고 하여 여기는 제꼈다.<br><code>Kindly note that we cannot share our licence because they are personal.</code> 라고 답장이 왔는데 아마 가이드가 개인이라서 별도 라이센스가 없다는 뜻으로 나는 이해했다.  </p><p>그리고 또 찾다보니 <a href="https://bigtimesafaris.co.ke/">Big Time Safaris</a>와 <a href="https://kalevoyage.com/">Kale Voyage</a>에서도 예약을 많이 한다길래 해당 사이트에도 문의를 넣어보았다.<br>Big Time Safaris가 답변이 빨랐고, Kale Voyage는 메일을 보낸 다음날 답장이 왔다.<br>그래서 답장이 온 Big Time Safaris와 연락을 하다보니 열기구(Hot Air Balloon)도 별도 요금($450)을 내면 탈 수 있다고 하여 나의 니즈와 맞아 바로 계약을 하였다.<br>4박 5일(5일차 점심에 숙소&#x2F;공항으로 복귀) 사파리 요금은 $890였고, 열기구까지 합쳐서 총합 $1,340이 들었다. (근데 카드 수수료 3.5%가 별도로 붙어서 더 내긴 했다.)<br>계약금(Deposit)은 15%를 먼저 업체에서 보내준 Pesapal 링크를 통해 결제를 하고 나머지 잔금은 케냐에 가서 사파리 투어 사무실에서 결제하는 방식이었다.<br>너무 많은 계약금을 요구하는 곳이 있다고 하면 사기일 가능성이 있으니 유의를 해야한다고 했는데 15%는 합리적인 거 같고 저 업체를 통해서 많이들 예약한다고 블로그에서 봤기 때문에 믿고 결제했다.<br>확실히 세렝게티는 같은 기간이면 $1,000이 넘었는데 마사이 마라는 그거에 비하면 싸다고 느껴졌다.  </p><img src="/2025/12/02/travel-001-kenya-01/safari-confirm-docs.png" class=""><p>정상적인 업체라면 위와 같이 계약서?견적서?를 pdf나 구글 docs 형태로 준다.</p><h2 id="케냐로-떠나기"><a href="#케냐로-떠나기" class="headerlink" title="케냐로 떠나기"></a>케냐로 떠나기</h2><img src="/2025/12/02/travel-001-kenya-01/kenya-boarding-pass.jpeg" class=""><p>케냐까지는 직항으로 가는 게 없기 때문에 인천공항에서 아랍에미리트(UAE)의 아부다비까지 10시간 35분, 아부다비 공항에서 2시간 35분 대기, 케냐의 나이로비까지 5시간 20분을 날아서 총 18시간 30분의 긴 여정을 떠나야했다. </p><img src="/2025/12/02/travel-001-kenya-01/meal-in-flight-1.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/meal-in-flight-2.jpeg" class="">  <p>아부다비로 가는 첫 비행에서 기내식은 총 2번이 나왔는데 두개가 비슷한 메뉴여서 벌써부터 음식이 질리기 시작했다.  </p><img src="/2025/12/02/travel-001-kenya-01/camel-in-abu-dhabi.jpeg" class="">  <p>공항을 구경하다보니 큰 낙타 모형(250KG)을 파는 게 신기해서 봤는데 79,000.00 AED (12&#x2F;2 기준 ₩31,575,692원) 으로 가격이 상당히 나갔고, 뭐 이런 걸 파나… 싶었는데 기름국이라 부자들이 많아서 그런가 싶었다. (그리고 이집트에서는 낙타 탄다는 소리를 들었지만 아랍에미리트도 사막이 많나? 낙타를 타나? 란 생각이 들었다.)</p><img src="/2025/12/02/travel-001-kenya-01/books-in-abu-dhabi.jpeg" class="">  <p>그리고 또 신기했던 게 공항에서 책도 판다는 것이었다. 면세상품인지 아닌지 모르겠는데 인천공항에서는 책 파는 걸 본 적이 없다보니 저런 소설 같은 것도 파는 게 뭔가 신기했다.  </p><img src="/2025/12/02/travel-001-kenya-01/meal-in-flight-3.jpeg" class="">  <p>기나긴 기다림 끝에 케냐 행 비행기를 탔고, 이번에도 기내식이 나왔다.<br>저 하얀 요거트? 같은 거는 아부다비 갈 때부터 계속 나오고 빵도 계속 나와서 이전에 먹었던 음식을 세끼 연속 먹는 느낌이 들어 너무 질렸다. (아마 같은 에티하드 항공사라 그런 것 같다.)  </p><h2 id="1일차-마사이족-마을-방문-마사이-마라-국립공원"><a href="#1일차-마사이족-마을-방문-마사이-마라-국립공원" class="headerlink" title="1일차 (마사이족 마을 방문 + 마사이 마라 국립공원)"></a>1일차 (마사이족 마을 방문 + 마사이 마라 국립공원)</h2><img src="/2025/12/02/travel-001-kenya-01/nairobi-airport.jpeg" class="">  <p>기나긴 여정 끝에 케냐 나이로비에 있는 조모 케냐타 공항으로 올 수 있었다.</p><img src="/2025/12/02/travel-001-kenya-01/pick-up-from-nairobi-airport.jpeg" class="">  <p>공항에 내려서는 왓츠앱을 통해 사파리 업체와 연락해서 픽업을 했다.<br>차는 우리나라 오래된 중고차 수출단지에서나 볼법한 자동차였는데 나름 블루투스 연결이 되는지 케냐 노래도 틀어주었다.<br>하지만 말이 잘 통하지는 않아서 제대로 가는 건지 불안했지만, 믿을 수 밖에 없었다.<br>그리고 달러로 환전해오려고 했는데 깜빡하고 인천공항에서 다 체크인 한 이후에야 생각이 나서 달러로 환전을 하지 못하고, 현지에서 케냐 실링화(KES)로 9,000 KES를 출금했다.<br>원래는 사파리 가이드 팁 + 비상금을 생각하고 뽑은 건데 사파리 투어에서 다 써버려서 나중에 7,000 KES를 더 출금해서 현금으로 총 16,000 KES를 출금했다. (그리고 100 KES가 남았다.)  </p><img src="/2025/12/02/travel-001-kenya-01/big-time-safari-office.jpeg" class=""><p>픽업해서 사파리 오피스가 있는 건물에 내려주었는데 엘리베이터가 동작을 안 해서 건물 7층까지 올라갔다 내려왔다.<br>근데 복도도 뭔가 어두컴컴하고 음침한 느낌이 들었다.<br>그리고 잔금 결제를 하는데 뭔가 내가 생각했던 것 보다 더 내는 것 같았는데 번역기 쓰면서 따지기도 번거롭고 금액이 크지도 않아서 그냥 넘어갔다.<br>원래대로라면 잔금은 $1,139(총 $1,340에서 계약금 $201을 뺀 금액)이고, 카드 수수료 3.5%까지 더하면 $1,179(잔금 $1,139에 수수료 $40) 정도 되는데 실제로는 $1,185를 결제했다.  </p><img src="/2025/12/02/travel-001-kenya-01/safari-vehicle.jpeg" class="">  <p>이게 우리의 4박 5일을 책임질 4X4 land cruiser 차량이었다.<br>나는 혼자 왔지만, 우리 그룹에는 에스토니아 두커플을 포함해 총 5명이 차를 타고 같이 여행을 했다.<br>그래도 Martin이 나를 많이 챙겨주었는데(혼자 밥먹고 싶어도 계속 같이 먹을 거면 자기네 테이블로 오라고 해서 마지못해 가기도 했다.), 영어가 안 되는 게 역시나 서러운 순간이었다.<br>라스베가스에서도 영어가 안 돼서 꼭 영어 공부를 하겠다고 다짐을 했는데 4년이 지난 지금도 여전히 영어를 못 하는 걸 보고 이제는 진짜진짜 영어 공부를 해야겠다고 생각이 들었다.</p><img src="/2025/12/02/travel-001-kenya-01/nairobi-side-road-01.jpeg" class="" title="nairobi-side-road-01.jpeg">  <p>나이로비에서 마사이 마라 국립공원으로 가는 길은 참 신기했다.<br>전통시장 같은 게 그냥 찻길 바로 옆에 있었고 이게 그들만의 지역 생태계를 이루고 있는 듯한 느낌으로 보였다.  </p><img src="/2025/12/02/travel-001-kenya-01/nairobi-side-road-02.jpeg" class="" title="nairobi-side-road-02.jpeg">  <p>그리고 별도로 인도가 없기 때문에 옆에 있는 흙길을 따라서 걷는 게 일상처럼 보였다.<br>현지인이 아니고 혼자서 저렇게 걸어다니면 뭔가 표적이 될 거 같아 무서웠다.  </p><img src="/2025/12/02/travel-001-kenya-01/monkey-on-the-road.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/sheep-on-the-road.jpeg" class="">  <p>그리고 차도 옆으로 원숭이 같은 야생동물이 혼자 돌아다니거나 양치기 소년이 소나 양 같은 걸 데리고 다니는 걸 보고 새삼 아프리카에 온 것을 실감하게 되었다.  </p><img src="/2025/12/02/travel-001-kenya-01/tent-001.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/tent-002.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/tent-003.jpeg" class="">  <p>4시간을 이동한 후에 2박 3일을 머무를 숙소에 도착했는데 <a href="https://mitimingiecocamp.com/">Miti Mingi Eco Camp</a> 라는 텐트형 숙소였다.<br>전기와 따뜻한 물은 저녁에만 나온다고 하고, 그래서 낮에는 텐트 앞에 천막을 걷지 않으면 내부는 너무나 어두웠다.<br>모기장도 칠 수 있고, 벌레 기피제를 바른 덕분인지 모기는 1방 밖에 물리지 않았고 날이 춥지 않아서 그래도 자는데는 무리가 없었다.<br>그리고 나는 혼자 왔다보니 할 게 없어서 숙소 밖을 산책할 수 있는지 물어봤는데 숙소 밖으로 나가면 구걸하는 사람들 때문에 위험할 거라고 나가지 말라고 했다.  </p><img src="/2025/12/02/travel-001-kenya-01/tent-lunch-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/tent-lunch-02.jpeg" class="">  <p>대충 짐정리를 하고 나와서 점심을 먹었는데 썩 마음에 들지는 않았지만, 뭐 그럭저럭 먹을만했다.<br>거의 매 끼니 과일과 콩 음식은 있었던 것 같았다. ‘콩을 매 끼니 먹다보니 그들이 건강을 유지하는 비결이 아닐까?’ 하는 생각이 들어서 우리가 배워야할 식습관 같다고 생각했다.<br>그리고 그나마 익숙한 요리가 파스타라서 먹는데 뭔가 이상한 냄새가 나서 억지로 먹었고, 고기도 잡내가 심하지는 않았지만 한국에서 먹던 그런 향이 아니었다.  </p><p>그리고 첫 일정은 마사이 마을에 방문하는 것이었다.  </p><img src="/2025/12/02/travel-001-kenya-01/usd-to-kes-currency.png" class="" title="원래대로라면 1300KES 정도를 내야하지만 1500KES를 내고 입장했다.">  <p>계약서에도 마사이 마을 방문 비용은 포함돼있지 않았기 때문에 추가 비용을 지불해야했는데 달러로는 $10이지만, 케냐 실링화로는 1500 KES를 내야했다.<br>아마 케냐 실링화는 환율이 불안정하고, 현지인들도 달러를 선호하는 상황 때문에 공식 환율보다도 좀 더 비싸게 받는 것 같다. (영어가 됐다면 정확한 이유를 물어보겠지만 다른 일행도 있어서 그러지 못하고 나중에 챗GPT한테 물어봤다.)  </p><img src="/2025/12/02/travel-001-kenya-01/masai-village-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-village-02.jpeg" class=""><p>마사이 족 마을까지는 걸어서 이동했고, 우리가 도착하자 마사이 족 마을 청년들이 삼삼오오 모이기 시작했다.  </p><img src="/2025/12/02/travel-001-kenya-01/masai-village-03.jpeg" class=""><p>춤인지 의식인지 노래를 부르며 점프도 뛰고 우리 앞에서 보여주다가 우리에게도 참여하라고 했다.<br>그리고 내 휴대폰으로 동영상도 찍어주었는데 그들과 동화된다는 느낌을 느끼고 싶어서 최대한 열심히 노력해봤다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/S6_3_7lbVnk" frameborder="0" loading="lazy" allowfullscreen></iframe></div><br /><img src="/2025/12/02/travel-001-kenya-01/masai-village-04.jpeg" class="">그리고 한명씩 현지인이 붙어서 자기 집을 소개해주었다.  그리고 마지막에는 '자기 아내와 아이를 위해 본인이 만든 기념품을 사달라'고 동정심을 호소했는데 생각보다 가격이 비쌌다. (목걸이나 팔찌 같은 거였던 걸로 기억한다.)  그래서 문법에 맞는지도 모르겠지만 돈이 많이 없다는 뉘앙스로 'I have much money.'라고 하자 그는 얼마를 가지고 있냐고 물어보고 왠지 그대로 답변했다가는 그 가격대로 깎아줄 것 같았다.  하지만 이건 내가 가진 유일한 현금이라 가이드 팁도 있고 또 어디서 현금이 필요할지 몰라서 계속 'Sorry.'만 연발할 수 밖에 없었다.  <p>그렇게 집구경이 끝나자 그 다음코스는 기념샵 방문이었다.<br>좌판에다가 기념품을 쫙 깔고 구경하는 거였는데 이번에는 마을의 여성 뿐만 아니라 어린 아이들까지 와서 동정심을 호소했다.<br>뭔가 짠한 마음에 사주고 싶다가도 ‘이사람들 이러고 벤츠 타고 퇴근하는 거 아니야? 마사이 족 코스프레 아니야?’ 같은 의심도 들었다가 ‘이게 지속 가능한 상황일까?’란 생각이 들어 착잡했다.<br>나는 진짜 현지인들의 생활 그대로를 느끼고 싶었는데 관광코스가 돼버린 형태를 직접 눈으로 마주하다보니 뭔가 안타깝고 여기서 기념품을 사주는 게 장기적인 방향에서 그들에게 도움이 된다는 생각이 들지 않았다.<br>그리고 자석이라던지, 아니면 동물 모양 장식품이라던지 내 기준에서는 쓸모가 크게 없는 물건이라서 사주고 싶다는 생각도 크게 들지 않았다.<br>이번에도 ‘Sorry’와 그냥 구경만 하겠다 라는 뉘앙스로 문법에 맞는지도 모를 영어인 ‘I’m just looking.’이라고 얘기하고 하나도 사지 않았다.<br>일행에게 물어보니 본인들은 하나씩 다 샀다고 하는 걸 보면 이 전략이 잘 먹히는 거 같지만 뭔가 현지인 감성이 점점 사라지는 것 같아서 아쉬움이 많이 남았다.  </p><img src="/2025/12/02/travel-001-kenya-01/masai-school-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-school-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-school-03.jpeg" class="">  <p>그 다음에는 마사이 족 마을 어린이들이 다니는 학교에 갔다.<br>근데 방학을 했는지 아이들은 없다고 했다. 나는 이 사람들이 연기하는 거라면 관광객들을 만족시켜주기 위해 학교에 와서 연기를 할 것이라고 생각했는데 학생들이 없는 걸 보고 ‘아 진짜로 방학이나 뭐 그런 거라 쉬는 건가 보구나. 진짜 학교인가보다’ 라고 생각했다.<br>그 전까지는 ‘이 사람들이 그냥 돈벌려고 쑈하는 사람인가…’ 하는 의심이 살짝 들었었다.<br>열악한 학교시설에서 공부하는 아이들을 봤더라면 더 실감이 났을텐데 아무도 없이 그냥 시설 구경만 하다보니 크게 감흥은 없었다.  </p><p>학교 투어까지 마치고 이제 본격적으로 동물 구경을 하러 마사이 마라 국립공원을 향했다.  </p><img src="/2025/12/02/travel-001-kenya-01/masai-mara-shop-01.jpeg" class="" title="masai-mara-shop-01.jpeg">  <p>근데 가이드가 잠시만 기다리라고 하더니 갑자기 차에서 내리자 기념품을 파는 여성 무리들이 왔다.<br>가이드와 한통속인 것 같아 보였고, 나한테는 별로 쓸모도 없는 물건이기도 하고 나에게는 현금이 소중해서 아무것도 구매하지 않았다.<br>그래도 끈질기게 말을 걸어서 안들리는 척, 다른 곳을 응시하자 드디어 포기를 하고 떠났다.  </p><img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-03.jpeg" class="">  <p>이제 마사이 마라 국립공원에 들어와서 2시간 정도 본격적인 사파리 투어를 시작했다.<br>사파리에서는 이렇게 차량을 차고 구경하는 걸 ‘게임 드라이브’라고 부른다.<br>인간의 개입 없이 자연에서 살아가는 야생동물을 보니 신기하고 오기를 잘했다는 생각이 들었다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/u3x2OdsyHMw" frameborder="0" loading="lazy" allowfullscreen></iframe></div><div class="video-container"><iframe src="https://www.youtube.com/embed/PlUr0tf4vqA" frameborder="0" loading="lazy" allowfullscreen></iframe></div><div class="video-container"><iframe src="https://www.youtube.com/embed/xbsCrapKuWM" frameborder="0" loading="lazy" allowfullscreen></iframe></div><div class="video-container"><iframe src="https://www.youtube.com/embed/V_TfxOT3lQY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><div class="video-container"><iframe src="https://www.youtube.com/embed/o6KnHuJfgTk" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>11월에는 마라 강을 건너 탄자니아의 세렝게티 국립 공원으로 많은 동물들이 떠난 이후에서인지 뭔가 공원이 휑~해 보여서 좀 아쉽기는 했지만 그래도 다양한 동물들을 만날 수 있었다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/WlYjIesRu9g" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>다큐멘터리에서도 봤지만 파리가 이렇게 많이 붙어있는데 아무렇지도 않은 게 참 신기했다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/ITUhUuTp9jg" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>사자가 스트레칭하는 모습인데 왠만한 사람보다 훨씬 유연해보인다.</p><img src="/2025/12/02/travel-001-kenya-01/tent-dinner-01.jpeg" class="">  <p>첫날 저녁인데 케냐의 쌀은 우리나라와 달리 길쭉길쭉 했고, 뭔가 동남아에서 나올 법한 쌀 품종인 거 같았다.<br>그리고 수박과 파인애플이 나왔는데 수박을 싫어해서 파인애플만 담아왔다.  </p><img src="/2025/12/02/travel-001-kenya-01/tent-night.jpeg" class="">  <p>그리고 불멍을 때릴 수 있는 장소가 있었는데 외국인이 차지하고 있었고, 영어도 안 돼서 그냥 텐트로 가서 잠을 청했다.  </p><h2 id="2일차-열기구-마사이-마라-국립공원"><a href="#2일차-열기구-마사이-마라-국립공원" class="headerlink" title="2일차 (열기구 + 마사이 마라 국립공원)"></a>2일차 (열기구 + 마사이 마라 국립공원)</h2><p>다음날 새벽 4시에 일어나서 열기구를 타러 떠났다.<br>일행 중에 나 혼자 열기구를 타는 거라서 숙소 로비 쪽으로 가서 기다리다가 그 시간에 오는 사람한테 ‘Are you balloon guy?’ 뭐 대충 이렇게 물어봐서 해당 가이드의 차량을 타고 이동했다.<br>영어가 안 통하다보니 진짜 그 시간에 열기구 가이드가 오는 건 맞는지, 또 추가요금 내라고 하는 건 아닌지 불안불안 했는데 어찌저찌 가이드를 만나서 혼자서 가이드의 차를 타고 이동했다.  </p><img src="/2025/12/02/travel-001-kenya-01/fig-tree-camp-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/fig-tree-camp-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/fig-tree-camp-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/fig-tree-camp-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/fig-tree-camp-05.jpeg" class="">  <p><a href="https://madahotels.com/fig-tree-camp-masai-mara/">Mara Fig Tree Camp</a>라는 숙소에 내려주면서 기다리면 열기구를 타러 출발한다고 했다.<br>숙소를 보자마자 ‘와… 진짜 자연과 하나 되는 숙소 같고 여기서 묵었으면 좋겠다…’ 하는 생각이 들며 우리 숙소와 비교를 하였다.<br>프론트로 가서 열기구 타러 왔다고 말하자 티켓이 없냐고 물어봤다. 나는 그런 거 받은 거 없다고 하자 그 자리에서 티켓을 끊어줬는데 열기구에 탈 때 결국 검사는 하지 않았다.<br>커피도 마시고 30분 정도 기다리자 뭔가 출발한다는 얘기를 하고 사람들이 이동하길래 눈치껏 나도 이동했다.<br>이동하면서도 이 사람이 열기구 타러 움직이는 사람들인지 아니면 다른 사파리 투어하는 사람들인지 불안했지만 그냥 눈치껏 이동했다.  </p><img src="/2025/12/02/travel-001-kenya-01/hot-air-balloon-01.jpeg" class="">  <p>차를 타고 이동해서 열기구를 타는 곳에 내리니 그 곳에서는 이미 열기구를 띄울 준비를 하는 중이었다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/D79rrc5zkz8" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>열기구를 위로 띄우기 위해 누워있는 열기구를 세워야하는데 이 때 불을 붙이는데 화력이 엄청나다보니 뭔가 웅장했다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/o2bgysi1hR4" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>열기구에서 본 야생동물인데 공중에서 동물이 움직이는 걸 보니 한눈에 보여서 시원시원했다.</p><img src="/2025/12/02/travel-001-kenya-01/hot-air-balloon-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hot-air-balloon-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hot-air-balloon-04.jpeg" class="">  <p>열기구에서 내려다 본 모습은 차로 이동하면서 보던 모습과는 다르고 공원을 한 눈에 내려다 보는 뷰가 펼쳐지니 돈값($450)을 하는 것 같았다.</p><img src="/2025/12/02/travel-001-kenya-01/hot-air-balloon-05.jpeg" class="">  <p>열기구 운전기사는 열기구도 조종하고, 사진도 찍어서 고객들에게 판매도 했다. ($55에 기념품 1개와 함께 판매했는데 구글 드라이브로 사진과 동영상을 전송해준다.) </p><img src="/2025/12/02/travel-001-kenya-01/hot-air-balloon-06.jpeg" class="">  <p>태양이 워낙 강렬하다보니 공중에 떠있는 열기구의 그림자가 선명하게 보이는 것도 신기했다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/9e35LPy0kR8" frameborder="0" loading="lazy" allowfullscreen></iframe></div><div class="video-container"><iframe src="https://www.youtube.com/embed/08dd9zIo4qY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>열기구를 다 타고 나서 아침을 먹으러 차로 이동하던 중에 하마와 타조도 만났다.</p><img src="/2025/12/02/travel-001-kenya-01/balloon-breakfast-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/balloon-breakfast-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/balloon-breakfast-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/balloon-breakfast-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/balloon-breakfast-05.jpeg" class="">  <p>아침 식사를 하러 왔는데 완전 서구식 아침 식사였다. 여태까지 했던 식사 중에 제일 근사했고, 내 입맛에 맞았다. (고기 잡내를 맞지 않아도 돼서 행복했다.)  </p><img src="/2025/12/02/travel-001-kenya-01/balloon-breakfast-06.jpeg" class="">  <p>그리고 혼자 온 걸 불쌍하게 여겼는지, 아니면 같은 동양인이라서 동질감이 느껴진 건지 일본 아줌마들이 아침식사에 초대해주었다.<br>되도않는 일본어로 어떻게든 대화를 시도했고 아줌마들도 이태원 클라스니 뭐니 한국 드라마를 많이 봤다고 서로의 문화를 칭찬해주었다.<br>유럽&#x2F;아프리카인 사이에만 있다가 동양인을 만나니 뭔가 마음이 놓이는 것 같았고 오랜만에 정말 즐거운 식사를 할 수 있었다.  </p><img src="/2025/12/02/travel-001-kenya-01/balloon-toilet.jpeg" class="">  <p>야외에 있는 변기는 이렇게 생겼고, 자연에 처리를 맡기는 걸로 보였다.</p><p>그리고 아침을 맛있게 먹었는데 문득 ‘내 사파리 가이드 일행들은 어떻게 만나지? 여기로 오나? 가만히 있으면 되나?’하는 불안함이 들었다.<br>영어가 된다면 진작에 물어봤겠지만 ‘알아서 오겠지~’ 하는 생각에 굳이 물어보지 않고 좀 더 초조해지려던 찰나에 내 가이드가 차를 끌고 와서 일행과 합류할 수 있었다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/lSawWE5_i-4" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>그리고 처음으로 진짜 야생다운 모습을 보았다. 사자가 먹이를 잡아먹는 모습인데 멀어서 잘 보이지 않아 좀 아쉽기도 했고, 직접 사냥하는 모습도 보고 싶다는 생각이 들었다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/iZepagSFpRk" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>한 쪽에는 악어, 한 쪽에는 하마가 있어서 뭔가 스펙타클한 일이 일어나지 않을까?? 하고 기대했는데 별 일은 일어나지 않았다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/NgueB9rKsJo" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>좀 더 가다보니 목욕 중인 하마들도 볼 수 있었다.</p><img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-hyena.jpeg" class="">  <p>이번엔 진흙에서 목욕 중인 하이에나 무리도 볼 수 있었다.</p><img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-cheetah-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-cheetah-02.jpeg" class="">  <p>이번에는 어제 못 본 치타를 볼 수 있었는데 이 치타 한마리를 보기 위해 5대의 차가 둘러싸고 있는 걸 보니 ‘이게 진짜 자연이 맞나??’란 의문이 드는 순간이었다.<br>치타 입장에서는 ‘얼마나 스트레스일까? 아니 태어날 때부터 보던 광경이라 이제는 이것조차 그냥 자연의 일부가 된 걸까?’하는 생각이 들었다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/vkUHtNGQa2s" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>마사이 마라 국립공원에서는 포유류만 있는 게 아니다. 이렇게 간지나게 날아서 착륙하는 새도 볼 수 있어서 좋았다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/fXQhbh-lEtY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>계속 이동하다보니 케냐(마사이 마라 국립공원)와 탄자니아(세렝게티 국립공원)의 국경선에 올 수 있었다.<br>맨 처음에는 어디인지도 몰랐는데 하도 사람들이 사진을 찍고 가이드가 무슨 농담 따먹기를 하는데 하나도 알아먹지를 못했는데 알고보니 국경선이었다.  </p><img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-lunch-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-lunch-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-lunch-03.jpeg" class=""><p>국경선 근처에서 점심을 먹는데 거대한 새들이 주위로 몰려왔다. 아마 우리가 떨어뜨리는 부스러기를 먹으러 모이는 거 같았는데 덩치가 크다보니 좀 무서웠다.<br>그래서 음식물을 절대 흘리지 않게 아주 경계하면서 먹었다.</p><img src="/2025/12/02/travel-001-kenya-01/masai-mara-park-repair-vehicle.jpeg" class="">  <p>우리가 밥을 먹는 사이 가이드는 차량을 고쳤는데 다들 아는 사이인지 다른 사파리 업체 가이드들도 모여서 같이 수다도 떨고 공구도 빌려주고 하였다.<br>나중에 물어보니 특정 투어 회사에 종속되는 구조가 아니라고 하는데 그래서인지 다른 가이드하고도 저렇게 교류가 활발한 거 같았다. (물론 나는 영어가 짧아서 물어보지 못하고 같이 있는 에스토니아인이 물어봤다.)  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/pI8s4ycZ0S0" frameborder="0" loading="lazy" allowfullscreen></iframe></div><div class="video-container"><iframe src="https://www.youtube.com/embed/YmCeRlRpPPc" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>마사이 마라 국립공원에서는 이렇게 동물 가족들을 볼 수 있다. 뭐든 새끼는 귀여운 것 같다.  </p><h2 id="3일차-나쿠루-호수"><a href="#3일차-나쿠루-호수" class="headerlink" title="3일차 (나쿠루 호수)"></a>3일차 (나쿠루 호수)</h2><img src="/2025/12/02/travel-001-kenya-01/tent-breakfast-01.jpeg" class="">  <p>나쿠루 국립공원으로 떠나기 전에 아침을 먹었는데 역시나 콩 요리는 빠짐없이 나오는 것 같다.<br>그리고 오늘부터 이스라엘 커플도 합류하여 총 7명이 여행을 하게 되었다. (나빼고 다 커플이었다.)  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/O1I2jPsyCnQ" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>케냐의 도로를 보면 참 특이한 게 신호등도 횡단보도도 없고 양방향 일차선이라는 것이다.<br>사람들도 눈치를 보면서 길을 건너야하고, 앞에 트럭이나 느린 차량이 있으면 눈치보면서 추월을 해야하는 구조다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/0RlMV2TlvVs" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>그리고 차도를 활보하는 당나귀를 보면서 참 신기했다. (저런 당나귀 때문에 교통체증이 일어나기도 하는 것 같다.)  </p><img src="/2025/12/02/travel-001-kenya-01/kenya-cow-on-the-road.jpeg" class="">  <p>횡단보도도 크게 없다보니 이렇게 소 떼가 차도를 막고 건너기도 한다.  </p><img src="/2025/12/02/travel-001-kenya-01/kenya-peddler-car.jpeg" class="">  <p>그리고 과적차량 단속 기준도 없어서인지 이렇게 아주 차 위에 보따리 장수마냥 엄청난 짐들을 싣고 가는 것도 볼 수 있었다.  </p><img src="/2025/12/02/travel-001-kenya-01/kenya-gift-shop-001.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/kenya-gift-shop-002.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/kenya-gift-shop-003.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/kenya-gift-shop-004.jpeg" class="">  <p>중간에 기념품 가게도 들렀는데 역시나 팔찌&#x2F;동물 장식품&#x2F;이상한 탈 같은 게 있었고 나한테 필요한 건 하나도 없어서 대충 구경만 하고 나왔다.<br>근데 들어가면 1명이 전담마크로 붙어서 계속 옆에서 호객행위를 해서 좀 짜증이 났지만 그들한테는 생계가 달려있는지라 어쩔 수 없어보였다.</p><img src="/2025/12/02/travel-001-kenya-01/lake-nakuru-001.jpeg" class="">  <p>레이크 호수에 와서는 보트를 타고 이동하였다.<br>보트를 타는 비용은 $20인데 나는 달러가 없어서 2500 KES를 냈다. ($10은 1,500 KES인데 $20은 또 2,500 KES를 받는 게 신기했다.)  </p><img src="/2025/12/02/travel-001-kenya-01/lake-nakuru-003.jpeg" class="">  <p>이동하다보면 다른 섬들도 보이는데 여기는 하마나 얼룩말도 보이고, 마사이 마라 국립공원과는 또다른 생태계가 있는 것이 신기했다.<br>똑같은 얼룩말이라도 마사이 마라 국립공원에, 누구는 나쿠루 호수에 있는 게 무슨 이유때문일까? 참 신기했다.</p><img src="/2025/12/02/travel-001-kenya-01/lake-nakuru-004.jpeg" class="">  <p>레이크 호수에는 물에 잠긴 건물들이 보이는데 지구 온난화 영향 때문이라고 한다.</p><img src="/2025/12/02/travel-001-kenya-01/lake-nakuru-002.jpeg" class="">  <p>그리고 호수에서 거니는 새들도 많이 볼 수 있다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/tlGMcOy7ldc" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>이렇게 많은 새떼가 보이기도 하고,</p><div class="video-container"><iframe src="https://www.youtube.com/embed/lKHuEt0541E" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>간지나게 죽은 물고기를 낚아채는 독수리도 볼 수 있다. 장소를 계속 이동해가며 세 차례나 죽은 물고기를 던져가며 시도한 건데 영화와 같은 장면을 담을 수 있어서 행운이었다.  </p><img src="/2025/12/02/travel-001-kenya-01/lake-nakuru-005.jpeg" class="">  <p>그리고 이건 흙처럼 보이지만 물이라고 한다. (가이드가 밟지 말라고 주의하라고 했다.)  </p><img src="/2025/12/02/travel-001-kenya-01/hotel-01-001.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-002.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-003.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-004.jpeg" class="">  <p>나쿠루 호수 관광을 마친 후 드디어 사람사는 듯한 <a href="https://burahazenoni.com/">Buraha Zenoni Hotel</a>로 오게 되었다.  </p><img src="/2025/12/02/travel-001-kenya-01/hotel-01-pool.jpeg" class="">  <p>수영장을 가니 현지에서 가족단위로 놀러온 그룹들도 보였다. 근데 수영장에 벌레가 너무 많이 죽어있어서 수영을 조금만 하다가 나왔다.<br>그리고 수영도 오랜만에 하니 한바퀴만 돌아도 힘들어서 다리에 쥐가 날 지경이었다.<br>수영장이 있다고 신나하던 외국인들은 아무도 안 나오고 나만 혼자 수영했다.</p><img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-05.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-06.jpeg" class="">  <p>케냐인들 식단을 보면 거의 콩은 필수이고 야채들도 많은 거 같아서 건강 측면에서는 좋은 것 같았다.<br>하지만 저 고기도 여전히 조금 잡내가 나서 잘 먹지 못했다.<br>그리고 하얀 건 우갈리 라고 하는 케냐 전통 음식인데 수분이 없는 호빵? 술빵? 같은 그런 느낌이고 간은 전혀 돼있지 않았다.</p><img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-07.jpeg" class="">  <p>내가 매운 한국 찌개들이 그립다고 하자 저기도 수프랑 고춧가루가 있다고 해서 고춧가루를 냅다 넣었다가 목구멍만 따갑고 니맛도 내맛도 아니게 되었다.  </p><img src="/2025/12/02/travel-001-kenya-01/hotel-01-dinner-08.jpeg" class="">  <p>그리고 에스토니아 커플 중 한 여성이 식후에 입에 뭔가 넣길래 박하사탕인가? 싶었는데 찾아보니 니코틴 껌이었다.<br>담배 안 필 거 같이 생겼었는데 외국은 역시 이런 거에 있어서 뭔가 개방적이라는 느낌이 들었다.</p><h2 id="4일차-나쿠루-국립공원-나이바샤-보호구역"><a href="#4일차-나쿠루-국립공원-나이바샤-보호구역" class="headerlink" title="4일차 (나쿠루 국립공원 + 나이바샤 보호구역)"></a>4일차 (나쿠루 국립공원 + 나이바샤 보호구역)</h2><img src="/2025/12/02/travel-001-kenya-01/hotel-01-breakfast-01.jpeg" class="">  <p>나쿠루 국립공원으로 떠나기 전에 아침을 먹었는데 역시나 콩은 빠지지 않고 나왔다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/Zysw0AwY20g" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>나쿠루 국립공원으로 들어가니 원숭이 가족이 반겨주었다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/FSkeyuVwQtE" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>케냐에 와서 코뿔소는 처음 보았다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/hJx83pSVDB8" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>숫사자가 꾸벅꾸벅 조는 모습을 보니 배가 부른 거 같아 보였다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/SrPiAgRxTwc" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>먹이를 먹고 있는 새들의 모습을 보니 누군가 사냥 후에 남긴 찌꺼기를 모여서 먹는 것 같았다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/cyVBvFiHLCI" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>그리고 마칼리아 폭포에 와서 경치 구경을 했다.  </p><img src="/2025/12/02/travel-001-kenya-01/dead-bird.jpeg" class="">  <p>그 와중에 새의 사체를 보았고, 눈 앞에서 또 야생의 흔적을 발견한 것 같아 재미있었다.</p><img src="/2025/12/02/travel-001-kenya-01/lunch-day-4.jpeg" class=""><p>나쿠루 국립공원을 떠나 점심을 먹었다. 역시나 콩은 빠지지 않았고, 저 양념된 거는 내장?이었던 걸로 기억하는데 내장인 줄 모르고 먹었다가 너무 냄새가 역해서 먹다 토할 뻔 해서 바로 뱉었다.<br>점심을 먹고 나서 에스토니아 2커플은 암보셀리로 간다고 하여 헤어지고, 이제부터는 새로운 가이드, 차량, 이스라엘 커플과 함께 여행을 떠났다.<br>기존 가이드와 헤어지기 전에 이스라엘 커플이 팁을 주는 걸 발견해서 나도 뭐라도 줘야하나 싶어서 남은 5,000 KES를 보여주었는데 이걸로는 안 된다고 했다.<br>팁은 주는 사람 마음인데 마치 가격이 정해져있는 거 처럼 얘기해서 좀 당황스럽기는 했지만 하루에 $10 정도는 주는 게 적당하다고 생각하여 나도 납득을 하였다.<br>근데 가이드가 6,500 KES를 불렀다. 근데 돈이 없어서 어떻게 전달하냐고 하자 새로운 가이드에게 ATM에서 돈을 뽑아 전달하면 그 가이드가 본인에게 전달해줄 것이라고 했다.<br>나도 돈이 없는 상황이 걱정되어 챗GPT한테 물어봤는데 무슨 현지인들만 쓸 수 있는 어플을 사용하여 송금을 해주면 된다는 구라를 쳐서 역시 챗GPT는 무한 신뢰하기 보다는 더블체크 하는 게 맞는 것 같다.<br>그리고 다시 계산을 해보니 기존 가이드는 3.5일 밖에 가이드를 하지 않았고, 하루에 $10이면 $35만 주면 되는 것이다. 여기서 $10은 1,500 KES이기 때문에 5,250 KES만 주면 되는데 6,500 KES로 바가지를 씌운 것이었다.<br>근데 여기서 따지면 또 얼굴 붉혀야하니 일단은 알겠다고 했다. 영어를 잘 못하는 나에게 그래도 친절하게 잘 대해주어 팁을 주려고 생각했던 건데 마치 당연하다는 듯 여기는 태도가 마음에 들지 않았고 괜히 이런데서 정 주는 건 아니라는 걸 깨달았다.</p><img src="/2025/12/02/travel-001-kenya-01/kenya-gift-shop-005.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/kenya-gift-shop-006.jpeg" class="">  <p>나이바샤로 떠나는 중간에 기념품 샵에 들렀다.<br>여기도 뻔한 기념품들이 있었지만 그림을 보니 요거는 구매욕구가 조금은 생겼지만 집에 장식할 곳도 없어서 굳이 사지는 않았다.  </p><img src="/2025/12/02/travel-001-kenya-01/hotel-02-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-02-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-02-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-02-04.jpeg" class="">  <p>그리고 나이바샤에 있는 <a href="https://leisureapexresort.co.ke/">Leisure Apex Resort</a> 호텔에 왔다.  </p><p>호텔에서 좀 쉬다가 나이바샤 보호구역(Sanctuary)으로 갔는데 워킹 사파리는 $20인데 달러가 없어서 역시나 2,500 KES를 냈다.  </p><img src="/2025/12/02/travel-001-kenya-01/naivasha-01.jpeg" class="">  <p>얼룩말 어미와 새끼인데 자세히 보면 눈을 뜨고 있지만 자고 있는 거라고 해서 참 신기했다.</p><img src="/2025/12/02/travel-001-kenya-01/naivasha-02.jpeg" class="">  <p>기념으로 사진을 찍어보았는데 먹이를 주는 것처럼 자연스럽게 나와서 만족했다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/gw-iY6LImbs" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>워킹 사파리는 동물을 가까이서 볼 수 있기 때문에 다양한 기념사진&#x2F;동영상을 찍을 수 있는 묘미가 있는 거 같다.</p><img src="/2025/12/02/travel-001-kenya-01/naivasha-07.jpeg" class="">  <p>돈을 더 내면 말을 타고도 구경할 수 있다.  </p><img src="/2025/12/02/travel-001-kenya-01/naivasha-03.jpeg" class="">  <p>그리고 이건 하이에나가 사는 땅굴이라고 했다. 하이에나는 밤에 주로 돌아다니고 지금은 잔다고 해서 볼 수가 없었다.<br>그리고 여기는 다른 맹수는 없기 때문에 초식동물의 천적이 없을 줄 알았는데 하이에나가 여기서는 사냥도 한다고 해서 신기했다.  </p><img src="/2025/12/02/travel-001-kenya-01/naivasha-04.jpeg" class="">  <p>하이에나가 사냥을 한다는 증거인지 땅굴 근처에 저렇게 동물 머리뼈가 있었다.</p><img src="/2025/12/02/travel-001-kenya-01/naivasha-05.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/naivasha-06.jpeg" class="">  <p>그리고 이렇게 무리에서 혼자 떨어진 애들은 늙고 병들어서 죽을날만 기다린다고 했던 거 같은데 뭔가 짠했다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/hK09Kv07yHo" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>또 하나 신기했던 건데 임팔라인지 이 초식동물 무리는 수컷 무리와 하렘(수컷 한마리와 다수의 암컷) 무리가 따로 존재하고, 하렘 무리 내에서는 수컷이 다수의 암컷을 독점해서 짝짓기를 한다는 것이다.<br>자신의 유전자를 널리 퍼뜨리기 위한 번식 본능 때문인가 싶은데 정말 동물의 세계는 신기하다.</p><img src="/2025/12/02/travel-001-kenya-01/naivasha-08.jpeg" class="">  <p>그리고 보호구역 중간중간 누워 있거나 하는 사람들이 보이길래 ‘저 사람들은 현지인이 피크닉 온 건가?’ 하고 물어보니 여기서 일하는 사람들이 그냥 쉬는 거라고 했다.<br>나는 직원들이면 휴게실 같은데서 쉴 줄 알았는데 별도로 그런 시설은 없고 그냥 자연에서 쉬는 듯 해보였다.</p><img src="/2025/12/02/travel-001-kenya-01/naivasha-dinner-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/naivasha-dinner-02.jpeg" class="">  <p>숙소로 돌아와 저녁을 먹는데 너무 내스타일이 아니어서 조금만 담았더니 내가 불쌍해보였는지 계란후라이를 따로 해주었다.<br>그리고 콜라가 너무 먹고 싶어서 사먹으려고 하는데 현금만 된다고 해서 어쩔 수 없이 참았다. (내일 일정에도 현금을 써야해서 비축해둬야했다.)  </p><h2 id="5일차-Hell’s-Gate-국립공원-Karen-지역"><a href="#5일차-Hell’s-Gate-국립공원-Karen-지역" class="headerlink" title="5일차 (Hell’s Gate 국립공원 + Karen 지역)"></a>5일차 (Hell’s Gate 국립공원 + Karen 지역)</h2><img src="/2025/12/02/travel-001-kenya-01/naivasha-breakfast-01.jpeg" class=""><p>Hell’s Gate 국립공원으로 떠나기 전에 아침을 먹었다. 이 때는 몰랐는데 콩이 없는 첫 끼였던 것 같다.  </p><p>Hell’s Gate 국립공원은 자전거를 타고도 갈 수 있는데 $20(2,500 KES)라서 돈이 부족하기도 하고 일행 중 아무도 안 타기도 해서 타지 않았는데 뭔가 못 탄게 좀 아쉬움이 남았다.  </p><img src="/2025/12/02/travel-001-kenya-01/climb-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/climb-02.jpeg" class="">  <p>그래서 아쉬움을 달래고자 암벽등반에 도전하였다. 가격은 1,000KES 였고 클라이밍은 조카와 함께 동네에서 1시간 체험한 게 다였지만 안전하다고 하니 한번 해보고 싶었다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/gace5JK2E94" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>올라가는데 체력이 많이 소모되기도 하고 다리를 어디다가 걸쳐야할지 잘 몰라서 헤매기도 하고, 유연성이 부족해서 힘들기도 했다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/hwXF-salmuQ" frameborder="0" loading="lazy" allowfullscreen></iframe></div>  <p>내려오는 게 더 쉬울 줄 알았는데 로프가 없었다면 떨어질 뻔 하기도 하고 방심할 수 없었다.  </p><img src="/2025/12/02/travel-001-kenya-01/gorge-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/gorge-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/gorge-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/gorge-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/gorge-05.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/gorge-06.jpeg" class="">  <p>협곡을 걷는 것도 가이드가 동행했는데 1,000 KES가 들었다. 조금 빡센 산책하는 느낌으로 걸어가며 풍경을 구경했다.  </p><img src="/2025/12/02/travel-001-kenya-01/gorge-07.jpeg" class="">  <p>그리고 역시나 투어의 마지막은 또 기념품 가게가 있었는데 돈이 없기도 하고 별 쓰잘데기 없는 것들이 대부분이라 그냥 나와서 일행을 기다렸다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/YI3Hitabyts" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>그리고 차로 이동하면서 초식동물들끼리 뿔을 맞대고 싸우는 걸 보았는데 너무 싱겁게 끝나서 좀 아쉬웠다.</p><img src="/2025/12/02/travel-001-kenya-01/lunch-day-5.jpeg" class="">  <p>이제 모든 투어가 끝나고 마지막 점심을 즐겼다. 바나나를 구운 것은 처음 봤는데 그럭저럭 먹을만 했다. </p><img src="/2025/12/02/travel-001-kenya-01/deal-with-car-01.jpeg" class="">  <p>그리고 헤어지기 전에 ATM기에서 돈을 뽑아 팁 정산을 했어야하는데 두 번째 가이드도 따로 본인 팁을 2,500 KES 요구했다.<br>그래서 이건 말이 안 되는 것 같아 차의 뒷 창문에다가 숫자를 써가며 계산을 해서 5일치 $50 &#x3D; 7,500 KES 라고 합의를 했다.<br>원래였으면 기존 가이드 6,500 KES(3.5일) + 2,500 KES(1.5일) &#x3D; 9,000 KES나 낼 뻔했기 때문에 이건 너무 아닌 거 같아서 혼신의 힘을 다해 협상을 했던 것 같다.<br>왠지 삔또 상하면 투어 내내 지장이 생길 수도 있을 거 같아서 헤어지기 전에 물어봐서 타이밍을 잘 잡았던 것 같다.</p><img src="/2025/12/02/travel-001-kenya-01/hotel-03-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-05.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-06.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-07.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/hotel-03-08.jpeg" class="">  <p>모든 일정이 끝나고 사파리 차량이 내 숙소인 <a href="https://www.google.com/maps/place/Riara+One+Residency/@-1.2976376,36.7614154,17z/data=!3m1!4b1!4m6!3m5!1s0x182f1b7170f07bf3:0xbf7c73e92e52e1d!8m2!3d-1.2976376!4d36.7639903!16s%2Fg%2F11kb1zk66y?entry=ttu&g_ep=EgoyMDI1MTEwNC4xIKXMDSoASAFQAw==">Lux Suites Riara One Residency Angama</a> 호텔로 내려줬다.<br>Karen 지역에 있는 호텔인데 나이로비에서 Karen 지역이 그나마 중산층이 사는 곳이라 치안이 좋다고 하여 저 곳으로 잡았다.<br>사파리 업체에서 제공해준 숙소만 보다보니 이 호텔 시설이 너무 좋아보였고, 이 정도 시설이 1박에 8만원 밖에 하지 않아 매우 만족스러웠다.<br>다만 세탁기는 있는데 세제가 없어서 결국 손빨래를 하였다.<br>그리고 나는 호텔 측과 WhatsApp을 통해 연락했는데 그들은 중국인이었고, 호텔에서 맞아준 사람은 현지 케냐인으로 보였다.<br>그리고 자꾸 Owner 거리는 걸 보면 실 소유주는 중국인이고, 현지인을 고용해서 현장을 관리하게 한 것 같았다.<br>뭔가 이런 현실을 보니 자본주의 사회에서 케냐인들을 노예처럼 부리는 현대판 노예같다는 생각이 들었다. 자본있는 중국인들은 온라인으로 편하게 메신저로 응대하고, 실제 힘든 건 돈 없는 케냐인을 시키는 느낌이었다.  </p><img src="/2025/12/02/travel-001-kenya-01/boda-boda.jpeg" class="">  <p>그리고 원래는 현지의 느낌을 느끼려고 우버 택시 보다는 보다보다(Boda-boda)라고 현지인들이 많이 타는 오토바이를 타고 이동을 하려고 했다.<br>근데 현지인들이 타고 가는 걸 보니 여러명이 타기도 하고 헬멧도 안 쓰고 그런 걸 보니 이건 너무 위험하다고 생각이 돼서 우버 택시를 불렀다.<br>근데 생각보다 대기시간이 좀 길어서 혹시나 예약시간이 늦는 건 아닐까 걱정이 됐다. (한 10분 좀 넘게 차를 대기했던 걸로 기억한다.)<br>그리고 택시를 타고 가는데 좀만 교통이 정체되니 갑자기 케냐 잼민이 같은 애가 오더니 창문을 두들기면서 ‘Hey, bro.’하면서 돈을 달라고 하는 것이었다.<br>나는 너무 무섭고 영어를 못알아듣는 척 안 봤는데 끝까지 계속 문을 두들겼고 차가 움직이자 그제서야 사라졌다.<br>이런 경험을 하고 나니 ‘케냐에서는 어디 걸어다니기도 무섭겠구나’하는 생각이 들었다.  </p><img src="/2025/12/02/travel-001-kenya-01/carnivore-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-05.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-06.jpeg" class="">  <p>저녁으로는 악어 고기가 있다고 현지인이 추천했던 <a href="https://tamarind.co.ke/locations/carnivore">The Carnivore Restaurant</a>에 방문했다.<br>그중에서 모든 고기를 마음껏 먹어볼 수 있는 BEAST OF A FEAST로 예약을 했고, 가격은 $42.45를 카드로 결제했다.  </p><img src="/2025/12/02/travel-001-kenya-01/carnivore-07.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-08.jpeg" class="">  <p>고기는 내가 가져오는 게 아니라 종업원들이 스테이크를 꽂아서 돌아다니면서 썰어주고 어떤 소스와 먹으면 되는지 알려주는 형태였다.  </p><img src="/2025/12/02/travel-001-kenya-01/carnivore-09.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-10.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-11.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/carnivore-12.jpeg" class="">  <p>근데 쉴새없이 몰아치다보니 뭐가 무슨 고기인지 모르고 먹었던 것도 있는데, 악어고기는 뭔가 물에 사니 물고기 같은 느낌이 날까 싶었는데 포유류 고기 같은 느낌이 났던 걸로 기억한다.<br>타조 고기도 있었던 걸로 기억하는데 무슨 맛인지 기억이 안 난다.  </p><img src="/2025/12/02/travel-001-kenya-01/carnivore-13.jpeg" class="">  <p>계속 고기를 갖다주는대로 받다보니 다른 고기를 못 먹을 거 같아서 거의 한입씩만 먹었는데도 배가 부르기도 하고 내 입맛에 안 맞는 것들도 있다보니 거의 절반 이상을 남긴 것 같다.  </p><img src="/2025/12/02/travel-001-kenya-01/carnivore-14.jpeg" class="">  <p>gg를 치고 디저트로 마무리를 했다.</p><img src="/2025/12/02/travel-001-kenya-01/carnivore-15.jpeg" class="">  <p>그리고 돌아가는 길에 택시가 안 잡혀서 고생을 했다.<br>우버가 케냐에서는 고급 택시 이미지여서 그런지 잘 잡히지 않았고, 어떤 기사는 잡혔는데 10분이 넘게 움직이지를 않았다.<br>그래서 내가 오고 있냐고 물어보니까 너무 멀리 있다고만 하고 별 말이 없었다. 아마 나보고 알아서 취소하라는 거 같아서 취소를 하고 새로 잡았는데 이 사람은 다행히 오긴 온다고 하는데 15분을 기다렸다.<br>택시가 안 잡힐 때는 ‘이거 숙소에 어떻게 가지? 종업원에게 도움을 구해야하나…’ 하고 별에 별 생각을 했는데 다행히 숙소에 돌아올 수 있었다.<br>이런 경험을 하고 나니 나는 케냐 현지 여행은 절대 못할 것 같다.</p><h2 id="6일차-Karen-Blixen-박물관-터키행"><a href="#6일차-Karen-Blixen-박물관-터키행" class="headerlink" title="6일차 (Karen Blixen 박물관 + 터키행)"></a>6일차 (Karen Blixen 박물관 + 터키행)</h2><img src="/2025/12/02/travel-001-kenya-01/hotel-03-breakfast.jpeg" class="">  <p>아침이 되자 초인종이 울렸는데 왠지 불안해서 자는척을 하니까 WhatsApp으로 조식을 배달했다는 메세지가 왔다.<br>그래서 호다닥 달려나가서 열어보니 빵과 바나나, 우유가 있었다. 다 내가 좋아하는 메뉴라 기뻤는데 우유는 왠지 모르게 뭔가 이상한 냄새가 나서 제대로 먹지 못했다.  </p><img src="/2025/12/02/travel-001-kenya-01/karen-blixen-museum-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/karen-blixen-museum-02.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/karen-blixen-museum-03.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/karen-blixen-museum-04.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/karen-blixen-museum-05.jpeg" class="">  <p>그리고 오전에 어디 둘러볼 데 없나 싶어서 <a href="https://museums.or.ke/karen-blixen/">Karen Blixen 박물관</a>을 방문하였다.<br>토요일이라 그런지 운이 좋게 가이드와 1:1로 설명을 들을 수 있어서 영어를 못알아듣는 거 치고는 꽤 괜찮았던 경험이었다.<br>Karen Blixen 이라는 사람의 생가이고, 영화 ‘Out of Africa’의 배경이 됐던 집이라고 한다. 그래서 어떤 기구들로 커피를 만들었고 어떻게 생활했는지 둘러볼 수 있었다.<br>영화를 봐야지~ 하고 생각했는데 까먹고 있었다. 다시 회사로 출근하기 전에 한번 봐야겠다.<br>그리고 영어를 못알아듣는 나를 위해 열심히 설명해줬기 때문에 팁을 드리려고 했는데 캐리어에 지폐를 놓고와서 팁을 못 줘서 좀 미안했다.  </p><img src="/2025/12/02/travel-001-kenya-01/artist-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/artist-02.jpeg" class="">  <p>그리고 박물관 관광을 마치고 또 기념품 가게가 있어서 대충 둘러만 보고 가려고 했는데 그림을 그리는 청년이 있었다. (<a href="https://www.facebook.com/joseph.m.mwangi.5">Joseph Muchina Mwangi</a> 라는 화가다.)<br>직접 그림을 그리고 있는 모습이 인상깊었고, 또 그가 상상만으로 직접 그린 그림들이라고 해서 호기심이 갔다.<br>근데 우리 집에는 그림을 걸만한 곳이 없기도 하고, 또 내가 원하는 스타일의 그림은 보이지 않아서 따로 구매를 하지 않으려고 했다.<br>근데 그의 열정과 예술성이 너무 인상 깊어서 고민고민을 하다가 내가 원하는 스타일의 그림을 얘기하니 표범 그림을 보여주었다.<br>사파리에서 볼 수 있는 Big 5 동물(코끼리, 사자, 버팔로, 코뿔소, 표범) 중에 표범만 유일하게 못 보기도 했고, 주황 배경이 너무 강렬하게 느껴졌다.<br>근데 너~무 비싸게 가격을 부르길래 2&#x2F;3으로 깎으니까 바로 콜을 하는 것이었다. ‘와… 이럴 거면 절반으로 깎을 걸 그랬나…’ 하고 후회가 밀려오기도 했지만 영어도 안 되는데 다시 딜을 하고 그러기에 뭐해서 그냥 2&#x2F;3 가격에 샀다.<br>지금 다시 와서 보니 표범이 아니라 그냥 덩치 큰 고양이처럼 보이기도 하고, 뭔가 아쉬움이 남는 그림이기도 하다. (지금 집에 놓을 곳이 없어서 구석에 짱박아놓은 상태이다.)</p><img src="/2025/12/02/travel-001-kenya-01/junction-mall-01.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/junction-mall-02.jpeg" class="">  <p>그리고 터키행 비행기를 타기까지 시간이 좀 남아서 숙소 맞은편에 있는 Junction Mall에 방문했다.<br>케냐는 테러가 많은 국가라 그런지 이런 대형 쇼핑몰에 들어갈 때도 보안검사를 했다.<br>그리고 역시 아프리카답게 과일들은 굉장히 쌌던 걸로 기억한다.  </p><img src="/2025/12/02/travel-001-kenya-01/junction-mall-03.jpeg" class="">  <p>그리고 아프리카에 이렇게 잔망루피가 있는 걸 보니 뭔가 신기했다.  </p><img src="/2025/12/02/travel-001-kenya-01/junction-mall-04.jpeg" class="">  <p>케냐에도 이렇게 어린이들이 놀 수 있는 시설이 있는 걸 보니 ‘전세계 어린이들은 다 똑같이 노는 걸 좋아하는구나~’ 하는 생각이 들었다.</p><img src="/2025/12/02/travel-001-kenya-01/junction-mall-05.jpeg" class="">  <p>케냐에서 유명한 커피 프렌차이즈인 Java House이다. 사진만 찍고 들어가지는 않았다.  </p><img src="/2025/12/02/travel-001-kenya-01/junction-mall-06.jpeg" class="">  <img src="/2025/12/02/travel-001-kenya-01/junction-mall-07.jpeg" class="">  <p>대신 Java House와 양대산맥을 이루는 Artcaffe에 들어갔다.  </p><img src="/2025/12/02/travel-001-kenya-01/junction-mall-08.jpeg" class="">  <p>커피를 마실까 고민했지만 커피는 사파리 중간에도 마시기도 했고, 케냐에서만 먹을 수 있는 게 뭐가 있을까… 하고 생각하다가 뭔가 생강이 들어간 쥬스를 마셨다.<br>새콤하면서도 생강향이 올라오는 게 마치 수정과의 달달함에 계피향이 올라오는 그런 느낌으로 맛있게 먹었다.</p><img src="/2025/12/02/travel-001-kenya-01/kenya-airport-01.jpeg" class="">  <p>그리고 택시를 타고 나이로비에 있는 조모 케냐타 공항으로 이동하는데 갑자기 택시에서 내리라고 하는 것이다.<br>이 때도 무슨 보안수색대를 걸어서 지나고 다시 택시에 합류를 해야했는데 맨 처음에는 무슨 영문인지 몰랐고, 택시에서 내려서 보안수색을 하고 다시 탑승한다는 게 뭔가 신기한 경험이었다.  </p><img src="/2025/12/02/travel-001-kenya-01/kenya-airport-02.jpeg" class="">  <p>그리고 공항으로 들어가기도 전에 가방을 쭉 세워놓고 마약탐지견 같은 강아지가 한 번 수색을 하고 지나갔다.<br>이런 걸 보면 케냐가 진짜 치안이 안 좋은 나라인가보다… 하고 생각이 됐다. 그리고 여기는 공항에서 시간 없는 사람들을 위해 새치기 하고 돈받아주는 사람도 존재한다.<br>나보고도 자꾸 도와줄까? 그러길래 거절을 했는데 나중에 알고 보니 나보다 늦게 왔는데 새치기를 해주고 빠르게 입장을 하고 근데 공항에서도 별다른 제재가 없는 걸 보고 ‘진짜 이 나라는 치안이나 인식이 많이 떨어지는구나…’하고 느꼈다.</p><img src="/2025/12/02/travel-001-kenya-01/kenya-airport-03.jpeg" class="">  <p>그리고 공항 안팎으로 군복입은 사람들이 보이니 ‘진짜 무슨 테러가 벌어지면 어쩌지?? 괜히 나도 처신 잘못했다가 과잉진압 당할 수도 있으려나??’하는 걱정이 들었다.<br>이런 걸 보니 ‘한국에서 군인들이나 탱크가 돌아다니는 걸 보면 외국인 입장에서도 정말 무섭겠구나…’하는 생각이 들었다.  </p><h2 id="케냐-여행을-마치며"><a href="#케냐-여행을-마치며" class="headerlink" title="케냐 여행을 마치며"></a>케냐 여행을 마치며</h2><p>맨 처음에는 호기롭게 ‘자연을 찾아 떠나겠어!’하고 떠났는데 생각보다 나는 나약한 존재라는 걸 깨달았다.<br>‘그냥 야생에 텐트만 치고 자는 게 진짜지!’라고 생각했는데 그것보다 더 좋은 숙소를 줘도 불평하기 일쑤였고, ‘현장에서 발품 팔아서 사파리 예약해야겠다.’라고 안일하게 생각했는데 현지의 무서움을 느꼈더라면 절대 못했을 것 같다.<br>혼자 돌아다니기는 너무 무섭고 영어도 안 되니 더더욱 그랬으면 안 됐을 거 같다는 생각이 든다.<br>그리고 한편으로는 휑~한 마사이 마라 국립공원이 아쉬워서 ‘나중에 탄자니아 세렝게티 국립공원으로 한번 더 가볼까??’하는 생각도 들 정도로 정말 멋지고 좋은 경험이었던 것 같다.<br>다음에 올 때는 영어가 통하는 상태로 와서 외국인들과 다양한 경험을 교류하면 좋을 것 같다.</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/2025/12/02/travel-001-kenya-01/end-kenya.jpeg&quot; class&gt;  
&lt;p&gt;케냐의 강렬한 햇빛 때문에 팔토시를 한 부분과 안 한 부분의 경계가 명확하게 나뉘었다.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;회사에서는 3년 근속을 하면 1달 휴가를 주는 리프레시 제도가 있다.&lt;br&gt;원래 입사했을 당시에는 유럽에 대한 로망이 있고, 살면서 한번 쯤은 가보고 싶단 생각에 막연하게 ‘3년 채우면 1달 유럽 여행 가야지~’라는 생각이 있었다.&lt;br&gt;하지만 &lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-01/&quot;&gt;라스베가스&lt;/a&gt;를 한 번 다녀오고 나서 생각이 많이 바뀌었다.&lt;br&gt;고작 4박 5일만 다녀왔을 뿐인데도 ‘이렇게 내가 한 곳에 오래 있을 수 있을까?? 너무 지루한데??’ 라는 생각이 들었고, ‘만약 한달동안 갔는데 재미없으면 어떡하지??’ 라는 생각이 머릿속을 뒤덮었다.&lt;br&gt;그러다보니 3년을 채우고도 어떻게 해야할 줄을 몰라서 계속 미루기만 했었다.&lt;/p&gt;
&lt;h2 id=&quot;케냐로-떠나기까지&quot;&gt;&lt;a href=&quot;#케냐로-떠나기까지&quot; class=&quot;headerlink&quot; title=&quot;케냐로 떠나기까지&quot;&gt;&lt;/a&gt;케냐로 떠나기까지&lt;/h2&gt;</summary>
    
    
    
    <category term="기타" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/"/>
    
    <category term="잡동사니" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/%EC%9E%A1%EB%8F%99%EC%82%AC%EB%8B%88/"/>
    
    
    <category term="여행" scheme="https://perfectacle.github.io/tags/%EC%97%AC%ED%96%89/"/>
    
  </entry>
  
  <entry>
    <title>자바의 Virtual Thread가 나와도 코틀린의 코루틴은 여전히 살아남을까?</title>
    <link href="https://perfectacle.github.io/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/"/>
    <id>https://perfectacle.github.io/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/</id>
    <published>2023-07-10T01:04:44.000Z</published>
    <updated>2025-12-09T17:06:50.211Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/2022/12/29/look-over-java-virtual-threads/">Java Virtual Threads 훑어보기</a>에서 Virtual Thread에 대해 대충 훑어봤었고, 2023&#x2F;09&#x2F;19에 나오는 <a href="https://openjdk.org/projects/jdk/21/">JDK21(심지어 LTS)</a>에서 <a href="https://openjdk.org/jeps/444">Virtual Threads (JEP 444)</a>가 정식으로 출시된다는 소식을 들었다.<br>그러다보니 코틀린의 코루틴의 소식이 궁금했다.</p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/is-loom-a-java-equivalent-of-coroutines-in-kotlin.png" class=""><p>출처: <a href="https://www.youtube.com/live/QxxG66eQoTc?feature=share&t=3652">https://www.youtube.com/live/QxxG66eQoTc?feature=share&amp;t=3652</a><br>많은 사람들이 Virtual Thread가 코루틴과 같은 역할을 할 수 있을지 궁금해하는 것 같았고, 나 또한 코루틴을 잘 모르는 입장에서 ‘결국 코루틴은 사장되는 게 아닐까?’란 생각이 들었다.</p><p>그러던 중 <a href="https://youtu.be/zluKcazgkV4">Coroutines and Loom behind the scenes by Roman Elizarov</a>라는 영상을 보게 되어서 이해한 내용을 겸사겸사 정리해보았다. (나중에 회사에서 Virtual Thread 적용 할 때 고민해야할 부분도 함께 적어두기 위해서도 있지만…)<br>우선 해당 포스트에서는 Virtual Thread에 대한 기본적인 내용들은 알고 있다는 전제 하에 작성했다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/zluKcazgkV4" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2 id="간단-요약"><a href="#간단-요약" class="headerlink" title="간단 요약"></a>간단 요약</h2><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/recap.png" class=""><p>가상 쓰레드는 요청 당 쓰레드 하나를 만드는 모델(Spring WebMVC 같은)에 적합하고, 이미 존재하는 코드를 재사용할 수 있다는 장점이 있다.<br>코루틴은 높은 동시성(동시에 여러 요청을 보내서 응답을 받은 후 머지를 한다던지)을 요구하거나 Event 기반 시스템(유저의 이벤트를 받아서 UI를 제어해야한다던지)이나 Hierarchy가 있는 작업(Strucured Concurrency)을 처리하거나 취소해야하는 경우에 적합하다.</p><h2 id="Virtual-Thread-간단히-훑어보기"><a href="#Virtual-Thread-간단히-훑어보기" class="headerlink" title="Virtual Thread 간단히 훑어보기"></a>Virtual Thread 간단히 훑어보기</h2><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/goal-of-virtual-thread.png" class=""><p>우선 Virtual Thread는 기존에 존재하던 java.lang.Thread API의 최소한의 변경만을 목표로 하고, 서버 사이드에서 1 Request에 1 Thread를 사용하는 모델(Spring WebMVC 같은)에서 최적화가 잘 되는 걸 목표로 삼고 있다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/physical-thread-code.png" class=""><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/physical-thread-pool.png" class=""><p>그래서 이렇게 전통적인 방식으로 코드를 짜게 되면 요청이 여러번 들어왔을 때 OS의 Thread와 매칭되는 실제 쓰레드가 생성되고, Blocking I&#x2F;O를 만나는 순간 쓰레드가 블락되고, 다른 쓰레드로 CPU의 제어권이 넘어가면서 컨텍스트 스위칭이 발생한다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/virtual-thread-code.png" class=""><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/virtual-thread-pool-01.png" class=""><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/virtual-thread-pool-02.png" class=""><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/virtual-thread-pool-03.png" class=""><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/virtual-thread-pool-04.png" class=""><p>Virtual Thread 방식은 OS의 Thread와 매칭되는 실제 쓰레드는 조금만(컨텍스트 스위칭 비용을 줄이기 위해 기본적으로 CPU 코어 갯수 정도)만 만들고, 필요할 때마다 가상 쓰레드를 만든다.<br>그리고 가상 쓰레드 내에서도 Blocking I&#x2F;O를 만나는 순간 쓰레드가 블락되지만, 가상 쓰레드만 블락이 되고 실제 쓰레드는 블락되지 않는다.<br>그리고 다른 가상 쓰레드로 컨텍스트 스위칭을 하는데 이 때 실제 쓰레드 전환이 일어나는 게 아니기 때문에 컨텍스트 스위칭 비용이 매우 적다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/limitation-of-virtual-thread.png" class="">  <p>하지만 가상 쓰레드에도 다음과 같은 두 가지 상황에서 Carrier Thread가 블락당할 수 있다. </p><ol><li>native method(JNI 같은)를 호출하는 경우에 Blocking I&#x2F;O를 만나도 다른 가상 쓰레드로 yield를 하지 않는다. 가상 쓰레드에서 yield 하는 역할은 JVM에서 할 역할인데 native method는 JVM에서 실행되는 것이 아니기 때문에 JVM이 알 수가 없다.  </li><li>synchroized block을 만나는 경우에도 Blocking I&#x2F;O를 만나도 다른 가상 쓰레드로 yield를 하지 않는다. synchronized block은 실제 쓰레드인 Carrier Thread 전체를 synchronized block에 진입시키기 때문에 다른 가상 쓰레드로 yield를 시킬 수가 없다.  <blockquote><p>Instead, avoid frequent and long-lived pinning by revising synchronized blocks or methods that run frequently and guard potentially long I&#x2F;O operations to use java.util.concurrent.locks.ReentrantLock instead.<br>There is no need to replace synchronized blocks and methods that are used infrequently (e.g., only performed at startup) or that guard in-memory operations.<br>…<br>In a future release we may be able to remove the first limitation above, namely pinning inside synchronized. The second limitation is required for proper interaction with native code.<br><a href="https://openjdk.org/jeps/444#Executing-virtual-threads">https://openjdk.org/jeps/444#Executing-virtual-threads</a></p></blockquote></li></ol><p>이렇게 쓰레드가 핀(가상 쓰레드가 고정돼서 다른 가상 쓰레드로 전환되지 않는 현상) 되지 않으려면 synchronized 대신 ReentrantLock의 사용을 권장하고 있고,<br>아주 가끔 호출되는(초기 설정 같은) 경우나 아주 짧은 시간동안만 점유하는 경우(메모리 내의 변수만 조작한다던지)에는 굳이 synchronized를 바꿀 필요가 없다고 한다.<br>만약 본인이 사용하는 라이브러리&#x2F;프레임워크에서도 synchronized를 어디서 어떻게 사용하는지 보고 문제가 없는지 확인도 해야한다.<br>PostgreSQL JDBC Driver 같은 경우에도 <a href="https://github.com/pgjdbc/pgjdbc/issues/1951">synchronized를 ReentrantLock으로 바꾸는 작업</a>을 하고 있다.<br>그리고 이런 제약들이 추후 수정된다는데 언제 수정될 지도 모르고, LTS가 아닌 이상 회사에서 해당 버전을 쓰다가 안정성에 문제가 생겨도 서포트 기간이 끝나면 업데이트가 올라오지 않을 수도 있다보니 우선은 조심해서 써야한다.  </p><h2 id="코루틴-간단히-훑어보기"><a href="#코루틴-간단히-훑어보기" class="headerlink" title="코루틴 간단히 훑어보기"></a>코루틴 간단히 훑어보기</h2><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/goal-of-coroutine.png" class=""><p>코루틴은 기존에 존재하는 다양한 비동기 API들(Java NIO, 다양한 Future 구현체 등등)을 래핑해서 사용하기 쉽게 만들고, 다른 라이브러리들에 의존성을 가지지 않으며, async&#x2F;await를 사용하는 케이스나 generator 블럭(아마 둘 다 ECMAScript에 있는 내용을 얘기하는 것 같음)를 커버하는 것을 목표로 하고 있다. </p><h2 id="Virtual-Thread-vs-코루틴"><a href="#Virtual-Thread-vs-코루틴" class="headerlink" title="Virtual Thread vs 코루틴"></a>Virtual Thread vs 코루틴</h2><h3 id="Use-case"><a href="#Use-case" class="headerlink" title="Use case"></a>Use case</h3><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/best-case-of-coroutine-vs-virtual-thread-01.png" class="">  <img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/best-case-of-coroutine-vs-virtual-thread-02.png" class="">  <p>그러다보니 가상 쓰레드는 Thread에, Coroutine은 비동기에 더욱 집중하고 있으며 가상 쓰레드는 서버 사이드에서 외부 네트워크를 콜 하는 경우 등등에 적합한 반면, 코루틴은 다양한 동시성 이슈(UI에 다양한 애니메이션 이벤트가 돌아가야하는 경우, 서버 사이드에서 다른 서비스에 동시에 요청을 보내서 응답을 머지해야하는 경우 등등)를 다뤄야하는 복잡한 케이스에 적합하다고 한다.</p><h3 id="프로그래밍-스타일"><a href="#프로그래밍-스타일" class="headerlink" title="프로그래밍 스타일"></a>프로그래밍 스타일</h3><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/programming-style-of-virtual-thread.png" class="">  <p>virtual thread 같은 경우에는 중간에 Blocking I&#x2F;O를 만나더라도 다른 가상 쓰레드로 스위칭 될 거기 때문에 그냥 동기 방식으로 코드 짜듯이 순차적으로 짜면 된다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/programming-style-of-coroutine-01.png" class=""><p>반면 코루틴은 이벤트를 핸들링하는 방식으로 코드를 많이 짜기 때문에 상태를 업데이트 하는 부분에 Blocking I&#x2F;O를 넣어선 안 된다.<br>그러면 다음 이벤트를 핸들링 할 수 없기 때문에 UI가 멈추는 현상이 발생하거나 서버 사이드에서 다른 서비스에 요청을 보내서 응답을 머지하는 경우에도 블락이 발생한다면 다른 요청을 보내지 못하게 되거나 할 수도 있다.</p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/programming-style-of-coroutine-02.png" class="">  <p>그리고 코틀린은 suspend function과 일반 function을 구분하는 게 매우 중요하다고 하는데 아마 suspend function으로 진입하는 순간 다른 코루틴 스코프에게 제어권을 양보하기 때문에 로컬에서 아주 짧은 시간 동안 처리하고 끝낼 수 있음에도 불구하고, 다시 제어권을 획득할 때까지 기다려야하기 때문에 처리 속도가 느려질 수 있는 이유 때문이 아닐까 싶다.</p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/structured-concurrency-of-coroutine.png" class="">  <p>그리고 코루틴은 자식&#x2F;부모 코루틴 스코프와 같이 구조화된 코루틴을 사용할 수도 있고, 특정 코루틴 스코프의 실행을 취소 시켜버리거나 에러를 핸들링하기 쉽다는 점도 존재한다.</p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/structured-concurrency-of-virtual-thread-vs-coroutine.png" class="">  <p>물론 가상 쓰레드도 incubating 단계이긴 하지만 <a href="https://openjdk.org/jeps/428">JEP 428: Structured Concurrency</a>에서 위에서 언급한 코루틴의 에러 핸들링이나 취소 기능을 지원하려고 하고 있다.</p><h3 id="내부-구현"><a href="#내부-구현" class="headerlink" title="내부 구현"></a>내부 구현</h3><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/implementation-of-virtual-thread-01.png" class="">  <img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/implementation-of-virtual-thread-02.png" class="">  <p>가상 쓰레드는 Blocking I&#x2F;O가 발생하여 yield 메서드가 실행되는 순간 가상 쓰레드가 들고있던 정보들(로컬 변수, 쓰레드 로컬 변수, 콜스택 정보 등등)을 힙메모리에 올리는 과정이 진행된다.<br>그리고 나서 다른 가상 쓰레드가 Carrier Thread를 점유하게 되는데 실제 쓰레드는 스위칭 된 게 아니기 때문에 우리가 알고 있는 컨텍스트 스위칭에 비해서는 쓰레드 스위칭 비용이 훨씬 싸다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/implementation-of-virtual-thread-vs-coroutine.png" class="">  <p>그렇기 때문에 가상 쓰레드에서는 yield 하는 비용이 가장 크다.<br>그런 반면 코루틴에서는 yield 할 때 비용이 발생하는 게 아니라 다음 suspend function을 만났을 때 현재 메서드의 상태를 힙에 저장하기 때문에 이 때 비용이 가장 크다.<br>그러한 이유 때문에 suspend function과 일반 function을 잘 구분해서 작성해야한다.</p><h3 id="성능"><a href="#성능" class="headerlink" title="성능"></a>성능</h3><h4 id="메모리"><a href="#메모리" class="headerlink" title="메모리"></a>메모리</h4><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/memory-of-virtual-thread-vs-coroutine.png" class=""><p>메모리는 코루틴이 더 적게 먹긴 하는데 가상 쓰레드가 100만개라고 가정했을 때 2.6GB 정도 차지하는데 요즘 어지간해서 JVM에 힙메모리는 4GB 이상은 주지 않나(케바케긴 하겠지만) 싶고, 사실 단일 서버가 100만개의 요청을 동시에 받을 일도 없고 하다보니 메모리는 크게 신경쓰지 않아도 될 것 같다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/why-virtual-threads-are-heavier.png" class="">  <p>그리고 가상 쓰레드가 느린 이유를 아래 3가지로 설명하고 있다.</p><ol><li>아직 가상 쓰레드가 정식 버전으로 출시된 게 아니기 때문에 아직 더 최적화의 여지가 존재함.</li><li>가상 쓰레드는 가상이라 할지라도 쓰레드라는 컨셉을 유지하고 있기 때문에 정말 가벼운 동시성 관련된 컨셉들만 가지고 있는 코루틴에 비해서는 무겁다.  </li><li>코루틴은 suspend&#x2F;non suspend function을 구분하고, suspend function을 위해서 컴파일러가 최적화 작업을 하는데 비해 가상 쓰레드는 그런 구분이나 최적화가 없기 때문에 더 무겁다.<br>코루틴은 어디서 suspend 되는지 안 되는지를 알아서 suspend 되는 쪽에 최적화를 할 수 있는 반면, 가상 쓰레드는 어떤 메서드가 yield 될지 안 될지 몰라서 최적화가 불가능하기 때문이 아닐까 싶다.</li></ol><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/cpu-of-virtual-thread-vs-coroutine.png" class="">  <img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/limited-to-virtual-thread-api.png" class="">  <p>코루틴과 가상 쓰레드의 CPU 리소스 사용률을 비교하려고 하는데 가상 쓰레드에 마땅히 비교할 때 사용할만한 API가 없다고 한다.<br>아마 가상 쓰레드는 쓰레드에 포커스를 맞췄기 때문에 저렇게 명시적으로 특정 가상 쓰레드를 yield만 하는 API는 딱히 없는 것 같다.<br>그럴 필요도 없이 쭉 실행하면 돼서 그런 게 아닐까 싶다.  </p><p>이쯤에서 궁금해지는 게 코루틴은 저렇게 명시적으로 다른 코루틴 스코프에게 제어권을 양보하는 yield 메서드가 있고, 일반적인 멀티쓰레드 모델에서는 OS의 쓰레드가 사용되니까 OS에 의해 쓰레드가 스케쥴링이 될텐데 그럼 가상 쓰레드는 어떻게 스케쥴링이 될까? 궁금하기도 했다.<br>Blocking I&#x2F;O를 만나면 yield 메서드가 실행되어 다른 쓰레드에게 제어권을 양보할텐데 만약 CPU 집약적인 작업을 많이 해서 오랫동안 yield 메서드가 실행되지 않고 있는 가상 쓰레드가 있다면 어떻게 될까??</p><blockquote><p>The scheduler does not currently implement time sharing for virtual threads. Time sharing is the forceful preemption of a thread that has consumed an allotted quantity of CPU time.<br>While time sharing can be effective at reducing the latency of some tasks when there are a relatively small number of platform threads and CPU utilization is at 100%,<br>it is not clear that time sharing would be as effective with a million virtual threads.<br><a href="https://openjdk.org/jeps/444#Scheduling-virtual-threads">https://openjdk.org/jeps/444#Scheduling-virtual-threads</a></p></blockquote><p>아직 Time Sharing 방식으로 가상 쓰레드를 스케쥴링을 하지 않고 있다고 한다.<br>따라서 CPU 집약적인 작업을 오래하는 가상 쓰레드가 있다면 그 가상 쓰레드는 계속 CPU를 점유하게 될 것이다.  </p><blockquote><p>How that capability will be exposed to the schedulers is TBD, and will likely not make it to the first Preview.<br><a href="https://cr.openjdk.org/~rpressler/loom/loom/sol1_part2.html#forced-preemption">https://cr.openjdk.org/~rpressler/loom/loom/sol1_part2.html#forced-preemption</a></p></blockquote><p>하지만 추후 개선될 예정이라고 하니 그 전까지는 조심조심 하면서 사용해야하고, 혹시 CPU 집약적인 작업이 많은 어플리케이션이라면 가상 쓰레드를 꼭 써야하는지 고민 후 적용해봐야할 것 같다. (아니면 부분적으로만 적용한다던지) </p><h4 id="I-O"><a href="#I-O" class="headerlink" title="I&#x2F;O"></a>I&#x2F;O</h4><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/io-of-virtual-thread-vs-coroutine.png" class=""><p>가상 쓰레드는 built-in으로 Async I&#x2F;O(NIO 같은)을 지원하는데 반해 코루틴은 특정 I&#x2F;O 라이브러리(프레임워크)에 종속적이지 않고, 여러 I&#x2F;O 기술을 범용적으로 다룰 수 있다.<br>그러다보니 가상 쓰레드는 Blocking I&#x2F;O를 쓰는 코드에서 적합하고, 코루틴은 I&#x2F;O를 많이 쓰면서 높은 처리량을 내야하는 비동기 코드에 적합하다고 한다.<br>그리고 코루틴이 특정 I&#x2F;O 기술에 종속적인 게 아니다보니 어떤 Async I&#x2F;O 프레임워크를 쓰는지에 따라서 성능도 달라질 수 있다고 한다.</p><h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h4><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/last-goal-of-virtual-thread.png" class="">  <img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/tools-of-virtual-thread-vs-coroutine-01.png" class=""><p>가상 쓰레드의 마지막 목표는 기존에 있던 도구들(힙메모리 분석 도구, IDE의 디버깅 툴 등등)을 그대로 이용하는 것이다.<br>따라서 IntelliJ IDEA에서도 가상 쓰레드를 디버깅 할 수 있는데 아직은 가상 쓰레드가 Preview 버전이라 좀 더 작업할 것들이 남아있다고 한다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/tools-of-virtual-thread-vs-coroutine-02.png" class=""><p>그리고 코루틴은 기존에 없던 것이다 보니 도구가 새롭게 나왔는데, JetBrains에서 코틀린도 만들고, IntelliJ IDEA도 만들었으니 IntelliJ를 사용하면 코루틴도 디버깅이 가능하다.  </p><h2 id="가상-쓰레드와-코루틴-함께-사용하기"><a href="#가상-쓰레드와-코루틴-함께-사용하기" class="headerlink" title="가상 쓰레드와 코루틴 함께 사용하기"></a>가상 쓰레드와 코루틴 함께 사용하기</h2><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/use-together-virtual-thread-and-coroutine-01.png" class="">  <p>그럼 가상 쓰레드와 코루틴은 언제 함께 사용하는 게 좋을까??<br>코루틴의 단점은 보완하면서 가상 쓰레드의 장점을 사용할 수 있을 때 함께 사용하면 좋다고 한다. (그 반대 케이스인 가상 쓰레드의 단점을 코루틴이 보완하는 케이스도 궁금했는데 영상에는 나오지 않는다.)  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/use-together-virtual-thread-and-coroutine-02.png" class="">  <p>코루틴 안에서 복잡한 레거시 로직을 호출해야하는데 이 안에 Blocking I&#x2F;O가 있다고 하면 suspend function이 적절한 타이밍에 yield를 하지 않기 때문에 Dispatchers.IO를 사용해서 코루틴을 별도 쓰레드에서 실행시키면 된다.<br><a href="https://sandn.tistory.com/110">Coroutine의 IO Dispatcher와 Default Dispatcher 의 사용 시 차이</a>에 <a href="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-i-o.html">Dispatchers.IO</a>에 대해 간단히 설명하고 있다.<br>하지만 Dispatchers.IO 같은 경우에는 실제 쓰레드를 생성하기 때문에 메모리를 더 많이 쓴다는 단점이 존재한다.  </p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/use-together-virtual-thread-and-coroutine-03.png" class="">  <p>이럴 때 Blocking 로직을 가상 쓰레드에서 실행시키면 메모리를 절약할 수 있다는 장점이 존재한다.</p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/use-together-virtual-thread-and-coroutine-04.png" class="">  <p>그럼에도 불구하고 무조건 가상 쓰레드가 좋은 건 아니고 트레이드 오프가 존재한다.<br>Dispatchers.IO 같은 경우에는 Blocking 전&#x2F;후에 실행되는 쓰레드가 같기 때문에 불필요하게 컨텍스트 스위칭이 일어나지 않는다는 장점이 존재하고, 반면 메모리를 더 사용한다는 단점이 있다.<br>가상 쓰레드의 경우에는 메모리를 덜 사용한다는 장점이 있지만, 쓰레드가 다르기 때문에 물리적인 쓰레드의 스위칭까지는 아니지만 가상 쓰레드끼리는 스위칭이 발생한다는 단점이 존재한다.<br>물론 둘의 단점이 각각 미비할 수 있기 때문에 상황에 따라서 적절히 사용하면 된다.</p><img src="/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/use-together-virtual-thread-and-coroutine-05.png" class="">  <p>물론 나중에 가상 쓰레드가 정식으로 나오면 Dispatchers.IO가 가상 쓰레드를 사용하도록 바뀌고, 가상 쓰레드끼리도 스위칭이 발생하지 않을 수 있게 서로의 장점만 취하는 방향으로 개발한다고 한다.<br>근데 가상 쓰레드 사용하는데 Blocking I&#x2F;O를 만나서 yield가 되면서 힙메모리에 기존 가상 쓰레드의 컨텍스트 정보들을 올려뒀다가 다시 실행될 때는 그 정보들을 다시 가져오느라 비용이 발생할텐데 어떻게 이런 비용을 줄일 수 있을지 궁금하다.</p><h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>가상 쓰레드와 코루틴은 서로 컨셉부터 다르고 장단점도 명확한 것 같다.<br>다만 나는 아직까지는 높은 동시성 처리&#x2F;처리량을 요구하는 시스템이라기 보다는 돈이 오고가는 도메인을 다루다보니 안정성을 더 중점적으로 다루다보니 코루틴의 장점이 크게 와닿지 않았다.<br>그리고 코루틴은 어쨋든 코루틴 스코프 안에서 실행이 돼야하고, 이게 일반 function에서 실행시킬 것인지, suspend function에서 실행시킬 것인지, suspend function 안에 Blocking I&#x2F;O가 있는 건 아닌지 등등 고민을 많이 해서 코드를 짜야한다는 단점이 존재하는 것 같다.<br>가상 쓰레드로도 몸빵이 안 쳐지는 높은 처리량을 요구하는 서버라면 차라리 서버를 더 늘리는 게 값 싼 것 같다.<br>아직까지는 사람이 제일 비싼 자원인 것 같고, 사람이 이해하기 쉽고 관리하기 편한 코드를 짜는 게 더 중요한 것 같다.<br>다만 가상 쓰레드도 위에 얘기한 것처럼 synchronized 블럭에 진입하면 해당 가상 쓰레드가 핀 된다던지, Structured Concurreny가 Preview 단계라던지 하는 등의 문제 때문에 필요에 따라서는 코루틴과 함께 사용할 수도 있을 것 같다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/2022/12/29/look-over-java-virtual-threads/&quot;&gt;Java Virtual Threads 훑어보기&lt;/a&gt;에서 Virtual Thread에 대해 대충 훑어봤었고, 2023&amp;#x2F;09&amp;#x2F;19에 나오는 &lt;a href=&quot;https://openjdk.org/projects/jdk/21/&quot;&gt;JDK21(심지어 LTS)&lt;/a&gt;에서 &lt;a href=&quot;https://openjdk.org/jeps/444&quot;&gt;Virtual Threads (JEP 444)&lt;/a&gt;가 정식으로 출시된다는 소식을 들었다.&lt;br&gt;그러다보니 코틀린의 코루틴의 소식이 궁금했다.&lt;/p&gt;
&lt;img src=&quot;/2023/07/10/java-virtual-thread-vs-kotlin-coroutine/is-loom-a-java-equivalent-of-coroutines-in-kotlin.png&quot; class&gt;
&lt;p&gt;출처: &lt;a href=&quot;https://www.youtube.com/live/QxxG66eQoTc?feature=share&amp;t=3652&quot;&gt;https://www.youtube.com/live/QxxG66eQoTc?feature=share&amp;amp;t=3652&lt;/a&gt;&lt;br&gt;많은 사람들이 Virtual Thread가 코루틴과 같은 역할을 할 수 있을지 궁금해하는 것 같았고, 나 또한 코루틴을 잘 모르는 입장에서 ‘결국 코루틴은 사장되는 게 아닐까?’란 생각이 들었다.&lt;/p&gt;
&lt;p&gt;그러던 중 &lt;a href=&quot;https://youtu.be/zluKcazgkV4&quot;&gt;Coroutines and Loom behind the scenes by Roman Elizarov&lt;/a&gt;라는 영상을 보게 되어서 이해한 내용을 겸사겸사 정리해보았다. (나중에 회사에서 Virtual Thread 적용 할 때 고민해야할 부분도 함께 적어두기 위해서도 있지만…)&lt;br&gt;우선 해당 포스트에서는 Virtual Thread에 대한 기본적인 내용들은 알고 있다는 전제 하에 작성했다.&lt;/p&gt;
&lt;div class=&quot;video-container&quot;&gt;&lt;iframe src=&quot;https://www.youtube.com/embed/zluKcazgkV4&quot; frameborder=&quot;0&quot; loading=&quot;lazy&quot; allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Note" scheme="https://perfectacle.github.io/categories/Note/"/>
    
    <category term="Java" scheme="https://perfectacle.github.io/categories/Note/Java/"/>
    
    
    <category term="Java" scheme="https://perfectacle.github.io/tags/Java/"/>
    
    <category term="Virtual Threads" scheme="https://perfectacle.github.io/tags/Virtual-Threads/"/>
    
    <category term="Loom" scheme="https://perfectacle.github.io/tags/Loom/"/>
    
    <category term="Kotlin" scheme="https://perfectacle.github.io/tags/Kotlin/"/>
    
    <category term="Coroutine" scheme="https://perfectacle.github.io/tags/Coroutine/"/>
    
  </entry>
  
  <entry>
    <title>Java Virtual Threads 훑어보기</title>
    <link href="https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/"/>
    <id>https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/</id>
    <published>2022-12-29T00:22:21.000Z</published>
    <updated>2025-12-09T17:06:50.325Z</updated>
    
    <content type="html"><![CDATA[<p>Java의 <a href="https://openjdk.org/jeps/425">Virtual Threads</a>는 JDK 19에 <a href="https://openjdk.org/jeps/12">Preview Features</a>로 추가되었다.<br><a href="https://wiki.openjdk.org/display/loom/Main">프로젝트 룸(Loom)</a>에서 개발한 기능으로 알고있는데 사실 큰 관심도 없던(뭐하는 지도 모르던) 프로젝트였고, JDK 19가 LTS도 아니기 때문에 회사에서 바로 써볼 수도 없기에 JDK 19는 큰 관심도 가지고 있지 않았다.<br>하지만 최근 스프링 블로그에서 <a href="https://spring.io/blog/2022/10/11/embracing-virtual-threads">Embracing Virtual Threads</a> 라는 포스트가 올라온 걸 보고 살짝 관심 가지게 되었다.</p><p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc">Spring Web MVC</a>와 같이 전형적인 1 Request per 1 Thread 모델의 한계(쓰레드 자체가 많은 메모리를 소비하고, 컨텍스트 스위칭에 따른 불필요한 시간 소요 등등)를 극복하기 위해<br><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#spring-webflux">Spring Webflux</a>(가 의존하는 <a href="https://netty.io/">Netty</a>)에서는 코어 갯수 * 2개만의 쓰레드를 만듦으로 인해 그 한계를 극복하였지만 하나의 요청을 하나의 쓰레드가 온전히 처리하는 것이 아니기 때문에 스택트레이스를 봐도 파편화된 정보가 남아 트러블 슈팅에 문제가 있었고,<br><a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html">Mono</a>나 <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html">Flux</a>와 같은 Publisher 타입으로 값을 감싸야 하기 때문에 코드가 매우 보기 힘들고, 어디서 쓰레드를 블락하는 코드를 호출하는 건 아닌지 항상 불안에 떨었어야했다.  </p><p>그러다보니 Webflux가 더 고성능을 보장하더라도 유지보수하기가 힘들고 러닝커브 또한 존재하기 때문에 어지간한 경우가 아니면 Web MVC로 프로젝트를 만들었다.<br>사실 프로덕션에서 RDBMS를 안 쓰는 곳이 거의 없는데 <a href="https://r2dbc.io/">R2DBC</a>를 사용하기에는 너무 불안정해 보이기도 했고, 그리고 TPS가 안 나오면 대부분 스케일 아웃하는 형태로 해결을 많이 했다.<br>서버보다는 사람이 가장 비싼 자원이라고 생각되기에 유지보수 측면으로만 생각하다보니 Webflux는 거의 사용한 적이 없는 것 같다.<br>결정적으로 Web MVC(Spring Boot를 사용한다면 톰캣의 최대 쓰레드인 200개)만으로도 부족함이 없는 서비스도 많았고, 단일 서버가 아닌 이중화 등등으로 인해 서버가 다중으로 뜨기에 Webflux를 써야할 만큼의 처리를 단일서버에서 하지 않는 경우가 대다수였다.  </p><p>그럼에도 불구하고 Virtual Threads는 어떠한 문제를 해결해주는 것인지, Spring과 함께 사용하면 어떤 시너지를 낼 수 있을지 궁금해서 살짝만 훑어보았다.</p><h2 id="Platform-Threads"><a href="#Platform-Threads" class="headerlink" title="Platform Threads"></a>Platform Threads</h2><pre><code class="highlight mermaid">graph TD;    subgraph OS    A[OS Scheduler] -- schedule --&gt; B[OS Thread 1];    A[OS Scheduler] -- schedule --&gt; C[OS Thread 2];    end    subgraph JVM    B --&gt; D[Platform Thread 1];    C --&gt; E[Platform Thread 2];    end</code></pre><p>우리가 일반적으로 자바에서 쓰레드라고 부르는 것은 OS에서 생성한 쓰레드를 래핑해서 JVM에서 사용하기 쉽게 만든 Platform Threads라는 것을 말한다.<br>OS에 의해 스케쥴링 되기 때문에 쓰레드 간 전환을 위해 컨텍스트 스위칭이 발생하기도 하고, Platform Thread 하나를 생성하는 것은 OS에도 쓰레드를 하나 생성하는 것이기 때문에 일반적인 객체 생성과는 비교 불가능할 정도로 느리기 때문에 기본적으로 쓰레드 풀이라는 것을 만들고 거기에 미리 쓰레드들을 생성해두게 된다.<br>그러다보면 쓰레드 풀을 또 관리해야하는데 많은 양의 쓰레드를 만들다보면 또 메모리를 너무 많이 사용해서 문제가 발생하기도 한다.</p><h2 id="Virtual-Threads"><a href="#Virtual-Threads" class="headerlink" title="Virtual Threads"></a>Virtual Threads</h2><pre><code class="highlight mermaid">graph TD;    subgraph OS    A[OS Scheduler] -- schedule --&gt; B[OS Thread 1];    A[OS Scheduler] -- schedule --&gt; C[OS Thread 2];    end    subgraph JVM    B --&gt; D[ForkJoinPool];    C --&gt; D[ForkJoinPool];    D -- schedule --&gt; E[&quot;Carrier Thread 1 (Worker Thread 1)&quot;];    D -- schedule --&gt; F[&quot;Carrier Thread 2 (Worker Thread 2)&quot;];    E --&gt; G[Queue 1];    F --&gt; H[Queue 2];    G --  schedule --&gt; I[&quot;Virtual Thread 1 (Task 1)&quot;];    G --  schedule --&gt; J[&quot;Virtual Thread 2 (Task 2)&quot;];    H --  schedule --&gt; K[&quot;Virtual Thread 3 (Task 3)&quot;];    end</code></pre><p>그에 반해 Virtual Threads는 OS의 Thread와 1:1로 대응되지 않는다.<br>OS와 1:1로 대응되던 Platform Threads는 Carrier Threads라고 부른다.  </p><p>Carrier Thread는 <a href="https://docs.oracle.com/en/java/javase/19/docs/api/java.base/java/util/concurrent/ForkJoinPool.html">ForkJoinPool</a> 안에 Worker Thread로 생성이 되어 스케쥴링이 되고, 각 Worker Thread들은 Queue를 가지고 있어서 Task를 스케쥴링하는데 Virtual Thread 자체(좀 더 정확히는 Virtual Thread의 runContinuation 메서드를 실행하는 Runnable 타입)가 Task가 되어서 Queue에 들어가게 된다.</p><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-1.png" class="">  <img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-2.png" class="">  <img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-fork-join-pool-3.png" class="">  <blockquote><p>initially, carrier threads for virtual threads are threads in a ForkJoinPool that operates in FIFO mode. The size of this pool defaults to the number of available processors.<br><a href="https://www.infoq.com/articles/java-virtual-threads">https://www.infoq.com/articles/java-virtual-threads</a></p></blockquote><p>Queue 안에 있는 Virtual Thread 쓰레드들은 FIFO 방식으로 스케쥴링 되고, ForkJoinPool 안의 Worker Thread인 Carrier Thread는 기본적으로 CPU 코어 갯수(정확히는 available processor)만큼의 Carrier Threads를 생성한다. (아마 컨텍스트 스위칭 비용 때문이 아닐까 싶다.)  </p><blockquote><p>We dont have to guess how much stack space a thread might need, or make a one-size-fits-all estimate for all threads;<br>the memory footprint for a virtual thread starts out at only a few hundred bytes, and is expanded and shrunk automatically as the call stack expands and shrinks.<br><a href="https://www.infoq.com/articles/java-virtual-threads">https://www.infoq.com/articles/java-virtual-threads</a></p></blockquote><p>그리고 Virtual Threads는 OS의 쓰레드와 대응되는 개념도 아니고, JVM에서 직접 쓰레드를 생성하기 때문에 생성 비용(용량&#x2F;시간 등등의 측면에서)이 비싸지도 않고, 크기가 자동으로 조절되기 때문에 쓰레드 풀처럼 갯수를 관리할 필요도 없다.</p><blockquote><p>The difference with virtual threads is that, due to them being under the control of the JVM, the thread stack is stored in the heap memory and not in the stack.<br>This means that allocating the thread stack for an awakened virtual thread becomes much cheaper.<br><a href="https://theboreddev.com/understanding-java-virtual-threads/">https://theboreddev.com/understanding-java-virtual-threads/</a> </p></blockquote><p>JVM에서 쓰레드를 스케쥴링 해야하기 때문에 stack이 아닌 Heap 메모리 영역에 쓰레드의 스택이 저장되고 관리되기 때문에 우리가 알고있는 컨텍스트 스위칭에 대한 비용이 OS 레벨이 아닌 JVM 레벨에서 끝나기 때문에 훨씬 값싼 것이다.</p><h3 id="Virtual-Threads-스케쥴링"><a href="#Virtual-Threads-스케쥴링" class="headerlink" title="Virtual Threads 스케쥴링"></a>Virtual Threads 스케쥴링</h3><blockquote><p>The operating system schedules OS threads, and thus platform threads, but virtual threads are scheduled by the JDK.<br>The JDK does so indirectly by assigning virtual threads to platform threads in a process called mounting.<br>The JDK unassigns the platform threads later; this is called unmounting.<br>…<br>To implement this process, the JDK uses a dedicated ForkJoinPool in first-in-first-out (FIFO) mode as a virtual thread scheduler.<br>(Note: This is distinct from the common pool used by parallel streams.)<br>…<br>The JDK could mount a virtual thread by copying all its frames from heap to stack.<br>When the virtual thread is unmounted, most frames are left on the heap and copied lazily as needed.<br><a href="https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads">https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads</a></p></blockquote><p>Carrier Threads(Platform Threads)와 달리 Virtual Threads는 JDK에 의해 스케쥴링 되는데 ForkJoinPool을 이용하여 구현하였다. (parallel streams에서 사용하는 common pool과는 별개의 ForkJoinPool이라고 함.)<br>Virtual Threads 내에서는 CPU를 사용하지 않는 블로킹 메서드(네트워크 I&#x2F;O, 파일 I&#x2F;O 등등)를 만나게 되면 <strong>stack frames를 Heap 메모리에 저장(복사)</strong> 해놓는데 이 과정을 <strong>unmounting</strong>이라고 부른다.<br>그리고 블로킹 메서드가 종료되면 <strong>Heap 메모리에 저장된 stack frames를 다시 Virtual Threads로 불러오는데</strong> 이 과정을 <strong>mounting</strong>이라고 부른다.</p><p>이렇게 JVM 내에서 Virtual Threads 간 컨텍스트 스위칭이 이루어지기 때문에 Platform Threads를 사용할 때 비해서 컨텍스트 스위칭 비용이 매우 싸고, 스택트레이스를 찍었을 때 유실없이 모든 정보를 남길 수 있는 것이다.</p><p>코드를 통해 어떻게 Virtual Threads가 스케쥴링 되는지 좀 더 자세히 보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualThreadExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> Logger.getAnonymousLogger();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// Dec 29, 2022 2:39:08 AM org.example.VirtualThreadExample main</span></span><br><span class="line">        <span class="comment">// INFO:</span></span><br><span class="line">        <span class="comment">// threadName: main</span></span><br><span class="line">        <span class="comment">// availableProcessors: 10</span></span><br><span class="line">        log.info(<span class="string">&quot;\nthreadName: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;\navailableProcessors: &quot;</span> + Runtime.getRuntime().availableProcessors());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">indexValue</span> <span class="operator">=</span> index.incrementAndGet();</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// INFO: </span></span><br><span class="line">                <span class="comment">// threadName:</span></span><br><span class="line">                <span class="comment">// value: xx</span></span><br><span class="line">                <span class="comment">// Dec 29, 2022 2:39:09 AM org.example.VirtualThreadExample lambda$main$0</span></span><br><span class="line">                log.info(<span class="string">&quot;\nthreadName: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;\nvalue: &quot;</span> + indexValue);</span><br><span class="line">                </span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 일반적으로 쓰레드 풀의 갯수를 지정하는 것과는 달리 쓰레드의 갯수를 지정할 필요가 없다.</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                executorService.submit(runnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">finish</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeElapsed</span> <span class="operator">=</span> finish - start;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Dec 29, 2022 2:39:09 AM org.example.VirtualThreadExample main</span></span><br><span class="line">        <span class="comment">// INFO:</span></span><br><span class="line">        <span class="comment">// threadName: main</span></span><br><span class="line">        <span class="comment">// Run time: 1022</span></span><br><span class="line">        log.info(<span class="string">&quot;\nthreadName: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;\nRun time: &quot;</span> + timeElapsed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-not-show-name.png" class="" title="Virtual Threads는 이름을 표시하지 않는다.">  <p>Virtual Thread로 실행하는 블럭 내에 브레이크 포인트를 걸고 디버그 모드로 실행해서 확인해보면 Carrier Thread가 뭔지 볼 수 있다.</p><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-states.png" class="" title="Virtual Thread의 상태도 확인해볼 수 있다.">  <p>Virtual Threads는 Platform Threads와 달리 더 많은 상태들을 가지고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Virtual thread state and transitions:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      NEW -&gt; STARTED         // Thread.start</span></span><br><span class="line"><span class="comment"> *  STARTED -&gt; TERMINATED      // failed to start</span></span><br><span class="line"><span class="comment"> *  STARTED -&gt; RUNNING         // first run</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  RUNNING -&gt; PARKING         // Thread attempts to park</span></span><br><span class="line"><span class="comment"> *  PARKING -&gt; PARKED          // cont.yield successful, thread is parked</span></span><br><span class="line"><span class="comment"> *  PARKING -&gt; PINNED          // cont.yield failed, thread is pinned</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   PARKED -&gt; RUNNABLE        // unpark or interrupted</span></span><br><span class="line"><span class="comment"> *   PINNED -&gt; RUNNABLE        // unpark or interrupted</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * RUNNABLE -&gt; RUNNING         // continue execution</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  RUNNING -&gt; YIELDING        // Thread.yield</span></span><br><span class="line"><span class="comment"> * YIELDING -&gt; RUNNABLE        // yield successful</span></span><br><span class="line"><span class="comment"> * YIELDING -&gt; RUNNING         // yield failed</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  RUNNING -&gt; TERMINATED      // done</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NEW</span>      <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STARTED</span>  <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNABLE</span> <span class="operator">=</span> <span class="number">2</span>;     <span class="comment">// runnable-unmounted</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>  <span class="operator">=</span> <span class="number">3</span>;     <span class="comment">// runnable-mounted</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PARKING</span>  <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PARKED</span>   <span class="operator">=</span> <span class="number">5</span>;     <span class="comment">// unmounted</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PINNED</span>   <span class="operator">=</span> <span class="number">6</span>;     <span class="comment">// mounted</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">YIELDING</span> <span class="operator">=</span> <span class="number">7</span>;     <span class="comment">// Thread.yield</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span> <span class="number">99</span>;  <span class="comment">// final state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// can be suspended from scheduling when unmounted</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SUSPENDED</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNABLE_SUSPENDED</span> <span class="operator">=</span> (RUNNABLE | SUSPENDED);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PARKED_SUSPENDED</span>   <span class="operator">=</span> (PARKED | SUSPENDED);</span><br></pre></td></tr></table></figure><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-profiling.png" class="" title="cpu 코어 갯수인 10개의 ForkJoinPool Worker 쓰레드가 생성되었다.">  <p>무조건 cpu 코어 갯수만큼 생기는 건 아니고, Virtual Threads 갯수가 적다면 더 적은 Carrier Threads(ForkJoinPool Worker 쓰레드)가 생성된다.</p><p>그리고 실행 결과를 보면 100번의 Thread.sleep(1초)가 발생했고, 실제로 OS Thread와 매칭되는 Carrier Thread는 10개 밖에 사용하지 않았는데 1초 만에 모든 연산이 종료된 걸 볼 수 있다.<br>동일하게 10개의 Platform Threads를 사용하면 10초가 걸린다. (<code>Executors.newFixedThreadPool(10)</code>)</p><h3 id="기존-코드와의-호환성"><a href="#기존-코드와의-호환성" class="headerlink" title="기존 코드와의 호환성"></a>기존 코드와의 호환성</h3><p>Virtual Thread를 사용하면 100%는 아니지만 기존 코드의 변경없이 Virtual Thread를 사용할 수 있다고 한다.<br>어떻게 그게 가능한지 살펴보자.</p><h4 id="Thread-클래스의-호환성"><a href="#Thread-클래스의-호환성" class="headerlink" title="Thread 클래스의 호환성"></a>Thread 클래스의 호환성</h4><p><a href="https://github.com/openjdk/loom/blob/fibers/src/java.base/share/classes/java/lang/VirtualThread.java">VirtualThread</a>의 부모 타입인 <a href="https://github.com/openjdk/loom/blob/fibers/src/java.base/share/classes/java/lang/BaseVirtualThread.java">BaseVirtualThread</a>가 <a href="https://docs.oracle.com/en/java/javase/19/docs/api/java.base/java/lang/Thread.html">Thread 클래스</a>를 상속받았기 때문에 기존 Thread 구현의 변경 없이 Virtual Threads를 사용할 수 있다.</p><p>실제로 Thread.sleep(long millis) 메서드를 보면 아래와 같이 구현돼있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;timeout value is negative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentThread() <span class="keyword">instanceof</span> VirtualThread vthread) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> MILLISECONDS.toNanos(millis);</span><br><span class="line">        vthread.sleepNanos(nanos);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ThreadSleepEvent.isTurnedOn()) &#123;</span><br><span class="line">        <span class="type">ThreadSleepEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadSleepEvent</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            event.time = MILLISECONDS.toNanos(millis);</span><br><span class="line">            event.begin();</span><br><span class="line">            sleep0(millis);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            event.commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sleep0(millis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>내부에서 VirtualThread인지 아닌지 판단하고 있다.<br>그리고 VirtualThread라면 <a href="https://github.com/openjdk/loom/blob/fibers/src/java.base/share/classes/java/lang/VirtualThread.java#L728-L785">sleepNanos(long nanos) 메서드</a>를 호출하고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">VirtualThread</span> <span class="keyword">extends</span> <span class="title class_">BaseVirtualThread</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sleep the current virtual thread for the given sleep time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nanos the maximum number of nanoseconds to sleep</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException if interrupted while sleeping</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sleepNanos</span><span class="params">(<span class="type">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">assert</span> Thread.currentThread() == <span class="built_in">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (nanos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ThreadSleepEvent.isTurnedOn()) &#123;</span><br><span class="line">                <span class="type">ThreadSleepEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadSleepEvent</span>();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    event.time = nanos;</span><br><span class="line">                    event.begin();</span><br><span class="line">                    doSleepNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    event.commit();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                doSleepNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sleep the current thread for the given sleep time (in nanoseconds). If</span></span><br><span class="line"><span class="comment">     * nanos is 0 then the thread will attempt to yield.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implNote</span> This implementation parks the thread for the given sleeping time</span></span><br><span class="line"><span class="comment">     * and will therefore be observed in PARKED state during the sleep. Parking</span></span><br><span class="line"><span class="comment">     * will consume the parking permit so this method makes available the parking</span></span><br><span class="line"><span class="comment">     * permit after the sleep. This may be observed as a spurious, but benign,</span></span><br><span class="line"><span class="comment">     * wakeup when the thread subsequently attempts to park.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSleepNanos</span><span class="params">(<span class="type">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">assert</span> nanos &gt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (getAndClearInterrupt())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="keyword">if</span> (nanos == <span class="number">0</span>) &#123;</span><br><span class="line">            tryYield();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// park for the sleep time</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">remainingNanos</span> <span class="operator">=</span> nanos;</span><br><span class="line">                <span class="type">long</span> <span class="variable">startNanos</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                <span class="keyword">while</span> (remainingNanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    parkNanos(remainingNanos);</span><br><span class="line">                    <span class="keyword">if</span> (getAndClearInterrupt()) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    remainingNanos = nanos - (System.nanoTime() - startNanos);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// may have been unparked while sleeping</span></span><br><span class="line">                setParkPermit(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parks up to the given waiting time or until unparked or interrupted.</span></span><br><span class="line"><span class="comment">     * If already unparked then the parking permit is consumed and this method</span></span><br><span class="line"><span class="comment">     * completes immediately (meaning it doesn&#x27;t yield). It also completes immediately</span></span><br><span class="line"><span class="comment">     * if the interrupt status is set or the waiting time is &#123;<span class="doctag">@code</span> &lt;= 0&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nanos the maximum number of nanoseconds to wait.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">parkNanos</span><span class="params">(<span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> Thread.currentThread() == <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// complete immediately if parking permit available or interrupted</span></span><br><span class="line">        <span class="keyword">if</span> (getAndSetParkPermit(<span class="literal">false</span>) || interrupted)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// park the thread for the waiting time</span></span><br><span class="line">        <span class="keyword">if</span> (nanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> yielded;</span><br><span class="line">            Future&lt;?&gt; unparker = scheduleUnpark(<span class="built_in">this</span>::unpark, nanos);</span><br><span class="line">            setState(PARKING);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                yielded = yieldContinuation();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">assert</span> (Thread.currentThread() == <span class="built_in">this</span>)</span><br><span class="line">                    &amp;&amp; (state() == RUNNING || state() == PARKING);</span><br><span class="line">                cancel(unparker);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// park on carrier thread for remaining time when pinned</span></span><br><span class="line">            <span class="keyword">if</span> (!yielded) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> startTime + nanos;</span><br><span class="line">                <span class="keyword">if</span> (deadline &lt; <span class="number">0L</span>)</span><br><span class="line">                    deadline = Long.MAX_VALUE;</span><br><span class="line">                parkOnCarrierThread(<span class="literal">true</span>, deadline - System.nanoTime());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Unmounts this virtual thread, invokes Continuation.yield, and re-mounts the</span></span><br><span class="line"><span class="comment">     * thread when continued. When enabled, JVMTI must be notified from this method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the yield was successful</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ChangesCurrentThread</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">yieldContinuation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// unmount</span></span><br><span class="line">        <span class="keyword">if</span> (notifyJvmtiEvents) notifyJvmtiUnmountBegin(<span class="literal">false</span>);</span><br><span class="line">        unmount();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Continuation.<span class="keyword">yield</span>(VTHREAD_SCOPE);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// re-mount</span></span><br><span class="line">            mount();</span><br><span class="line">            <span class="keyword">if</span> (notifyJvmtiEvents) notifyJvmtiMountEnd(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sleepNanos -&gt; doSleepNanos -&gt; parkNanos -&gt; yieldContinuation 메서드를 순차적으로 호출하게 되는데<br>yieldContinuation 메서드 안에서 unmount 메서드를 호출해서 virtual thread를 block 시키고, 지정한 시간이 지나면 다시 mount 메서드를 호출해서 block 된 virtual thread를 깨워서 해당 지점부터 다시 task를 진행하도록 한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Unmounts this virtual thread from the carrier. On return, the</span></span><br><span class="line"><span class="comment"> * current thread is the current platform thread.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ChangesCurrentThread</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unmount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// set Thread.currentThread() to return the platform thread</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">carrier</span> <span class="operator">=</span> <span class="built_in">this</span>.carrierThread;</span><br><span class="line">    carrier.setCurrentThread(carrier);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// break connection to carrier thread, synchronized with interrupt</span></span><br><span class="line">    <span class="keyword">synchronized</span> (interruptLock) &#123;</span><br><span class="line">        setCarrierThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    carrier.clearInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mounts this virtual thread onto the current platform thread. On</span></span><br><span class="line"><span class="comment"> * return, the current thread is the virtual thread.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ChangesCurrentThread</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// sets the carrier thread</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">carrier</span> <span class="operator">=</span> Thread.currentCarrierThread();</span><br><span class="line">    setCarrierThread(carrier);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sync up carrier thread interrupt status if needed</span></span><br><span class="line">    <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">        carrier.setInterrupt();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (carrier.isInterrupted()) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (interruptLock) &#123;</span><br><span class="line">            <span class="comment">// need to recheck interrupt status</span></span><br><span class="line">            <span class="keyword">if</span> (!interrupted) &#123;</span><br><span class="line">                carrier.clearInterrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set Thread.currentThread() to return this virtual thread</span></span><br><span class="line">    carrier.setCurrentThread(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-mount-unmount.png" class="" title="Virtual Thread의 Carrier Thread와 Carrier Thread의 currentThread"><p>unmount 메서드에서는 Virtual Thread의 Carrier Thread(ForkJoinPool Worker 쓰레드)의 currentThread(VirtualThread)를 Carrier Thread 그 자체로 할당해버림으로써 VirtualThread는 할당된 Carrier Thread가 없기 때문에 남은 연산을 수행하지 못하게 만들어버리고(blocking),<br>mount 메서드에서는 Virtual Thread의 Carrier Thread(ForkJoinPool Worker 쓰레드)의 currentThread(ForkJoinPool Worker 쓰레드)를 다시 자기 자신인 Virtual Thread 그 자체로 할당해버림으로써 VirtualThread의 남은 연산을 다시 Carrier Thread에서 수행하게 끔 만든다.</p><p>이렇게 되면 실제로 OS Thread와 매칭되는 Carrier Thread 그 자체가 블로킹 된 건 아니기 때문에 OS 레벨에서는 컨텍스트 스위칭이 발생하지 않고, JVM 레벨에서만 Carrier Thread에 다른 Virtual Thread를 할당하는 컨텍스트 스위칭만 발생하게 된다.</p><h4 id="Socket-API와의-호환성"><a href="#Socket-API와의-호환성" class="headerlink" title="Socket API와의 호환성"></a>Socket API와의 호환성</h4><p>기존 코드와의 호환성을 위해 <a href="https://openjdk.org/jeps/353">JEP 353 (Reimplement the legacy Socket API)</a>, <a href="https://openjdk.org/jeps/373">JEP 373 (Reimplement the legacy DatagramSocket API)</a>에서 Socket API들을 재구현함으로써 코드의 변경없이 Virtual Thread를 사용할 수 있도록 하였다.  </p><p>JDK 11로 실행시킨 Apache HTTP Client 4.5의 stacktrace </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">at java.base/java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">at java.base/java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">115</span>)</span><br><span class="line">at java.base/java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">168</span>)</span><br><span class="line">at java.base/java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">140</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class="number">137</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class="number">153</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class="number">280</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">138</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">56</span>)</span><br><span class="line">at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class="number">259</span>)</span><br><span class="line">at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class="number">163</span>)</span><br><span class="line">at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class="number">157</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class="number">273</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class="number">125</span>)</span><br><span class="line">at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class="number">272</span>)</span><br><span class="line">at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class="number">186</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class="number">89</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class="number">110</span>)</span><br><span class="line">at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class="number">185</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">83</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">108</span>)</span><br></pre></td></tr></table></figure><p>JDK 19로 실행시킨 Apache HTTP Client 4.5의 stacktrace</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">at java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:<span class="number">313</span>)</span><br><span class="line">at java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:<span class="number">340</span>)</span><br><span class="line">at java.base/sun.nio.ch.NioSocketImpl$<span class="number">1.</span>read(NioSocketImpl.java:<span class="number">789</span>)</span><br><span class="line">at java.base/java.net.Socket$SocketInputStream.read(Socket.java:<span class="number">1025</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class="number">137</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class="number">153</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class="number">280</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">138</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">56</span>)</span><br><span class="line">at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class="number">259</span>)</span><br><span class="line">at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class="number">163</span>)</span><br><span class="line">at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class="number">157</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class="number">273</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class="number">125</span>)</span><br><span class="line">at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class="number">272</span>)</span><br><span class="line">at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class="number">186</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class="number">89</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class="number">110</span>)</span><br><span class="line">at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class="number">185</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">83</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">108</span>)</span><br></pre></td></tr></table></figure><p>둘의 가장 큰 차이는 JDK 19에서는 NioSocket을 사용한다는 것이다.<br>기본적으로 SocketImpl의 구현체로 NioSocketImpl을 사용하는 건 JDK 13부터 변경된 사항이지만, JDK 19부터 Virtual Threads의 지원을 위해 내부에서 VirtualThread의 park 메서드를 호출하고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NioSocketImpl</span> <span class="keyword">extends</span> <span class="title class_">SocketImpl</span> <span class="keyword">implements</span> <span class="title class_">PlatformSocketImpl</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reads bytes from the socket into the given byte array.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of bytes read or -1 at EOF</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SocketException if the socket is closed or a socket I/O error occurs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SocketTimeoutException if the read timeout elapses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">implRead</span><span class="params">(<span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">FileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> beginRead();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connectionReset)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Connection reset&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (isInputClosed)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="built_in">this</span>.timeout;</span><br><span class="line">            configureNonBlockingIfNeeded(fd, timeout &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// read with timeout</span></span><br><span class="line">                n = timedRead(fd, b, off, len, MILLISECONDS.toNanos(timeout));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// read, no timeout</span></span><br><span class="line">                n = tryRead(fd, b, off, len);</span><br><span class="line">                <span class="keyword">while</span> (IOStatus.okayToRetry(n) &amp;&amp; isOpen()) &#123;</span><br><span class="line">                    park(fd, Net.POLLIN);</span><br><span class="line">                    n = tryRead(fd, b, off, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConnectionResetException e) &#123;</span><br><span class="line">            connectionReset = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Connection reset&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(ioe.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            endRead(n &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Disables the current thread for scheduling purposes until the</span></span><br><span class="line"><span class="comment">     * socket is ready for I/O or is asynchronously closed, for up to the</span></span><br><span class="line"><span class="comment">     * specified waiting time.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O error occurs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(FileDescriptor fd, <span class="type">int</span> event, <span class="type">long</span> nanos)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="keyword">if</span> (t.isVirtual()) &#123;</span><br><span class="line">            Poller.poll(fdVal(fd), event, nanos, <span class="built_in">this</span>::isOpen);</span><br><span class="line">            <span class="keyword">if</span> (t.isInterrupted()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedIOException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">long</span> millis;</span><br><span class="line">            <span class="keyword">if</span> (nanos == <span class="number">0</span>) &#123;</span><br><span class="line">                millis = -<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                millis = NANOSECONDS.toMillis(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">            Net.poll(fd, event, millis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Poller</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parks the current thread until a file descriptor is ready for the given op.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fdVal the file descriptor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event POLLIN or POLLOUT</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nanos the waiting time or 0 to wait indefinitely</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> supplier supplies a boolean to indicate if the enclosing object is open</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">poll</span><span class="params">(<span class="type">int</span> fdVal, <span class="type">int</span> event, <span class="type">long</span> nanos, BooleanSupplier supplier)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">assert</span> nanos &gt;= <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">if</span> (event == Net.POLLIN) &#123;</span><br><span class="line">            readPoller(fdVal).poll(fdVal, nanos, supplier);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event == Net.POLLOUT) &#123;</span><br><span class="line">            writePoller(fdVal).poll(fdVal, nanos, supplier);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parks the current thread until a file descriptor is ready.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">poll</span><span class="params">(<span class="type">int</span> fdVal, <span class="type">long</span> nanos, BooleanSupplier supplier)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (USE_DIRECT_REGISTER) &#123;</span><br><span class="line">            poll1(fdVal, nanos, supplier);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            poll2(fdVal, nanos, supplier);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parks the current thread until a file descriptor is ready. This implementation</span></span><br><span class="line"><span class="comment">     * registers the file descriptor, then parks until the file descriptor is polled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">poll1</span><span class="params">(<span class="type">int</span> fdVal, <span class="type">long</span> nanos, BooleanSupplier supplier)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        register(fdVal);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isOpen</span> <span class="operator">=</span> supplier.getAsBoolean();</span><br><span class="line">            <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LockSupport.parkNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LockSupport.park();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            deregister(fdVal);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parks the current thread until a file descriptor is ready. This implementation</span></span><br><span class="line"><span class="comment">     * queues the file descriptor to the update thread, then parks until the file</span></span><br><span class="line"><span class="comment">     * descriptor is polled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">poll2</span><span class="params">(<span class="type">int</span> fdVal, <span class="type">long</span> nanos, BooleanSupplier supplier)</span> &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> registerAsync(fdVal);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isOpen</span> <span class="operator">=</span> supplier.getAsBoolean();</span><br><span class="line">            <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LockSupport.parkNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LockSupport.park();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            request.awaitFinish();</span><br><span class="line">            deregister(fdVal);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockSupport</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread().isVirtual()) &#123;</span><br><span class="line">            VirtualThreads.park();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            U.park(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parkNanos</span><span class="params">(<span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (nanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread().isVirtual()) &#123;</span><br><span class="line">                VirtualThreads.park(nanos);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                U.park(<span class="literal">false</span>, nanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>코드의 변경이 없기 때문에 마치 Thread(Carrier Threads&#x2F;Platform Threads)가 블로킹 될 것처럼 보이지만, 내부를 들여다보면 Virtual Threads만 unmounting 되는 걸 볼 수 있다.<br>따라서 Carrier Threads에서는 블로킹 없이 다른 연산들을 처리할 수 있게 된다. </p><h4 id="Spring과의-호환성"><a href="#Spring과의-호환성" class="headerlink" title="Spring과의 호환성"></a>Spring과의 호환성</h4><p><a href="https://spring.io/blog/2022/10/11/embracing-virtual-threads">스프링 블로그 포스트</a>에서 가장 최신 버전을 기준으로 설명하기 때문에 Spring Boot 3.0.1(Spring 6.0.3)을 기준으로 설명한다.<br><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/web.html">Spring Boot Starter Web</a>을 사용하게 되면 Embedded Tomcat을 사용하게 되므로 아래와 같이 Virtual Threads를 사용하도록 설정해주면 된다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TomcatProtocolHandlerCustomizer&lt;?&gt; protocolHandlerVirtualThreadExecutorCustomizer() &#123;</span><br><span class="line">    <span class="keyword">return</span> protocolHandler -&gt; protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>쓰레드 풀의 갯수를 신경 쓸 필요 없는 것도 엄청난 장점같다.</p><p>그리고 혹시나 MDC도 정상적으로 동작하는지 궁금했다.<br>Webflux에서는 <a href="https://projectreactor.io/docs/core/release/reference/#context">Context</a>라는 것에 넣어야해서 매우 번거로웠던 기억이 있는데 한 번 MDC에 값을 넣는 인터셉터를 설정해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MdcInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response, <span class="keyword">final</span> Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        MDC.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HandlerInterceptor.<span class="built_in">super</span>.preHandle(request, response, handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MdcInterceptor mdcInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebMvcConfiguration</span><span class="params">(<span class="keyword">final</span> MdcInterceptor mdcInterceptor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mdcInterceptor = mdcInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(<span class="keyword">final</span> InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(mdcInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-interceptor.png" class="" title="Interceptor에 진입했을 때부터 Virtual Thread를 사용하는 걸 볼 수 있다.">  <p>우리가 위에서 <code>protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor())</code>로 세팅을 해놨기 때문에 요청을 받아들이는 부분부터 Virtual Threads를 사용하기 때문에 당연히 Interceptor에서도 Virtual Threads를 사용하게 된다.  </p><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-logging.png" class="" title="Controller에서도 Interceptor와 동일한 Virtual Thread를 사용하는 걸 볼 수 있다.">  <p>동일한 Virtual Thread이기 때문에 ThreadLocal 값인 MDC의 값이 그대로 유지되는 걸 볼 수 있다.  </p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2022-12-29T05:35:27.085+09:00  INFO 12707 --- [               ] c.e.p.controller.MdcController           : MDC.a: a</span><br></pre></td></tr></table></figure><p>참고로 Virtual Thread이기 때문에 쓰레드의 이름은 찍히지 않는다.</p><p>그리고 아래와 같이 @Async 어노테이션에서 사용할 쓰레드 풀에도 Virtual Thread를 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">asyncTaskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TaskExecutorAdapter</span>(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@Async 어노테이션을 사용했을 때는 MDC가 어떻게 동작하는지 한 번 살펴보자.</p><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-mdc-interceptor.png" class="" title="Interceptor에 진입했을 때부터 Virtual Thread를 사용하는 걸 볼 수 있다."><img src="/2022/12/29/look-over-java-virtual-threads/virtual-threads-async-thread.png" class="" title="Async Thread에서는 Interceptor에서 사용한 Virtual Thread와 다른 Virtual Thread를 사용하는 걸 볼 수 있다."><p>Virtual Thread가 달라졌기 때문에 ThreadLocal 값인 MDC의 값은 유지되지 않는 걸 볼 수 있다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2022-12-29T05:55:02.257+09:00  INFO 14591 --- [               ] c.e.p.controller.VirtualThreadService    : MDC.a: null</span><br></pre></td></tr></table></figure><p>이는 Platform Threads를 사용했을 때도 마찬가지이므로 <a href="https://blog.gangnamunni.com/post/mdc-context-task-decorator/">MDCTaskDecorator</a> 같은 걸 만들면 쉽게 해결할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MdcTaskDecorator</span> <span class="keyword">implements</span> <span class="title class_">TaskDecorator</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Runnable <span class="title function_">decorate</span><span class="params">(<span class="keyword">final</span> Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; mdcContext = MDC.getCopyOfContextMap();</span><br><span class="line">        <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(mdcContext != <span class="literal">null</span>)&#123;</span><br><span class="line">                MDC.setContextMap(mdcContext);</span><br><span class="line">            &#125;</span><br><span class="line">            runnable.run();</span><br><span class="line"></span><br><span class="line">            MDC.clear();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME)</span></span><br><span class="line"><span class="keyword">public</span> Executor <span class="title function_">asyncTaskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TaskExecutorAdapter</span> <span class="variable">taskExecutorAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskExecutorAdapter</span>(Executors.newVirtualThreadPerTaskExecutor());</span><br><span class="line">    taskExecutorAdapter.setTaskDecorator(<span class="keyword">new</span> <span class="title class_">MdcTaskDecorator</span>());</span><br><span class="line">    <span class="keyword">return</span> taskExecutorAdapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="코틀린과의-호환성"><a href="#코틀린과의-호환성" class="headerlink" title="코틀린과의 호환성"></a>코틀린과의 호환성</h4><p>코틀린 최신 버전인 1.8.0에서 JDK 19를 지원하긴 하지만, JDK 19에서도 Preview Features인 Virtual Threads를 코틀린으로 한 번 더 컴파일까지 거쳐야하면 의도대로 동작한다는 보장이 없어서 아직은 시기상조인 것 같다.</p><h3 id="주의사항"><a href="#주의사항" class="headerlink" title="주의사항"></a>주의사항</h3><p>아무리 Virtual Threads가 기존 코드와의 호환성을 최대한 지켰다고는 하지만 100% 호환성을 가진 건 아니다.<br>코드가 돌아가는 측면에서는 호환성을 지켰을지 몰라도 아래 주의사항 같은 걸 지키지 않으면 시스템에 심각한 성능저하를 유발할 수도 있다.</p><p><a href="https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads">Coming to Java 19: Virtual threads and platform threads</a>의 마지막 부분인 Three pieces of practical advice 파트를 눈여겨보면 된다.</p><ul><li><p>Virtual Threads를 풀링하지 말고 Semaphore를 사용해라.<br>Virtual Threads는 생성 비용도 굉장히 싸기 때문에 굳이 풀링할 필요가 없고, 기존 방식대로 풀링하게 되면 Virtual Threads가 아닌 Platform Threads를 아마 사용하게 되는 것 같다.<br>따라서 만약 풀링해야하는 일이 있다면 Semaphore 방식을 권장하고 있다.</p></li><li><p>synchronized 키워드를 사용해서 Carrier Thread까지 Blocking 되는 현상(이걸 보고 Thread가 Pinning 됐다고 말하는 듯)을 피해라</p><blockquote><p>Fortunately, future work may make synchronization nonpinning.</p></blockquote></li></ul><p>다만 추후에는 synchronized 키워드를 사용해도 쓰레드가 pinning 되는 현상은 사라질 듯 하다.  </p><ul><li>쓰레드 로컬을 조심해서 사용해라<br>Virtual Thread는 굉장히 많은 갯수일 수 있다보니 어디선가 오염이 될 수 있다는 뜻인가? 이건 왜 얘기한 건지 모르겠음.</li></ul><h2 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h2><p>기존의 비동기 모델이 거의 끝판왕이라고 생각하고 성능을 얻으려면 코드의 퀄리티는 포기해야할 줄 알았는데 이렇게 내가 생각한 한계를 깨부시는 아키텍처가 나오는 걸 보면 정말 흥미롭다.<br>얼른 Virtual Threads를 실무에서 사용할 날이 왔으면 좋겠는데 <a href="https://openjdk.org/jeps/428">JEP 428: Structured Concurrency</a>, <a href="https://openjdk.org/jeps/429">JEP 429: Scoped Values</a>까지 완료시키려면 한참 멀었나… 싶다.<br>다음 LTS인 JDK 21(2023&#x2F;09월에 릴리즈)에 포함되면 참 좋을 것만 같다.  </p><h2 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h2><p>해당 포스트는 아래 링크들을 참고하여 짜집기한 글이므로 보다 자세한 정보들은 아래 링크를 참고하는 걸 추천한다.</p><ul><li><a href="https://blogs.oracle.com/javamagazine/post/java-loom-virtual-threads-platform-threads">Coming to Java 19: Virtual threads and platform threads</a></li><li><a href="https://www.infoq.com/articles/java-virtual-threads/">Virtual Threads: New Foundations for High-Scale Java Applications</a></li><li><a href="https://theboreddev.com/understanding-java-virtual-threads/">Understanding Java Virtual Threads – The Death of Async Programming</a></li><li><a href="https://www.infoworld.com/article/3678148/intro-to-virtual-threads-a-new-approach-to-java-concurrency.html">Intro to virtual threads: A new approach to Java concurrency</a></li><li><a href="https://www.baeldung.com/java-virtual-thread-vs-thread">Difference Between Thread and Virtual Thread in Java</a></li><li><a href="https://spring.io/blog/2022/10/11/embracing-virtual-threads">Embracing Virtual Threads</a></li><li><a href="https://homoefficio.github.io/2020/12/11/Java-Concurrency-Evolution/">Java Concurrency Evolution</a></li><li><a href="http://gunsdevlog.blogspot.com/2020/09/java-project-loom-reactive-streams.html">Java의 동시성 개선을 위한 Project Loom은 reactive streams를 대체할 것인가?</a></li><li><a href="https://jakewharton.com/report-card-java-19-and-the-end-of-kotlin/#virtual-threads">Report card: Java 19 and the end of Kotlin</a></li><li><a href="https://blog.gangnamunni.com/post/mdc-context-task-decorator/">Spring 의 동기, 비동기, 배치 처리시 항상 context 를 유지하고 로깅하기</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Java의 &lt;a href=&quot;https://openjdk.org/jeps/425&quot;&gt;Virtual Threads&lt;/a&gt;는 JDK 19에 &lt;a href=&quot;https://openjdk.org/jeps/12&quot;&gt;Preview Features&lt;/a&gt;로 추가되었다.&lt;br&gt;&lt;a href=&quot;https://wiki.openjdk.org/display/loom/Main&quot;&gt;프로젝트 룸(Loom)&lt;/a&gt;에서 개발한 기능으로 알고있는데 사실 큰 관심도 없던(뭐하는 지도 모르던) 프로젝트였고, JDK 19가 LTS도 아니기 때문에 회사에서 바로 써볼 수도 없기에 JDK 19는 큰 관심도 가지고 있지 않았다.&lt;br&gt;하지만 최근 스프링 블로그에서 &lt;a href=&quot;https://spring.io/blog/2022/10/11/embracing-virtual-threads&quot;&gt;Embracing Virtual Threads&lt;/a&gt; 라는 포스트가 올라온 걸 보고 살짝 관심 가지게 되었다.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc&quot;&gt;Spring Web MVC&lt;/a&gt;와 같이 전형적인 1 Request per 1 Thread 모델의 한계(쓰레드 자체가 많은 메모리를 소비하고, 컨텍스트 스위칭에 따른 불필요한 시간 소요 등등)를 극복하기 위해&lt;br&gt;&lt;a href=&quot;https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#spring-webflux&quot;&gt;Spring Webflux&lt;/a&gt;(가 의존하는 &lt;a href=&quot;https://netty.io/&quot;&gt;Netty&lt;/a&gt;)에서는 코어 갯수 * 2개만의 쓰레드를 만듦으로 인해 그 한계를 극복하였지만 하나의 요청을 하나의 쓰레드가 온전히 처리하는 것이 아니기 때문에 스택트레이스를 봐도 파편화된 정보가 남아 트러블 슈팅에 문제가 있었고,&lt;br&gt;&lt;a href=&quot;https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html&quot;&gt;Mono&lt;/a&gt;나 &lt;a href=&quot;https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html&quot;&gt;Flux&lt;/a&gt;와 같은 Publisher 타입으로 값을 감싸야 하기 때문에 코드가 매우 보기 힘들고, 어디서 쓰레드를 블락하는 코드를 호출하는 건 아닌지 항상 불안에 떨었어야했다.  &lt;/p&gt;
&lt;p&gt;그러다보니 Webflux가 더 고성능을 보장하더라도 유지보수하기가 힘들고 러닝커브 또한 존재하기 때문에 어지간한 경우가 아니면 Web MVC로 프로젝트를 만들었다.&lt;br&gt;사실 프로덕션에서 RDBMS를 안 쓰는 곳이 거의 없는데 &lt;a href=&quot;https://r2dbc.io/&quot;&gt;R2DBC&lt;/a&gt;를 사용하기에는 너무 불안정해 보이기도 했고, 그리고 TPS가 안 나오면 대부분 스케일 아웃하는 형태로 해결을 많이 했다.&lt;br&gt;서버보다는 사람이 가장 비싼 자원이라고 생각되기에 유지보수 측면으로만 생각하다보니 Webflux는 거의 사용한 적이 없는 것 같다.&lt;br&gt;결정적으로 Web MVC(Spring Boot를 사용한다면 톰캣의 최대 쓰레드인 200개)만으로도 부족함이 없는 서비스도 많았고, 단일 서버가 아닌 이중화 등등으로 인해 서버가 다중으로 뜨기에 Webflux를 써야할 만큼의 처리를 단일서버에서 하지 않는 경우가 대다수였다.  &lt;/p&gt;
&lt;p&gt;그럼에도 불구하고 Virtual Threads는 어떠한 문제를 해결해주는 것인지, Spring과 함께 사용하면 어떤 시너지를 낼 수 있을지 궁금해서 살짝만 훑어보았다.&lt;/p&gt;
&lt;h2 id=&quot;Platform-Threads&quot;&gt;&lt;a href=&quot;#Platform-Threads&quot; class=&quot;headerlink&quot; title=&quot;Platform Threads&quot;&gt;&lt;/a&gt;Platform Threads&lt;/h2&gt;</summary>
    
    
    
    <category term="Note" scheme="https://perfectacle.github.io/categories/Note/"/>
    
    <category term="Java" scheme="https://perfectacle.github.io/categories/Note/Java/"/>
    
    
    <category term="Java" scheme="https://perfectacle.github.io/tags/Java/"/>
    
    <category term="Spring" scheme="https://perfectacle.github.io/tags/Spring/"/>
    
    <category term="Spring Boot" scheme="https://perfectacle.github.io/tags/Spring-Boot/"/>
    
    <category term="Virtual Threads" scheme="https://perfectacle.github.io/tags/Virtual-Threads/"/>
    
    <category term="Loom" scheme="https://perfectacle.github.io/tags/Loom/"/>
    
  </entry>
  
  <entry>
    <title>히카리 CP에서 다양한 시간 설정해보기</title>
    <link href="https://perfectacle.github.io/2022/09/25/hikari-cp-time-config/"/>
    <id>https://perfectacle.github.io/2022/09/25/hikari-cp-time-config/</id>
    <published>2022-09-25T17:06:17.000Z</published>
    <updated>2025-12-09T17:06:50.206Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://spring.io/projects/spring-boot">Spring Boot 2</a>에서 제공하는 RDB 관련 의존성을 추가하면 DB의 커넥션 풀을 관리하기 위해 기본적으로 사용하는 <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>는 시간 관련해서 다양한 설정들이 있다.<br>하지만 그냥 설명하는 것만 봐서는 무슨 내용인지 헷갈리는 설명들이 있어서 요번에 프로젝트에 도입된 설정들을 포함해 몇가지 정리를 해보았다.</p><h2 id="maxLifeTime"><a href="#maxLifeTime" class="headerlink" title="maxLifeTime"></a>maxLifeTime</h2><blockquote><p>⏳maxLifetime<br>  This property controls the maximum lifetime of a connection in the pool.<br>  An in-use connection will never be retired, only when it is closed will it then be removed.<br>  On a connection-by-connection basis, minor negative attenuation is applied to avoid mass-extinction in the pool.<br>  We strongly recommend setting this value, and it should be several seconds shorter than any database or infrastructure imposed connection time limit.<br>  A value of 0 indicates no maximum lifetime (infinite lifetime), subject of course to the idleTimeout setting.<br>  The minimum allowed value is 30000ms (30 seconds). Default: 1800000 (30 minutes)</p></blockquote><p>커넥션 풀에서 idle 커넥션이 최대 얼마동안 생존할 수 있냐는 설정이다. (단위는 ms, 기본값은 30분, 최소값은 30초, 0으로 설정하면 무제한)<br>반환될 때마다 idle time은 다시 0으로 초기화 될테니 트래픽이 많이 들어와서 커넥션이 계속 사용되는 서비스라면 이 설정에 의해 커넥션이 종료될 일은 적을 것이다.</p><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (maxLifeTime: 30000ms(30s))  participant C1 as Connection 1 (current idle time: 20s)  participant C2 as Connection 2 (current idle time: 15s)    Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; C1: getConnection()  C1 -&gt;&gt; Hikari:  Connection 1  Hikari -&gt;&gt; Server: Connection 1  Server -&gt;&gt; Hikari: releaseConnection(Connection 1)  Hikari -&gt;&gt; C1: release (reset idle time to 0s)</code></pre><p>히카리 CP에서 커넥션을 가져오고 반납하는 과정을 대략적으로 그려보면 위와 같을 것이다.<br>커넥션 풀에 있는 idle 커넥션을 가져와서 사용하고 반납할 때는 idle time을 다시 0으로 초기화해서 반납하는 것이다.</p><p>위와 같은 상황에서 15초가 지났다고 할 때 어떻게 될까…??</p><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Hikari as HikariCP (maxLifeTime: 30000ms(30s))  participant C2 as Connection 2 (current idle time: 30s)  participant C1 as Connection 1 (current idle time: 15s)    Hikari -&gt;&gt; C2: close()  C2 -&gt;&gt; Hikari:  remove from Connection Pool</code></pre><p>HikariCP에서는 내부적으로 maxLifeTime에 도달한 idle conenection을 종료하고 커넥션 풀에서 제거하는 스케쥴러가 돌고 있다.<br>그리고 커넥션들이 동시에 종료돼서 성능 상 이슈를 유발하는 것을 방지하고자 각 커넥션 사이에 ms 단위의 차이를 두고 순차적으로 종료시키고 있다.<br>자세한 내용은 다음 블로그에 나와있다.<br><a href="https://pkgonan.github.io/2018/04/HikariCP-test-while-idle#hikaricp-%EA%B0%9C%EB%B0%9C%EC%9E%90%EB%8A%94-%EC%99%9C-test-while-idle%EC%9D%84-%EB%B0%98%EB%8C%80%ED%95%A0%EA%B9%8C">HikariCP는 test-while-idle과 같은 커넥션 갱신 기능이 없을까?</a></p><h3 id="maxLifeTime을-DBMS의-wait-timeout-보다-길게-설정한-경우"><a href="#maxLifeTime을-DBMS의-wait-timeout-보다-길게-설정한-경우" class="headerlink" title="maxLifeTime을 DBMS의 wait_timeout 보다 길게 설정한 경우"></a>maxLifeTime을 DBMS의 wait_timeout 보다 길게 설정한 경우</h3><p>maxLifeTime을 지나치게 길게 설정했거나 아무런 설정도 하지 않았을 경우에 가끔 아래와 같은 warn 로그를 보게 된다. (주로 트래픽이 없는 어드민 류의 서버에서 종종 발생했던 거 같다.)  </p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hikari-pool - Failed to validate connection com.mysql.cj.jdbc.ConnectionImpl@1e2db70 (No operations allowed after connection closed.).  </span><br><span class="line">Possibly consider using a shorter maxLifetime value.</span><br></pre></td></tr></table></figure><p>위 로그는 DB에 설정한 wait_timeout(DBMS마다 파라미터 이름은 다를 수 있다.) 보다 maxLifeTime을 길게 줬을 경우 발생할 수 있다. (여기서는 MySQL을 사용한다고 가정하고 설명한다.)<br>MySQL의 경우 아래와 같이 쿼리를 날려서 <a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_wait_timeout">wait_timeout</a>을 확인해볼 수 있다. (기본값은 28800(s)로 8시간이다.)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;wait_timeout&#x27;</span> </span><br></pre></td></tr></table></figure><p>MySQL의 wait_timeout 기본값은 8시간이고, maxLifeTime의 기본값은 30분이라서 발생하지 않을텐데 MySQL의 wait_timeout이 maxLifeTime 보다 짧을 때 어떻게 동작하는지 알아보자.</p><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (maxLifeTime: 600000ms(10m))  participant C1 as Connection 1 (current idle time: 5m)  participant C2 as Connection 2 (current idle time: 4m)  participant MySQL as MySQL (wait_timeout: 300s(5m))    MySQL -&gt;&gt; C1: close  Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; C1: getConnection()  C1 -&gt;&gt; Hikari:  failed to getConnection (already closed connection)  Hikari -&gt;&gt; C1: remove from connection pool  Hikari -&gt;&gt; C2: getConnection()  C2 -&gt;&gt; Hikari:  Connection 2  Hikari -&gt;&gt; Server: Connection 2</code></pre><p>MySQL에서는 wait_timeout에 도달한 idle connection을 끊어버린다.<br>하지만 MySQL은 해당 커넥션을 어떤 어플리케이션에서 사용하는지 모르니 해당 어플리케이션에도 커넥션을 사용하지 말라는 패킷을 보낼 수 없다.<br>따라서 우리가 짠 어플리케이션에는 HikariCP에 아직도 종료된 커넥션이 남아있는 것이다.<br>이 때 우리가 해당 커넥션을 풀에서 꺼내려고 하면 warn 로그가 뜨는 것이다.<br>하지만 warn 로그이기 때문에 유효한 connection을 제대로 획득했다면 서비스 장애로까지 전파되지는 않을 것이다. (connection 획득에 실패했으면 다른 에러로그가 찍혔을 것이다.)<br>따라서 warn 로그에 나와있는대로 maxLifeTime을 줄여야한다. (네트워크 지연 등등을 고려하여 wait_timeout 보다 2~3초 정도 짧게 잡아주는 걸 권장하는 것으로 알고 있다.)<br>위 warn 로그에 대한 내용도 다음 블로그에 자세하게 나와있다.<br><a href="https://jaehun2841.github.io/2020/01/08/2020-01-08-hikari-pool-validate-connection">HikariCP Failed to Validate Connection Warning 이야기</a></p><h2 id="connectionTimeout"><a href="#connectionTimeout" class="headerlink" title="connectionTimeout"></a>connectionTimeout</h2><blockquote><p>⏳connectionTimeout<br>  This property controls the maximum number of milliseconds that a client (that’s you) will wait for a connection from the pool.<br>  If this time is exceeded without a connection becoming available, a SQLException will be thrown.<br>  Lowest acceptable connection timeout is 250 ms. Default: 30000 (30 seconds)</p></blockquote><p>커넥션을 맺는데 걸리는 시간을 의미하며 이 시간은 단순히 하나의 물리적인 커넥션을 맺는데 걸리는 시간을 의미하는 게 아니라 <a href="https://github.com/brettwooldridge/HikariCP/blob/dev/src/main/java/com/zaxxer/hikari/pool/HikariPool.java#L136-L176">커넥션 풀에서 커넥션을 획득하는데 걸리는 시간</a>을 의미한다.</p><h3 id="더이상-커넥션을-맺지-못하는-상황에-도달했는데-connectionTimeout-내에-유효한-커넥션을-획득하지-못하는-경우"><a href="#더이상-커넥션을-맺지-못하는-상황에-도달했는데-connectionTimeout-내에-유효한-커넥션을-획득하지-못하는-경우" class="headerlink" title="더이상 커넥션을 맺지 못하는 상황에 도달했는데 connectionTimeout 내에 유효한 커넥션을 획득하지 못하는 경우"></a>더이상 커넥션을 맺지 못하는 상황에 도달했는데 connectionTimeout 내에 유효한 커넥션을 획득하지 못하는 경우</h3><p>커넥션 풀에 유효한 커넥션이 없으면 새로운 커넥션을 맺게 되는데 maximumPoolSize 등에 도달하는 등의 상황에 의해 더이상 커넥션을 맺지 못하게 될 가능성이 있다.<br>이런 상황에 어떻게 되는지 한 번 살펴보자.</p><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (connectionTimeout: 1100ms(1.1s), maximumPoolSize: 2)  participant C1 as Connection 1 (in use)  participant C2 as Connection 2 (in use)    Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; Hikari: wait 1.1s untill get available connection  Hikari -&gt;&gt; Server: throw SQLException(connection timeout)</code></pre><p>유효한 커넥션을 획득하지 못해 DB를 사용하지 못하는 상황이기 때문에 아마 해당 API는 제대로 처리하지 못하고, 이런 상황이 오래 유지되면 전면 장애도 발생할 수 있을 것이다.<br>이런 상황이 발생하는데는 아래와 같은 이유 등등이 있을 것이다.</p><ol><li>장기간 커넥션을 물고 있을만한 상황은 없는지?<ol><li>슬로우 쿼리가 발생해서 커넥션을 오래 물고 있는 커넥션은 없는지? 이런 경우 슬로우 쿼리의 원인을 찾아서 해결해야한다.<br>슬로우 쿼리 로그를 남기고 있지 않다면 access log 등등을 통해 당시 오래 걸렸던 API를 찾는다던지 해서 오래 걸리는 쿼리의 explain을 떠서 원인도 분석해보자. (올바른 index를 타지 않아 풀 텍스트 스캔을 돌고 있었다던지…?) </li><li>롱 트랜잭션(트랜잭션 안에서 외부 API 호출과 같이 오래 걸리는 작업을 한다던지)으로 인해 커넥션을 오래 유지하고 있다던지?<br>트랜잭션의 범위를 최소화하여야한다.<br>하나의 큰 트랜잭션이 아닌 작은 범위의 트랜잭션으로 잘게 쪼개고, 각 트랜잭션을 보장할 수 있도록 별도의 상태를 더 두고 수동 롤백 전략(롤백 코드 직접 작성)을 취해야할 수도 있다.</li><li>OSIV(Open Session In View)에 의해 커넥션을 과도하게 물고있는 것은 아닌지…?<br>스프링 부트 1부터 2까지 <a href="https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/orm/jpa/JpaBaseConfiguration.java#L213">OSIV는 기본값으로 활성화</a> 돼있다.<br>그리고 Spring Data JPA에서 Hibernate를 사용할 경우 Hibernate의 기본값을 덮어씌우는 것들이 존재한다.<br>Spring Boot 2.x의 Spring Data JPA에서 기본적으로 사용하는 Hibernate 5.2+의 <a href="https://github.com/hibernate/hibernate-orm/blob/5.2/hibernate-core/src/main/java/org/hibernate/resource/transaction/backend/jta/internal/JtaTransactionCoordinatorBuilderImpl.java#L39-L42">커넥션 핸들링 전략(PhysicalConnectionHandlingMode)</a>은 <a href="https://github.com/hibernate/hibernate-orm/blob/5.2/hibernate-core/src/main/java/org/hibernate/resource/jdbc/spi/PhysicalConnectionHandlingMode.java#L42">DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT</a>이다. (최대한 커넥션을 늦게 획득하고 트랜잭션이 종료되기 전에도 SQL 문이 하나 종료될 때마다 커넥션을 반납하는 전략)<br>하지만 Spring Boot 2.x에서는 Hibernate의 기본값을 무시하고 <a href="https://github.com/spring-projects/spring-framework/blob/5.3.x/spring-orm/src/main/java/org/springframework/orm/jpa/vendor/HibernateJpaVendorAdapter.java#L159-L162">DELAYED_ACQUISITION_AND_HOLD로 덮어씌우고</a> 있다. (최대한 커넥션을 늦게 획득하고 요청이 끝나는 시점인 엔티티매니저가 close 되는 시점에 커넥션풀에 커넥션을 반납하는 전략)<br>위 전략은 DELAYED_ACQUISITION이기 때문에 엔티티 매니저가 생성되는 시점인 컨트롤러가 요청을 받는 시점에는 커넥션을 획득하지 않는다.<br>커넥션이 정말 필요한 트랜잭션을 만난다던지, 쿼리를 날려야하는 상황이 올 때만 비로소 커넥션을 획득한다.<br>그리고 트랜잭션이 끝나거나 단건 쿼리가 종료됐음에도 불구하고 Lazy 로딩된 엔티티를 언제 조회하게 될지 모르기 때문에 커넥션을 다시 반납하지 않는 것 같다.<br>하지만 이로 인해 커넥션을 과도하게 오래 물고 있을 수 있기 때문에 커넥션 풀 고갈을 유발해서 장애가 발생할 수 있다.<br>따라서 OSIV를 킨 상황에서는 PhysicalConnectionHandlingMode를 DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION(최대한 늦게 획득하고 트랜잭션 종료 즉시 반납)을 설정하는 게 커넥션 풀 고갈을 방지할 수 있다.<br>근본적으로 OSIV를 비활성화 시키면 굳이 PhysicalConnectionHandlingMode를 따로 설정할 필요가 없지만 이미 운영중인 서비스의 OSIV를 비활성화 시키면 런타임에 언제 장애(<a href="https://docs.jboss.org/hibernate/core/3.5/api/org/hibernate/LazyInitializationException.html">LazyInitializationException</a>)를 맞을지 모르니 추천하지 않는다.</li></ol></li><li>커넥션풀 사이즈(maximumPoolSize)를 너무 작게 유지한 건 아닌지?<br>내가 생각하기에는 트래픽이 얼마 안 들어올 줄 알고 DB 자원을 아끼려고 커넥션풀 사이즈를 작게 잡았는데 이로 인해 커넥션풀 고갈이 생각보다 빨리 발생할 수 있다.<br>평상시 트래픽&#x2F;피크 시간의 트래픽 추이를 분석해서 적절한 사이즈를 지정해주자 (물론 단일 서버로 서비스할 때는 계산하기 쉽겠지만 여러 서버에서 서비스하면 좀 더 복합적인 요소를 계산해야할 것이다.)</li><li>connectionTimeout을 너무 짧게 유지한 건 아닌지?<br>예제에서는 1.1초(1초 안에 DB 서버에서 syn+ack가 오지 않으면 OS 레벨에서 TCP Syn Retransmission을 하기 때문에 한 번 정도 TCP 3Way Handshake를 더 하게 된다, 물론 OS 설정에 따라 Retransmission 주기는 다르지만 대부분의 리눅스는 1초였던 걸로 기억한다.)로 지정했다.<br>하지만 어플리케이션 서버와 DB 서버의 네트워크가 불안정하거나 물리적 거리가 멀다던지, 아니면 그다지 빠른 응답을 보장할 필요가 없는 서비스(내부 스케쥴러에서 돈다던지)라면 connectionTimeout을 늘리는 것도 고려해보아야한다.</li></ol><h2 id="validationTimeout"><a href="#validationTimeout" class="headerlink" title="validationTimeout"></a>validationTimeout</h2><blockquote><p>⏳validationTimeout<br>  This property controls the maximum amount of time that a connection will be tested for aliveness.<br>  This value must be less than the connectionTimeout.<br>  Lowest acceptable validation timeout is 250 ms. Default: 5000</p></blockquote><p>커넥션의 유효성(사용 가능한 상태인지)을 검사하는데 걸리는 최대 마지노선 시간이라고 보면 된다. (기본값은 5초이고, 최소값은 250ms)<br>그리고 connectionTimeout 보다 짧게 유지해야한다고 하는데 HikariCP의 커넥션 유효성 검증 전략을 우선 짚고 이해해야한다.</p><p>다른 DB Connection Pool에서는 idle connection을 계속 유지하려고 select 1과 같은 무의미한 쿼리를 지속적으로 날려서 커넥션을 유지한다.<br>HikariCP에서는 이런 것조차 오버헤드(여러 대의 서버에서 여러 커넥션이 주기적으로 쿼리를 날리면 생각보다 오버헤드가 클 수도 있다.)라고 판단하는 듯하다. (관련 이슈: <a href="https://github.com/brettwooldridge/HikariCP/issues/766">https://github.com/brettwooldridge/HikariCP/issues/766</a>)<br>따라서 HikariCP에서는 주기적으로 쿼리를 날리지 않는다.<br>대신 <a href="https://github.com/brettwooldridge/HikariCP/blob/2.4.x/src/main/java/com/zaxxer/hikari/pool/PoolBase.java#L142-L148">JDBC4 이상의 드라이버를 사용한다면 단순한 validation 패킷 정도만 날리는 것</a>만으로도 커넥션의 유효성을 검사할 수 있다.  </p><p>아래 상황에 대해서 커넥션의 유효성을 검사한 이후에 아직 커넥션이 끊기지 않은 상태이니 사용 가능한 커넥션이라 판단해서 풀에 남기던지, 아니면 제거하던지 하게 된다.</p><ol><li>커넥션을 DB에서 새로 맺을 때</li><li>커넥션 풀에서 커넥션을 획득할 때</li><li>커넥션의 idle time이 keepaliveTime에 도달했을 때</li></ol><p>참고로 validationTimeout이 발생하면 <code>Failed to validate connection com.mysql.cj.jdbc.ConnectionImpl@63123dfa (No operations allowed after connection closed.). Possibly consider using a shorter maxLifetime value.</code> 요런 warn 로그가 발생하곤 한다.<br>해당 로그 이후에 커넥션 획득에 실패했다는 에러 로그 같은 게 남지 않았으면 서비스가 장애까지 이어지지 않았다고 판단하면 된다.<br>저 로그 이후 connectionTimeout 이내에 유효한 커넥션을 획득했으니 에러로그가 남지 않았을 거다.<br>validationTimeout은 정말 작은 패킷을 주고 받기 때문에 어지간해서 발생하지 않는데 아래 상황에 발생할 수 있다.<br>다만 warn이기 때문에 너무 자주 발생하는 게 아니면 즉각 조치가 필요하지는 않을 것 같고, noise라고 느껴질 정도로 과하게 느껴지면 connectionTimeout과 validationTimeout을 함께 조금씩 늘려보는 것도 고려해보아야한다.</p><ol><li>네트워크가 불안정하거나</li><li>DB 서버에서 어떤 사유에 의해 연결을 먼저 끊은 상황이거나</li><li>물리적으로 거리가 먼데 비해 과도하게 짧게 잡았거나</li></ol><p>근데 connectionTimeout과 validationTimeout은 어떤 상관관계가 있기에 validationTimeout을 더 짧게 설정하라는 걸까?  </p><h3 id="validationTimeout이-connectionTimeout-보다-짧지-않은-경우"><a href="#validationTimeout이-connectionTimeout-보다-짧지-않은-경우" class="headerlink" title="validationTimeout이 connectionTimeout 보다 짧지 않은 경우"></a>validationTimeout이 connectionTimeout 보다 짧지 않은 경우</h3><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (connectionTimeout: 1100ms(1.1s), validationTimeout: 1100ms(1.1s))  participant C1 as Connection 1 (idle)  participant C2 as Connection 2 (idle)    Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; C1: getConnection()  C1 -&gt;&gt; Hikari:  after validationTimeout(1.1s), failed to getConnection (Failed to validate connection)  Hikari -&gt;&gt; C1: remove from connection pool  Hikari -&gt;&gt; Server: throw SQLException(connection timeout)</code></pre><p>validationTimeout이 connectionTimeout 보다 짧지 않기 때문에 오롯이 커넥션 하나가 살아있는지 확인하느라 시간을 다 쓸 수 있다.<br>빠르게 validation을 멈추고 다음 커넥션 획득을 시도했더라면 성공할 수도 있지 않았을까…??</p><h3 id="validationTimeout이-connectionTimeout-보다-짧은-경우"><a href="#validationTimeout이-connectionTimeout-보다-짧은-경우" class="headerlink" title="validationTimeout이 connectionTimeout 보다 짧은 경우"></a>validationTimeout이 connectionTimeout 보다 짧은 경우</h3><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (connectionTimeout: 1100ms(1.1s), validationTimeout: 1000ms(1s))  participant C1 as Connection 1 (idle)  participant C2 as Connection 2 (idle)    Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; C1: getConnection()  C1 -&gt;&gt; Hikari:  after validationTimeout(1s), failed to getConnection (Failed to validate connection)  Hikari -&gt;&gt; C1: remove from connection pool  Hikari -&gt;&gt; C2: getConnection()  C2 -&gt;&gt; Hikari:  Connection 2  Hikari -&gt;&gt; Server: Connection 2</code></pre><p>위에 얘기했던대로 validationTimeout을 너무 과하게 잡아서 다른 커넥션 획득 시도의 기회조차 잃어버릴 수 있기 때문에<br>이를 방지하고자 validationTimeout이 connectionTimeout 보다 짧게 설정하면 커넥션 획득 시도를 여러 번 할 수 있기 때문에 장애를 방지할 수도 있다.<br>하지만 그렇다고 해서 connectionTimeout을 너무 길게 잡으면 우리 시스템은 온전히 처리했지만 클라이언트 측 시스템에서 Read Timeout이 발생할 수 있으니 이 부분은 상황에 맞게 설정해야한다.</p><h2 id="keepaliveTime"><a href="#keepaliveTime" class="headerlink" title="keepaliveTime"></a>keepaliveTime</h2><blockquote><p>⏳keepaliveTime<br>  This property controls how frequently HikariCP will attempt to keep a connection alive, in order to prevent it from being timed out by the database or network infrastructure.<br>  This value must be less than the maxLifetime value.<br>  A “keepalive” will only occur on an idle connection.<br>  When the time arrives for a “keepalive” against a given connection, that connection will be removed from the pool, “pinged”, and then returned to the pool.<br>  The ‘ping’ is one of either: invocation of the JDBC4 isValid() method, or execution of the connectionTestQuery.<br>  Typically, the duration out-of-the-pool should be measured in single digit milliseconds or even sub-millisecond, and therefore should have little or no noticible performance impact.<br>  The minimum allowed value is 30000ms (30 seconds), but a value in the range of minutes is most desirable. Default: 0 (disabled)</p></blockquote><p>idle connection에 대해서 keepaliveTime에 도달하면 주기적으로 커넥션의 유효성을 검증한다. (최소값은 30분, 기본값은 비활성화(0)이다.)<br>커넥션이 살아있다고 해도 idle time이 0으로 초기화 되는 건 아니고 그냥 커넥션이 잘 살아있는지 확인하는 것 뿐이다.  </p><p>idle connection은 다양한 사유에 의해 DB 서버로부터 먼저 커넥션이 끊길 수 있다.  </p><ol><li>maxLifeTime이 DBMS의 wait_timeout 보다 긴 경우</li><li>DB 서버의 리소스 부족 등등으로 인해 불필요한 idle 커넥션을 종료시키는 경우</li></ol><h3 id="keepaliveTime을-설정하지-않은-경우"><a href="#keepaliveTime을-설정하지-않은-경우" class="headerlink" title="keepaliveTime을 설정하지 않은 경우"></a>keepaliveTime을 설정하지 않은 경우</h3><p>위와 같이 DB 서버에서 먼저 커넥션을 끊은 경우 아래와 같은 오버헤드가 발생할 수 있다.</p><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (keepaliveTime: 0(disabled))  participant C1 as Connection 1 (closed)  participant C2 as Connection 2 (idle)    Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; C1: getConnection()  C1 -&gt;&gt; Hikari:  failed to getConnection (already closed connection)  Hikari -&gt;&gt; C1: remove from connection pool  Hikari -&gt;&gt; C2: getConnection()  C2 -&gt;&gt; Hikari:  Connection 2  Hikari -&gt;&gt; Server: Connection 2</code></pre><p>Connection 1은 이미 종료됐기 때문에 굳이 커넥션 획득을 할 필요가 없었다.<br>하지만 HikariCP는 그 사실을 모르기 때문에 Connection 1 획득 절차가 끼어들게 되고 이 시간만큼 지연이 발생해서 혹시 connectionTimeout이 발생한다고 하면 장애가 발생할 수도 있다.</p><h3 id="keepaliveTime을-설정한-경우"><a href="#keepaliveTime을-설정한-경우" class="headerlink" title="keepaliveTime을 설정한 경우"></a>keepaliveTime을 설정한 경우</h3><p>keepaliveTime을 설정하지 않았을 때의 문제는 커넥션이 종료됐다는 사실을 트래픽을 받은 시점에 알게 된다는 것이다.<br>트래픽을 받았을 때는 최대한 빠른 응답성을 보장해야하는데 저런 자잘한 것들로 인해 빠른 응답성을 보장하지 못하거나 장애를 유발할 수도 있게 된다. (간헐적일 수도 있겠지만…)  </p><p>그럼 keepaliveTime을 설정했을 때 어떤 장점이 있는지 알아보자.</p><pre><code class="highlight mermaid">sequenceDiagram  autonumber  participant Server  participant Hikari as HikariCP (keepaliveTime: 30000ms (30s))  participant C1 as Connection 1 (closed)  participant C2 as Connection 2 (idle)    Hikari -&gt;&gt; C1: isConnectionAlive (when keepaliveTime is up)   C1 -&gt;&gt; Hikari:  Failed to validate connection (already closed connection)  Hikari -&gt;&gt; C1: remove from connection pool  Server -&gt;&gt; Hikari: getConnection()  Hikari -&gt;&gt; C2: getConnection()  C2 -&gt;&gt; Hikari:  Connection 2  Hikari -&gt;&gt; Server: Connection 2</code></pre><p>트래픽을 받기 전부터 Connection 1의 종료사실을 인지하고 커넥션 풀에서 제거했기 때문에 트래픽이 들어왔을 때는 바로 유효한 커넥션인 Conenction 2부터 획득을 시도했다.<br>사소하고 찰나의 시간으로 인식할 수도 있지만 대용량 트래픽에서 이런 것들이 쌓이게 됐을 때 힘을 발휘할 수 있을 것 같다.<br>또한 DB에 뭔가 문제가 있다는 상황, 혹은 네트워크가 불안정하다는 상황을 트래픽을 받은 시점이 아닌 미리 파악할 수 있다는 장점도 존재한다.<br>서버가 엄청 많이 떠있는 서버는 keepaliveTime을 너무 짧게 설정하면 오히려 그게 오버헤드를 유발할 수도 있기 때문에 적절한 튜닝이 필요한 것 같다.</p><h2 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h2><p>처음에는 maxLifeTime과 connectionTimeout 정도만 신경썼는데 DevOps(SRE 겸임) 개발자 분께서 올려주신 PR을 보고 저 설정은 도대체 무엇일까… 하고 고민하면서<br>질문하고 공부하면서 정리한 내용이 머릿속으로는 어느정도 있었는데 그림으로 한 번 그려보니 어떤 상황에 문제가 있고 어떤 문제를 해결하는지 좀 더 명쾌해진 것 같다.<br>아직 보지도 못한 설정들도 많을텐데 이런식으로 정복해나가면 그래도 조금이나마 더 나은 엔지니어가 되지 않을까? 싶다. </p><h2 id="참조-링크"><a href="#참조-링크" class="headerlink" title="참조 링크"></a>참조 링크</h2><ul><li><a href="https://github.com/brettwooldridge/HikariCP">HikarCP Github</a></li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_wait_timeout">MySQL Server System Variables</a></li><li><a href="https://pkgonan.github.io/2018/04/HikariCP-test-while-idle#hikaricp-%EA%B0%9C%EB%B0%9C%EC%9E%90%EB%8A%94-%EC%99%9C-test-while-idle%EC%9D%84-%EB%B0%98%EB%8C%80%ED%95%A0%EA%B9%8C">HikariCP는 test-while-idle과 같은 커넥션 갱신 기능이 없을까?</a></li><li><a href="https://jaehun2841.github.io/2020/01/08/2020-01-08-hikari-pool-validate-connection">HikariCP Failed to Validate Connection Warning 이야기</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://spring.io/projects/spring-boot&quot;&gt;Spring Boot 2&lt;/a&gt;에서 제공하는 RDB 관련 의존성을 추가하면 DB의 커넥션 풀을 관리하기 위해 기본적으로 사용하는 &lt;a href=&quot;https://github.com/brettwooldridge/HikariCP&quot;&gt;HikariCP&lt;/a&gt;는 시간 관련해서 다양한 설정들이 있다.&lt;br&gt;하지만 그냥 설명하는 것만 봐서는 무슨 내용인지 헷갈리는 설명들이 있어서 요번에 프로젝트에 도입된 설정들을 포함해 몇가지 정리를 해보았다.&lt;/p&gt;
&lt;h2 id=&quot;maxLifeTime&quot;&gt;&lt;a href=&quot;#maxLifeTime&quot; class=&quot;headerlink&quot; title=&quot;maxLifeTime&quot;&gt;&lt;/a&gt;maxLifeTime&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;⏳maxLifetime&lt;br&gt;  This property controls the maximum lifetime of a connection in the pool.&lt;br&gt;  An in-use connection will never be retired, only when it is closed will it then be removed.&lt;br&gt;  On a connection-by-connection basis, minor negative attenuation is applied to avoid mass-extinction in the pool.&lt;br&gt;  We strongly recommend setting this value, and it should be several seconds shorter than any database or infrastructure imposed connection time limit.&lt;br&gt;  A value of 0 indicates no maximum lifetime (infinite lifetime), subject of course to the idleTimeout setting.&lt;br&gt;  The minimum allowed value is 30000ms (30 seconds). Default: 1800000 (30 minutes)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;커넥션 풀에서 idle 커넥션이 최대 얼마동안 생존할 수 있냐는 설정이다. (단위는 ms, 기본값은 30분, 최소값은 30초, 0으로 설정하면 무제한)&lt;br&gt;반환될 때마다 idle time은 다시 0으로 초기화 될테니 트래픽이 많이 들어와서 커넥션이 계속 사용되는 서비스라면 이 설정에 의해 커넥션이 종료될 일은 적을 것이다.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;highlight mermaid&quot;&gt;sequenceDiagram
  autonumber
  participant Server
  participant Hikari as HikariCP (maxLifeTime: 30000ms(30s))
  participant C1 as Connection 1 (current idle time: 20s)
  participant C2 as Connection 2 (current idle time: 15s)
  
  Server -&amp;gt;&amp;gt; Hikari: getConnection()
  Hikari -&amp;gt;&amp;gt; C1: getConnection()
  C1 -&amp;gt;&amp;gt; Hikari:  Connection 1
  Hikari -&amp;gt;&amp;gt; Server: Connection 1
  Server -&amp;gt;&amp;gt; Hikari: releaseConnection(Connection 1)
  Hikari -&amp;gt;&amp;gt; C1: release (reset idle time to 0s)&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Note" scheme="https://perfectacle.github.io/categories/Note/"/>
    
    <category term="DB" scheme="https://perfectacle.github.io/categories/Note/DB/"/>
    
    
    <category term="MySQL" scheme="https://perfectacle.github.io/tags/MySQL/"/>
    
    <category term="HikariCP" scheme="https://perfectacle.github.io/tags/HikariCP/"/>
    
    <category term="DB" scheme="https://perfectacle.github.io/tags/DB/"/>
    
  </entry>
  
  <entry>
    <title>TDD는 Design Acitivity이다.</title>
    <link href="https://perfectacle.github.io/2022/06/06/tdd-is-design-activity/"/>
    <id>https://perfectacle.github.io/2022/06/06/tdd-is-design-activity/</id>
    <published>2022-06-06T14:39:22.000Z</published>
    <updated>2025-12-09T17:06:50.365Z</updated>
    
    <content type="html"><![CDATA[<p>1~2년 전 쯤 존경하는 개발자 분과 함께 <a href="http://www.mockobjects.com/2009/09/brief-history-of-mock-objects.html">A Brief History of Mock Objects</a>라는 아티클을 함께 본 적이 있다.<br>개인적으로 이렇게 특정 개념의 근본이 된다던지, 해당 분야의 대가들이 쓴 아티클들을 함께 보는 것으로 인해 굉장히 많은 인사이트들이 생겼던 것 같다.<br>객체의 테스트 때문에 추가했던 getter로부터의 해방을 위해 고민하던 것으로 시작한 게 Mock의 탄생이라는 사실을 알게 되었을 때는 정말 위대한 탄생이라고 생각했다.  </p><p>그리고 문득 시간이 지나 해당 아티클을 다시 보고 싶어졌다. (물론 해당 아티클은 <a href="https://www.yes24.com/Product/Goods/9008455">테스트 주도 개발로 배우는 객체 지향 설계와 실천</a> 책의 후기에 한글로 적혀있다.)<br>아티클을 보던 중에 후반 부분에 Mock과 관련해서 <a href="http://jmock.org/oopsla2004.pdf">Mock Roles, not Objects</a>라는 논문까지 썼다는 걸 보고 해당 논문까지 봐야 Mock에 대해 정확한 이해를 할 수 있을 것 같아 해당 논문을 보게 되었다.<br>그리고 목의 역사와 마찬가지로 해당 논문도 너무나 감명이 깊어 한 번 느낀점이나 내용을 정리해보고 싶었다.</p><h2 id="Writing-tests-is-a-design-activity"><a href="#Writing-tests-is-a-design-activity" class="headerlink" title="Writing tests is a design activity"></a>Writing tests is a design activity</h2><p>먼저 TDD(Test Driven Development)에는 크게 두 가지 관점이 존재할 것 같다.  </p><p>첫 번째로 “검증”이다.<br>코드들이 의도대로 동작하는지, 버그는 없는지 검증하는 것이다.<br>이를 통해 프로덕션에 코드를 내보내도 된다는 자신감이 올라가고, 리팩토링을 하거나 신규 기능을 추가하더라도 코드의 동작은 변하지 않았음에 확신을 가질 수 있다.  </p><p>두 번째로 “설계”이다.<br>나의 코드를 검증하려고 테스트를 짜려고 하는데 테스트를 짜기가 힘들다면 “Code Smell”이 난다고 할 수 있다. (코드에 뭔가 구린 내가 나는 것이다.)<br>이를 통해 적절한 책임을 가진 객체로 쪼갬으로 인해 더 나은 설계로 유도해낼 수 있을 것이다.</p><p>나는 첫 번째 목적인 검증에 좀 더 집중했다.<br>더 나은 설계도 물론 중요하지만 일단 버그가 없는 게 “1순위”라고 생각했기 때문이다.<br>하지만 그러다보니 TDD를 하려고 할 때, 즉 신규 기능을 구현할 때 테스트를 먼저 짜려고 할 때 어디서부터 코드를 짜야할지, 뭘 테스트해야할지 막막했다.<br>아직 검증할 게 없는데 뭘 검증한단 말인가?<br>그래서 번번이 테스트부터 짜보겠다는 실패로 돌아가고, 코드를 짠 후에 내가 코드를 제대로 짰는지 검증하는 목적으로 테스트를 나중에 작성했다.  </p><p>나의 이런 TDD는 접근 방법부터 잘못됐던 것 같다.<br>Test “Driven” Development면 테스트가 (나의 어플리케이션 코드를) 주도해야하는데 전혀 주도하고 있지 못했다.<br>자꾸 나의 어플리케이션 코드를 테스트에 끼워맞출 생각(어떻게 이 부분을 검증할까)만 하고 있다보니 단순히 “테스트만 먼저 짜면 TDD다”라고 생각했던 것 같다.<br>물론 “검증” 또한 포기할 수 없는 부분이다.<br>하지만 여기에 너무 매몰되다보니 결국 테스트가 나의 코드를 주도하게 하지 못하게 됐던 것 같다.  </p><p>그러다보니 이렇게 논문까지 쓰고 TDD의 대가라고 부를 법한 사람들은 무슨 생각을 가지고 실제로 TDD를 어떻게 수행하는지 너무나 궁금했다.<br>논문을 보니 내가 생각했던 관점과 완전 다른 관점을 가지고 있었다. </p><blockquote><p>Writing tests is a design activity,<br>…<br>This changes design from a process of <strong><em>invention</em></strong>,<br>where the developer thinks hard about what a unit of code should do and then implements it,<br>to a process of <strong><em>discovery</em></strong>,<br>where the developer adds small increments of functionality and then extracts structure from the working code.<br>…<br>Using TDD has many benefits but the most relevant is that<br>it directs the programmer to think about the design of code from its intended use,<br>rather than from its implementation.</p></blockquote><p>테스트를 작성하는 것은 Design Activity(설계 행위)이며,<br>Design Activity는 design(코드의 설계)을 발명(invention)의 과정(어떤 코드가 무엇을 해야하고 어떻게 구현해야할지)에서 발견(discovery)의 과정(조그만 기능을 추가하고 동작하는 코드로부터 구조를 추출하는)으로 바꾼다고 설명하고 있다.<br>번역이 매끄럽지는 않지만 대충 어떤 뉘앙스인지 생각해보면 발명이라는 건 어떤 걸 만들어야겠다는 명확한 목표를 가지고 있는 것이고, 발견이라는 것은 명확한 목표를 가지고 있기 보다는 추상적인 무언가를 떠오르고 탐색하던 과정 중에 튀어나오는 것이 아닐까 싶다.<br>따라서 전자의 관점으로 설계를 하게 되면 어떤 일을 어떻게 해야하는 객체들이 명확하게 정의돼있다보니 설계가 매우 딱딱하게 강결합이 될 것이다.<br>이는 코드의 구조를 바꾸기 어렵다는 것을 뜻하며 구체적인 타입으로 확정짓는 것을 뜻하는 것 같다.<br>하지만 후자의 관점으로 설계를 하게 되면 무엇을 만들긴 해야하는데 아직 어떻게 해야하는지 명확하게 정의된 게 없다보니 두루뭉실하게 “이런 객체가 필요하지 않을까?”라는 작은 발견의 과정(작은 기능의 추가)을 반복해서 수행해나가다보니 설계가 유연하게 약결합 될 것이다.<br>이는 코드의 구조를 바꾸기 쉽다는 것을 뜻하며 추상적인 타입(인터페이스)를 사용한다는 것을 뜻하는 것 같다.  </p><p>그리고 TDD에는 많은 이점들이 존재하지만 가장 중요한 건 개발자의 사고를 (구체적인) 구현이 아니라 코드의 설계에 대해 생각하도록 “지시”한다는 것이라고 한다.<br>이러한 지시를 통해 내 코드가 테스트에 의해 “주도”되는 것이 아닐까 싶다.<br>즉, 테스트가 내 코드를 주도하려면(테스트에 의한 개발이 되려면) 이러한 지시를 따라야하고, 이는 검증이 아닌 “설계”를 테스트의 주된 목적이라고 생각해야 달성 가능한 목표같다.</p><h2 id="Need-Driven-Development"><a href="#Need-Driven-Development" class="headerlink" title="Need-Driven Development"></a>Need-Driven Development</h2><p>그럼 TDD가 Design Activity라는 것은 알았는데 어떻게 더 나은 설계를 만들 것인가…?<br>나는 그 답은 Need-Driven Development(Top-Down Development)를 통해 달성할 수 있다고 믿는다.  </p><blockquote><p>A core principle of Lean Development is that value should be pulled into existence from demand,<br>rather than pushed from implementation:<br>“The effect of ‘pull’ is that production is not based on forecast;<br>commitment is delayed until demand is present to indicate what the customer really wants.”</p></blockquote><p>영어를 잘 하지 못해 뉘앙스를 정확히 이해한 건지는 모르겠지만, Lean Development(개발 프로세스에서 비효율 적인 부분을 제거한 방법론 정도로 알고 있다.)의 핵심 원칙은 존재하는 요구사항(existence from demand)에서 가치를 뽑아와야한다(be pulled)는 것 같다.<br>예측에 의해 뭔가를 만들어내기 보다는 “고객이 정말로 원하는 것”이 실제로 나타낼 때까지 commitment(뭔가를 확정짓는…?)를 계속 뒤로 미루라는 것 같다.<br>고객도 자신이 무엇을 원하는지 정확히 모르기 때문에 요구사항이 명확해질 때까지 계속 요구사항을 명쾌하게 만들어나가는 과정이 필요한 것 같다.</p><img src="/2022/06/06/tdd-is-design-activity/Richard's_guide_to_software_development.png" class="" title="아무도 쓰지 않는데 개발자만 좋아하는 소프트웨어"><p>“혹시 이런 기능도 필요하지 않을까?”라고 생각하다 보면 위와 같은 형태의 소프트웨어가 나오게 될 가능성이 높을 것이다.</p><p>결국 “정말 필요한 기능”만 개발하라는 것인데 어떻게 해야하는 것일까…??</p><blockquote><p>By testing an object in isolation,<br>the programmer is forced to consider an object’s interactions with its collaborators in the abstract,<br>possibly before those collaborators exist.<br>TDD with Mock Objects guides interface design by the services that an object requires,<br>not just those it provides.<br>This process results in a system of narrow interfaces each of which defines a role in an interaction between objects,<br>rather than wide interfaces that describe all the features provided by a class.<br>We call this approach Need-Driven Development.</p></blockquote><p>단위 테스트에서 개발자는 객체와 협력객체 사이의 상호작용을 신경쓰도록 강요된다.<br>그것또한 추상적인 레벨에서 이루어지는데 왜냐하면 협력 객체들은 아직 존재도 하기 전이기 때문이다.<br>왜냐하면 TDD에 의해 테스트를 먼저 작성하고, Need-Driven Development에 의해 불필요한 객체는 아직 생성도 하기 전이기 때문이다.<br>이 시점에서 협력 객체는 커녕 아직 테스트하고자 하는 객체도 만들어지기 이전이다.<br>Mock Object로 TDD를 하는 건 단순히 객체가 제공하는 것 뿐만이 아니라 해당 객체가 필요로 하는 요구사항에 의해 인터페이스 설계를 가이드 한다.<br>이런 과정을 통해 narrow 인터페이스를 가진 시스템이 나오게 된다.<br>여기서 narrow한 인터페이스란 건 객체 사이의 상호작용에서 특정 역할만 수행한다는 것을 의미한다는 것 같다.<br>반면에 wide한 인터페이스는 여기저기서 사용할 수 있는 걸 뜻하며 하는 일이 굉장히 많은 객체를 뜻하는 것 같다.<br>이런 접근법을 Need-Driven Devlopment라고 부른다는데 좀 더 자세한 예시는 아래 나오게 된다.</p><img src="/2022/06/06/tdd-is-design-activity/ndd-01.png" class="" title="인터페이스의 발견"><blockquote><p>To fulfil the needs of A, we discover that it needs a service S.<br>While testing A, we mock the responsibilities of S without defining a concrete implementation.</p></blockquote><p>A의 요구사항을 만족시키기 위해 S라는 서비스가 필요하다는 걸 발견(discovery)하게 된다.<br>이 때 S의 구체적인 구현을 정의하는 것이 아니라 해당 책임을 모킹한다.</p><img src="/2022/06/06/tdd-is-design-activity/ndd-02.png" class="" title="반복적인 인터페이스 발견 절차"><blockquote><p>Once we have implemented A to satisfy its requirements we can switch focus and implement an object that performs the role of S<br>…<br>This process will then discover services required by B,<br>which we again mock out until we have finished our implementation of B</p></blockquote><p>A의 요구사항 구현이 모두 끝났으면 이제 S의 “역할”을 수행하는 객체를 구현하는 것에 집중할 수 있다.<br>이제 B(S의 역할을 수행하는)가 필요로하는 서비스를 발견하는 절차들이 진행된다.<br>그리고 B의 구현이 끝날 때까지 그런 서비스들은 모킹하게 된다.</p><img src="/2022/06/06/tdd-is-design-activity/ndd-03.png" class="" title="객체 간의 협력 그래프"><blockquote><p>Our experience is that systems we produce this way tend towards very flat class hierarchies.<br>This avoids well-known problems, such as the Fragile Base Class,<br>which make systems harder to understand and modify.</p></blockquote><p>이런 식으로 필요한 객체와 역할들을 발견(탐색)해 나가는 과정에서 매우 flat한 클래스 계층이 나온다고 한다.<br>이는 깨지기 쉬운(Fragile) Base Class 문제를 피할 수도 있다.<br>많은 클래스들이 해당 클래스에 의존하는 구조가 아니라 인접한 객체끼리만 관계를 맺고 있기 때문이 아닐까 싶다.<br>또한 상속이 아닌 인터페이스를 사용하고 있기 때문에 인터페이스가 바뀌지 않는 한 부모 객체에 영향을 받지 않는 것도 한 몫 하는 것 같다. (자바8의 인터페이스는 부모 인터페이스에 기본 구현체(default method)가 존재할 수 있긴 하지만…)  </p><blockquote><p>This process is similar to traditional Top-Down Development,<br>in which the programmer starts at the highest level of abstraction and proceeds, layer by layer, to fill in the detail.<br>The intention is that each layer of code is written in a coherent terminology,<br>defined in terms of the next level of abstraction</p></blockquote><p>Need-Driven Development는 전통적인 Top-Down Development와도 유사한데<br>Top-Down Development에서는 가장 높은 레벨의 추상화에서 시작해서 구체적인 내용을 구현하기 위해 계층 별로 접근하게 된다.<br>각 계층의 코드는 다음 단계의 추상화에 정의된 “일관된 용어”로 작성된다.<br>핵심은 “일관된 용어로 정의된다”는 것에 있는 것 같다.<br>이는 일관된 추상화 수준을 뜻하는 게 아닐까?</p><blockquote><p>Programming from the Bottom-Up has different risks.<br>All the authors have had the experience of developing a supporting class in isolation,<br>as part of a larger task,<br>only to find that the result was not right because we had misunderstood something.</p></blockquote><p>반면 Bottom-up으로 프로그래밍 하는 건 다른 리스크를 가지고 있다. (논문에서 Top-Down은 각 레이어에서 중복을 야기한다는 리스크를 명시하고 있다.)<br>독립된 환경에서 개발해봤는데 뭔가 잘못 이해하고 개발한 게 있어서 결과가 올바르지 않은 걸 발견했다는 것이다.<br>아마 이게 필요하지 않을까? 나는 이거까지 책임져야하지 않을까? 하고 예측을 기반으로 각자 개발을 하다보니 나중에 객체 간의 협력을 해야할 때 뭔가 미묘하게 안 맞는 부분이 계속 생겼던 게 아닐까 싶다.</p><p><a href="https://www.nomachetejuggling.com/2012/08/10/need-driven-development/">Need-Driven Development</a>이라는 아티클을 보면 Need-Driven Development(Top-Down)과 Bottom-up의 차이가 좀 더 명확히 느껴질 것이다.</p><h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>TDD는 단순히 테스트를 “먼저” 작성하는 게 아니라 테스트가 내 코드를 “주도”하게 만들어야하는 것 같다.<br>그럼 좀 더 테스트가 막강한 권력을 가지고 테스트가 내 코드를 어떠한 길로 인도(guide)해야하는 것 같다.<br>좀 더 강하게는 강제(force)하거나 지시(direct)를 내려야하는 것 같다.<br>나는 멍청하고 테스트가 내 코드가 어떻게 구현해야하는지 명령을 내리는 것이다.</p><p>그런 관점에서 보면 단순 “검증”만으로는 뭔가 부족했던 것 같다.<br>그걸 모르고 계속 TDD 거리니 매번 실패 했던 게 아닐까 싶다.</p><p>해당 논문을 읽고 나니 “Design Activity”가 무엇인지, 요구사항이 왜 중요한 것인지 좀 더 알게 된 거 같다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;1~2년 전 쯤 존경하는 개발자 분과 함께 &lt;a href=&quot;http://www.mockobjects.com/2009/09/brief-history-of-mock-objects.html&quot;&gt;A Brief History of Mock Objects&lt;/a&gt;라는 아티클을 함께 본 적이 있다.&lt;br&gt;개인적으로 이렇게 특정 개념의 근본이 된다던지, 해당 분야의 대가들이 쓴 아티클들을 함께 보는 것으로 인해 굉장히 많은 인사이트들이 생겼던 것 같다.&lt;br&gt;객체의 테스트 때문에 추가했던 getter로부터의 해방을 위해 고민하던 것으로 시작한 게 Mock의 탄생이라는 사실을 알게 되었을 때는 정말 위대한 탄생이라고 생각했다.  &lt;/p&gt;
&lt;p&gt;그리고 문득 시간이 지나 해당 아티클을 다시 보고 싶어졌다. (물론 해당 아티클은 &lt;a href=&quot;https://www.yes24.com/Product/Goods/9008455&quot;&gt;테스트 주도 개발로 배우는 객체 지향 설계와 실천&lt;/a&gt; 책의 후기에 한글로 적혀있다.)&lt;br&gt;아티클을 보던 중에 후반 부분에 Mock과 관련해서 &lt;a href=&quot;http://jmock.org/oopsla2004.pdf&quot;&gt;Mock Roles, not Objects&lt;/a&gt;라는 논문까지 썼다는 걸 보고 해당 논문까지 봐야 Mock에 대해 정확한 이해를 할 수 있을 것 같아 해당 논문을 보게 되었다.&lt;br&gt;그리고 목의 역사와 마찬가지로 해당 논문도 너무나 감명이 깊어 한 번 느낀점이나 내용을 정리해보고 싶었다.&lt;/p&gt;
&lt;h2 id=&quot;Writing-tests-is-a-design-activity&quot;&gt;&lt;a href=&quot;#Writing-tests-is-a-design-activity&quot; class=&quot;headerlink&quot; title=&quot;Writing tests is a design activity&quot;&gt;&lt;/a&gt;Writing tests is a design activity&lt;/h2&gt;&lt;p&gt;먼저 TDD(Test Driven Development)에는 크게 두 가지 관점이 존재할 것 같다.  &lt;/p&gt;
&lt;p&gt;첫 번째로 “검증”이다.&lt;br&gt;코드들이 의도대로 동작하는지, 버그는 없는지 검증하는 것이다.&lt;br&gt;이를 통해 프로덕션에 코드를 내보내도 된다는 자신감이 올라가고, 리팩토링을 하거나 신규 기능을 추가하더라도 코드의 동작은 변하지 않았음에 확신을 가질 수 있다.  &lt;/p&gt;</summary>
    
    
    
    <category term="Test" scheme="https://perfectacle.github.io/categories/Test/"/>
    
    
    <category term="TDD" scheme="https://perfectacle.github.io/tags/TDD/"/>
    
    <category term="mock" scheme="https://perfectacle.github.io/tags/mock/"/>
    
    <category term="test" scheme="https://perfectacle.github.io/tags/test/"/>
    
    <category term="design" scheme="https://perfectacle.github.io/tags/design/"/>
    
  </entry>
  
  <entry>
    <title>(Tomcat) ClientAbortException은 왜 발생할까? (Part 2)</title>
    <link href="https://perfectacle.github.io/2022/03/20/client-abort-exception-deep-dive-part-02/"/>
    <id>https://perfectacle.github.io/2022/03/20/client-abort-exception-deep-dive-part-02/</id>
    <published>2022-03-20T10:30:19.000Z</published>
    <updated>2025-12-09T17:06:50.131Z</updated>
    
    <content type="html"><![CDATA[<p>서버에서 아주 가끔가다가 ClientAbortException(java.io.IOExceiption: Broken pipe)이 발생해서 어떨 때 발생하는지 딥다이브 해봄.</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stacktrace.png" class=""><p>적다보니 글이 길어져 글을 나누었는데 해당 글을 읽기 전에 <a href="/2022/03/20/client-abort-exception-deep-dive-part-01">(Tomcat) ClientAbortException은 왜 발생할까? (Part 1)</a>을 먼저 보는 것을 추천함.</p><hr><p><a href="https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html">https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html</a></p><blockquote><p>Extend IOException to identify it as being caused by an abort of a request by a remote client.</p></blockquote><p>외부 클라이언트 측에서 요청을 abort(중단) 시켰을 때 발생하는 예외로 보인다.<br>톰캣에서 발생시키는 예외인데 Spring Boot의 Web(Mvc) 모듈에서 기본적으로 사용하는 게 Embedded Tomcat이기 때문에 많은 분들께서 자주 마주치지 않았을까… 싶다.<br>구글링 해보면 뭐 브라우저 이슈(API 응답이 오기 전에 새로고침을 했다던가, 뒤로가기를 했다던가 등등)니 뭐니 하는데 내가 겪은 상황은 server → server 통신에서 발생한 것이기 때문에 서버 간의 통신 관점에서만 파보았다.</p><p>삽질을 해보고 싶은 사람은 <a href="https://github.com/perfectacle/client-abort-exception-playground">https://github.com/perfectacle/client-abort-exception-playground</a> 을 clone 하면 된다.</p><p>그리고 ClientAbortException이 발생해도 스프링에서 기본적으로 <a href="https://www.baeldung.com/exception-handling-for-rest-with-spring#exceptionresolver">HandlerExceptionResolver</a>에서 예외를 핸들링하기 때문에 로그에는 아무것도 남지 않는다.<br>따라서 해당 에러가 발생하는지 에러 로그로 명확히 확인해보는 게 훨씬 직관적이기 때문에 아래 @RestControllerAdvice를 추가했다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControllerAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = [Exception::class])</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">handleException</span><span class="params">(e: <span class="type">Exception</span>)</span></span>: ResponseEntity&lt;<span class="built_in">Void</span>&gt; &#123;</span><br><span class="line">        log.error(e.message, e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.internalServerError().build()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="N줄-요약"><a href="#N줄-요약" class="headerlink" title="N줄 요약"></a>N줄 요약</h1><ol><li>클라이언트가 응답 패킷을 받는 와중에 Read Timeout 시간을 초과하면<ol><li>각 응답 패킷의 시간 간격은 Read Timeout 안에 왔지만 모든 응답 패킷은 Read Timeout 안에 오지 않았다면<ol><li>Read Timeout의 의미는 모든 응답 패킷을 받는데까지 걸리는 시간이 아니라 각 응답 패킷 사이의 Timeout을 의미한다. (그래서 Apach HTTP Client는 오해의 소지를 줄이고자인지 socketTimeout이라고 부르고 있다.)</li><li>따라서 총 응답 패킷을 다 받는데까지는 Read Timeout에 설정한 시간을 초과해도 클라이언트&#x2F;서버 모두 아무런 오류가 발생하지 않는다.</li></ol></li><li>각 응답 패킷의 시간 간격이 Read Timeout 안에 오지 않은 경우<ol><li>Read Timeout의 의미는 각 응답 패킷 사이의 Timeout을 의미한다.</li><li>응답 패킷이 계속해서 잘 오다가 특정 패킷 하나만 Read Timeout을 초과하더라도 Read Timeout이 발생한다.</li><li>클라이언트 측에서 Read Timeout이 발생해서 소켓을 종료한 이후에도 <code>서버 측에서 응답 패킷을 보내면 ClientAbortException이 발생한다</code>.</li></ol></li></ol></li><li><a href="#ClientAbortException%EC%9D%84-%ED%95%B4%EA%B2%B0%ED%95%98%EB%A0%A4%EB%A9%B4">ClientAbortException을 해결하려면?</a></li><li>프로세스(메인 함수)가 종료되더라도 Passive Close로부터 FIN 패킷을 받지 않으면 클라이언트&#x2F;서버의 소켓은 닫히지 않는다. (오동작을 막기 위해 대기하는 것으로 알고 있음.)<br>하지만 Passive Close로부터 FIN 패킷이 아닌 다른 패킷이 오면 Active Close에서는 RST 패킷을 보낸 후 소켓을 닫는다.<br>60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨) 만큼) 동안 대기 후에도 Passive Close에게 아무런 패킷이 오지 않으면 Active Close는 RST 패킷을 보내고 소켓을 닫는다.<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mac (60_000ms)</span></span><br><span class="line">sysctl -a | grep net.inet.tcp.fin_timeout</span><br><span class="line">net.inet.tcp.fin_timeout: 60000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">linux alpine (60s)</span></span><br><span class="line">sysctl -a | grep net.ipv4.tcp_fin_timeout</span><br><span class="line">net.ipv4.tcp_fin_timeout = 60</span><br></pre></td></tr></table></figure></li><li>소켓이 정상 종료된 경우에 ACTIVE_CLOSE 측에서 소켓이 바로 사라지는 게 아니라 오동작을 막기 위해 TIME_WAIT 상태로 대기하다가 사라지게 되는데 그 전까지는 해당 소켓(로컬ip:로컬port, 서버ip:서버port 쌍)을 사용하지 못한다.<br>대기 시간은 대부분 60초(OS마다 다르지만 2 * MSL(Maximum Segment Lifetime, OS 커널 레벨에 하드코딩 돼있는데 대다수의 리눅스는 60로초 설정됨) 동안 대기 후에 사라지게 된다.<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mac (2 * msl = 2 * 15_000ms = 30_000ms)</span></span><br><span class="line">sysctl -a | grep net.inet.tcp.msl</span><br><span class="line">net.inet.tcp.msl: 15000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">linux alpine</span></span><br><span class="line">sysctl -a | grep msl</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">몇몇 linux os는 tcp_fin_timeout을 2*msl로 사용하는 os도 있다고 함. (alpine linux도 아무것도 안 나오는 거 보면 그런 거 같음)</span></span><br></pre></td></tr></table></figure></li><li>HTTP Client 구현체마다 다르겠지만 Apache HTTP Client의 경우 Keep-Alive를 사용한다고 했음에도 불구하고 요청이 정상적으로 처리되지 않는 경우(Read Timeout 발생, 500 Internal Sever Error 응답을 받는다던지… 모든 4xx, 5xx가 포함되는 건 아님)에는 커넥션을 커넥션 풀에 반납하지 않고(재사용하지 않고) 종료한다.</li></ol><h1 id="클라이언트가-응답-패킷을-받는-시간이-Read-Timout을-초과한-경우"><a href="#클라이언트가-응답-패킷을-받는-시간이-Read-Timout을-초과한-경우" class="headerlink" title="클라이언트가 응답 패킷을 받는 시간이 Read Timout을 초과한 경우"></a>클라이언트가 응답 패킷을 받는 시간이 Read Timout을 초과한 경우</h1><h2 id="1-각-응답-패킷의-시간-간격은-Read-Timeout-안에-왔지만-모든-응답-패킷은-Read-Timeout-안에-오지-않은-경우"><a href="#1-각-응답-패킷의-시간-간격은-Read-Timeout-안에-왔지만-모든-응답-패킷은-Read-Timeout-안에-오지-않은-경우" class="headerlink" title="1. 각 응답 패킷의 시간 간격은 Read Timeout 안에 왔지만 모든 응답 패킷은 Read Timeout 안에 오지 않은 경우"></a>1. 각 응답 패킷의 시간 간격은 Read Timeout 안에 왔지만 모든 응답 패킷은 Read Timeout 안에 오지 않은 경우</h2><p>서버 쪽 API에서 큰 응답을 준다고 가정</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LargeResponseController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/large&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">slow</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        log.info(<span class="string">&quot;request is arrived!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;done!&quot;</span>.repeat(<span class="number">1_000_000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>클라이언트 측은 응답을 받다가 끊어야하기 때문에 리드 타임아웃 설정을 25ms로 매우 짧게 설정함.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> readTimeout = Duration.ofMillis(<span class="number">25L</span>)</span><br><span class="line">    <span class="keyword">val</span> restTemplate = RestTemplate(</span><br><span class="line">        HttpComponentsClientHttpRequestFactory(</span><br><span class="line">            HttpClientBuilder</span><br><span class="line">                .create()</span><br><span class="line">                .setMaxConnPerRoute(<span class="number">100</span>)</span><br><span class="line">                .setMaxConnTotal(<span class="number">100</span>)</span><br><span class="line">                .setKeepAliveStrategy(DefaultConnectionKeepAliveStrategy())</span><br><span class="line">                .setDefaultRequestConfig(</span><br><span class="line">                    RequestConfig.custom().setSocketTimeout(readTimeout.toMillis().toInt()).build()</span><br><span class="line">                )</span><br><span class="line">                .build()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/large&quot;</span>, String::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] request is done!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 커넥션 풀에 있는 커넥션을 바로 종료하지 않기 위해 10초간 슬립</span></span><br><span class="line">    Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line">    println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] main function is done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="데모-영상"><a href="#데모-영상" class="headerlink" title="데모 영상"></a>데모 영상</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/BPnMAVpJnTI" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h3 id="클라이언트-로그-콘솔에-응답을-로깅하느라-짤림…"><a href="#클라이언트-로그-콘솔에-응답을-로깅하느라-짤림…" class="headerlink" title="클라이언트 로그 (콘솔에 응답을 로깅하느라 짤림…)"></a>클라이언트 로그 (콘솔에 응답을 로깅하느라 짤림…)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!do&quot;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;ne!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done&quot;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!d&quot;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;one!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!don&quot;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;e!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!done!&quot;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080] can be kept alive for 60.0 seconds</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: <span class="keyword">set</span> socket timeout to <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 1; route allocated: 1 of 100; total allocated: 1 of 100]</span></span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-20T06:<span class="number">56</span>:<span class="number">05.674</span>] request <span class="keyword">is</span> done!</span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-20T06:<span class="number">56</span>:<span class="number">15.679</span>] main function <span class="keyword">is</span> done!</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>06:56:05.670에 마지막 응답 패킷을 받음 (<code>06:56:05.670 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;e!done!done!done!done!done!done!done!done!done!done!don...</code>)</li><li>06:56:05.670에 커넥션을 종료하지 않고 커넥션 풀에 반납함 (Keep-Alive 설정에 따라 60초 동안 idle 상태의 커넥션이라도 보관함, <code>06:56:05.670 [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection released: [id: 0][route: &#123;&#125;-&gt;http://localhost:8080][total available: 1; route allocated: 1 of 100; total allocated: 1 of 100]</code>)</li><li>06:56:15.679에 메인함수 종료</li></ol><h3 id="서버-로그"><a href="#서버-로그" class="headerlink" title="서버 로그"></a>서버 로그</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.568</span>  INFO <span class="number">86561</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>] c.e.playground.LargeResponseController   : request <span class="keyword">is</span> arrived!</span><br></pre></td></tr></table></figure><ol><li>06:56:05.568에 요청 도착</li></ol><h3 id="패킷-로그-소켓-상태"><a href="#패킷-로그-소켓-상태" class="headerlink" title="패킷 로그 (소켓 상태)"></a>패킷 로그 (소켓 상태)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">231</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.565966</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">51612</span> → <span class="number">8080</span> [SYN] Seq=<span class="number">0</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">4237975396</span> TSecr=<span class="number">0</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">232</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.566176</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">8080</span> → <span class="number">51612</span> [SYN, ACK] Seq=<span class="number">0</span> Ack=<span class="number">1</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">3590453492</span> TSecr=<span class="number">4237975396</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">233</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.566202</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">4237975396</span> TSecr=<span class="number">3590453492</span></span><br><span class="line"><span class="number">234</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.566226</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">8080</span> → <span class="number">51612</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3590453492</span> TSecr=<span class="number">4237975396</span></span><br><span class="line"><span class="number">235</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.568288</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>HTTP<span class="number">274</span>GET /large HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">236</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.568329</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">51612</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3590453495</span> TSecr=<span class="number">4237975399</span></span><br><span class="line"><span class="number">237</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.582682</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">51612</span> [PSH, ACK] Seq=<span class="number">1</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3590453510</span> TSecr=<span class="number">4237975399</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">238</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.582700</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">51612</span> [PSH, ACK] Seq=<span class="number">8193</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3590453510</span> TSecr=<span class="number">4237975399</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">239</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.582717</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">51612</span> [PSH, ACK] Seq=<span class="number">16385</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3590453510</span> TSecr=<span class="number">4237975399</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">240</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.582730</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">51612</span> [PSH, ACK] Seq=<span class="number">24577</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3590453510</span> TSecr=<span class="number">4237975399</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">241</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.582740</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">219</span> Ack=<span class="number">8193</span> Win=<span class="number">400064</span> Len=<span class="number">0</span> TSval=<span class="number">4237975414</span> TSecr=<span class="number">3590453510</span></span><br><span class="line">...</span><br><span class="line"><span class="number">856</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.648652</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">12387</span><span class="number">8080</span> → <span class="number">51612</span> [PSH, ACK] Seq=<span class="number">4987837</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">12331</span> TSval=<span class="number">3590453575</span> TSecr=<span class="number">4237975479</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">857</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.648660</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">219</span> Ack=<span class="number">4987837</span> Win=<span class="number">250048</span> Len=<span class="number">0</span> TSval=<span class="number">4237975479</span> TSecr=<span class="number">3590453575</span></span><br><span class="line"><span class="number">858</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.653137</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">12387</span>[TCP Retransmission] <span class="number">8080</span> → <span class="number">51612</span> [PSH, ACK] Seq=<span class="number">4987837</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">12331</span> TSval=<span class="number">3590453579</span> TSecr=<span class="number">4237975479</span></span><br><span class="line"><span class="number">859</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.653169</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">219</span> Ack=<span class="number">5000168</span> Win=<span class="number">499008</span> Len=<span class="number">0</span> TSval=<span class="number">4237975483</span> TSecr=<span class="number">3590453575</span> SLE=<span class="number">4987837</span> SRE=<span class="number">5000168</span></span><br><span class="line"><span class="number">860</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.666381</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">219</span> Ack=<span class="number">5000168</span> Win=<span class="number">763648</span> Len=<span class="number">0</span> TSval=<span class="number">4237975497</span> TSecr=<span class="number">3590453575</span></span><br><span class="line"><span class="number">861</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">05.670136</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">219</span> Ack=<span class="number">5000168</span> Win=<span class="number">1025792</span> Len=<span class="number">0</span> TSval=<span class="number">4237975500</span> TSecr=<span class="number">3590453575</span></span><br><span class="line"><span class="number">866</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">16.068837</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">51612</span> → <span class="number">8080</span> [FIN, ACK] Seq=<span class="number">219</span> Ack=<span class="number">5000168</span> Win=<span class="number">1045248</span> Len=<span class="number">0</span> TSval=<span class="number">4237985900</span> TSecr=<span class="number">3590453575</span></span><br><span class="line"><span class="number">867</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">16.068992</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">51612</span> [ACK] Seq=<span class="number">5000168</span> Ack=<span class="number">220</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3590463996</span> TSecr=<span class="number">4237985900</span></span><br><span class="line"><span class="number">870</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">16.069677</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">51612</span> [FIN, ACK] Seq=<span class="number">5000168</span> Ack=<span class="number">220</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3590463996</span> TSecr=<span class="number">4237985900</span></span><br><span class="line"><span class="number">871</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">06</span>:<span class="number">56</span>:<span class="number">16.069725</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">51612</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">220</span> Ack=<span class="number">5000169</span> Win=<span class="number">1045248</span> Len=<span class="number">0</span> TSval=<span class="number">4237985900</span> TSecr=<span class="number">3590463996</span></span><br></pre></td></tr></table></figure><ol><li>231 ~ 233번 패킷은 TCP 3 Way Handshake (syn, syn&#x2F;ack, ack)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-tcp-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-02/tcp-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-tcp-3-way-handshake-socket-status.png" class=""></li><li>235번 패킷에서 클라이언트 → 서버로 HTTP 요청 패킷 전송 (06:56:05.568288)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-request-packet.png" class=""></li><li>236번 패킷에서 서버가 요청 잘 받았다고 클라이언트한테 ACK 패킷 전송 (06:56:05.568329)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-request-ack-packet.png" class=""></li><li>237번 패킷은 서버에서 온 응답인데 ACK를 받은 06:56:05.5<code>68</code>329에서 Read Timeout으로 설정한 <code>25</code>ms 이전에 도착함 (06:56:05.5<code>82</code>682)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-response-packet-01.png" class=""></li><li>238 ~ 240번 패킷은 서버에서 응답 패킷을 쪼개서 보내고 있음 (06:56:05.582700 ~ 06:56:05.582730)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-response-packet-02.png" class=""></li><li>241번 패킷은 클라이언트가 서버한테 응답 패킷 잘 받았다고 ACK 패킷을 보내고 있음 (06:56:05.582740)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-response-ack-packet-01.png" class=""></li><li>858번 패킷은 마지막 응답 패킷인데 패킷 유실 때문인지 재전송을 하고 있다. (06:56:05.653137)<br>원래 클라이언트가 생각했던 Read Timeout 25ms는 최초 ACK를 받은 06:56:05.5<code>68</code>329 시점부터 계산해보면 06:56:05.5<code>93</code>329이다.<br>근데 마지막 응답 패킷이 온 걸 보면 06:56:05.<code>653</code>137으로 실제로는 ACK를 받은 시점으로부터 85ms가 흘렀다.<br>즉, Read Timeout은 클라이언트의 모든 요청을 받은 시간이 아닌 각 응답 패킷을 받는데까지 걸리는 시간이다.<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-response-packet-03.png" class=""></li><li>859번 패킷에서 응답 패킷을 잘 받았다는 마지막 ACK 패킷을 서버에게 보내고 있다. (06:56:05.653169)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-send-http-response-ack-packet-02.png" class=""></li><li>866 ~ 871번 패킷은 TCP Connection Termination (FIN&#x2F;ACK&#x2F;FIN&#x2F;ACK)이다. (06:56:16.068837 ~ 06:56:16.069725)<br>클라이언트가 먼저 연결을 종료하겠다는 FIN 패킷을 보냈기 때문에 클라이언트가 Active Close<br>서버는 클라이언트로부터 FIN 패킷을 받았기 때문에 서버는 Passive Close가 됨<br>(무조건 클라이언트가 Active Close는 아니고 경우에 따라서 다름)<br>마지막 패킷을 받은 이후 10초 동안 메인 함수의 Thread.sleep을 했기 때문에 10초 이후에 메인 함수가 종료(프로세스가 종료)되면서 커넥션을 끊게 되는 것이다.<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-tcp-connection-termination.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-02/tcp-termination.png" class=""></li><li>소켓이 종료된 이후에 바로 해당 소켓이 사라지는 게 아니라 오동작을 막기 위해 30초(OS마다 다르지만 2 * MSL(Maximum Segment Lifetime, OS 커널 레벨에 하드코딩 돼있는데 대다수의 리눅스는 60로초 설정됨, 내가 쓰는 맥os는 30초)) 동안 TIME_WAIT 상태에서 대기를 함. (06:56:16)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-tcp-time-wait-socket-status.png" class=""></li><li>30초가 지나면 소켓이 사라지고 해당 소켓(로컬ip:로컬port, 서버ip:서버port 쌍)을 재사용 할 수 있다. (06:56:47)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/large-response-in-read-timeout-tcp-socket-status.png" class=""></li></ol><h2 id="2-각-응답-패킷의-시간-간격이-Read-Timeout-안에-오지-않은-경우"><a href="#2-각-응답-패킷의-시간-간격이-Read-Timeout-안에-오지-않은-경우" class="headerlink" title="2. 각 응답 패킷의 시간 간격이 Read Timeout 안에 오지 않은 경우"></a>2. 각 응답 패킷의 시간 간격이 Read Timeout 안에 오지 않은 경우</h2><p>서버 쪽 API에서 각 응답을 주는 패킷의 지연시간이 제각각이라고 가정</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StreamResponseController</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">val</span> executor = Executors.newCachedThreadPool()</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(<span class="string">&quot;/stream&quot;</span>)</span></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">stream</span><span class="params">()</span></span>: ResponseEntity&lt;ResponseBodyEmitter&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> emitter = ResponseBodyEmitter()</span><br><span class="line">      executor.execute &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100L</span>)</span><br><span class="line">            emitter.send(<span class="string">&quot;hello, once&quot;</span>, MediaType.TEXT_PLAIN)</span><br><span class="line">            log.info(<span class="string">&quot;hello, once&quot;</span>)</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">100L</span>)</span><br><span class="line">            emitter.send(<span class="string">&quot;hello, twice&quot;</span>, MediaType.TEXT_PLAIN)</span><br><span class="line">            log.info(<span class="string">&quot;hello, twice&quot;</span>)</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">500L</span>) <span class="comment">// 최대 지연 시간</span></span><br><span class="line">            emitter.send(<span class="string">&quot;hello, thrice&quot;</span>, MediaType.TEXT_PLAIN)</span><br><span class="line">            log.info(<span class="string">&quot;hello, thrice&quot;</span>)</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">100L</span>)</span><br><span class="line">            emitter.send(<span class="string">&quot;bye&quot;</span>, MediaType.TEXT_PLAIN)</span><br><span class="line">            log.info(<span class="string">&quot;bye&quot;</span>)</span><br><span class="line"></span><br><span class="line">            emitter.complete()</span><br><span class="line">         &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            emitter.completeWithError(e)</span><br><span class="line">            log.error(e.message, e)</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> ResponseEntity(emitter, HttpStatus.OK)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>클라이언트 측은 서버 측 응답 패킷의 최대 지연 시간보다 짧게 Read Timeout을 설정함.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> readTimeout = Duration.ofMillis(<span class="number">200L</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> restTemplate = RestTemplate(</span><br><span class="line">        HttpComponentsClientHttpRequestFactory(</span><br><span class="line">            HttpClientBuilder</span><br><span class="line">                .create()</span><br><span class="line">                .setMaxConnPerRoute(<span class="number">100</span>)</span><br><span class="line">                .setMaxConnTotal(<span class="number">100</span>)</span><br><span class="line">                .setKeepAliveStrategy(DefaultConnectionKeepAliveStrategy())</span><br><span class="line">                .setDefaultRequestConfig(</span><br><span class="line">                    RequestConfig.custom().setSocketTimeout(readTimeout.toMillis().toInt()).build()</span><br><span class="line">                )</span><br><span class="line">                .build()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/stream&quot;</span>, String::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] request is done!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 커넥션 풀에 있는 커넥션을 바로 종료하지 않기 위해 10초간 슬립</span></span><br><span class="line">    Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line">    println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] main function is done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="데모-영상-1"><a href="#데모-영상-1" class="headerlink" title="데모 영상"></a>데모 영상</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/k6o-3P3mwAY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h3 id="클라이언트-로그"><a href="#클라이언트-로그" class="headerlink" title="클라이언트 로그"></a>클라이언트 로그</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.248</span> [main] DEBUG org.springframework.web.client.RestTemplate - HTTP GET http:<span class="comment">//localhost:8080/stream</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.254</span> [main] DEBUG org.springframework.web.client.RestTemplate - Accept=[text/plain, application/json, application<span class="comment">/*+json, */</span>*]</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.282</span> [main] DEBUG org.apache.http.client.protocol.RequestAddCookies - CookieSpec selected: default</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.285</span> [main] DEBUG org.apache.http.client.protocol.RequestAuthCache - Auth cache not <span class="keyword">set</span> <span class="keyword">in</span> the context</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.285</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.289</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection leased: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 1 of 100; total allocated: 1 of 100]</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.290</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Opening connection &#123;&#125;-&gt;http:<span class="comment">//localhost:8080</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.293</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connecting to localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">55447</span>&lt;-&gt;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: <span class="keyword">set</span> socket timeout to <span class="number">200</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Executing request GET /stream HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Target auth state: UNCHALLENGED</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Proxy auth state: UNCHALLENGED</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; GET /stream HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept: text/plain, application/json, application<span class="comment">/*+json, */</span>*</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Host: localhost:<span class="number">8080</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.294</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Connection: Keep-Alive</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; User-Agent: Apache-HttpClient/<span class="number">4.5</span><span class="number">.13</span> (Java/<span class="number">1.8</span><span class="number">.0_322</span>)</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept-Encoding: gzip,deflate</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;GET /stream HTTP/1.1[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept: text/plain, application/json, application/*+json, */*[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Host: localhost:8080[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Connection: Keep-Alive[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;User-Agent: Apache-HttpClient/4.5.13 (Java/1.8.0_322)[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept-Encoding: gzip,deflate[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;HTTP/1.1 200 [\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;Transfer-Encoding: chunked[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;Date: Sun, 20 Mar 2022 01:04:13 GMT[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;Keep-Alive: timeout=60[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;Connection: keep-alive[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;b[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;hello, once[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.402</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &lt;&lt; HTTP/<span class="number">1.1</span> <span class="number">200</span> </span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.402</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &lt;&lt; Transfer-Encoding: chunked</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.402</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &lt;&lt; Date: Sun, <span class="number">20</span> Mar <span class="number">2022</span> <span class="number">01</span>:<span class="number">04</span>:<span class="number">13</span> GMT</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.402</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &lt;&lt; Keep-Alive: timeout=<span class="number">60</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.402</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &lt;&lt; Connection: keep-alive</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.404</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Connection can be kept alive <span class="keyword">for</span> <span class="number">60000</span> MILLISECONDS</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.406</span> [main] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.407</span> [main] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] <span class="keyword">as</span> <span class="string">&quot;application/octet-stream&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.506</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;c[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.507</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;hello, twice[\r][\n]&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.712</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;[read] I/O error: Read timed out&quot;</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.712</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Close connection</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.713</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Connection discarded</span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.713</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line"><span class="number">10</span>:<span class="number">04</span>:<span class="number">13.715</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;[read] I/O error: Socket closed&quot;</span></span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-20T10:<span class="number">04</span>:<span class="number">13.719</span>] request <span class="keyword">is</span> done!</span><br><span class="line">org.springframework.web.client.RestClientException: Error <span class="keyword">while</span> extracting response <span class="keyword">for</span> type [<span class="keyword">class</span> <span class="title class_">java</span>.<span class="title">lang</span>.<span class="title">String</span>] <span class="title">and</span> <span class="title">content</span> <span class="title">type</span> [<span class="title">application</span>/<span class="title">octet</span>-<span class="title">stream</span>]; <span class="title">nested</span> <span class="title">exception</span> <span class="title">is</span> <span class="title">java</span>.<span class="title">net</span>.<span class="title">SocketTimeoutException</span>: <span class="type">Read</span> <span class="title">timed</span> <span class="title">out</span></span><br><span class="line">at org.springframework.web.client.HttpMessageConverterExtractor.extractData(HttpMessageConverterExtractor.java:<span class="number">120</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">778</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:<span class="number">711</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:<span class="number">334</span>)</span><br><span class="line">at com.example.playground.StreamResponseRestTemplatePlaygroundKt.main(StreamResponseRestTemplatePlayground.kt:<span class="number">29</span>)</span><br><span class="line">at com.example.playground.StreamResponseRestTemplatePlaygroundKt.main(StreamResponseRestTemplatePlayground.kt)</span><br><span class="line">Caused <span class="keyword">by</span>: java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">171</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br><span class="line">at org.apache.http.impl.conn.LoggingInputStream.read(LoggingInputStream.java:<span class="number">84</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class="number">137</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class="number">153</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class="number">280</span>)</span><br><span class="line">at org.apache.http.impl.io.ChunkedInputStream.getChunkSize(ChunkedInputStream.java:<span class="number">261</span>)</span><br><span class="line">at org.apache.http.impl.io.ChunkedInputStream.nextChunk(ChunkedInputStream.java:<span class="number">222</span>)</span><br><span class="line">at org.apache.http.impl.io.ChunkedInputStream.read(ChunkedInputStream.java:<span class="number">183</span>)</span><br><span class="line">at org.apache.http.conn.EofSensorInputStream.read(EofSensorInputStream.java:<span class="number">135</span>)</span><br><span class="line">at java.io.FilterInputStream.read(FilterInputStream.java:<span class="number">133</span>)</span><br><span class="line">at java.io.PushbackInputStream.read(PushbackInputStream.java:<span class="number">186</span>)</span><br><span class="line">at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:<span class="number">284</span>)</span><br><span class="line">at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:<span class="number">326</span>)</span><br><span class="line">at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:<span class="number">178</span>)</span><br><span class="line">at java.io.InputStreamReader.read(InputStreamReader.java:<span class="number">184</span>)</span><br><span class="line">at java.io.Reader.read(Reader.java:<span class="number">140</span>)</span><br><span class="line">at org.springframework.util.StreamUtils.copyToString(StreamUtils.java:<span class="number">91</span>)</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.readInternal(StringHttpMessageConverter.java:<span class="number">96</span>)</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.readInternal(StringHttpMessageConverter.java:<span class="number">44</span>)</span><br><span class="line">at org.springframework.http.converter.AbstractHttpMessageConverter.read(AbstractHttpMessageConverter.java:<span class="number">199</span>)</span><br><span class="line">at org.springframework.web.client.HttpMessageConverterExtractor.extractData(HttpMessageConverterExtractor.java:<span class="number">114</span>)</span><br><span class="line">... <span class="number">5</span> more</span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-20T10:<span class="number">04</span>:<span class="number">23.725</span>] main function <span class="keyword">is</span> done!</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>10:04:13.294에 서버와 커넥션 맺음. (<code>10:04:13.294 [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established 127.0.0.1:55447&lt;-&gt;127.0.0.1:8080</code>)</li><li>10:04:13.295에 요청 전송 (<code>10:04:13.295 [main] DEBUG org.apache.http.headers - http-outgoing-0 &gt;&gt; ...</code>)</li><li>10:04:13.401에 첫 번째 응답이 옴 (대략 100ms 이후에 옴, <code>10:04:13.401 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;hello, once[\r][\n]&quot;</code>)</li><li>10:04:13.507에 두 번째 응답이 옴 (대략 100ms 이후에 옴, <code>10:04:13.507 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;hello, twice[\r][\n]&quot;</code>)</li><li>10:04:13.712에 Read Timeout 발생 (마지막 패킷이 온 이후로 정확히 우리가 설정한 200ms 후에 발생함, <code>10:04:13.712 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;[read] I/O error: Read timed out&quot;</code>)</li><li>10:04:13.712 ~ 10:04:13.715에 커넥션 종료 (Keep-Alive 설정했음에도 불구하고, 정상적인 응답을 받지 못했으면 커넥션을 종료함. <code>10:04:13.712 [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-0: Close connection</code>)</li><li>10:04:23.725에 메인함수 종료</li></ol><h3 id="서버-로그-1"><a href="#서버-로그-1" class="headerlink" title="서버 로그"></a>서버 로그</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401</span>  INFO <span class="number">54891</span> --- [pool-<span class="number">1</span>-thread-<span class="number">3</span>] c.e.playground.StreamResponseController  : hello, once</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.506</span>  INFO <span class="number">54891</span> --- [pool-<span class="number">1</span>-thread-<span class="number">3</span>] c.e.playground.StreamResponseController  : hello, twice</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">14.012</span>  INFO <span class="number">54891</span> --- [pool-<span class="number">1</span>-thread-<span class="number">3</span>] c.e.playground.StreamResponseController  : hello, thrice</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">14.118</span> ERROR <span class="number">54891</span> --- [pool-<span class="number">1</span>-thread-<span class="number">3</span>] c.e.playground.StreamResponseController  : java.io.IOException: Broken pipe</span><br><span class="line"></span><br><span class="line">org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:<span class="number">310</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:<span class="number">273</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:<span class="number">118</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.implFlush(StreamEncoder.java:<span class="number">297</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:<span class="number">141</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at java.io.OutputStreamWriter.flush(OutputStreamWriter.java:<span class="number">229</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at org.springframework.util.StreamUtils.copy(StreamUtils.java:<span class="number">148</span>) ~[spring-core-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:<span class="number">126</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:<span class="number">44</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:<span class="number">227</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:<span class="number">212</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:<span class="number">205</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:<span class="number">205</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.ResponseBodyEmitter.send(ResponseBodyEmitter.java:<span class="number">199</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at com.example.playground.StreamResponseController.stream$lambda-<span class="number">0</span>(StreamResponseController.kt:<span class="number">35</span>) ~[main/:na]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">750</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">Caused <span class="keyword">by</span>: java.io.IOException: Broken pipe</span><br><span class="line">at sun.nio.ch.FileDispatcherImpl.write0(Native Method) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:<span class="number">47</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:<span class="number">93</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.IOUtil.write(IOUtil.java:<span class="number">65</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:<span class="number">470</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:<span class="number">135</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:<span class="number">1376</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:<span class="number">766</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:<span class="number">719</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:<span class="number">709</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:<span class="number">573</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:<span class="number">157</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:<span class="number">221</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:<span class="number">1255</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:<span class="number">402</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.Response.action(Response.java:<span class="number">209</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:<span class="number">306</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">... <span class="number">17</span> common frames omitted</span><br></pre></td></tr></table></figure><ol><li>10:04:13.401에 첫 번째 응답 전송</li><li>10:04:13.506에 두 번째 응답 전송 (100ms 지연)</li><li>10:04:14.012에 세 번째 응답 전송 (500ms 지연)</li><li>10:04:14.118에 <code>ClientAbortException(java.io.IOException: Broken pipe)</code> 발생</li><li>소켓이 종료된 상태에서 “bye”라는 응답 패킷을 전송하려다 발생함.</li></ol><h3 id="패킷-로그"><a href="#패킷-로그" class="headerlink" title="패킷 로그"></a>패킷 로그</h3><p>워낙 순식간에 지나가서 netstat으로 소켓의 상태는 관찰하지 못함.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">174</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.293423</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">55447</span> → <span class="number">8080</span> [SYN] Seq=<span class="number">0</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">811634482</span> TSecr=<span class="number">0</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">175</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.293697</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">8080</span> → <span class="number">55447</span> [SYN, ACK] Seq=<span class="number">0</span> Ack=<span class="number">1</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">3020801649</span> TSecr=<span class="number">811634482</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">176</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.293717</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">55447</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">811634482</span> TSecr=<span class="number">3020801649</span></span><br><span class="line"><span class="number">177</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.293729</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">8080</span> → <span class="number">55447</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3020801649</span> TSecr=<span class="number">811634482</span></span><br><span class="line"><span class="number">178</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295356</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>HTTP<span class="number">275</span>GET /stream HTTP/<span class="number">1.1</span> </span><br><span class="line"><span class="number">179</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.295402</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">55447</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">220</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3020801651</span> TSecr=<span class="number">811634484</span></span><br><span class="line"><span class="number">180</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401563</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">202</span><span class="number">8080</span> → <span class="number">55447</span> [PSH, ACK] Seq=<span class="number">1</span> Ack=<span class="number">220</span> Win=<span class="number">408064</span> Len=<span class="number">146</span> TSval=<span class="number">3020801757</span> TSecr=<span class="number">811634484</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">181</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.401620</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">55447</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">220</span> Ack=<span class="number">147</span> Win=<span class="number">408128</span> Len=<span class="number">0</span> TSval=<span class="number">811634590</span> TSecr=<span class="number">3020801757</span></span><br><span class="line"><span class="number">182</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.506841</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">73</span><span class="number">8080</span> → <span class="number">55447</span> [PSH, ACK] Seq=<span class="number">147</span> Ack=<span class="number">220</span> Win=<span class="number">408064</span> Len=<span class="number">17</span> TSval=<span class="number">3020801863</span> TSecr=<span class="number">811634590</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">183</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.506895</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">55447</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">220</span> Ack=<span class="number">164</span> Win=<span class="number">408128</span> Len=<span class="number">0</span> TSval=<span class="number">811634696</span> TSecr=<span class="number">3020801863</span></span><br><span class="line"><span class="number">184</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.713445</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">55447</span> → <span class="number">8080</span> [FIN, ACK] Seq=<span class="number">220</span> Ack=<span class="number">164</span> Win=<span class="number">408128</span> Len=<span class="number">0</span> TSval=<span class="number">811634902</span> TSecr=<span class="number">3020801863</span></span><br><span class="line"><span class="number">185</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">13.713503</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">55447</span> [ACK] Seq=<span class="number">164</span> Ack=<span class="number">221</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3020802069</span> TSecr=<span class="number">811634902</span></span><br><span class="line"><span class="number">186</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">14.012150</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">74</span>HTTP/<span class="number">1.1</span> <span class="number">200</span>   [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">187</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">14.012215</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">55447</span> → <span class="number">8080</span> [RST] Seq=<span class="number">221</span> Win=<span class="number">0</span> Len=<span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>174 ~ 176번 패킷은 TCP 3 Way Handshake (syn, syn&#x2F;ack, ack)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-tcp-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-02/tcp-3-way-handshake.png" class=""></li><li>178번 패킷에서 클라이언트 → 서버로 HTTP 요청 패킷 전송 (10:04:13.295356)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-request-packet.png" class=""></li><li>179번 패킷에서 서버가 요청 잘 받았다고 클라이언트한테 ACK 패킷 전송 (10:04:13.295402)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-request-ack-packet.png" class=""></li><li>180번 패킷은 서버에서 온 첫 번째 응답 패킷(hello, once)인데 ACK를 받은 10:04:13.<code>295</code>402에서 Read Timeout으로 설정한 <code>200</code>ms 이전에 도착함 (10:04:13.<code>401</code>563)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-response-packet-01.png" class=""></li><li>181번 패킷은 서버에서 보낸 응답 패킷을 잘 받았다는 ACK 패킷을 클라이언트 -&gt; 서버로 보내고 있음. (10:04:13.401620)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-response-ack-packet-01.png" class=""></li><li>182번 패킷은 서버에서 온 두 번째 응답 패킷(hello, twice)인데 마지막 응답 패킷(hello, once)을 받은 10:04:13.<code>401</code>563에서 Read Timeout으로 설정한 <code>200</code>ms 이전에 도착함 (10:04:13.<code>506</code>841)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-response-packet-02.png" class=""></li><li>183번 패킷은 서버에서 보낸 응답 패킷을 잘 받았다는 ACK 패킷을 클라이언트 -&gt; 서버로 보내고 있음. (10:04:13.506895)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-response-ack-packet-02.png" class=""></li><li>184번 패킷은 서버에서 온 마지막 응답 패킷(hello, twice)을 받은 10:04:13.<code>506</code>841에서 Read Timeout으로 설정한 <code>200</code>ms이 넘도록 아무런 패킷이 오지 않아 Read Timeout이 발생해서 서버 측에 FIN&#x2F;ACK 패킷을 날려서 커넥션을 종료할 준비를 하고 있음. (10:04:13.<code>713</code>445)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-fin-packet.png" class=""></li><li>185번 패킷에서 서버가 클라이언트로부터 FIN&#x2F;ACK 패킷을 잘 받았다고 반대로 ACK 패킷을 클라이언트에게 보냄 (10:04:13.713503)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-ack-packet.png" class=""></li><li>클라이언트가 먼저 연결을 종료하겠다는 FIN 패킷을 보냈기 때문에 클라이언트가 Active Close<br>서버는 클라이언트로부터 FIN 패킷을 받았기 때문에 서버는 Passive Close가 됨<br>(무조건 클라이언트가 Active Close는 아니고 경우에 따라서 다름)<br>그리고 아직까지는 서버(Passive Close)로부터 FIN 패킷을 받은 게 아니기 때문에 소켓이 정상적으로 종료된 게 아님.<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/tcp-termination.png" class=""></li><li>186번 패킷에서 서버 → 클라이언트로 HTTP 세 번째 응답 패킷(hello, thrice) 전송 (10:04:14.<code>012</code>150, 마지막 응답 패킷(hello, twice)를 보낸 10:04:13.<code>506</code>841에서 500ms가 지난 시점임.)<img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-http-response-packet-03.png" class=""></li><li>187번 패킷을 보면 서버에서 FIN 패킷이 온 게 아니기 때문에 클라이언트는 다시 서버에게 RST 패킷을 보내서 소켓을 닫을 준비를 한다. (10:04:14.012215) <img src="/2022/03/20/client-abort-exception-deep-dive-part-02/stream-response-over-read-timeout-send-rst-packet.png" class=""></li><li>소켓이 닫혔기 때문에 “bye”라는 응답패킷은 전송되지 않았다.</li></ol><h1 id="ClientAbortException을-해결하려면"><a href="#ClientAbortException을-해결하려면" class="headerlink" title="ClientAbortException을 해결하려면?"></a>ClientAbortException을 해결하려면?</h1><ol><li>서버 측에서 처리 속도를 더 빠르게 한다.</li><li>처리 속도는 빠르지만 응답이 크다면 응답의 사이즈를 줄인 API를 제공한다 (불필요한 필드 제거 or 페이징 API 제공)</li><li>클라이언트 측 리드 타임아웃 설정값을 늘린다.</li><li>정 합의가 안 된다면 ClientAbortException을 핸들링 해서 log.info로만 남긴다. (장애 상황은 아니라서 불필요한 노이즈라고 판단된다는 가정 하에)</li><li>클라이언트 측에서는 ReadTimeout이 발생했다면(ClientAbortException 여부와 상관 없이), 장애 상황(고객에게 돈은 출금이 됐는데 주문은 완료처리 안 됐다던지)을 막기 위해 서버 측에 취소 API 같은 걸 호출하거나 상태 조회 API 같은 걸 호출한 이후 내가 처리를 따로 해야하는 건지 아닌지 판단한 후에 올바른 처리를 해줘야한다.</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;서버에서 아주 가끔가다가 ClientAbortException(java.io.IOExceiption: Broken pipe)이 발생해서 어떨 때 발생하는지 딥다이브 해봄.&lt;/p&gt;
&lt;img src=&quot;/2022/03/20/client-abort-exception-deep-dive-part-02/stacktrace.png&quot; class&gt;

&lt;p&gt;적다보니 글이 길어져 글을 나누었는데 해당 글을 읽기 전에 &lt;a href=&quot;/2022/03/20/client-abort-exception-deep-dive-part-01&quot;&gt;(Tomcat) ClientAbortException은 왜 발생할까? (Part 1)&lt;/a&gt;을 먼저 보는 것을 추천함.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;a href=&quot;https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html&quot;&gt;https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="tomcat" scheme="https://perfectacle.github.io/categories/tomcat/"/>
    
    
    <category term="Spring Boot" scheme="https://perfectacle.github.io/tags/Spring-Boot/"/>
    
    <category term="Tomcat" scheme="https://perfectacle.github.io/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>(Tomcat) ClientAbortException은 왜 발생할까? (Part 1)</title>
    <link href="https://perfectacle.github.io/2022/03/20/client-abort-exception-deep-dive-part-01/"/>
    <id>https://perfectacle.github.io/2022/03/20/client-abort-exception-deep-dive-part-01/</id>
    <published>2022-03-20T03:30:19.000Z</published>
    <updated>2025-12-09T17:06:50.118Z</updated>
    
    <content type="html"><![CDATA[<p>서버에서 아주 가끔가다가 ClientAbortException(java.io.IOExceiption: Broken pipe)이 발생해서 어떨 때 발생하는지 딥다이브 해봄.</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/stacktrace.png" class=""><p>적다보니 글이 길어져 글을 나누었는데 해당 글을 읽고 난 후에 <a href="/2022/03/20/client-abort-exception-deep-dive-part-02">(Tomcat) ClientAbortException은 왜 발생할까? (Part 2)</a>를 마저 보는 것을 추천함.</p><hr><p><a href="https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html">https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html</a></p><blockquote><p>Extend IOException to identify it as being caused by an abort of a request by a remote client.</p></blockquote><p>외부 클라이언트 측에서 요청을 abort(중단) 시켰을 때 발생하는 예외로 보인다.<br>톰캣에서 발생시키는 예외인데 Spring Boot의 Web(Mvc) 모듈에서 기본적으로 사용하는 게 Embedded Tomcat이기 때문에 많은 분들께서 자주 마주치지 않았을까… 싶다.<br>구글링 해보면 뭐 브라우저 이슈(API 응답이 오기 전에 새로고침을 했다던가, 뒤로가기를 했다던가 등등)니 뭐니 하는데 내가 겪은 상황은 server → server 통신에서 발생한 것이기 때문에 서버 간의 통신 관점에서만 파보았다.</p><p>삽질을 해보고 싶은 사람은 <a href="https://github.com/perfectacle/client-abort-exception-playground">https://github.com/perfectacle/client-abort-exception-playground</a> 을 clone 하면 된다.</p><p>그리고 ClientAbortException이 발생해도 스프링에서 기본적으로 <a href="https://www.baeldung.com/exception-handling-for-rest-with-spring#exceptionresolver">HandlerExceptionResolver</a>에서 예외를 핸들링하기 때문에 로그에는 아무것도 남지 않는다.<br>따라서 해당 에러가 발생하는지 에러 로그로 명확히 확인해보는 게 훨씬 직관적이기 때문에 아래 @RestControllerAdvice를 추가했다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControllerAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = [Exception::class])</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">handleException</span><span class="params">(e: <span class="type">Exception</span>)</span></span>: ResponseEntity&lt;<span class="built_in">Void</span>&gt; &#123;</span><br><span class="line">        log.error(e.message, e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.internalServerError().build()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="N줄-요약"><a href="#N줄-요약" class="headerlink" title="N줄 요약"></a>N줄 요약</h1><ol><li>클라이언트가 응답 패킷을 받기 전에 연결을 끊으면<ol><li>ReadTimeout이 발생한 지 60초가 지나기 전에 응답 패킷을 보낸다면 (바로 소켓의 연결을 끊는 게 아니라 오동작을 막기 위해 60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨)) 동안 대기를 함.)<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mac (60_000ms)</span></span><br><span class="line">sysctl -a | grep net.inet.tcp.fin_timeout</span><br><span class="line">net.inet.tcp.fin_timeout: 60000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">linux alpine (60s)</span></span><br><span class="line">sysctl -a | grep net.ipv4.tcp_fin_timeout</span><br><span class="line">net.ipv4.tcp_fin_timeout = 60</span><br></pre></td></tr></table></figure><ol><li>응답 패킷이 아주 작은 경우 (하나의 응답패킷에 담길 만큼)<ol><li>아직 소켓이 완전히 닫힌 게 아니기 때문에 응답 패킷을 보낼 수 있기 때문에 ClientAbortException이 발생하지 않는다.</li><li>ClientAbortException만 발생하지 않을 뿐이지, 클라이언트 측에서 정상적으로 응답 패킷을 받을 수 있는 건 아니다.</li></ol></li><li>응답 패킷이 큰 경우 (하나의 응답 패킷에 담기지 않을 만큼)<ol><li>아직 소켓이 완전히 닫힌 게 아니기 때문에 몇 개의 응답 패킷을 보낼 수 있다.</li><li>이 때는 ClientAbortException만 발생하지 않을 뿐이지, 클라이언트 측에서 정상적으로 응답 패킷을 받을 수 있는 건 아니다.</li><li>클라이언트 측에서는 FIN 패킷이 오길 원했는데 예상치 못한 패킷이 왔기 때문에 서버 측에 RST 패킷을 보낸 후 소켓을 닫는다.</li><li>나머지 응답 패킷을 보내려고 했는데 소켓이 닫혔기 때문에 <code>서버 측에서 응답 패킷을 보내려다가 ClientAbortException이 발생한다</code>.</li></ol></li></ol></li><li>ReadTimeout이 발생한 지 60초가 지난 이후에 응답 패킷을 보낸다면 (혹은 클라이언트 측 서버 셧다운(배포 혹은 컴퓨터 종료)으로 인해 소켓이 종료된 이후에 보낸다면)<ol><li>클라이언트가 ReadTimeout이 발생했다고 바로 소켓의 연결을 끊는 게 아니라 오동작을 막기 위해 60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨) 만큼) 동안 대기를 함.</li><li>그리고 60초가 지나면 클라이언트&#x2F;서버 소켓은 모두 종료됨.</li><li>이 상태에서 서버에서 응답 패킷을 보내려고 하면 소켓이 종료됐기 때문에 <code>서버 측에서 응답 패킷을 보내려다가 ClientAbortException이 발생한다</code>.</li></ol></li></ol></li><li><a href="#ClientAbortException%EC%9D%84-%ED%95%B4%EA%B2%B0%ED%95%98%EB%A0%A4%EB%A9%B4">ClientAbortException을 해결하려면?</a></li><li>프로세스(메인 함수)가 종료되더라도 Passive Close로부터 FIN 패킷을 받지 않으면 클라이언트&#x2F;서버의 소켓은 닫히지 않는다. (오동작을 막기 위해 대기하는 것으로 알고 있음.)<br>하지만 Passive Close로부터 FIN 패킷이 아닌 다른 패킷이 오면 Active Close에서는 RST 패킷을 보낸 후 소켓을 닫는다.<br>60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨) 만큼) 동안 대기 후에도 Passive Close에게 아무런 패킷이 오지 않으면 Active Close는 RST 패킷을 보내고 소켓을 닫는다.</li><li>HTTP Client 구현체마다 다르겠지만 Apache HTTP Client의 경우 Keep-Alive를 사용한다고 했음에도 불구하고 요청이 정상적으로 처리되지 않는 경우(Read Timeout 발생, 500 Internal Sever Error 응답을 받는다던지… 모든 4xx, 5xx가 포함되는 건 아님)에는 커넥션을 커넥션 풀에 반납하지 않고(재사용하지 않고) 종료한다.</li></ol><h1 id="클라이언트가-응답-패킷을-받기-전에-연결을-끊는-경우"><a href="#클라이언트가-응답-패킷을-받기-전에-연결을-끊는-경우" class="headerlink" title="클라이언트가 응답 패킷을 받기 전에 연결을 끊는 경우"></a>클라이언트가 응답 패킷을 받기 전에 연결을 끊는 경우</h1><h2 id="1-Read-Timeout-발생-후-60초-이내-소켓이-닫히기-전-에-응답-패킷을-전송하는-경우"><a href="#1-Read-Timeout-발생-후-60초-이내-소켓이-닫히기-전-에-응답-패킷을-전송하는-경우" class="headerlink" title="1. Read Timeout 발생 후 60초 이내(소켓이 닫히기 전)에 응답 패킷을 전송하는 경우"></a>1. Read Timeout 발생 후 60초 이내(소켓이 닫히기 전)에 응답 패킷을 전송하는 경우</h2><h3 id="1-1-클라이언트-측에서-Read-Timeout-발생-후-60초-이내-소켓이-닫히기-전-에-응답-패킷을-하나만-전송하는-경우-응답이-작은-경우"><a href="#1-1-클라이언트-측에서-Read-Timeout-발생-후-60초-이내-소켓이-닫히기-전-에-응답-패킷을-하나만-전송하는-경우-응답이-작은-경우" class="headerlink" title="1-1. 클라이언트 측에서 Read Timeout 발생 후 60초 이내(소켓이 닫히기 전)에 응답 패킷을 하나만 전송하는 경우 (응답이 작은 경우)"></a>1-1. 클라이언트 측에서 Read Timeout 발생 후 60초 이내(소켓이 닫히기 전)에 응답 패킷을 하나만 전송하는 경우 (응답이 작은 경우)</h3><p>서버 쪽 API에서 처리하는데 10초 소요되고, 매우 작은 문자열을 응답한다고 가정</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SlowResponseController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/slow&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">slow</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        log.info(<span class="string">&quot;request is arrived!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;slow process is done!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;done!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>클라이언트 측 리드 타임아웃 설정은 3초로 서버 쪽 처리 시간보다 더 짧게 설정함</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> readTimeout = Duration.ofSeconds(<span class="number">3L</span>)</span><br><span class="line">    <span class="keyword">val</span> restTemplate = RestTemplate(</span><br><span class="line">        HttpComponentsClientHttpRequestFactory(</span><br><span class="line">            HttpClientBuilder</span><br><span class="line">                .create()</span><br><span class="line">                .setMaxConnPerRoute(<span class="number">100</span>)</span><br><span class="line">                .setMaxConnTotal(<span class="number">100</span>)</span><br><span class="line">                .setKeepAliveStrategy(DefaultConnectionKeepAliveStrategy())</span><br><span class="line">                .setDefaultRequestConfig(</span><br><span class="line">                    RequestConfig.custom().setSocketTimeout(readTimeout.toMillis().toInt()).build()</span><br><span class="line">                )</span><br><span class="line">                .build()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/slow&quot;</span>, String::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] request is done!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 커넥션 풀에 있는 커넥션을 바로 종료하지 않기 위해 10초간 슬립</span></span><br><span class="line">    Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line">    println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] main function is done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="데모-영상"><a href="#데모-영상" class="headerlink" title="데모 영상"></a>데모 영상</h4><div class="video-container"><iframe src="https://www.youtube.com/embed/NO6JOsIE0aI" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h4 id="클라이언트-로그"><a href="#클라이언트-로그" class="headerlink" title="클라이언트 로그"></a>클라이언트 로그</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.241</span> [main] DEBUG org.springframework.web.client.RestTemplate - HTTP GET http:<span class="comment">//localhost:8080/slow</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.247</span> [main] DEBUG org.springframework.web.client.RestTemplate - Accept=[text/plain, application/json, application<span class="comment">/*+json, */</span>*]</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.277</span> [main] DEBUG org.apache.http.client.protocol.RequestAddCookies - CookieSpec selected: default</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.280</span> [main] DEBUG org.apache.http.client.protocol.RequestAuthCache - Auth cache not <span class="keyword">set</span> <span class="keyword">in</span> the context</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.280</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.284</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection leased: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 1 of 100; total allocated: 1 of 100]</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.285</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Opening connection &#123;&#125;-&gt;http:<span class="comment">//localhost:8080</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connecting to localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">60596</span>&lt;-&gt;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: <span class="keyword">set</span> socket timeout to <span class="number">3000</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Executing request GET /slow HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Target auth state: UNCHALLENGED</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Proxy auth state: UNCHALLENGED</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; GET /slow HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept: text/plain, application/json, application<span class="comment">/*+json, */</span>*</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Host: localhost:<span class="number">8080</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Connection: Keep-Alive</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; User-Agent: Apache-HttpClient/<span class="number">4.5</span><span class="number">.13</span> (Java/<span class="number">1.8</span><span class="number">.0_322</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept-Encoding: gzip,deflate</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;GET /slow HTTP/1.1[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept: text/plain, application/json, application/*+json, */*[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Host: localhost:8080[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Connection: Keep-Alive[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;User-Agent: Apache-HttpClient/4.5.13 (Java/1.8.0_322)[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept-Encoding: gzip,deflate[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">26.290</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;[\r][\n]&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">29.296</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;[read] I/O error: Read timed out&quot;</span></span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">29.296</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Close connection</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">29.297</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Shutdown connection</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">29.297</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Connection discarded</span><br><span class="line"><span class="number">21</span>:<span class="number">15</span>:<span class="number">29.297</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-19T21:<span class="number">15</span>:<span class="number">29.306</span>] request <span class="keyword">is</span> done!</span><br><span class="line">org.springframework.web.client.ResourceAccessException: I/O error on GET request <span class="keyword">for</span> <span class="string">&quot;http://localhost:8080/slow&quot;</span>: Read timed <span class="keyword">out</span>; nested exception <span class="keyword">is</span> java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">785</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:<span class="number">711</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:<span class="number">334</span>)</span><br><span class="line">at com.example.playground.slow.SlowResponseRestTemplatePlaygroundKt.main(SlowResponseRestTemplatePlayground.kt:<span class="number">28</span>)</span><br><span class="line">at com.example.playground.slow.SlowResponseRestTemplatePlaygroundKt.main(SlowResponseRestTemplatePlayground.kt)</span><br><span class="line">Caused <span class="keyword">by</span>: java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">171</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br><span class="line">at org.apache.http.impl.conn.LoggingInputStream.read(LoggingInputStream.java:<span class="number">84</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class="number">137</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class="number">153</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class="number">280</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">138</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">56</span>)</span><br><span class="line">at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class="number">259</span>)</span><br><span class="line">at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class="number">163</span>)</span><br><span class="line">at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class="number">157</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class="number">273</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class="number">125</span>)</span><br><span class="line">at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class="number">272</span>)</span><br><span class="line">at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class="number">186</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class="number">89</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class="number">110</span>)</span><br><span class="line">at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class="number">185</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">83</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">56</span>)</span><br><span class="line">at org.springframework.http.client.HttpComponentsClientHttpRequest.executeInternal(HttpComponentsClientHttpRequest.java:<span class="number">87</span>)</span><br><span class="line">at org.springframework.http.client.AbstractBufferingClientHttpRequest.executeInternal(AbstractBufferingClientHttpRequest.java:<span class="number">48</span>)</span><br><span class="line">at org.springframework.http.client.AbstractClientHttpRequest.execute(AbstractClientHttpRequest.java:<span class="number">66</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">776</span>)</span><br><span class="line">... <span class="number">4</span> more</span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-19T21:<span class="number">15</span>:<span class="number">39.315</span>] main function <span class="keyword">is</span> done!</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>21:15:26.289에 서버와 커넥션 맺음. (<code>21:15:26.289 [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established 127.0.0.1:60596&lt;-&gt;127.0.0.1:8080</code>)</li><li>21:15:26.290에 요청 전송 (<code>21:15:26.290 [main] DEBUG org.apache.http.wire - http-outgoing-0 &gt;&gt; ...</code>)</li><li>21:15:29.296에 Read Timeout 발생 (정확히 우리가 설정한 3초 후에 발생함, <code>21:15:29.296 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;[read] I/O error: Read timed out&quot;</code>)</li><li>21:15:29.296 ~ 21:15:29.297에 커넥션 종료 (Keep-Alive 설정했음에도 불구하고, 정상적인 응답을 받지 못했으면 커넥션을 종료함. <code>21:15:29.296 [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-0: Close connection</code>)</li><li>21:15:39.315에 메인함수 종료</li></ol><h4 id="서버-로그"><a href="#서버-로그" class="headerlink" title="서버 로그"></a>서버 로그</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.291</span>  INFO <span class="number">8275</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">3</span>] c.e.s.SlowResponseController             : request <span class="keyword">is</span> arrived!</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">36.297</span>  INFO <span class="number">8275</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">3</span>] c.e.s.SlowResponseController             : slow process <span class="keyword">is</span> done!</span><br></pre></td></tr></table></figure><ol><li>21:15:26.291에 요청 도착</li><li>21:15:36.297에 처리 완료 (10초 걸림)</li></ol><p>아무런 에러 로그를 출력하지 않기 때문에 서버 측에서는 클라이언트가 올바르게 응답을 처리했는지 알 방법이 없다.</p><h4 id="패킷-로그-소켓-상태"><a href="#패킷-로그-소켓-상태" class="headerlink" title="패킷 로그 (소켓 상태)"></a>패킷 로그 (소켓 상태)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">239</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289278</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">60596</span> → <span class="number">8080</span> [SYN] Seq=<span class="number">0</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">3550708683</span> TSecr=<span class="number">0</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">240</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289504</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">8080</span> → <span class="number">60596</span> [SYN, ACK] Seq=<span class="number">0</span> Ack=<span class="number">1</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">2530353116</span> TSecr=<span class="number">3550708683</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">241</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289530</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">60596</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3550708683</span> TSecr=<span class="number">2530353116</span></span><br><span class="line"><span class="number">242</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.289547</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">8080</span> → <span class="number">60596</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">2530353116</span> TSecr=<span class="number">3550708683</span></span><br><span class="line"><span class="number">243</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.291192</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>HTTP<span class="number">273</span>GET /slow HTTP/<span class="number">1.1</span> </span><br><span class="line"><span class="number">244</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">26.291233</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">60596</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">218</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">2530353118</span> TSecr=<span class="number">3550708685</span></span><br><span class="line"><span class="number">245</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">29.297321</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">60596</span> → <span class="number">8080</span> [FIN, ACK] Seq=<span class="number">218</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3550711691</span> TSecr=<span class="number">2530353118</span></span><br><span class="line"><span class="number">246</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">29.297383</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">60596</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">219</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">2530356124</span> TSecr=<span class="number">3550711691</span></span><br><span class="line"><span class="number">247</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">36.298103</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>HTTP<span class="number">222</span>HTTP/<span class="number">1.1</span> <span class="number">200</span>   (text/plain)</span><br><span class="line"><span class="number">248</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">36.298215</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">60596</span> → <span class="number">8080</span> [RST] Seq=<span class="number">219</span> Win=<span class="number">0</span> Len=<span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li><p>239 ~ 241번 패킷은 TCP 3 Way Handshake (syn, syn&#x2F;ack, ack)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/tcp-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-3-way-handshake-socket-status.png" class=""></li><li><p>243번 패킷에서 클라이언트 → 서버로 HTTP 요청 패킷 전송 (21:15:26.291192)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-http-request-packet.png" class=""></li><li><p>244번 패킷에서 서버가 요청 잘 받았다고 클라이언트한테 ACK 패킷 전송 (21:15:26.291233)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-http-request-ack-packet.png" class=""></li><li><p>245번 패킷에서 클라이언트는 커넥션을 종료한다고 FIN&#x2F;ACK 패킷을 서버에게 전송 (21:15:29.297321, 정확히 HTTP 패킷 보내고 3초 후(read timeout)임.)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-fin-packet.png" class=""></li><li><p>246번 패킷에서 서버가 클라이언트로부터 FIN&#x2F;ACK 패킷을 잘 받았다고 반대로 ACK 패킷을 클라이언트에게 보냄 (21:15:29.297383)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-ack-packet.png" class=""></li><li><p>클라이언트가 먼저 연결을 종료하겠다는 FIN 패킷을 보냈기 때문에 클라이언트가 Active Close<br>서버는 클라이언트로부터 FIN 패킷을 받았기 때문에 서버는 Passive Close가 됨<br>(무조건 클라이언트가 Active Close는 아니고 경우에 따라서 다름)<br>그리고 아직까지는 서버(Passive Close)로부터 FIN 패킷을 받은 게 아니기 때문에 소켓이 정상적으로 종료된 게 아님.</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/tcp-termination.png" class=""></li><li><p>서버 측 소켓의 상태는 CLOSE_WAIT(클라이언트가 보낸 FIN 패킷을 받았으므로)이고, 클라이언트 측 소켓의 상태는 FIN_WAIT_2(서버가 보낸 ACK 패킷을 받았으므로)이다. (21:15:29)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-fin-ack-socket-status-01.png" class=""></li><li><p>서버는 클라이언트로부터 FIN 패킷을 받았지만 아직 보낼 패킷이 남아있기 때문인지 클라이언트에게 FIN 패킷을 보내지 않음.<br>그리고 Active Close(클라이언트) 측에서는 오동작을 막기 위해 바로 소켓의 연결을 끊는 게 아니라 60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨) 만큼) 동안 대기하게 됨. (21:15:35)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-fin-ack-socket-status-02.png" class=""></li><li><p>247번 패킷에서 서버 → 클라이언트로 HTTP 응답 패킷 전송 (21:15:36.298103, 클라이언트가 요청 보낸 21:15:26.291192로부터 10초가 지난 시간임)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-http-response-packet.png" class=""></li><li><p>248번 패킷에서 클라이언트 → 서버로 RST 패킷 전송 (21:15:36.298215)</p><blockquote><p>When an unexpected TCP packet arrives at a host, that host usually responds by sending a reset packet back on the same connection. A reset packet is simply one with no payload and with the <code>RST</code> bit set in the TCP header flags.<br>출처: <a href="https://www.pico.net/kb/what-is-a-tcp-reset-rst/">https://www.pico.net/kb/what-is-a-tcp-reset-rst/</a></p></blockquote><p>클라이언트 측에서는 소켓 연결 종료를 준비하고 있었는데 서버 측으로부터 의도치 않은 HTTP 패킷이 왔기 때문에 더 이상 패킷을 받을 수 없다는 RST 패킷을 전송한 것으로 보임. (원래는 서버에서 FIN 패킷을 한 번 보내주고 클라이언트가 다시 ACK 패킷을 보내서 소켓을 종료해야한다.)</p><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-rst-packet.png" class=""></li><li><p>RST 패킷을 전송한 이후에 클라이언트&#x2F;서버 측 소켓이 정상적으로 종료됨 (21:15:36)</p></li></ol>   <img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-small-response-send-rst-packet-socket-status.png" class=""><h3 id="1-2-클라이언트-측에서-Read-Timeout-발생-후-60초-이내-소켓이-닫히기-전-에-응답-패킷을-여러-개-전송하는-경우-응답이-큰-경우"><a href="#1-2-클라이언트-측에서-Read-Timeout-발생-후-60초-이내-소켓이-닫히기-전-에-응답-패킷을-여러-개-전송하는-경우-응답이-큰-경우" class="headerlink" title="1-2. 클라이언트 측에서 Read Timeout 발생 후 60초 이내(소켓이 닫히기 전)에 응답 패킷을 여러 개 전송하는 경우 (응답이 큰 경우)"></a>1-2. 클라이언트 측에서 Read Timeout 발생 후 60초 이내(소켓이 닫히기 전)에 응답 패킷을 여러 개 전송하는 경우 (응답이 큰 경우)</h3><p>서버 쪽 API에서 처리하는데 10초 소요되고, 매우 큰 문자열을 응답한다고 가정</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SlowLargeResponseController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/slow-large&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">slow</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        log.info(<span class="string">&quot;request is arrived!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;slow large process is done!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;done!&quot;</span>.repeat(<span class="number">1_000_000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>클라이언트 측 리드 타임아웃 설정은 3초로 서버 쪽 처리 시간보다 더 짧게 설정함</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> readTimeout = Duration.ofSeconds(<span class="number">3L</span>)</span><br><span class="line">    <span class="keyword">val</span> restTemplate = RestTemplate(</span><br><span class="line">        HttpComponentsClientHttpRequestFactory(</span><br><span class="line">            HttpClientBuilder</span><br><span class="line">                .create()</span><br><span class="line">                .setMaxConnPerRoute(<span class="number">100</span>)</span><br><span class="line">                .setMaxConnTotal(<span class="number">100</span>)</span><br><span class="line">                .setKeepAliveStrategy(DefaultConnectionKeepAliveStrategy())</span><br><span class="line">                .setDefaultRequestConfig(</span><br><span class="line">                    RequestConfig.custom().setSocketTimeout(readTimeout.toMillis().toInt()).build()</span><br><span class="line">                )</span><br><span class="line">                .build()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/slow-large&quot;</span>, String::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] request is done!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 커넥션 풀에 있는 커넥션을 바로 종료하지 않기 위해 10초간 슬립</span></span><br><span class="line">    Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line">    println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] main function is done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="데모-영상-1"><a href="#데모-영상-1" class="headerlink" title="데모 영상"></a>데모 영상</h4><div class="video-container"><iframe src="https://www.youtube.com/embed/3PJNHxeGbeQ" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h4 id="클라이언트-로그-1"><a href="#클라이언트-로그-1" class="headerlink" title="클라이언트 로그"></a>클라이언트 로그</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.860</span> [main] DEBUG org.springframework.web.client.RestTemplate - HTTP GET http:<span class="comment">//localhost:8080/slow-large</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.867</span> [main] DEBUG org.springframework.web.client.RestTemplate - Accept=[text/plain, application/json, application<span class="comment">/*+json, */</span>*]</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.895</span> [main] DEBUG org.apache.http.client.protocol.RequestAddCookies - CookieSpec selected: default</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.898</span> [main] DEBUG org.apache.http.client.protocol.RequestAuthCache - Auth cache not <span class="keyword">set</span> <span class="keyword">in</span> the context</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.899</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.903</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection leased: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 1 of 100; total allocated: 1 of 100]</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.903</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Opening connection &#123;&#125;-&gt;http:<span class="comment">//localhost:8080</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.905</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connecting to localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">50422</span>&lt;-&gt;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: <span class="keyword">set</span> socket timeout to <span class="number">3000</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Executing request GET /slow-large HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Target auth state: UNCHALLENGED</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Proxy auth state: UNCHALLENGED</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; GET /slow-large HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept: text/plain, application/json, application<span class="comment">/*+json, */</span>*</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Host: localhost:<span class="number">8080</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Connection: Keep-Alive</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; User-Agent: Apache-HttpClient/<span class="number">4.5</span><span class="number">.13</span> (Java/<span class="number">1.8</span><span class="number">.0_322</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept-Encoding: gzip,deflate</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;GET /slow-large HTTP/1.1[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept: text/plain, application/json, application/*+json, */*[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Host: localhost:8080[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Connection: Keep-Alive[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;User-Agent: Apache-HttpClient/4.5.13 (Java/1.8.0_322)[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept-Encoding: gzip,deflate[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">22.907</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;[\r][\n]&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">25.913</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;[read] I/O error: Read timed out&quot;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">25.913</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Close connection</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">25.915</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Shutdown connection</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">25.916</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Connection discarded</span><br><span class="line"><span class="number">05</span>:<span class="number">19</span>:<span class="number">25.916</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-20T05:<span class="number">19</span>:<span class="number">25.920</span>] request <span class="keyword">is</span> done!</span><br><span class="line">org.springframework.web.client.ResourceAccessException: I/O error on GET request <span class="keyword">for</span> <span class="string">&quot;http://localhost:8080/slow-large&quot;</span>: Read timed <span class="keyword">out</span>; nested exception <span class="keyword">is</span> java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">785</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:<span class="number">711</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:<span class="number">334</span>)</span><br><span class="line">at com.example.playground.SlowLargeResponseRestTemplatePlaygroundKt.main(SlowLargeResponseRestTemplatePlayground.kt:<span class="number">28</span>)</span><br><span class="line">at com.example.playground.SlowLargeResponseRestTemplatePlaygroundKt.main(SlowLargeResponseRestTemplatePlayground.kt)</span><br><span class="line">Caused <span class="keyword">by</span>: java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">171</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br><span class="line">at org.apache.http.impl.conn.LoggingInputStream.read(LoggingInputStream.java:<span class="number">84</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class="number">137</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class="number">153</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class="number">280</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">138</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">56</span>)</span><br><span class="line">at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class="number">259</span>)</span><br><span class="line">at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class="number">163</span>)</span><br><span class="line">at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class="number">157</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class="number">273</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class="number">125</span>)</span><br><span class="line">at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class="number">272</span>)</span><br><span class="line">at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class="number">186</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class="number">89</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class="number">110</span>)</span><br><span class="line">at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class="number">185</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">83</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">56</span>)</span><br><span class="line">at org.springframework.http.client.HttpComponentsClientHttpRequest.executeInternal(HttpComponentsClientHttpRequest.java:<span class="number">87</span>)</span><br><span class="line">at org.springframework.http.client.AbstractBufferingClientHttpRequest.executeInternal(AbstractBufferingClientHttpRequest.java:<span class="number">48</span>)</span><br><span class="line">at org.springframework.http.client.AbstractClientHttpRequest.execute(AbstractClientHttpRequest.java:<span class="number">66</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">776</span>)</span><br><span class="line">... <span class="number">4</span> more</span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-20T05:<span class="number">19</span>:<span class="number">35.925</span>] main function <span class="keyword">is</span> done!</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>05:19:22.906에 서버와 커넥션 맺음. (<code>05:19:22.906 [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established 127.0.0.1:50422&lt;-&gt;127.0.0.1:8080</code>)</li><li>05:19:22.907에 요청 전송 (<code>05:19:22.907 [main] DEBUG org.apache.http.wire - http-outgoing-0 &gt;&gt; ...</code>)</li><li>05:19:25.913에 Read Timeout 발생 (정확히 우리가 설정한 3초 후에 발생함, <code>05:19:25.913 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;[read] I/O error: Read timed out&quot;</code>)</li><li>05:19:25.913 ~ 05:19:25.915에 커넥션 종료 (Keep-Alive 설정했음에도 불구하고, 정상적인 응답을 받지 못했으면 커넥션을 종료함. <code>05:19:25.913 [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-0: Close connection</code>)</li><li>05:19:35.925에 메인함수 종료</li></ol><h4 id="서버-로그-1"><a href="#서버-로그-1" class="headerlink" title="서버 로그"></a>서버 로그</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.908</span>  INFO <span class="number">63172</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">2</span>] c.e.p.SlowLargeResponseController        : request <span class="keyword">is</span> arrived!</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.913</span>  INFO <span class="number">63172</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">2</span>] c.e.p.SlowLargeResponseController        : slow large process <span class="keyword">is</span> done!</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.937</span> ERROR <span class="number">63172</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">2</span>] com.example.playground.ControllerAdvice  : java.io.IOException: Broken pipe</span><br><span class="line"></span><br><span class="line">org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:<span class="number">353</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.flushByteBuffer(OutputBuffer.java:<span class="number">783</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.append(OutputBuffer.java:<span class="number">688</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.writeBytes(OutputBuffer.java:<span class="number">388</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.write(OutputBuffer.java:<span class="number">366</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:<span class="number">96</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.writeBytes(StreamEncoder.java:<span class="number">221</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.implWrite(StreamEncoder.java:<span class="number">282</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.write(StreamEncoder.java:<span class="number">125</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.write(StreamEncoder.java:<span class="number">135</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at java.io.OutputStreamWriter.write(OutputStreamWriter.java:<span class="number">220</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at java.io.Writer.write(Writer.java:<span class="number">157</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at org.springframework.util.StreamUtils.copy(StreamUtils.java:<span class="number">147</span>) ~[spring-core-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:<span class="number">126</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:<span class="number">44</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:<span class="number">227</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:<span class="number">293</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:<span class="number">183</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:<span class="number">78</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">135</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>) [spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>) [spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">4.0</span>.FR]</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>) [spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">4.0</span>.FR]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>) [tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">540</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">359</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">889</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1735</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">750</span>) [na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">Caused <span class="keyword">by</span>: java.io.IOException: Broken pipe</span><br><span class="line">at sun.nio.ch.FileDispatcherImpl.write0(Native Method) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:<span class="number">47</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:<span class="number">93</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.IOUtil.write(IOUtil.java:<span class="number">65</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:<span class="number">470</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:<span class="number">135</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:<span class="number">1376</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:<span class="number">766</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.writeBlocking(SocketWrapperBase.java:<span class="number">586</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.write(SocketWrapperBase.java:<span class="number">530</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.doWrite(Http11OutputBuffer.java:<span class="number">547</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.filters.IdentityOutputFilter.doWrite(IdentityOutputFilter.java:<span class="number">73</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11OutputBuffer.doWrite(Http11OutputBuffer.java:<span class="number">194</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.Response.doWrite(Response.java:<span class="number">615</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:<span class="number">340</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">... <span class="number">62</span> common frames omitted</span><br></pre></td></tr></table></figure><ol><li>05:19:22.908에 요청 도착</li><li>05:19:32.913에 처리 완료 (10초 걸림)</li><li>05:19:32.937에 <code>ClientAbortException(java.io.IOException: Broken pipe)</code> 발생</li></ol><h4 id="패킷-로그-소켓-상태-1"><a href="#패킷-로그-소켓-상태-1" class="headerlink" title="패킷 로그 (소켓 상태)"></a>패킷 로그 (소켓 상태)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">143</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906081</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">50422</span> → <span class="number">8080</span> [SYN] Seq=<span class="number">0</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">3840422295</span> TSecr=<span class="number">0</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">144</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906253</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">8080</span> → <span class="number">50422</span> [SYN, ACK] Seq=<span class="number">0</span> Ack=<span class="number">1</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">3598884109</span> TSecr=<span class="number">3840422295</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">145</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906270</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">50422</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3840422295</span> TSecr=<span class="number">3598884109</span></span><br><span class="line"><span class="number">146</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.906283</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">8080</span> → <span class="number">50422</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3598884109</span> TSecr=<span class="number">3840422295</span></span><br><span class="line"><span class="number">147</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.908202</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>HTTP<span class="number">279</span>GET /slow-large HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">148</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">22.908223</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">50422</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">224</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3598884111</span> TSecr=<span class="number">3840422297</span></span><br><span class="line"><span class="number">149</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">25.915247</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">50422</span> → <span class="number">8080</span> [FIN, ACK] Seq=<span class="number">224</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">3840425304</span> TSecr=<span class="number">3598884111</span></span><br><span class="line"><span class="number">150</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">25.915291</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">50422</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">225</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">3598887118</span> TSecr=<span class="number">3840425304</span></span><br><span class="line"><span class="number">163</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935627</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">50422</span> [PSH, ACK] Seq=<span class="number">1</span> Ack=<span class="number">225</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3598894139</span> TSecr=<span class="number">3840425304</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">164</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935668</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">50422</span> [PSH, ACK] Seq=<span class="number">8193</span> Ack=<span class="number">225</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3598894139</span> TSecr=<span class="number">3840425304</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">165</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935695</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">50422</span> [PSH, ACK] Seq=<span class="number">16385</span> Ack=<span class="number">225</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3598894139</span> TSecr=<span class="number">3840425304</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">166</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935704</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">50422</span> → <span class="number">8080</span> [RST] Seq=<span class="number">225</span> Win=<span class="number">0</span> Len=<span class="number">0</span></span><br><span class="line"><span class="number">167</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935715</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">50422</span> → <span class="number">8080</span> [RST] Seq=<span class="number">225</span> Win=<span class="number">0</span> Len=<span class="number">0</span></span><br><span class="line"><span class="number">168</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935719</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">50422</span> → <span class="number">8080</span> [RST] Seq=<span class="number">225</span> Win=<span class="number">0</span> Len=<span class="number">0</span></span><br><span class="line"><span class="number">169</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935721</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">8248</span><span class="number">8080</span> → <span class="number">50422</span> [PSH, ACK] Seq=<span class="number">24577</span> Ack=<span class="number">225</span> Win=<span class="number">408064</span> Len=<span class="number">8192</span> TSval=<span class="number">3598894139</span> TSecr=<span class="number">3840425304</span> [TCP segment of a reassembled PDU]</span><br><span class="line"><span class="number">170</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">32.935741</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">50422</span> → <span class="number">8080</span> [RST] Seq=<span class="number">225</span> Win=<span class="number">0</span> Len=<span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>143 ~ 145번 패킷은 TCP 3 Way Handshake (syn, syn&#x2F;ack, ack)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/tcp-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-3-way-handshake-socket-status.png" class=""></li><li>147번 패킷에서 클라이언트 → 서버로 HTTP 요청 패킷 전송 (05:19:22.908202)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-http-request-packet.png" class=""></li><li>148번 패킷에서 서버가 요청 잘 받았다고 클라이언트한테 ACK 패킷 전송 (05:19:22.908223)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-http-request-ack-packet.png" class=""></li><li>149번 패킷에서 클라이언트는 커넥션을 종료한다고 FIN&#x2F;ACK 패킷을 서버에게 전송 (05:19:25.915247, 정확히 HTTP 패킷 보내고 3초 이후(read timeout)임.)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-fin-packet.png" class=""></li><li>150번 패킷에서 서버가 클라이언트로부터 FIN&#x2F;ACK 패킷을 잘 받았다고 반대로 ACK 패킷을 클라이언트에게 보냄 (05:19:25.915291)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-ack-packet.png" class=""></li><li>클라이언트가 먼저 연결을 종료하겠다는 FIN 패킷을 보냈기 때문에 클라이언트가 Active Close<br>서버는 클라이언트로부터 FIN 패킷을 받았기 때문에 서버는 Passive Close가 됨<br>(무조건 클라이언트가 Active Close는 아니고 경우에 따라서 다름)<br>그리고 아직까지는 서버(Passive Close)로부터 FIN 패킷을 받은 게 아니기 때문에 소켓이 정상적으로 종료된 게 아님.<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/tcp-termination.png" class=""></li><li>서버 측 소켓의 상태는 CLOSE_WAIT(클라이언트가 보낸 FIN 패킷을 받았으므로)이고, 클라이언트 측 소켓의 상태는 FIN_WAIT_2(서버가 보낸 ACK 패킷을 받았으므로)이다. (05:19:26)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-fin-ack-socket-status-01.png" class=""></li><li>서버는 클라이언트로부터 FIN 패킷을 받았지만 아직 보낼 패킷이 남아있기 때문인지 클라이언트에게 FIN 패킷을 보내지 않음.<br>그리고 Active Close(클라이언트) 측에서는 오동작을 막기 위해 바로 소켓의 연결을 끊는 게 아니라 60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨)) 동안 대기하게 됨. (05:19:32)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-fin-ack-socket-status-02.png" class=""></li><li>163번 패킷에서 서버로부터 HTTP 응답이 오는데 너무 커서 한 번에 오지 않고 여러 패킷에 걸쳐서 전송됨. (05:19:32.935627)<br>TCP 패킷은 순서를 보장하지 않기 때문에 클라이언트 측에서 재조립하여야하는데 그걸 위해 <code>현재 시퀀스 넘버(1)</code>와 <code>다음 패킷의 시퀀스 넘버(8193)</code>를 알려주고 있음.<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-http-response-packet-01.png" class=""></li><li>164번 패킷을 보니 또 응답 패킷인데 <code>현재 패킷의 시퀀스 넘버는 8193</code>이니 163번 패킷의 다음 패킷이고, 그 <code>다음 패킷의 시퀀스 넘버는 16385</code>임. (05:19:32.935668)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-http-response-packet-02.png" class=""></li><li>165번 패킷을 보니 또 응답 패킷인데 <code>현재 패킷의 시퀀스 넘버는 16385</code>이니 164번 패킷의 다음 패킷이고, 그 <code>다음 패킷의 시퀀스 넘버는 24577</code>임. (05:19:32.935695)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-http-response-packet-03.png" class=""></li><li>166 ~ 168번 패킷을 보면 클라이언트는 FIN_WAIT_2 상태이기 때문에 서버로부터 FIN 패킷이 올 것을 예상했는데 3번이나 다른 패킷이 왔기 때문에 RST 패킷을 3번 보냄 (05:19:32.935704~ 05:19:32.935719)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-rst-packet-01.png" class=""></li><li>169번 패킷을 보면 서버 측에 RST 패킷을 보내긴 했지만 아직 소켓이 닫히기 이전이기 때문에 그사이에 또 서버 → 클라이언트로 응답패킷이 왔다. (05:19:32.935721)<br>여전히 응답이 더 남았기 때문에 다음 패킷의 시퀀스 넘버도 함께 보내줬다.<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-http-response-packet-04.png" class=""></li><li>170번 패킷을 보면 또 서버에서 FIN 패킷이 온 게 아니기 때문에 클라이언트는 다시 서버에게 RST 패킷을 보내서 소켓을 닫을 준비를 한다. (05:19:32.935741)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-rst-packet-02.png" class=""></li><li>그리고나서 진짜로 클라이언트&#x2F;서버의 소켓이 닫혔다. (05:19:33)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-in-60s-large-response-send-rst-packet-socket-status.png" class=""></li></ol><h2 id="2-클라이언트-측에서-Read-Timeout-발생-후-60초-이후-소켓이-닫힌-후-에-응답-패킷을-전송하는-경우"><a href="#2-클라이언트-측에서-Read-Timeout-발생-후-60초-이후-소켓이-닫힌-후-에-응답-패킷을-전송하는-경우" class="headerlink" title="2. 클라이언트 측에서 Read Timeout 발생 후 60초 이후(소켓이 닫힌 후)에 응답 패킷을 전송하는 경우"></a>2. 클라이언트 측에서 Read Timeout 발생 후 60초 이후(소켓이 닫힌 후)에 응답 패킷을 전송하는 경우</h2><p>서버 쪽 API에서 처리하는데 70초 소요된다고 가정</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VerySlowResponseController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(<span class="keyword">this</span>::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/very-slow&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">verySlow</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        log.info(<span class="string">&quot;request is arrived!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">70_000L</span>)</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;very slow process is done!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;done!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>클라이언트 측 리드 타임아웃 설정은 3초로 서버 쪽 처리 시간보다 훨씬 짧게 설정함</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> readTimeout = Duration.ofSeconds(<span class="number">3L</span>)</span><br><span class="line">    <span class="keyword">val</span> restTemplate = RestTemplate(</span><br><span class="line">        HttpComponentsClientHttpRequestFactory(</span><br><span class="line">            HttpClientBuilder</span><br><span class="line">                .create()</span><br><span class="line">                .setMaxConnPerRoute(<span class="number">100</span>)</span><br><span class="line">                .setMaxConnTotal(<span class="number">100</span>)</span><br><span class="line">                .setKeepAliveStrategy(DefaultConnectionKeepAliveStrategy())</span><br><span class="line">                .setDefaultRequestConfig(</span><br><span class="line">                    RequestConfig.custom().setSocketTimeout(readTimeout.toMillis().toInt()).build()</span><br><span class="line">                )</span><br><span class="line">                .build()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/very-slow&quot;</span>, String::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] request is done!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 커넥션 풀에 있는 커넥션을 바로 종료하지 않기 위해 10초간 슬립</span></span><br><span class="line">    Thread.sleep(<span class="number">10_000L</span>)</span><br><span class="line">    println(<span class="string">&quot;[<span class="subst">$&#123;LocalDateTime.now()&#125;</span>] main function is done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="데모-영상-2"><a href="#데모-영상-2" class="headerlink" title="데모 영상"></a>데모 영상</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/pWqBXHCkXW8" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h3 id="클라이언트-로그-2"><a href="#클라이언트-로그-2" class="headerlink" title="클라이언트 로그"></a>클라이언트 로그</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.010</span> [main] DEBUG org.springframework.web.client.RestTemplate - HTTP GET http:<span class="comment">//localhost:8080/very-slow</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.016</span> [main] DEBUG org.springframework.web.client.RestTemplate - Accept=[text/plain, application/json, application<span class="comment">/*+json, */</span>*]</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.042</span> [main] DEBUG org.apache.http.client.protocol.RequestAddCookies - CookieSpec selected: default</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.045</span> [main] DEBUG org.apache.http.client.protocol.RequestAuthCache - Auth cache not <span class="keyword">set</span> <span class="keyword">in</span> the context</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.046</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.050</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection leased: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 1 of 100; total allocated: 1 of 100]</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.050</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Opening connection &#123;&#125;-&gt;http:<span class="comment">//localhost:8080</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.052</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connecting to localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053</span> [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">62960</span>&lt;-&gt;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: <span class="keyword">set</span> socket timeout to <span class="number">3000</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Executing request GET /very-slow HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Target auth state: UNCHALLENGED</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Proxy auth state: UNCHALLENGED</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; GET /very-slow HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept: text/plain, application/json, application<span class="comment">/*+json, */</span>*</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Host: localhost:<span class="number">8080</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Connection: Keep-Alive</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; User-Agent: Apache-HttpClient/<span class="number">4.5</span><span class="number">.13</span> (Java/<span class="number">1.8</span><span class="number">.0_322</span>)</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.headers - http-outgoing-<span class="number">0</span> &gt;&gt; Accept-Encoding: gzip,deflate</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;GET /very-slow HTTP/1.1[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept: text/plain, application/json, application/*+json, */*[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Host: localhost:8080[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Connection: Keep-Alive[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;User-Agent: Apache-HttpClient/4.5.13 (Java/1.8.0_322)[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;Accept-Encoding: gzip,deflate[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.054</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;[\r][\n]&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">18.058</span> [main] DEBUG org.apache.http.wire - http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;[read] I/O error: Read timed out&quot;</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">18.059</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Close connection</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">18.060</span> [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-<span class="number">0</span>: Shutdown connection</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">18.060</span> [main] DEBUG org.apache.http.impl.execchain.MainClientExec - Connection discarded</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">18.060</span> [main] DEBUG org.apache.http.impl.conn.PoolingHttpClientConnectionManager - Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//localhost:8080][total available: 0; route allocated: 0 of 100; total allocated: 0 of 100]</span></span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-19T23:<span class="number">43</span>:<span class="number">18.067</span>] request <span class="keyword">is</span> done!</span><br><span class="line">org.springframework.web.client.ResourceAccessException: I/O error on GET request <span class="keyword">for</span> <span class="string">&quot;http://localhost:8080/very-slow&quot;</span>: Read timed <span class="keyword">out</span>; nested exception <span class="keyword">is</span> java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">785</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:<span class="number">711</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:<span class="number">334</span>)</span><br><span class="line">at com.example.playground.VerySlowResponseRestTemplatePlaygroundKt.main(VerySlowResponseRestTemplatePlayground.kt:<span class="number">30</span>)</span><br><span class="line">at com.example.playground.VerySlowResponseRestTemplatePlaygroundKt.main(VerySlowResponseRestTemplatePlayground.kt)</span><br><span class="line">Caused <span class="keyword">by</span>: java.net.SocketTimeoutException: Read timed <span class="keyword">out</span></span><br><span class="line">at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">171</span>)</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br><span class="line">at org.apache.http.impl.conn.LoggingInputStream.read(LoggingInputStream.java:<span class="number">84</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:<span class="number">137</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:<span class="number">153</span>)</span><br><span class="line">at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:<span class="number">280</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">138</span>)</span><br><span class="line">at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:<span class="number">56</span>)</span><br><span class="line">at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:<span class="number">259</span>)</span><br><span class="line">at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:<span class="number">163</span>)</span><br><span class="line">at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:<span class="number">157</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:<span class="number">273</span>)</span><br><span class="line">at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:<span class="number">125</span>)</span><br><span class="line">at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:<span class="number">272</span>)</span><br><span class="line">at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:<span class="number">186</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:<span class="number">89</span>)</span><br><span class="line">at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:<span class="number">110</span>)</span><br><span class="line">at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:<span class="number">185</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">83</span>)</span><br><span class="line">at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:<span class="number">56</span>)</span><br><span class="line">at org.springframework.http.client.HttpComponentsClientHttpRequest.executeInternal(HttpComponentsClientHttpRequest.java:<span class="number">87</span>)</span><br><span class="line">at org.springframework.http.client.AbstractBufferingClientHttpRequest.executeInternal(AbstractBufferingClientHttpRequest.java:<span class="number">48</span>)</span><br><span class="line">at org.springframework.http.client.AbstractClientHttpRequest.execute(AbstractClientHttpRequest.java:<span class="number">66</span>)</span><br><span class="line">at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:<span class="number">776</span>)</span><br><span class="line">... <span class="number">4</span> more</span><br><span class="line">[<span class="number">2022</span>-<span class="number">03</span>-19T23:<span class="number">43</span>:<span class="number">28.073</span>] main function <span class="keyword">is</span> done!</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>23:43:15.053에 서버와 커넥션 맺음. (<code>23:43:15.053 [main] DEBUG org.apache.http.impl.conn.DefaultHttpClientConnectionOperator - Connection established 127.0.0.1:62960&lt;-&gt;127.0.0.1:8080</code>)</li><li>23:43:15.054에 요청 전송 (<code>23:43:15.054 [main] DEBUG org.apache.http.wire - http-outgoing-0 &gt;&gt; ...</code>)</li><li>23:43:18.058에 Read Timeout 발생 (정확히 우리가 설정한 3초 후에 발생함, <code>23:43:18.058 [main] DEBUG org.apache.http.wire - http-outgoing-0 &lt;&lt; &quot;[read] I/O error: Read timed out&quot;</code>)</li><li>23:43:18.059 ~ 23:43:18.060에 커넥션 종료 (Keep-Alive 설정했음에도 불구하고, 정상적인 응답을 받지 못했으면 커넥션을 종료함. <code>23:43:18.059 [main] DEBUG org.apache.http.impl.conn.DefaultManagedHttpClientConnection - http-outgoing-0: Close connection</code>)</li><li>23:43:28.073에 메인함수 종료</li></ol><h3 id="서버-로그-2"><a href="#서버-로그-2" class="headerlink" title="서버 로그"></a>서버 로그</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.055</span>  INFO <span class="number">47262</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">4</span>] c.e.s.VerySlowResponseController         : request <span class="keyword">is</span> arrived!</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">44</span>:<span class="number">25.059</span>  INFO <span class="number">47262</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">4</span>] c.e.s.VerySlowResponseController         : very slow process <span class="keyword">is</span> done!</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">44</span>:<span class="number">25.062</span> ERROR <span class="number">47262</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">4</span>] c.e.playground.ControllerAdvice    : java.io.IOException: Broken pipe</span><br><span class="line"></span><br><span class="line">org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:<span class="number">310</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:<span class="number">273</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:<span class="number">118</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.implFlush(StreamEncoder.java:<span class="number">297</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:<span class="number">141</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at java.io.OutputStreamWriter.flush(OutputStreamWriter.java:<span class="number">229</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at org.springframework.util.StreamUtils.copy(StreamUtils.java:<span class="number">148</span>) ~[spring-core-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:<span class="number">126</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:<span class="number">44</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:<span class="number">227</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:<span class="number">293</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:<span class="number">183</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:<span class="number">78</span>) ~[spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">135</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.<span class="keyword">annotation</span>.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>) ~[spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>) [spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>) [spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">4.0</span>.FR]</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>) [spring-webmvc-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">4.0</span>.FR]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>) [tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>) [spring-web-<span class="number">5.3</span><span class="number">.16</span>.jar:<span class="number">5.3</span><span class="number">.16</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">540</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">359</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">889</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1735</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">750</span>) [na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">Caused <span class="keyword">by</span>: java.io.IOException: Broken pipe</span><br><span class="line">at sun.nio.ch.FileDispatcherImpl.write0(Native Method) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:<span class="number">47</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:<span class="number">93</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.IOUtil.write(IOUtil.java:<span class="number">65</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:<span class="number">470</span>) ~[na:<span class="number">1.8</span><span class="number">.0_322</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:<span class="number">135</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:<span class="number">1376</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:<span class="number">766</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:<span class="number">719</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:<span class="number">709</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:<span class="number">573</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.filters.IdentityOutputFilter.flush(IdentityOutputFilter.java:<span class="number">117</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:<span class="number">221</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:<span class="number">1255</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:<span class="number">402</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.coyote.Response.action(Response.java:<span class="number">209</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:<span class="number">306</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.58</span>.jar:<span class="number">9.0</span><span class="number">.58</span>]</span><br><span class="line">... <span class="number">56</span> common frames omitted</span><br></pre></td></tr></table></figure><ol><li>23:43:15.055에 요청 도착</li><li>23:44:25.059에 처리 완료 (70초 걸림)</li><li>23:44:25.062에 <code>ClientAbortException(java.io.IOException: Broken pipe)</code> 발생</li></ol><h3 id="패킷-로그-소켓-상태-2"><a href="#패킷-로그-소켓-상태-2" class="headerlink" title="패킷 로그 (소켓 상태)"></a>패킷 로그 (소켓 상태)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">97</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053056</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">62960</span> → <span class="number">8080</span> [SYN] Seq=<span class="number">0</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">2309492195</span> TSecr=<span class="number">0</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">98</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053210</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">68</span><span class="number">8080</span> → <span class="number">62960</span> [SYN, ACK] Seq=<span class="number">0</span> Ack=<span class="number">1</span> Win=<span class="number">65535</span> Len=<span class="number">0</span> MSS=<span class="number">16344</span> WS=<span class="number">64</span> TSval=<span class="number">234888919</span> TSecr=<span class="number">2309492195</span> SACK_PERM=<span class="number">1</span></span><br><span class="line"><span class="number">99</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053225</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">62960</span> → <span class="number">8080</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">2309492195</span> TSecr=<span class="number">234888919</span></span><br><span class="line"><span class="number">100</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.053235</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span>[TCP Window Update] <span class="number">8080</span> → <span class="number">62960</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">234888919</span> TSecr=<span class="number">2309492195</span></span><br><span class="line"><span class="number">101</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.055087</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>HTTP<span class="number">278</span>GET /very-slow HTTP/<span class="number">1.1</span> </span><br><span class="line"><span class="number">102</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">15.055106</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">62960</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">223</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">234888922</span> TSecr=<span class="number">2309492198</span></span><br><span class="line"><span class="number">103</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">18.060226</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">62960</span> → <span class="number">8080</span> [FIN, ACK] Seq=<span class="number">223</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span> TSval=<span class="number">2309495203</span> TSecr=<span class="number">234888922</span></span><br><span class="line"><span class="number">104</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">43</span>:<span class="number">18.060286</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">56</span><span class="number">8080</span> → <span class="number">62960</span> [ACK] Seq=<span class="number">1</span> Ack=<span class="number">224</span> Win=<span class="number">408064</span> Len=<span class="number">0</span> TSval=<span class="number">234891927</span> TSecr=<span class="number">2309495203</span></span><br><span class="line"><span class="number">119</span><span class="number">2022</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">23</span>:<span class="number">44</span>:<span class="number">18.060374</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>TCP<span class="number">44</span><span class="number">62960</span> → <span class="number">8080</span> [RST, ACK] Seq=<span class="number">224</span> Ack=<span class="number">1</span> Win=<span class="number">408256</span> Len=<span class="number">0</span></span><br></pre></td></tr></table></figure><ol><li>97 ~ 99번 패킷은 TCP 3 Way Handshake (syn, syn&#x2F;ack, ack)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/tcp-3-way-handshake.png" class=""><img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-3-way-handshake-socket-status.png" class=""></li><li>101번 패킷에서 클라이언트 → 서버로 HTTP 요청 패킷 전송 (23:43:15.055087)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-send-http-request-packet.png" class=""></li><li>102번 패킷에서 서버가 요청 잘 받았다고 클라이언트한테 ACK 패킷 전송 (23:43:15.055106)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-send-http-request-ack-packet.png" class=""></li><li>103번 패킷에서 클라이언트는 커넥션을 종료한다고 FIN&#x2F;ACK 패킷을 서버에게 전송 (23:43:18.060226, 정확히 HTTP 패킷 보내고 3초 후(read timeout)임.)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-send-fin-packet.png" class=""></li><li>104번 패킷에서 서버가 클라이언트로부터 FIN&#x2F;ACK 패킷을 잘 받았다고 반대로 ACK 패킷을 클라이언트에게 보냄 (23:43:18.060286)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-send-ack-packet.png" class=""></li><li>클라이언트가 먼저 연결을 종료하겠다는 FIN 패킷을 보냈기 때문에 클라이언트가 Active Close<br>서버는 클라이언트로부터 FIN 패킷을 받았기 때문에 서버는 Passive Close가 됨<br>(무조건 클라이언트가 Active Close는 아니고 경우에 따라서 다름)<br>그리고 아직까지는 서버(Passive Close)로부터 FIN 패킷을 받은 게 아니기 때문에 소켓이 정상적으로 종료된 게 아님.<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/tcp-termination.png" class=""></li><li>서버 측 소켓의 상태는 CLOSE_WAIT(클라이언트가 보낸 FIN 패킷을 받았으므로)이고, 클라이언트 측 소켓의 상태는 FIN_WAIT_2(서버가 보낸 ACK 패킷을 받았으므로)이다. (23:43:18)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-fin-ack-socket-status-01.png" class=""></li><li>서버는 클라이언트로부터 FIN 패킷을 받았지만 아직 보낼 패킷이 남아있기 때문인지 클라이언트에게 FIN 패킷을 보내지 않음.<br>그리고 Active Close(클라이언트) 측에서는 오동작을 막기 위해 바로 소켓의 연결을 끊는 게 아니라 60초(OS마다 다르지만 tcp_fin_timeout(대다수의 리눅스는 60로초 설정됨)) 동안 대기하게 됨. (23:44:17)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-fin-ack-socket-status-02.png" class=""></li><li>119번 패킷에서 이제 기다릴만큼 다 기다렸는데도 서버 측에서 FIN 패킷이 오지 않기 때문에 클라이언트 → 서버로 RST, ACK 패킷을 날림. (23:44:18.060374, 정확하게 서버로 ACK 패킷 받은 이후부터 60초간 대기한 후 전송)<img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-send-rst-packet.png" class=""></li><li>RST 패킷을 전송한 이후에 클라이언트&#x2F;서버 측 소켓이 정상적으로 종료됨 (23:44:18)</li></ol>   <img src="/2022/03/20/client-abort-exception-deep-dive-part-01/read-timout-over-60s-send-rst-packet-socket-status.png" class=""><h1 id="ClientAbortException을-해결하려면"><a href="#ClientAbortException을-해결하려면" class="headerlink" title="ClientAbortException을 해결하려면?"></a>ClientAbortException을 해결하려면?</h1><ol><li>서버 측에서 처리 속도를 더 빠르게 한다.</li><li>처리 속도는 빠르지만 응답이 크다면 응답의 사이즈를 줄인 API를 제공한다 (불필요한 필드 제거 or 페이징 API 제공)</li><li>클라이언트 측 리드 타임아웃 설정값을 늘린다.</li><li>정 합의가 안 된다면 ClientAbortException을 핸들링 해서 log.info로만 남긴다. (장애 상황은 아니라서 불필요한 노이즈라고 판단된다는 가정 하에)</li><li>클라이언트 측에서는 ReadTimeout이 발생했다면(ClientAbortException 여부와 상관 없이), 장애 상황(고객에게 돈은 출금이 됐는데 주문은 완료처리 안 됐다던지)을 막기 위해 서버 측에 취소 API 같은 걸 호출하거나 상태 조회 API 같은 걸 호출한 이후 내가 처리를 따로 해야하는 건지 아닌지 판단한 후에 올바른 처리를 해줘야한다.</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;서버에서 아주 가끔가다가 ClientAbortException(java.io.IOExceiption: Broken pipe)이 발생해서 어떨 때 발생하는지 딥다이브 해봄.&lt;/p&gt;
&lt;img src=&quot;/2022/03/20/client-abort-exception-deep-dive-part-01/stacktrace.png&quot; class&gt;

&lt;p&gt;적다보니 글이 길어져 글을 나누었는데 해당 글을 읽고 난 후에 &lt;a href=&quot;/2022/03/20/client-abort-exception-deep-dive-part-02&quot;&gt;(Tomcat) ClientAbortException은 왜 발생할까? (Part 2)&lt;/a&gt;를 마저 보는 것을 추천함.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;a href=&quot;https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html&quot;&gt;https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/connector/ClientAbortException.html&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="tomcat" scheme="https://perfectacle.github.io/categories/tomcat/"/>
    
    
    <category term="Spring Boot" scheme="https://perfectacle.github.io/tags/Spring-Boot/"/>
    
    <category term="Tomcat" scheme="https://perfectacle.github.io/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>(Gradle) 테스트 의존성 관리하기 (feat. java-test-fixtures 플러그인)</title>
    <link href="https://perfectacle.github.io/2022/03/13/gradle-java-test-fixtures-plugin/"/>
    <id>https://perfectacle.github.io/2022/03/13/gradle-java-test-fixtures-plugin/</id>
    <published>2022-03-13T00:02:03.000Z</published>
    <updated>2025-12-09T17:06:50.193Z</updated>
    
    <content type="html"><![CDATA[<h2 id="들어가기에-앞서"><a href="#들어가기에-앞서" class="headerlink" title="들어가기에 앞서"></a>들어가기에 앞서</h2><p><a href="/2022/03/12/gradle-implementation-vs-api/">(Gradle) implementation vs api</a>에서는 compile&#x2F;runtime 의존성을 관리하는 방법에 대해 정리했다.<br>하지만 이는 실제 src&#x2F;main 경로에 대해서만 의존성을 관리하는 것이지 src&#x2F;test 경로에서 사용하는 테스트 의존성(testCompileClasspath, testRuntimeClasspath)에 대해서는 딥하게 다루지 않았다.<br>테스트도 관리해야할 대상이고 하나의 소프트웨어라는 관점에서 테스트의 의존성 조차도 신경을 써줘야한다.</p><h2 id="testImplementation"><a href="#testImplementation" class="headerlink" title="testImplementation"></a>testImplementation</h2><img src="/2022/03/13/gradle-java-test-fixtures-plugin/api-structure.png" class=""><img src="/2022/03/13/gradle-java-test-fixtures-plugin/implementation-structure.png" class=""><p>기본적으로 <a href="/2022/03/12/gradle-implementation-vs-api/#implementation">implementation</a>과 <a href="/2022/03/12/gradle-implementation-vs-api/#api">api</a>로 의존성을 추가한 경우에도 testCompileClasspath, testRuntimeClasspath에 추가돼서 테스트에서도 사용이 가능하다.<br>하지만 compileClasspath, runtimeClasspath에도 추가되다보니 실제 프로덕션에서는 사용할 필요가 없고, 테스트에서만 사용할 목적으로 testImplementation을 많이 사용한다.</p><p><a href="https://docs.gradle.org/current/userguide/java_plugin.html#tab:configurations">testImplementation</a>으로 의존성을 관리하기 위해서는 <a href="https://docs.gradle.org/current/userguide/java_plugin.html">java 플러그인</a>을 활성화해야한다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>멀티 모듈인 경우 아래와 같이 활성화 시켜줘야한다. (java는 gradle core 플러그인이기 때문에 plugins 모듈에 별도로 정의 안 하고도 서브 모듈들에게 적용이 가능하다.)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subprojects &#123;</span><br><span class="line">    apply <span class="attr">plugin:</span> <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>build.gradle.kts에서는 kotlin jvm 플러그인만 활성화 시켜주면 된다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;<span class="variable">$kotlinVersion</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>멀티 모듈인 경우 아래와 같이 활성화 시켜줘야한다. (kotlin jvm 플러그인은 gradle core 플러그인이 아니기 때문에 plugins 모듈에 별도로 정의 해놔야 서브 모듈들에게 적용이 가능하다.)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;<span class="variable">$kotlinVersion</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subprojects &#123;</span><br><span class="line">    apply(plugin = <span class="string">&quot;org.jetbrains.kotlin.jvm&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 의존성 추가를 위해 build.gradle(or build.gradle.kts)에 아래와 같이 디펜던시들을 추가하게 된다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    testImplementation(<span class="string">&quot;org.junit.jupiter:junit-jupiter:5.8.2&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-implementation-single-module.png" class=""><p>실제로 gradle dependency를 보게되면 compileClasspath와 runtimeClasspath에는 추가되지 않고, testCompileClasspath와 testRuntimeClasspath에만 추가된 걸 볼 수 있다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-implementaion-can-use-in-test.png" class=""><p>testCompileClasspath에 추가됐기 때문에 src&#x2F;test에서 junit 5를 사용할 수 있다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-implementaion-can-not-use-in-test.png" class=""><p>compileClasspath에 추가되지 않았기 때문에 src&#x2F;main에서는 junit 5를 사용할 수 없다.</p><h2 id="테스트-경로에-있는-클래스들을-외부로-노출시키기"><a href="#테스트-경로에-있는-클래스들을-외부로-노출시키기" class="headerlink" title="테스트 경로에 있는 클래스들을 외부로 노출시키기"></a>테스트 경로에 있는 클래스들을 외부로 노출시키기</h2><p>단일 모듈의 경우에는 testImplementation, testCompileOnly, testRuntimeOnly 정도로 테스트 전용으로 의존성을 관리할 수 있다.<br>하지만 멀티 모듈의 경우에는 조금 복잡해진다.</p><ul><li>라이브러리: jakcson-core, spring-tx, 우리 프로젝트 내에서 만드는 모듈들 등등</li><li>컨슈머: 프로젝트 내에서 라이브러리를 사용하는 모듈, 우리 프로젝트에서 위 라이브러리들을 사용하는 모듈 등등</li></ul><p>프로젝트에 두 가지 모듈(producer와 consumer)을 만들어서 차이점을 확인해보자.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/producer-consumer-structur.png" class=""><p>producer는 모듈을 제공하는 측이고, consumer는 모듈을 소비하는 측이다.<br>따라서 consumer 모듈의 build.gradle(또는 build.gradle.kts)를 보면 producer 모듈에 의존하는 모습을 볼 수 있다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation(project(<span class="string">&quot;:producer&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 때 producer 모듈에 기본 생성자는 없고, 생성자에 인자가 많아서 생성하기 번거로운 클래스가 있다고 가정해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Some</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String hobby;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String zipCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Some</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> <span class="type">int</span> age, <span class="keyword">final</span> String hobby, <span class="keyword">final</span> String address, <span class="keyword">final</span> String zipCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">        <span class="built_in">this</span>.zipCode = zipCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>테스트에서 생성자에 모든 인자를 넣어서 매번 생성하기 번거로우므로 아래와 같은 빌더를 src&#x2F;test 하위 경로에 만들자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SomeBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String hobby;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> String zipCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SomeBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SomeBuilder <span class="title function_">aSome</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SomeBuilder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SomeBuilder <span class="title function_">withName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SomeBuilder <span class="title function_">withAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SomeBuilder <span class="title function_">withHobby</span><span class="params">(String hobby)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SomeBuilder <span class="title function_">withAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SomeBuilder <span class="title function_">withZipCode</span><span class="params">(String zipCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.zipCode = zipCode;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Some <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Some</span>(name, age, hobby, address, zipCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이제 내가 원하는 인자들만 설정하고 나머지는 빌더에 설정된 기본값을 사용하여 테스트에서 쉽게 해당 객체를 찍어낼 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Some</span> <span class="variable">givenSome</span> <span class="operator">=</span> SomeBuilder.aSome().withName(<span class="string">&quot;name&quot;</span>).build();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>producer 모듈에서 테스트 작성 시에 이렇게 SomeBuilder를 통해 원하는 객체를 원하는 모양으로 쉽게 찍어낼 수 있었는데 consumer 모듈에서는 어떨까??</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-class-file-does-not-expose.png" class=""><p>consumer 모듈에서는 producer 모듈의 src&#x2F;main에 있는 Some 클래스에는 접근이 가능한데 src&#x2F;test에 있는 SomeBuilder 클래스에는 접근이 안 된다.  </p><p>왜 그런 걸까??<br>우선 프로젝트를 빌드해보자.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">./gradlew build</span><br><span class="line"></span><br><span class="line">1:03:15 AM: Executing &#x27;build&#x27;...</span><br><span class="line"></span><br><span class="line">&gt; Task :producer:compileJava</span><br><span class="line">&gt; Task :producer:processResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:classes</span><br><span class="line">&gt; Task :producer:jar</span><br><span class="line">&gt; Task :consumer:compileJava NO-SOURCE</span><br><span class="line">&gt; Task :consumer:processResources NO-SOURCE</span><br><span class="line">&gt; Task :consumer:classes UP-TO-DATE</span><br><span class="line">&gt; Task :consumer:jar</span><br><span class="line">&gt; Task :consumer:assemble</span><br><span class="line">&gt; Task :consumer:compileTestJava</span><br><span class="line">&gt; Task :consumer:processTestResources NO-SOURCE</span><br><span class="line">&gt; Task :consumer:testClasses</span><br><span class="line">&gt; Task :consumer:test</span><br><span class="line">&gt; Task :consumer:check</span><br><span class="line">&gt; Task :consumer:build</span><br><span class="line">&gt; Task :producer:assemble</span><br><span class="line">&gt; Task :producer:compileTestJava</span><br><span class="line">&gt; Task :producer:processTestResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:testClasses</span><br><span class="line">&gt; Task :producer:test</span><br><span class="line">&gt; Task :producer:check</span><br><span class="line">&gt; Task :producer:build</span><br></pre></td></tr></table></figure><img src="/2022/03/13/gradle-java-test-fixtures-plugin/jar-contains-only-src-main-class.png" class=""><p>그리고 나서 producer 모듈의 빌드된 jar를 까보면 src&#x2F;main에 있는 Some 클래스만 존재하는 걸 볼 수 있다.<br>애초에 jar 파일에 SomeBuilder가 존재하지 않기 때문에 consumer 모듈에서는 접근조차 불가능한 것이다.</p><p>그럼 문제를 어떻게 해결해야할까?<br>가장 간단한 방법은 consumer 모듈의 src&#x2F;test에도 똑같이 SomeBuilder 파일을 복붙하는 방법이다.<br>하지만 IDE의 리팩토링 기능으로 관리가 되지 않기 때문에 동일한 파일을 두 번 관리해야한다는 매우 비효율을 낳게 된다.</p><h3 id="구세주-java-test-fixtures-플러그인"><a href="#구세주-java-test-fixtures-플러그인" class="headerlink" title="구세주 java-test-fixtures 플러그인"></a>구세주 java-test-fixtures 플러그인</h3><p>src&#x2F;main에 있는 파일만 jar로 뽑듯이 src&#x2F;test에 있는 파일들도 jar로 뽑아내기 위해 gradle에는 <a href="https://docs.gradle.org/current/userguide/java_testing.html#sec:java_test_fixtures">java-test-fixtures</a>라는 플러그인이 존재한다. </p><p>먼저 src&#x2F;test 하위 경로에 있는 파일들을 노출시키고 싶은 producer 모듈의 build.gradle 파일에 java-test-fixtures 플러그인을 추가해주자.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java-test-fixtures&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>build.gradle.kts 같은 경우에는 아래와 같이 추가하면 된다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    `java-test-fixtures`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/03/13/gradle-java-test-fixtures-plugin/java-test-fixtures-directory.png" class=""><p>플러그인을 추가한 후 producer 모듈에 새로운 경로를 추가하려고 하면 인텔리제이와 같은 IDE에서 testFixtures 경로를 자동으로 추천해주게 된다.</p><p>그리고 testFixtures 하위에 있는 파일들은 아래와 같은 특징을 가진다.</p><ul><li>they can see the main source set classes (src&#x2F;testFixtures에 존재하는 클래스에서 src&#x2F;main에 존재하는 클래스에 접근 가능)</li><li>test sources can see the test fixtures classes (src&#x2F;test에 존재하는 테스트 클래스에서 src&#x2F;testFixtures 클래스에 접근 가능)</li></ul><img src="/2022/03/13/gradle-java-test-fixtures-plugin/before-test-fixtures-classpath.png" class=""><p>java-test-fixtures 플러그인을 추가하기 전에는 testCompileClasspath와 testRuntimeClasspath만 존재하고, junit 5만 의존성으로 가지고 있는 모습이다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/after-test-fixtures-classpath.png" class=""><p>java-test-fixtures 플러그인을 추가하고 보면 testFixturesCompileClasspath와 testFixturesRuntimeClasspath가 추가된 모습을 볼 수 있다.<br>testCompileClasspath와 testRuntimeClasspath에 포함된 producer 모듈들은 아마 producer&#x2F;src&#x2F;main, producer&#x2F;src&#x2F;testFixtures 모듈이 아닐까 싶다.<br>그리고 testFixturesCompileClasspath와 testFixturesRuntimeClasspath에 포함된 producer 모듈은 producer&#x2F;src&#x2F;main 모듈이 아닐까 싶다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/builder-move-to-test-fixtures.png" class=""><p>그렇기에 SomeBuilder를 src&#x2F;test에서 src&#x2F;testFixutres로 옮겨도 아무런 문제가 없다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-fixtures-can-not-see-test.png" class=""><p>testFixtures에서는 main에 있는 Some에는 접근이 가능하지만 test에 있는 SomeTest2에는 접근이 불가능하다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-can-see-both-main-and-test-fixtures.png" class=""><p>test에서는 main에 있는 Some과 testFixtures에 있는 SomeBuilder에 모두 접근이 가능하다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/main-can-not-see-both-test-and-test-fixtures.png" class=""><p>main에서는 당연하게도 test에 있는 SomeTest와 testFixtures에 있는 SomeBuilder에 모두 접근이 불가능하다.</p><p>이 상태에서 다시 빌드를 때려보자</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">./gradlew build</span><br><span class="line"></span><br><span class="line">1:22:00 AM: Executing &#x27;build&#x27;...</span><br><span class="line"></span><br><span class="line">&gt; Task :producer:compileJava</span><br><span class="line">&gt; Task :producer:processResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:classes</span><br><span class="line">&gt; Task :producer:jar</span><br><span class="line">&gt; Task :consumer:compileJava NO-SOURCE</span><br><span class="line">&gt; Task :consumer:processResources NO-SOURCE</span><br><span class="line">&gt; Task :consumer:classes UP-TO-DATE</span><br><span class="line">&gt; Task :consumer:jar</span><br><span class="line">&gt; Task :consumer:assemble</span><br><span class="line">&gt; Task :consumer:compileTestJava</span><br><span class="line">&gt; Task :consumer:processTestResources NO-SOURCE</span><br><span class="line">&gt; Task :consumer:testClasses</span><br><span class="line">&gt; Task :consumer:test</span><br><span class="line">&gt; Task :consumer:check</span><br><span class="line">&gt; Task :consumer:build</span><br><span class="line">&gt; Task :producer:assemble</span><br><span class="line">&gt; Task :producer:compileTestFixturesJava</span><br><span class="line">&gt; Task :producer:compileTestJava</span><br><span class="line">&gt; Task :producer:processTestResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:testClasses</span><br><span class="line">&gt; Task :producer:processTestFixturesResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:testFixturesClasses</span><br><span class="line">&gt; Task :producer:testFixturesJar</span><br><span class="line">&gt; Task :producer:test</span><br><span class="line">&gt; Task :producer:check</span><br><span class="line">&gt; Task :producer:build</span><br></pre></td></tr></table></figure><p>기존에는 보지 못했던 testFixtures 관련 태스크들이 수행된 것을 볼 수 있다.</p><ul><li>:producer:compileTestFixturesJava</li><li>:producer:processTestFixturesResources</li><li>:producer:testFixturesClasses</li><li>:producer:testFixturesJar</li></ul><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-fixtures-jar.png" class=""><p>그리고 빌드된 jar를 보면 *-test-fixtures.jar 파일이 추가됐고, 해당 jar를 까보면 testFixtures 하위에 존재하던 SomeBuilder가 존재한다.<br>이렇듯 java-test-fixtures 플러그인은 src&#x2F;test 하위에 존재하는 불필요한 테스트 클래스는 jar에 포함시키지 않고 내가 원하는 클래스들만 jar에 추가시켜준다.</p><p>하지만 이렇게 test-fixtures.jar로 빌드했다고 해서 바로 consumer 모듈에서 사용할 수 있는 건 아니다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/before-test-implementation-test-fixtures.png" class=""><p>consumer 모듈의 의존성을 보면 testCompileClasspath와 testRuntimeClasspath에 producer 모듈이 존재하긴 하는데 이건 일반 jar(src&#x2F;main을 빌드한)만 의존성으로 가지고 있다는 뜻이다.</p><p>아래와 같이 test-fixtures.jar(src&#x2F;testFixtures를 빌드한)도 의존성으로 추가해줘야한다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testImplementation(testFixtures(project(<span class="string">&quot;:producer&quot;</span>)))</span><br></pre></td></tr></table></figure><img src="/2022/03/13/gradle-java-test-fixtures-plugin/after-test-implementation-test-fixtures.png" class=""><p>testImplementation으로 추가했기 때문에 compileClasspath와 runtimeClasspath에는 전혀 차이가 존재하지 않고, testCompileClasspath와 testRuntimeClasspath에만 producer 모듈(test-fixtures.jar)이 의존성에 추가된 걸 볼 수 있다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/consumer-test-can-see-both-producer-main-and-test-fixtures.png" class=""><p>이렇게 consumer 모듈의 테스트 클래스에서도 producer 모듈의 src&#x2F;testFixtures에 존재하는 SomeBuilder와 producer 모듈의 src&#x2F;main에 존재하는 Some 클래스에 모두 접근이 가능한 것을 볼 수 있다.<br>그리고 jar에 포함되지 않는 producer 모듈의 src&#x2F;test에 존재하는 SomeTest 클래스에는 접근이 불가능하다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/consumer-main-can-not-see-producer-test-fixtures.png" class=""><p>당연히 consumer 모둘의 src&#x2F;main에 존재하는 클래스에서는 producer 모듈의 src&#x2F;testFixtures에 존재하는 SomeBuilder에는 접근이 불가능하다.<br>대신 producer 모듈의 src&#x2F;main에 존재하는 Some 클래스에는 접근이 가능하다.</p><h2 id="테스트-의존성을-외부로-노출시키기"><a href="#테스트-의존성을-외부로-노출시키기" class="headerlink" title="테스트 의존성을 외부로 노출시키기"></a>테스트 의존성을 외부로 노출시키기</h2><p>만약 producer 모듈에서 인메모리 db로 테스트 할 일이 있어서 h2 db를 testRuntimeOnly로 추가했다고 가정해보자.<br>(h2 db의 클래스는 우리 테스트 클래스에서 직접 사용하기 보다는 Spring Boot Auto Configuration 등등에서 런타임에 사용하기 때문에 testCompileClasspath에는 추가될 필요가 딱히 없다.)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testRuntimeOnly(<span class="string">&quot;com.h2database:h2:2.1.210&quot;</span>)</span><br></pre></td></tr></table></figure><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-runtime-only-h2.png" class=""><p>testRuntimeOnly로 추가했기 때문에 testRuntimeClasspath를 제외한 다른 클래스패스에는 h2가 추가되지 않았다.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-runtime-only-can-not-see-in-test.png" class=""><p>testCompileClasspath에 존재하지 않기 때문에 테스트 클래스에서 H2 관련 클래스를 사용해서 컴파일 하면 컴파일 타임에 오류가 난다. (왜 IDE에서는 빨간 줄이 생기지 않는지 의문이다. 일시적 버그인가…)</p><p>그리고 consumer 모듈에서도 h2를 사용하여 테스트를 진행한다고 가정해보자.</p><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-runtime-only-can-not-see-in-consumer.png" class=""><p>하지만 단순히 producer 모듈에 testRuntimeOnly로 h2를 추가했다 하더라도 consumer 모듈의 testRuntimeClasspath에는 노출되지 않는다.<br>producer 모듈은 (testFixtures)compile&#x2F;runtimeClasspath를 기준으로 jar 파일을 생성하고 consumer 모듈에서 해당 jar 파일에 의존하게 되는데 h2는 해당 클래스패스에는 존재하지 않고, testRuntimeClasspath에만 존재하기 때문이다.</p><p>따라서 producer 모듈의 testFixturesCompileClasspath&#x2F;testFixturesRuntimeClasspath에 추가해야 test-fixtures.jar에 의존성이 추가되고</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testFixturesRuntimeOnly(<span class="string">&quot;com.h2database:h2:2.1.210&quot;</span>)</span><br></pre></td></tr></table></figure><p>consumer 모듈에서도 test-fixtures.jar를 의존성으로 추가해줘야</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testImplementation(testFixtures(project(<span class="string">&quot;:producer&quot;</span>)))</span><br></pre></td></tr></table></figure><img src="/2022/03/13/gradle-java-test-fixtures-plugin/test-fixtures-runtime-only-can-see-in-consumer-test.png" class=""><p>consumer 모듈의 testRuntimeClasspath에도 h2가 의존성으로 추가된 모습을 볼 수 있다.</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;들어가기에-앞서&quot;&gt;&lt;a href=&quot;#들어가기에-앞서&quot; class=&quot;headerlink&quot; title=&quot;들어가기에 앞서&quot;&gt;&lt;/a&gt;들어가기에 앞서&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;/2022/03/12/gradle-implementation-vs-api/&quot;&gt;(Gradle) implementation vs api&lt;/a&gt;에서는 compile&amp;#x2F;runtime 의존성을 관리하는 방법에 대해 정리했다.&lt;br&gt;하지만 이는 실제 src&amp;#x2F;main 경로에 대해서만 의존성을 관리하는 것이지 src&amp;#x2F;test 경로에서 사용하는 테스트 의존성(testCompileClasspath, testRuntimeClasspath)에 대해서는 딥하게 다루지 않았다.&lt;br&gt;테스트도 관리해야할 대상이고 하나의 소프트웨어라는 관점에서 테스트의 의존성 조차도 신경을 써줘야한다.&lt;/p&gt;
&lt;h2 id=&quot;testImplementation&quot;&gt;&lt;a href=&quot;#testImplementation&quot; class=&quot;headerlink&quot; title=&quot;testImplementation&quot;&gt;&lt;/a&gt;testImplementation&lt;/h2&gt;&lt;img src=&quot;/2022/03/13/gradle-java-test-fixtures-plugin/api-structure.png&quot; class&gt;
&lt;img src=&quot;/2022/03/13/gradle-java-test-fixtures-plugin/implementation-structure.png&quot; class&gt;</summary>
    
    
    
    <category term="gradle" scheme="https://perfectacle.github.io/categories/gradle/"/>
    
    
    <category term="gradle" scheme="https://perfectacle.github.io/tags/gradle/"/>
    
  </entry>
  
  <entry>
    <title>(Gradle) implementation vs api</title>
    <link href="https://perfectacle.github.io/2022/03/12/gradle-implementation-vs-api/"/>
    <id>https://perfectacle.github.io/2022/03/12/gradle-implementation-vs-api/</id>
    <published>2022-03-12T19:43:25.000Z</published>
    <updated>2025-12-09T17:06:50.191Z</updated>
    
    <content type="html"><![CDATA[<p>3줄 요약</p><ol><li><a href="#implementation">implementation</a>을 사용하자</li><li>implementation을 사용하더라도 라이브러리를 사용하는 <a href="#%EA%B7%B8%EB%9F%BC-implementation%EB%A7%8C-%EC%93%B0%EB%A9%B4-%EB%A7%8C%EC%82%AC-OK%EC%9D%BC%EA%B9%8C">consumer 측의 runtimeClassPath에 추가되기 때문에 런타임 의존성 충돌</a>이 발생할 수 있으니 의존성은 최대한 적게 추가하자.</li><li><a href="#api">api</a>가 필요한 건지 100번 고민하고 설계가 잘못된 건 아닌지 의심해 본 후 api를 사용한다. (api는 consumer의 compile&#x2F;runtimeClassPath에 모두 추가된다.)</li></ol><h2 id="들어가기에-앞서"><a href="#들어가기에-앞서" class="headerlink" title="들어가기에 앞서"></a>들어가기에 앞서</h2><p>의존성(라이브러리&#x2F;프레임워크)을 추가하기 위해 build.gradle(or build.gradle.kts)에 아래와 같이 디펜던시들을 추가하게 된다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    api(<span class="string">&quot;org.springframework.boot:spring-boot-starter-web&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;com.fasterxml.jackson.module:jackson-module-kotlin&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>참고로 compile은 depreacate 됐기 때문에 사용하면 안 되고 implementation을 쓰라고 나와있다. (compile은 api와 마찬가지로 consumer의 (test)compile&#x2F;runtimeClassPath에 모두 추가되니 사용하지 않는 게 좋다.)</p><blockquote><p>The compile configuration has been deprecated for dependency declaration.<br>This will fail with an error in Gradle 7.0. Please use the implementation configuration instead.<br>Consult the upgrading guide for further information: <a href="https://docs.gradle.org/6.9/userguide/upgrading_version_5.html#dependencies_should_no_longer_be_declared_using_the_compile_and_runtime_configurations">https://docs.gradle.org/6.9/userguide/upgrading_version_5.html#dependencies_should_no_longer_be_declared_using_the_compile_and_runtime_configurations</a></p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated(message = <span class="string">&quot;The compile configuration has been deprecated for dependency declaration. Please use the &#x27;implementation&#x27; configuration instead.&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> DependencyHandler.`compile`<span class="params">(dependencyNotation: <span class="type">Any</span>)</span></span>: Dependency? =</span><br><span class="line">    add(<span class="string">&quot;compile&quot;</span>, dependencyNotation)</span><br></pre></td></tr></table></figure><p>그럼 implementation은 뭐고 api는 뭘까??</p><h2 id="implementation"><a href="#implementation" class="headerlink" title="implementation"></a>implementation</h2><p><a href="https://docs.gradle.org/current/userguide/java_plugin.html#tab:configurations">implementation</a>으로 의존성을 관리하기 위해서는 <a href="https://docs.gradle.org/current/userguide/java_plugin.html">java 플러그인</a>을 활성화해야한다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>멀티 모듈인 경우 아래와 같이 활성화 시켜줘야한다. (java는 gradle core 플러그인이기 때문에 plugins 모듈에 별도로 정의 안 하고도 서브 모듈들에게 적용이 가능하다.)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subprojects &#123;</span><br><span class="line">    apply <span class="attr">plugin:</span> <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>build.gradle.kts에서는 kotlin jvm 플러그인만 활성화 시켜주면 된다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;<span class="variable">$kotlinVersion</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>멀티 모듈인 경우 아래와 같이 활성화 시켜줘야한다. (kotlin jvm 플러그인은 gradle core 플러그인이 아니기 때문에 plugins 모듈에 별도로 정의 해놔야 서브 모듈들에게 적용이 가능하다.)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;<span class="variable">$kotlinVersion</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subprojects &#123;</span><br><span class="line">    apply(plugin = <span class="string">&quot;org.jetbrains.kotlin.jvm&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/03/12/gradle-implementation-vs-api/implementation-structure.png" class=""><p>출처: <a href="https://docs.gradle.org/current/userguide/java_plugin.html#tab:configurations">https://docs.gradle.org/current/userguide/java_plugin.html#tab:configurations</a></p><p>기본적으로 implementation으로 의존성을 추가한다는 사실은 아래 클래스패스에 추가한다는 사실이다.</p><ul><li>compileClassPath: main 경로에서 해당 모듈을 컴파일할 때 사용함, 우리가 spring-tx 모듈의 @Transactional 어노테이션을 사용하는데 컴파일 클래스패스에 존재하지 않는다면 컴파일에 실패함. (대표적으로 lombok이 어노테이션 프로세서에 의해 소스코드에 있는 어노테이션을 해석하여 실제로 소스코드로 컴파일 할 때는 전부 사라지기 때문에 compileClassPath에만 존재하면 되고, runtimeClassPath에는 필요없는 경우이다. 그래서 <a href="https://mvnrepository.com/artifact/org.projectlombok/lombok/1.18.22">lombok을 compileOnly로 추가</a>하는 게 좋다.)</li><li>runtimeClassPath: main 경로에서 해당 모듈을 런타임에서 사용함, 우리가 컴파일한 소스코드를 실행할 때(런타임) spring-tx 모듈의 @Transactional 어노테이션을 사용하는데 런타임 클래스패스에 존재하지 않는다면 @Transactional을 사용하는 코드로 진입 시에 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/NoClassDefFoundError.html">NoClassDefFoundError</a>나 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ClassNotFoundException.html">ClassNotFoundException</a>과 같은 에러&#x2F;예외가 발생하며 서버가 제대로 뜨지 않거나 서버는 떴는데 특정 API만 호출하면 장애가 발생할 수도 있다. (대표적으로 mysql-connector-java 같은 경우가 우리가 소스코드에서 직접적으로 사용하지는 않기 때문에 compileClassPath에서는 필요 없는데 런타임에 jdbc 드라이버라던지 HikariCP 등등에서 사용할 것이기 때문에 runtimeClassPath에만 존재하면 되고, compileClassPath에는 필요없는 경우이다. 그래서 mysql-connector-java를 runtimeOnly로 추가하는 게 좋다.)</li><li>testCompileClassPath: test 경로에서 해당 모듈을 컴파일할 때 사용함, 우리가 spring-boot-test 모듈의 @SpringBootTest 어노테이션을 사용하는데 컴파일 클래스패스에 존재하지 않는다면 컴파일에 실패함. (대표적으로 junit 같은 경우가 실제 어플리케이션을 구동하는데는 필요하지 않고, 테스트를 수행하는데 필요하기 때문에 testImplementation으로 추가하는 게 좋다.)</li><li>testRuntimeClassPath: test 경로에서 해당 모듈을 런타임에서 사용함, 우리가 컴파일한 소스코드를 실행할 때(런타임) spring-boot-test 모듈의 @SpringBootTest 어노테이션을 사용하는데 런타임 클래스패스에 존재하지 않는다면 @SpringBootTest을 사용하는 코드로 진입 시에 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/NoClassDefFoundError.html">NoClassDefFoundError</a>나 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ClassNotFoundException.html">ClassNotFoundException</a>과 같은 에러&#x2F;예외가 발생하며 테스트가 실패하게 됨. (대표적으로 h2 db 같이 테스트에서 사용할 목적으로 쓰이는 인메모리 db의 경우 우리가 소스코드에서 직접 사용하는 게 아니라 Spring Boot의 특정 Auto Configuration에서 사용하기 때문에 컴파일 할 때는 필요 없어서 testCompileClassPath에는 존재할 필요가 없고, 런타임에서만 사용하기 때문에 testRuntimeClassPath에는 존재해야하는 경우이다. 그래서 h2는 testRuntimeOnly로 추가하는 게 좋다.)</li></ul><img src="/2022/03/12/gradle-implementation-vs-api/implementation-single-module.png" class=""><p>실제로 implementation으로 jackson-core 모듈을 추가하고 보면 4가지 클래스패스에 모두 추가된 걸 볼 수 있다.</p><h2 id="api"><a href="#api" class="headerlink" title="api"></a>api</h2><p>api로 의존성을 관리하기 위해서는 <a href="https://docs.gradle.org/current/userguide/java_library_plugin.html">java-library</a> 플러그인을 사용해야한다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>멀티 모듈인 경우 아래와 같이 활성화 시켜줘야한다. (java-library는 gradle core 플러그인이기 때문에 plugins 모듈에 별도로 정의 안 하고도 서브 모듈들에게 적용이 가능하다.)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subprojects &#123;</span><br><span class="line">    apply <span class="attr">plugin:</span> <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>build.gradle.kts에서는 똑같이 kotlin jvm 플러그인만 활성화 시켜주면 된다.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;$kotlinVersion&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>멀티 모듈인 경우 아래와 같이 활성화 시켜줘야한다. (kotlin jvm 플러그인은 gradle core 플러그인이 아니기 때문에 plugins 모듈에 별도로 정의 해놔야 서브 모듈들에게 적용이 가능하다.)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;<span class="variable">$kotlinVersion</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subprojects &#123;</span><br><span class="line">    apply(plugin = <span class="string">&quot;org.jetbrains.kotlin.jvm&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/03/12/gradle-implementation-vs-api/api-structure.png" class=""><p>출처: <a href="https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_configurations_graph">https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_configurations_graph</a></p><p>이미지를 보면 implementation과 마찬가지로 api도 compileClassPath, runtimeClassPath, testCompileClassPath, testRuntimeClassPath에 추가된다고 나와있다.</p><img src="/2022/03/12/gradle-implementation-vs-api/api-single-module.png" class=""><p>실제로 api로 jackson-core 모듈을 추가하고 보면 4가지 클래스패스에 모두 추가된 걸 볼 수 있다.</p><h2 id="implementation-vs-api"><a href="#implementation-vs-api" class="headerlink" title="implementation vs api"></a>implementation vs api</h2><p>여태까지 봤을 때는 둘 다 compileClassPath, runtimeClassPath, testCompileClassPath, testRuntimeClassPath에 추가된다는 걸 봐서 큰 차이점은 없어보인다.</p><p>하지만 이건 해당 모듈을 사용하는 컨슈머 입장이 돼봐야 그 차이점을 알게 된다.</p><ul><li>라이브러리: jakcson-core, spring-tx, 우리 프로젝트 내에서 만드는 모듈들 등등</li><li>컨슈머: 프로젝트 내에서 라이브러리를 사용하는 모듈, 우리 프로젝트에서 위 라이브러리들을 사용하는 모듈 등등</li></ul><p>프로젝트에 두 가지 모듈(producer와 consumer)을 만들어서 차이점을 확인해보자.</p><p>먼저 producer 모듈에 의존성을 추가할 때 implementation과 api로 각각 추가해보자</p><img src="/2022/03/12/gradle-implementation-vs-api/implementation-api-multi-module-01.png" class=""><p>implementation으로 추가한 jackson-core와 api로 추가한 commons-lang3 모듈이 모두 클래스패스에 추가됐다.</p><img src="/2022/03/12/gradle-implementation-vs-api/implementation-api-multi-module-02.png" class=""><p>consumer 쪽에서 producer 모듈을 의존성으로 추가하는데 여기서 차이점이 나온다. (producer 모듈을 api로 추가해도 마찬가지다.)<br>producer 모듈에서 implementation으로 추가했던 의존성인 jackson-core는 (test)runtimeClassPath에만 추가되고, (test)compileClassPath에는 추가되지 않았다.<br>그리고 api로 추가했던 의존성인 commons-lang3는 모든 클래스패스에 추가됐다.</p><p>(test)compileClassPath에 의존성을 전파하지 않음으로써 얻는 이점들은 다음과 같다.</p><h3 id="implementation의-장점-1-불필요한-의존성-전파를-막아준다"><a href="#implementation의-장점-1-불필요한-의존성-전파를-막아준다" class="headerlink" title="implementation의 장점 1: 불필요한 의존성 전파를 막아준다."></a>implementation의 장점 1: 불필요한 의존성 전파를 막아준다.</h3><img src="/2022/03/12/gradle-implementation-vs-api/implementation-block-expose-unnecessary-transitive-denpendency-01.png" class=""><p>consumer module의 compileClassPath에 있는 commons-lang3 모듈 같은 경우에는 실제 소스코드에서 사용이 가능하다.</p><img src="/2022/03/12/gradle-implementation-vs-api/implementation-block-expose-unnecessary-transitive-denpendency-02.png" class=""><p>하지만 consumer moudle의 compileClassPath에 없는 jackson-core 같은 경우에는 실제 소스코드에서 사용이 불가능하다.<br>compileClassPath에 없기 때문에 consumer 모듈에서 직접적인 사용이 불가능한 것이지, runtime에 jackson-core를 사용하는 producer 모듈을 사용하는 것에는 아무런 문제가 없다. (runtimeClassPath에 있기 때문에)<br>producer 모듈에 jackson-core를 이용하는 클래스를 작성해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sample</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 아무 의미 없지만 jackson-core 모듈을 사용하는데 아무 이상이 없다는 걸 보여주기 위해 사용함.</span></span><br><span class="line">        <span class="keyword">final</span> JsonParser.<span class="type">Feature</span> <span class="variable">allowComments</span> <span class="operator">=</span> JsonParser.Feature.ALLOW_COMMENTS;</span><br><span class="line">        System.out.println(<span class="string">&quot;test~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 consumer 모듈에서 jackson-core를 이용하는 Sample 클래스를 사용하는 클래스를 작성해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Some</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Sample</span> <span class="variable">sample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sample</span>();</span><br><span class="line">        sample.a(); <span class="comment">// test~</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Some 클래스의 메인 함수를 호출하면 Sample 클래스의 a 메서드가 호출되서 test~ 문자열이 정상적으로 호출되는 걸 볼 수 있다.<br>consumer 모듈 입장에서는 불필요한 의존성 전파(jackson-core 모듈이 consumer까지 전파)되는 걸 막아줘서 import 자체가 되지 않다보니 자동완성에서 import 할 수 있는 가짓수가 줄어들다보니 어떤 클래스를 사용해야하는지 고민할 시간이 줄어들고(생산성 향상),<br>producer 입장에서는 해당 모듈을 외부로 노출시키지 않다보니 마음대로 구현체를 갈아끼워도 컴파일 타임에 오류가 나지 않을 것이라는 신뢰가 어느정도 생긴다는 장점이 존재한다.</p><h3 id="implementation의-장점-2-compileClassPath의-의존성-충돌이-일어나지-않는다"><a href="#implementation의-장점-2-compileClassPath의-의존성-충돌이-일어나지-않는다" class="headerlink" title="implementation의 장점 2: compileClassPath의 의존성 충돌이 일어나지 않는다."></a>implementation의 장점 2: compileClassPath의 의존성 충돌이 일어나지 않는다.</h3><p>producer 모듈에 guava를 implementation으로 추가해보자</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;com.google.guava:guava:31.0.1-jre&quot;</span>)</span><br></pre></td></tr></table></figure><p>그리고 consumer 모듈에도 똑같이 guava 모듈을 추가하는데 굉장히 하위 버전을 추가해보자</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;com.google.guava:guava:10.0&quot;</span>)</span><br></pre></td></tr></table></figure><p>그리고 이번에는 producer 모듈에서 api로 추가했었던 commons-lang3 모듈을 consumer 모듈에 추가하는데 버전을 좀 낮게 추가해보자.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;org.apache.commons:commons-lang3:3.0&quot;</span>)</span><br></pre></td></tr></table></figure><img src="/2022/03/12/gradle-implementation-vs-api/implementation-avoid-compile-dependency-resolution.png" class=""><p>이제 consumer 모듈의 classPath를 보면</p><ul><li>producer 모듈에서 api로 추가했던 commons-lang3 같은 경우에는 (test)compile&#x2F;runtimeClassPath에서 의존성 충돌이 나서 producer 모듈에 추가한 가장 최신 버전인 3.12.0이 적용됨</li><li>producer 모듈에서 implement로 추가했던 guava 같은 경우에는 (test)compileClassPath에는 consumer 모듈에 추가한 10.0이 적용됨, (test)runtimeClassPath에서는 의존성 충돌이 나서 producer 모듈에 추가한 가장 최신 버전인 31.0.1-jre가 적용됨</li></ul><p>즉, implementation을 쓰면 consumer 입장에서 소스코드를 직접 작성하는 것과 연관이 있는 (test)compileClassPath는 의존성이 전파가 되지 않았기 때문에 consumer 모듈에 추가한 버전이 적용되었고,<br>소스코드를 실제 실행하는데 필요한 (test)runtimeClassPath는 의존성이 전파됐기 때문에 의존성 충돌에 의해 가장 최신버전이 적용된다. (안 그러면 런타임에 메서드나 클래스를 찾을 수 없다는 오류가 발생할 수 있다.)<br>반대로 최신버전에서는 사라진 코드를 사용했다면 컴파일은 성공하는데 런타임에 오류가 발생할 수도 있기 때문에 runtime 의존성도 체크하면서 사용해야 안전하다. (최대한 런타임 의존성과 호환성이 맞는 버전을 사용해야 안전하다.)</p><p>반면 api를 쓰면 (test)compile&#x2F;runtimeClassPath에 모두 의존성을 전파하기 때문에 의존성 충돌로 인해 원하는 버전을 쓰려면 버전을 강제하는 방법을 쓰거나 해야해서 사용하기가 좀 구려진다.</p><h3 id="implementation의-장점-3-compileClassPath에-포함되지-않기-때문에-라이브러리-측에서-의존성을-변경해도-컨슈머는-재컴파일-하지-않아도-된다"><a href="#implementation의-장점-3-compileClassPath에-포함되지-않기-때문에-라이브러리-측에서-의존성을-변경해도-컨슈머는-재컴파일-하지-않아도-된다" class="headerlink" title="implementation의 장점 3: compileClassPath에 포함되지 않기 때문에 라이브러리 측에서 의존성을 변경해도 컨슈머는 재컴파일 하지 않아도 된다."></a>implementation의 장점 3: compileClassPath에 포함되지 않기 때문에 라이브러리 측에서 의존성을 변경해도 컨슈머는 재컴파일 하지 않아도 된다.</h3><p>consumer 측에서 producer에서 api로 의존성을 추가한 commons-lang3를 사용한다고 해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Some</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        StringUtils.isBlank(<span class="string">&quot;asf&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;hello~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 producer 측에서 commons-lang3 모듈의 의존성 버전을 바꿔보자.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api(<span class="string">&quot;org.apache.commons:commons-lang3:3.10&quot;</span>)</span><br></pre></td></tr></table></figure><p>그리고 consumer 측의 Some 클래스의 main 함수를 실행하면 Some 클래스는 하나도 수정한 게 없는데 다시 컴파일 하는 걸 볼 수 있다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">6:04:36 AM: Executing &#x27;:consumer:Some.main()&#x27;...</span><br><span class="line"></span><br><span class="line">&gt; Task :producer:compileJava</span><br><span class="line">&gt; Task :consumer:compileJava</span><br><span class="line">&gt; Task :consumer:processResources UP-TO-DATE</span><br><span class="line">&gt; Task :consumer:classes</span><br><span class="line">&gt; Task :producer:processResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:classes</span><br><span class="line">&gt; Task :producer:jar UP-TO-DATE</span><br><span class="line"></span><br><span class="line">&gt; Task :consumer:Some.main()</span><br><span class="line">hello~</span><br></pre></td></tr></table></figure><p>하지만 producer에서 implementation으로 추가했던 jackson-core나 guava 같은 경우에는 consumer 측의 (test)compileClassPath에는 포함조차 돼있지 않기 때문에 해당 모듈은 의존성을 바꾼다 하더라도 consumer에서는 컴파일을 할 필요가 없다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">6:05:36 AM: Executing &#x27;:consumer:Some.main()&#x27;...</span><br><span class="line"></span><br><span class="line">&gt; Task :producer:compileJava</span><br><span class="line">&gt; Task :consumer:compileJava UP-TO-DATE</span><br><span class="line">&gt; Task :consumer:processResources UP-TO-DATE</span><br><span class="line">&gt; Task :consumer:classes UP-TO-DATE</span><br><span class="line">&gt; Task :producer:processResources NO-SOURCE</span><br><span class="line">&gt; Task :producer:classes</span><br><span class="line">&gt; Task :producer:jar UP-TO-DATE</span><br><span class="line"></span><br><span class="line">&gt; Task :consumer:Some.main()</span><br><span class="line">hello~</span><br></pre></td></tr></table></figure><h3 id="implementation의-장점-4-compileClassPath-사이즈가-줄어들었기-때문에-컴파일-속도가-빨라진다"><a href="#implementation의-장점-4-compileClassPath-사이즈가-줄어들었기-때문에-컴파일-속도가-빨라진다" class="headerlink" title="implementation의 장점 4: compileClassPath 사이즈가 줄어들었기 때문에 컴파일 속도가 빨라진다."></a>implementation의 장점 4: compileClassPath 사이즈가 줄어들었기 때문에 컴파일 속도가 빨라진다.</h3><p>컴파일 클래스패스가 줄어들었다는 것은 컴파일 해야할지 말아야할지 판단할 근거도 줄었다는 뜻이다.<br>위에서 보듯이 producer에서 api로 추가한 모듈들은 consumer에서 사용하는지, 안 하는지에 따라서 해당 클래스를 재컴파일 해야하는지 말아야하는지 비교를 해야한다.<br>하지만 전부 implementation으로 막혀있다면 그 비교 대상 자체가 확연히 줄어들게 될 것이다.<br>그로 인해 컴파일 속도가 빨라진다. (엄청나게 빨라지는 것까지는 아니겠지만… 의존성이 많으면 많을 수록 더 큰 빛을 발할 것 같다.)</p><h2 id="언제-implementaion을-쓰고-언제-api를-써야할까"><a href="#언제-implementaion을-쓰고-언제-api를-써야할까" class="headerlink" title="언제 implementaion을 쓰고 언제 api를 써야할까?"></a>언제 implementaion을 쓰고 언제 api를 써야할까?</h2><p><a href="https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_recognizing_dependencies">https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_recognizing_dependencies</a></p><blockquote><p>Prefer the <code>implementation</code> configuration over <code>api</code> when possible</p></blockquote><p>일단 무지성으로 implementation을 쓰고 어쩔 수 없을 때만 고민 한 100번 정도 한 다음에 api를 쓰면 된다.</p><h3 id="implementation을-써야할-때"><a href="#implementation을-써야할-때" class="headerlink" title="implementation을 써야할 때"></a>implementation을 써야할 때</h3><blockquote><p>any type that is used in the following list is irrelevant to the ABI, and therefore should be declared as an <code>implementation</code> dependency:<br>• types exclusively used in method bodies<br>• types exclusively used in private members<br>• types exclusively found in internal classes (future versions of Gradle will let you declare which packages belong to the public API)</p></blockquote><p>ABI(Application Binary Interface)와 무관한 케이스에는 implementation을 쓰면 된다.</p><ul><li>타입이 메서드 바디 안에서만 쓰이는 경우</li><li>타입이 프라이빗 멤버(변수&#x2F;메서드 등등)에서만 쓰이는 경우</li><li>타입이 인터널 클래스에서만 쓰이는 경우</li></ul><h3 id="api를-써야할-때"><a href="#api를-써야할-때" class="headerlink" title="api를 써야할 때"></a>api를 써야할 때</h3><blockquote><p>An API dependency is one that contains at least one type that is exposed in the library binary interface, often referred to as its ABI (Application Binary Interface). This includes, but is not limited to:<br>• types used in super classes or interfaces<br>• types used in public method parameters, including generic parameter types (where <em>public</em> is something that is visible to compilers. I.e. , <em>public</em>, <em>protected</em> and <em>package private</em> members in the Java world)<br>• types used in public fields<br>• public annotation types</p></blockquote><p>ABI(Application Binary Interface)와 관련있는 케이스에는 api를 쓰면 된다.</p><ul><li>타입이 인터페이스나 슈퍼 클래스에서 쓰이는 경우</li><li>타입이 public&#x2F;protected&#x2F;package private 메서드의 파라미터(메서드의 인자 혹은 리턴타입 및 제네릭 파라미터 타입)에서 쓰일 때</li><li>타입이 퍼블릭 필드에서 쓰일 때</li><li>퍼블릭 어노테이션 타입일 때</li></ul><h2 id="그럼-implementation만-쓰면-만사-OK일까"><a href="#그럼-implementation만-쓰면-만사-OK일까" class="headerlink" title="그럼 implementation만 쓰면 만사 OK일까??"></a>그럼 implementation만 쓰면 만사 OK일까??</h2><p>아니다, 최대한 의존성을 줄여야한다.<br>implementation이라 할지라도 (test)runtimeClassPath에 포함되기 때문에 의존성 충돌로 인해 문제가 발생할 수 있다.<br>런타임 의존성 충돌로 인해 실제 런타임에 내가 만든 소스코드가 제대로 동작하지 않을 수 있다.<br>내가 사용한 모듈(컴파일 클래스패스에 추가한) 버전에서는 존재하는 메서드였는데 런타임 의존성 충돌로 최신버전으로 주입됐을 때 최신버전에서는 삭제된 메서드일 때 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/NoSuchMethodException.html">NoSuchMethodException</a> 같은 게 날 수 있다.<br>혹은 라이브러리의 버전이 바뀌면서 내부 동작이 바뀌는 등의 무서운 일이 발생한다면 더욱 큰 장애로 이어질 수도 있다.<br>그리고 컴파일 타임에 발견되지 않고 런타임에 발견되는 문제는 해당 코드 블럭이 실행돼야지만 발견되는 장애이기 때문에 더더욱 무섭다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;3줄 요약&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;#implementation&quot;&gt;implementation&lt;/a&gt;을 사용하자&lt;/li&gt;
&lt;li&gt;implementation을 사용하더라도 라이브러리를 사용하는 &lt;a href=&quot;#%EA%B7%B8%EB%9F%BC-implementation%EB%A7%8C-%EC%93%B0%EB%A9%B4-%EB%A7%8C%EC%82%AC-OK%EC%9D%BC%EA%B9%8C&quot;&gt;consumer 측의 runtimeClassPath에 추가되기 때문에 런타임 의존성 충돌&lt;/a&gt;이 발생할 수 있으니 의존성은 최대한 적게 추가하자.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#api&quot;&gt;api&lt;/a&gt;가 필요한 건지 100번 고민하고 설계가 잘못된 건 아닌지 의심해 본 후 api를 사용한다. (api는 consumer의 compile&amp;#x2F;runtimeClassPath에 모두 추가된다.)&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;들어가기에-앞서&quot;&gt;&lt;a href=&quot;#들어가기에-앞서&quot; class=&quot;headerlink&quot; title=&quot;들어가기에 앞서&quot;&gt;&lt;/a&gt;들어가기에 앞서&lt;/h2&gt;&lt;p&gt;의존성(라이브러리&amp;#x2F;프레임워크)을 추가하기 위해 build.gradle(or build.gradle.kts)에 아래와 같이 디펜던시들을 추가하게 된다.&lt;/p&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    api(&lt;span class=&quot;string&quot;&gt;&amp;quot;org.springframework.boot:spring-boot-starter-web&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    implementation(&lt;span class=&quot;string&quot;&gt;&amp;quot;com.fasterxml.jackson.module:jackson-module-kotlin&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="gradle" scheme="https://perfectacle.github.io/categories/gradle/"/>
    
    
    <category term="gradle" scheme="https://perfectacle.github.io/tags/gradle/"/>
    
  </entry>
  
  <entry>
    <title>(독서노트) 제로 투 원 (ZERO to ONE) Part. 01</title>
    <link href="https://perfectacle.github.io/2022/01/22/book-review-zero-to-one-part-01/"/>
    <id>https://perfectacle.github.io/2022/01/22/book-review-zero-to-one-part-01/</id>
    <published>2022-01-22T15:02:19.000Z</published>
    <updated>2025-12-09T17:06:50.117Z</updated>
    
    <content type="html"><![CDATA[<p>평상 시 독서를 거의 안 하고, 짧은 글, 짧은 영상 위주의 인스턴트 식으로 살다보니 독해능력이 엄청나게 떨어졌다.<br>글을 읽어도 제대로 이해하지 못하고, 한 2~3문장 이전에 읽은 글이 기억나지 않는다.<br>책을 읽고, 해당 책이 좋다는 사실까지는 알았는데 이 책이 그래서 하고자 하는 말은 무엇이지? 무슨 내용의 책이지?<br>를 남들에게 요약해서 설명해주려해도 설명할 수가 없었다.<br>책을 읽긴 읽었는데 그래서 뭐? 책을 읽기 전과 책을 읽은 후의 나는 어떤 변화가 있나? 어떤 발전이 있나?… 그냥 책 하나 읽었다는 자기 만족 밖에 되지 않았다.<br>빠르게 정보를 습득하는 것도 중요하지만, 정보가 남아있지 않다면 그 시간마저 버린 것이기 때문에 이렇게 기록이라도 하는 의식적인 노력을 들여야 조금이나마 내 자신이 개선될 것 같아 노트를 남긴다.<br>+로 비판적 책읽기(책에 있는 내용을 무지성으로 수용하는 게 아니라 문장 하나, 단어 하나하나가 의미하는 게 무엇인지 곱씹어보기, 작가가 헛소리 하는 건 없는지 의심해보기)를 통해 작가와 소통하며 책을 읽는 듯한 느낌을 느껴보려고 하는 것도 있음.</p><h1 id="제로-투-원-ZERO-to-ONE"><a href="#제로-투-원-ZERO-to-ONE" class="headerlink" title="제로 투 원 (ZERO to ONE)"></a><a href="https://book.naver.com/bookdb/book_detail.nhn?bid=21074303">제로 투 원 (ZERO to ONE)</a></h1><img src="/2022/01/22/book-review-zero-to-one-part-01/book-cover.jpeg" class=""><p>참고로 나는 <a href="https://book.naver.com/bookdb/book_detail.nhn?bid=8377652">개정되기 이전 버전</a>을 읽었음.<br>읽게 된 계기는 회사 동료가 이 책을 읽고 가슴이 설렜다고 함.<br>그래서 사내에 기증된 도서에도 있길래 읽었음.<br>나의 난독+독해능력이 너무 딸려서 줄을 치면서(그나마 내용을 기억하기 위한 최소한의 행위&#x2F;노력) 읽고 싶었지만 회사 책이라 그러지는 못함.<br>그러다보니 그냥 읽기만 하고 다음날 되면 전날 내용 다 까먹음.<br>그러다보니 내가 이 책을 읽고 있기는 한데 남들한테 이 책이 무슨 내용이고 왜 좋고 어떤 영감을 받았는지 왜 추천하는지 하나도 설명하지 못함.<br>그래서 2독을 결심하고 조금이나마 노력을 들여 나의 기억력 + 독해력 향상을 위해 노트에 받아적다가 팔도 아프고, 아무 노트에 대충 정리해놓다보니 나중에 잊혀질까 아까워서 그냥 블로그에 적기로 결심함.<br>물론 손으로 적었을 때가 노력이 제일 많이 들어가다보니 기억이나 독해력 향상에는 도움이 많이 되는 것 같지만,<br>노트에 적고 또 장기보존을 위해 블로그에 또 적자니 시간도 아깝고… 시간이 무한정 한 것이 아니기 때문에 걍 블로그에 적기로 결심.</p><p>참고로 이 책은 <code>새로운 것을 창조하는 회사를 만드는 방법</code>을 다루는 책임.<br>따라서 스타트업 창업을 생각하거나 본인의 야망을 어떻게 실현시킬지, 어떤 생각으로 일을 하거나 인생을 살아가야하는지에 대한 도움이 될만한 책이라고 생각함.<br>굳이 창업 안 하더라도 성공한 사람, 혁신을 이뤄낸 사람들은 어떻게 생각하고 어떻게 행동했는지 를 통해 배울 수 있는 점이 많음.</p><h2 id="머릿말-0이-1이-되려면"><a href="#머릿말-0이-1이-되려면" class="headerlink" title="머릿말: 0이 1이 되려면"></a>머릿말: 0이 1이 되려면</h2><p>익숙한 것을 베끼는 건 1 -&gt; N이 되는 꼴임. (모방, 쉬움)<br>새로운 걸 만들어야 0 -&gt; 1이 되는 것임. (창조, 어려움)<br>창조(새로운 걸 만드는 행위)는 모든 순간에서 단 한번만 일어남: 검색엔진을 만들어서 제 2의 래리 페이지, 세르게이 브린이 될 수 있는가? 그건 모든 순간에 있어서 단 한 번 밖에 일어날 수 없는 행위임.<br>내가 검색엔진 만들면 그냥 1이 N이 되는 거임. (아니면 이미 많은 아이디어라면 N에서 N+@가 되는 거고…)</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 무엇이 창조이고 무엇이 모방인가? 그 기준은 무엇인가? 창조가 아니면 전부 노답인가? One of them(모방)이 부정적이긴 하지만 후발주자들이 성공하는 케이스도 있지 않은가?  </span><br><span class="line">1 -&gt; N이 되다가 그 안에서 0 -&gt; 1을 찾아야하는 걸까??</span><br><span class="line">모든 걸 0에서 시작할 필요는 없는 것 아닐까??</span><br><span class="line">1 -&gt; N을 잘하는 것도 힘든데 0 -&gt; 1은 평생 시도도 못해보는 거 아닐까??  </span><br><span class="line">토스도 토스뱅크(카카오뱅크의 모방 아닌가?), 토스증권(이미 다른 증권사들이 하는 거 따라하는 거 아닌가?)을 보면 모방인 거 같은데...</span><br><span class="line">결국 그 안에서 창조를 만들어내야한다는 뜻일까?</span><br><span class="line">아니면 0 -&gt; 1이라는 행위를 내가 너무 맹신하고 있나? 꼭 0 -&gt; 1일 필요는 없는 것 아닐까?  </span><br><span class="line">아니면 내가 0 -&gt; 1이라는 행위에 대해 제대로 이해하지 못하고 있는 건 아닐까??</span><br></pre></td></tr></table></figure><p>하지만 이런 창조(0 -&gt; 1)는 매우 어렵고 수많은 기적이 필요함.<br>하지만 인간은 그런 기적을 만들어 낼 수 있음.<br>그리고 그 기적을 기술(technology)이라고 부름.<br>기술이 기적인 이유는 <code>더 적은 것으로 더 많은 일</code>을 해주기 때문. (오프라인 결제는 점원이 병목이지만 온라인 결제는 그런 병목도 없음, 그냥 서버만 있으면 더 많은 결제를 받아낼 수 있음. 점포도 필요 없고 인건비도 안 나가고 서버비만 나감.)</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 결국엔 기술력이 핵심이란 것일까??</span><br><span class="line">창조적인 아이디어가 있어도 기술이 뒷받침 해주지 못하면 결국 실현 불가능한 아이디어이니까...??</span><br><span class="line">그럼 개발자인 나는 아이디어를 실현시킬 수 있는 기술력을 쌓는데 더 많은 노력을 해야할까??</span><br><span class="line">아이디어가 없어서(사실 아이디어를 짜내는 행위도 잘 하지 않으니 이건 핑계겠지만...) 사이드 프로젝트나 창업 생각은 하지도 못하고 있는데</span><br><span class="line">지금 내가 잘 할 수 있는 것(기술력 쌓기, 대용량 트래픽 잘 받아내기, 생산성 향상시키기 등등)인 기술력 향상에 더 집중하다보면 번뜩이는 아이디어를 빠르게 구현할 수 있지 않을까??</span><br></pre></td></tr></table></figure><p>책에서 이런 내용들은 초등학교 2학년 때나 배울법한 기본적인 사실이라고 함. (산업혁명(농업사회에서 자동화 사회? 석탄… 공장의 발전??) 같은 것을 배우는 그런 시점을 말하는 것인가??)<br>근데 우리가 이런 것들을 배웠음에도 불구하고 자주 까먹는 이유(애초에 이런 걸 생각조차 하지 못하는 이유)는 <code>대부분 했던 일을 반복하는 세상</code>속에서 우리가 살고 있기 때문이다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 반복하다보면 결국 익숙해지기 마련임.</span><br><span class="line">익숙해지면 편해지기 마련이고 편한 쪽으로 계속 가려는 게 사람 심리인 것 같음.</span><br><span class="line">결국 그 편함을 계속 추구하고 안주하는 게 제일 위험하다고 봄.</span><br><span class="line">발전이 없기 때문.</span><br><span class="line">지속적으로 comfort zone을 벗어나려는 노력을 하고 불편하고 스트레스를 받지만 그런 노력이 없다면 발전이 없는 거 같음.</span><br><span class="line">결국 반복되는 일상을 살다보니 기술력이 핵심이다(이건 내 생각), 기적을 만들어내야한다 라는 사실을 까먹고 살아가는 것 같음.</span><br><span class="line">반복되는 일상 속에서도 이건 왜 이렇게 해야하지? 이렇게 하면 더 편할 거 같은데? 왜 여기저기 정보가 파편화 돼있지?</span><br><span class="line">내 손 안 타고, 비개발자들도 확인하기 편하게 할 수는 없을까? 반복되는 업무를 어떻게 하면 내 손을 거치지 않고 끝낼 수 있을까?</span><br><span class="line">이런 생각을 계속 하다보면 결국 뭐라도 깨작대고 그 깨작댄 순간들로 인해 나에게 업무에 더 몰입할 수 있는 시간들이 주어지고 결국 생산성 향상으로 이루어짐.</span><br><span class="line">결국 나를 대신하는 무언가를 계속해서 만들어내는 기술력(자동화)가 나에게는 있기 때문에 이런 것들이 실현 가능한 것임.</span><br><span class="line">시간 없다, 할 일이 너무 많다 이런 핑계를 대지 않고 주말에라도 이런 것들을 찾아서 개선하는 노력을 조그만한 것이라도 하다보면(업무 환경을 개선할 수 있는 자동화 툴들을 많이 만들다던지)</span><br><span class="line">결국 생각이 발전/진화하여 더 큰 꿈을 이루어내는 아이디어까지 나오고 그간 내가 쌓아왔던 기술력이 빛을 발휘하지 않을까...??</span><br><span class="line"></span><br><span class="line">여튼 반복/편안함을 정말 위험한 신호로 받아들이고 끊임없이 Comfort zone을 벗어나 내 자신을 불편하게 만들고 그 불편함을 편하게 만들어서</span><br><span class="line">남들은 불편한 게 너무나 많은데 나한테는 그런 것들이 너무나 자연스럽고 익숙해서 더 많은 걸 이루어낼 수 있는 사람이 돼야겠음.</span><br></pre></td></tr></table></figure><p>그동안의 모든 혁신은 창조에서 왔음.<br>그리고 성공한 사람들은 예기치 못한 곳에서 가치를 찾았는데 기본적인 원리를 충실히 했기 때문임.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 내 생각에는 창조가 아니고 모방으로도 성공한 사람 많은 거 같은데??</span><br><span class="line">모방만 해도 빡센데??</span><br><span class="line">아니면 내가 혁신이라는 것을 너무 과소평가하고 있나?</span><br><span class="line">혁신은 정말 대단하고 그 누구도 상상하지 못하고, 상상을 했더라도 실현 가능성이 넘사 급이고, 그 넘사를 이뤄내야 혁신인가?</span><br><span class="line">사람들의 행동패턴을 변화하고, 사회에 긍정적인 영향을 끼치고, 인류를 구원한다는 그런 사명감으로 똘똘 뭉친 아이디어들을 실현했을 때 혁신이라고 부를 수 있는 것인가?</span><br><span class="line">혁신이란 게 그렇게 대단한 것이라면 나는 살면서 혁신을 이뤄낼 수 있을까??</span><br><span class="line">아니면 혁신에도 크기가 있는 게 아닐까?</span><br><span class="line">큰 혁신을 한 번에 이뤄내기는 어렵지만 자그만한 혁신들을 조금씩 꾸준히 이뤄내다 보면 그게 결국 큰 혁신이 되어 미래를 바꿀 수도 있는 것은 아닐까?</span><br><span class="line">내가 이뤄낼 수 있는 혁신들에는 무엇이 있을까??</span><br><span class="line">개발자인 내가 사회에 어떤 영향을 미칠 수 있을까??</span><br><span class="line">당장은 안 떠오르니까 사내에서 동료들에게 긍정적인 영향력을 끼칠 수 있는 혁신의 아이템을 발굴하고 실천/개선해나가다 보면 뭔가 나오지 않을까??</span><br><span class="line">코드리뷰를 좀 더 적극적으로 잘 도와준다거나? 주말에 공부한 내용들을 공유한다거나? 그들도 기술에 관심을 가지도록 내가 더 많은 노력을 기울여서 성장하는 조직을 만든다거나...?</span><br><span class="line">뭐 여러가지 아이디어들이 있을테지만 벌써부터 이런 걸 실천하고 성공적으로 마칠 생각을 하니 주말에 쉬면 안 되겠다는 생각이 들면서 피로감이 몰려온다...</span><br><span class="line"></span><br><span class="line">또한 기본적인 원리를 충실히 했기 때문이라고 하는데...</span><br><span class="line">그럼 나는 기본적인 원리를 충실히 지키지 않았나? 내가 알고있는 기본이 그들이 알고 있는 기본과는 다르거나 그 커버리지가 엄청 차이가 나는 걸까??</span><br><span class="line">TDD의 기본이라고 하면 테스트를 먼저 짜는 것이지만 나는 그것을 지키지 못하고 답답한 마음에 먼저 어플리케이션 소스코드 짜고 그 이후에 테스트를 끼워 맞추고 있는데...</span><br><span class="line">어찌보면 기본적인 원리(테스트를 먼저 짠다)도 지키지 않고, </span><br><span class="line">그 기본적인 원리를 지키기 위한 또다른 원리(프로덕션 코드에 바로 적용하기 어려우니 개인적으로 시간을 내어 익숙해지기 위한 훈련을 한다거나... 아니면 더 작은 단위에 대한 테스트를 먼저 짜보는 연습을 한다던가)를 모르기 때문이 아닐까??</span><br><span class="line">기본에 충실해라, 급할 수록 돌아가라... 라는 말을 많이 하지만 나의 성격이 급하고 시간이 없다는 핑계로 막 일하는 경우가 많은 것 같다.</span><br><span class="line">결국 그런 걸 개선하려면 어떻게 해야할까?</span><br><span class="line">어떻게 하면 급박한 상황 속에서도 평정심을 유지하며 기본을 지킬 수 있을까?</span><br><span class="line">실무를 하면서 당장은 고치기 힘들 것이므로 주말/평일에 따로 시간을 내서 기본에 충실하는 훈련을 해야하지 않을까?</span><br><span class="line">그런 훈련 방법에는 무엇이 있을까? 그리고 그 훈련을 효율적으로 하기 위해서는 어떻게 해야할까...??</span><br><span class="line">생각에 생각이 꼬리를 물고 결국 실천은 안 하고... 생각만 하면 피곤하고... 주말에 누워서 띵까띵까 유튜브나 보고 있고...</span><br><span class="line">성공한 사람이 되기 위해서는 정말 힘든 거 같다, 근데 뭐 생각해 보면 당연한 이치인 거 같기도 하고...</span><br><span class="line">평범한 사람들이 살듯이 주말에 띵까띵까 놀면서 성공하고 위대한 사람이 되고싶다고 생각하는 건 심하게 말하면 미친 생각, 도둑놈 심보/로또를 바라는 격이고 나에겐 그런 천운이 있지 않으니 정도를 가야하는 게 맞는 것 같다.</span><br></pre></td></tr></table></figure><h2 id="1-미래를-향해-도전하라"><a href="#1-미래를-향해-도전하라" class="headerlink" title="1. 미래를 향해 도전하라."></a>1. 미래를 향해 도전하라.</h2><p>Q: <code>정말 중요한 진실인데 남들이 당신한테 동의해주지 않는 것은 무엇인가요?</code><br>A: <code>대부분의 사람은 X라고 믿지만, 진실은 Y예요.</code></p><p>진실이 Y일지라도 Y라고 믿는 사람이 많지 않고(그건 많은 사람들이 알고 있는 진실일테므로, 책에서는 현재 교육 시스템이 문제가 있다고 지적하는 걸 예로 들고 있다.),<br>흔한 논쟁 중 한 쪽의 주장이 되지 않아야 좋은 대답이라고 할 수 있다고 한다. (책에선 신은 존재하지 않는다는 걸 예로 들고있다.)<br>대부분의 사람이 X라고 믿는 이유는 <code>학교에서 배우는 지식은 모든 사람들이 동의한 내용</code>이기 때문이고,<br>내가 Y라고 믿는 이유는 <code>미래를 예견</code>했기 때문이다. (물론 정확하지 않을 수 있겠지만…?)<br>미래가 중요한 이유는 <code>세상이 현재(지금 우리가 보는 세상)와 다를 것이기 때문</code>이다.<br>따라서 <code>현재와 10년 후의 미래가 다르지 않다면 그건 미래가 아직도 10년이나 남았다</code>는 것을 의미한다.<br>하지만 <code>현재와 10년 후의 미래가 급격하게 달라진다면, 그건 미래가 코앞에 와있다</code>는 뜻이다.</p><p>또한 이런 미래를 바라볼 수 있는 예견 능력(천재적인 아이디어)이 있다 할지라도 어찌보면 불편한 사실일 수 있는 이 내용을 내뱉을 수 있는 <code>용기</code>가 더 훌륭하다고 말한다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 책에서 미래는 아직 오지 않은 순간들의 총합이라고 했는데 나에겐 정말 충격이었다. (1독 할 때는 충격도 받지 못했다, 이 책을 빨리 읽어야겠다는 생각 때문에 이런 깨우침을 느끼지 못한 것 같다.)</span><br><span class="line">그 말 뜻을 또 곱씹어보면 현재와 미래가 다르지 않으면 아직 아무런 것도 오지 않은 것이고 그런 미래는 미래라고 부를 수 없는 것이다.</span><br><span class="line">그냥 미래가 시간이 지나서 미래라고 부를 수 있는 게 아니라 발전적인 미래를 뜻하는 건가?? 싶었다.</span><br><span class="line">그런 의미에서 또 생각해보면 과거 오스트랄로피테쿠스 시절에는 엄청나게 발전이 느렸지만 요즘에는 발전의 속도가 정말 미쳤다. (스마트폰의 발전만 보더라도...)  </span><br><span class="line">그렇다면 우리는 더욱 더 미래를 앞당기고 있고, 과거 조상들이 살았던 시간보다 더 많은 시간을 사는 듯한 효과를 누리는 것이 아닐까?? </span><br><span class="line">과거에는 어떤 발전/혁신을 이뤄내려면 수십~수백년이 걸렸다면 지금은 수개월 사이에도 혁신이 나오기도 한다.  </span><br><span class="line">그런 반복된 일상들을 살아왔던 조상에 비하면 우리는 몇배, 아니 몇십배는 더 많은 미래와 세상을 경험하며 살아가는 것이 아닐까?? </span><br><span class="line">이렇게 되면 우리는 지구의 수명도 점점 더 앞당기게 되는 것 같고(원래는 지구의 수명이 10억년이었다면 우리가 자꾸 미래를 앞당겼기 때문에 탄소를 많이 써서 5억년으로 줄였다던지...)</span><br><span class="line">그러다보니 환경의 중요성도 많이 깨달아야 할 것 같다.</span><br><span class="line">또 이건 잡설인데 미래를 자꾸 앞당긴다고 하다보니... 나이가 들면 들 수록 세월이 빠르게 흘러간다고 생각하는 것도 미래를 계속 앞당기고 있기 때문이 아닐까?</span><br><span class="line">라는 말도 안 되는 망상을 해보게 되었다. (생각해보면 나이가 들면 들 수록 세월이 빠르게 흘러간다고 생각하는 이유는 뇌의 어떤 작용이 나이가 들면서 달라지기 때문이 아닐까??)</span><br><span class="line"></span><br><span class="line">그리고 대부분의 사람들이 X라고 믿는 이유도 학교에서 배우는 지식들이 모든 사람들이 동의한 내용이라고 한 것도 좀 충격이었다.</span><br><span class="line">뭐 강남 대치동에 부잣집 자제들이 고액과외해서 서울대 가도 죽도 못 쓰는 사람들이 있다는 얘기를 들은 적이 있는데 이유들이 그런 것 때문 아닐까?  </span><br><span class="line">무지성 주입식 교육으로 과외선생님이 하라는대로 시키고 대학교 가니까 자유가 주어지니 어찌 해야할지 모르는 게 아닐까?</span><br><span class="line">그리고 어쩌저찌 대학에서는 잘 했다 할지라도 교수 마저도 사라지니 이제 또 능동적으로 어떻게 해야할지 몰라서 그런 게 아닐까?</span><br><span class="line">결국 그런 울타리 안에서 보호받다가 나왔을 때 어찌해야할지 모르는 현상이 나타나지 않으려면 선생님/교수/교과서/책 등등 많은 사람들이 신뢰하기로 합의한 내용에 대해서 비판적으로 받아들여야하지 않을까 싶다.  </span><br><span class="line">나야 뭐 고등학교 때는 그냥 공부를 잘 안 해서 무지성 수용할 것도 없었고, 하지만 대학을 가서 강의의 질에 엄청난 실망을 하고 교수와 학과, 더 나아가 학교에 대한 신뢰감이 바닥을 쳤다.  </span><br><span class="line">만약 내가 다른 학생들처럼 관심없는데 점수 맞춰서 학과를 왔거나 평상 시 관련 정보 습득을 게을리 했다면 나도 좋은 게 좋은 거지, 교수님이 우리보다 얼마나 더 많은 경험과 지식이 있을텐데 다 맞는 말씀 하시겠지 라고 생각했을 것 같다.</span><br><span class="line">물론 좋은 학교의 좋은 교수님이었다면 나에게 다른 인상을 심어줘서 무지성 수용을 했을지 모르겠지만, 그 때 안 좋은 학교의 안 좋은 교수들을 만남으로 인해 교수님들이 이상한 소리 하는 건 아닌지 의심하고 필터링 하게 되었다.  </span><br><span class="line">또한 내가 이렇게 비판적으로 생각해볼 수 있던 원인 중 하나는 주변에 개발자들을 알고 있었기 때문이다.</span><br><span class="line">오프라인 스터디를 통해 알게 된 스승 격이라 볼 수 있는 개발자 분들께 교수님께 들은 얘기가 실무에서도 먹히는지, 요즘 개발 생태계가 진짜 그렇게 돌아가는 게 맞는지</span><br><span class="line">물어보고 검증해보면서 그게 맞는 말인지 틀린 말인지 판단할 수 있는 기준이 생기게 되었다.  </span><br><span class="line">물론 나의 검증이 틀렸을 수도 있지만 적어도 나에겐 사실 여부를 판단할 수 있는 리소스(어찌보면 인맥)이 있었기 때문에 비판적으로 정보를 습득할 수 있었다.  </span><br><span class="line">이렇게 비판적으로 생각해볼 수 있는 힘을 기르려면 평상시 관련 정보 습득도 게을리하지 않고, 카더라~ 소식(블로그 등등)보다는 공식 문서나 오피셜 자료들 위주로 사실에 입각해 정보를 수용하는 자세를 가져야할 것 같다.  </span><br><span class="line">물론 무지성 수용이 빠르고 쉽게 정보를 습득할 수 있다는 측면에서는 너무나 편하고, 모든 내용을 비판적으로 수용하려면 시간을 한없이 써야하니 둘 사이의 밸런스를 잘 맞춰야할 것 같다.</span><br><span class="line"></span><br><span class="line">그리고 내가 정반대라고 믿게 된 이유는 미래를 예견했기 때문인데...(현재는 아니지만 미래에는 세상이 달라질 것이므로 미래 관점에서는 해당 사실이 진실이 되는 케이스)</span><br><span class="line">미래를 정확하게 예견하면 그럼 선두주자가 되는 것인가? 결국 선두주자가 되어 남들은 아무도 하지 못하는 시장에 들어가서 독점을 해야한다는 뜻일까??</span><br><span class="line">근데 그 미래가 너무 먼 미래라면 또 어떨까? 이것도 결국 너무 멀지 않은 미래에 대한 예견을 통해 선두주자가 되어야하는 것일까??</span><br><span class="line">근데 선두주자가 되었어도 결국 후발주자에게 빼앗기는 경우도 많은데...</span><br><span class="line">결국 미래를 예견하여 선두주자가 되었다 하더라도 후발주자가 따라오지 못할만큼의 격차를 그 사이에 엄청나게 벌려놓아서 시장을 잡아먹어야한다는 뜻인 것 같다.</span><br><span class="line"></span><br><span class="line">그리고 천재적인 아이디어(미래 예견 능력?)보다도 중요한 것이 용기라고 하는데 아마 이런 내용 중에는 다소 불편한 진실들이 많기 때문이 아닐까 싶다...</span><br><span class="line">사람들이 이건 무조건 맞지! 라고 생각하는 내용에 반대되는 개념을 들고오면 싸이코인가? 라고 생각할 수도 있기 때문이다. (지구는 둥글다 같은...??)</span><br><span class="line">근데 뭐 토스 팀의 코어밸류(핵심 문화, 가치) 중 하나인 불편함을 감수하는 용기(Dare to Make Conflicts)도 이런 걸 강조하기 위함이 아닐까 싶다.  </span><br><span class="line">좋은 게 좋은 거지~라고 생각하고 넘어갔다가 나중에 후폭풍이 몰려오는 경우가 많다.  </span><br><span class="line">그냥 상대방이 마음에 들지 않아 태클을 거는 게 아니라 정말 감정은 다 빼고 여러가지 근거(데이터를 기반한)를 토대로 피드백을 주는 것이다.</span><br><span class="line">여기서 또 어떻게 피드백을 줄 것인지는 개개인의 역량인 것 같지만 나는 다소 직설적으로 말하는 편이다.</span><br><span class="line">그걸 처음에 좀 거부감이 드는 사람도 있을지 모르겠지만, 나도 좋은 게 좋은 거지~ 란 생각으로 참으면서 많이 살아왔는데 그게 결국 좋게 끝난 적은 많지 않은 것 같다. (여러 인간관계에서 그렇게 살아왔는데 상대방은 몰라도 나는 불만족스러웠다.)</span><br><span class="line">또한 사사로운 감정이 들어간 관계라면 더더욱 이런 용기를 내는 게 나중에 나에게 올 여파가 두려워서 많이 용기를 못내는 편인데 회사는 프로답게 일을 하는 공간이고, </span><br><span class="line">프로끼리 사사로운 감정에 얽매이기 보다는 더 나은 방향으로 나아가기 위해서는 더 빠르고 정확한 피드백 전달을 위해선 잔인할만큼 직설적인 필요도 있는 것 같다.</span><br><span class="line">그런 측면에서 나는 용기가 있는 사람인가? 싸가지 없는 사람인가? 가끔 고민이 들 때가 있기도 하지만, 주변 동료들의 피드백으로는 직설적이기 때문에 피드백이 더 정확하게 작동한 거 같다는 내용이 있어서 앞으로도 이런 자세를 고수하지 않을까 싶다.</span><br><span class="line">물론 잔인할만큼 직설적이라고 해서 상대방에 대한 리스펙 없이 말을 하면 싸가지가 없어질 것이기 때문에 리스펙은 하되 정확한 사실 기반으로 전달하려는 그 밸런스 조절은 잘 해야할 것 같다.</span><br></pre></td></tr></table></figure><p>하지만 미래를 정확히 예견할 수 있는 사람은 아무도 없다고 한다.<br>그럼에도 불구하고 아래 두 가지 사실은 확실하다고 한다.</p><ol><li>미래는 지금과는 다를 것이라는 점<br>만약 그렇지 않다면 엄청난 위기라는 사실일까…?  </li><li>미래의 뿌리는 현재의 세상일 것이라는 점<br>그럼 현재를 정확히 판단해야 미래를 예견할 수 있는 능력을 키울 수 있을까??<br>책에서도 사람들의 의견과 반대되는 의견을 낼 줄 아는 사람은 <code>현재를 바라보는 시각의 차이</code>가 있기 때문이라고 한다.<br>결국 현재를 통찰하는 능력을 키우라는 거 같당. (물론 그 현재는 과거의 미래이기 때문에 과거에 대한 통찰도 중요한 거 같다.)</li></ol><h3 id="0에서-1로-진보된-미래"><a href="#0에서-1로-진보된-미래" class="headerlink" title="0에서 1로: 진보된 미래"></a>0에서 1로: 진보된 미래</h3><ol><li>수평적 진보: 효과가 입증된 것을 카피하는 것(1 -&gt; n), 우리가 이미 알고 있는 것이기 때문에 미래가 쉽게 그려진다.<br>ex) 한 개의 타자기를 보고 100개의 타자기로 만드는 것, 글로벌화 (한 곳에서 성공한 것을 모든 곳에서 성공하게 만드는 것), 중국(미국을 따라잡는 것, 하지만 모든 과정을 카피하는 게 아니라 중간에 불필요한 과정은 스킵)</li><li>수직적 진보(집중적 진보): 새로운 일을 하는 것(0 -&gt; 1), 아무도 한 적이 없는 일을 하는 것이기 때문에 미래가 쉽게 상상되지 않는다.<br>ex) 한 개의 타자기를 보고 워드프로세서를 만드는 것, 기술(technology, 굳이 컴퓨터 기술일 필요는 없고 새롭고 더 나은 방식으로 무언가를 가능하게 해주는 모든 것)</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 역시 빠른 성장에는 모방(카피)만 한 게 없는 것 같다.</span><br><span class="line">중국이 그렇~게 빨리 성장한 것도 모조리 다 짝퉁에 세계의 공장(값싼 인건비로 인한) 역할을 했기 때문이 아닐까 싶다.  </span><br><span class="line">하지만 그로인한 사이드 이펙트도 엄청난 것 같다.  </span><br><span class="line">결국 미국이 견제할 만큼 중국이 무서운 속도로 성장하자 미국에서는 중국을 견제하기 시작했고, 중국 자체적으로도 점점 성장 곡선이 꺾이고 있기 때문이다.  </span><br><span class="line">그럼 답은 빠른 카피/글로벌화를 이뤄가면서 동시에 새로운 기술로써 혁신(창조 행위)을 이루어내야하는 것일까??</span><br><span class="line">혁신만 하려면 불확실한 미래에 엄청 큰 배팅이고, 카피만 하다가는 언젠가 한계에 도달할테고...</span><br><span class="line">둘 다 어려운데(혁신이 훨씬 어렵긴 하지만) 둘을 동시에 할 수나 있을까??</span><br><span class="line">카피를 통해 감을 잡은 후에 혁신을 이뤄내야할까?</span><br><span class="line">아니면 혁신을 먼저 계획하고 그를 위한 여러 모방을 하다가 점점 호랑이 이빨 드러내듯이 슬슬 혁신을 해야하는 걸까??</span><br><span class="line">근데 토스에서 처음에 간편송금 한 거 보면 아무도 들어오지 않았던 시장을 공략(0-&gt;1)을 했기 때문에 성공한 거 같은데...</span><br><span class="line">그럼 역시나 여러가지 혁신을 계속해서 돌려보고, 그 중에 하나 맞는 걸 찾아서 쫙 끌어올려야하는 걸까??</span><br><span class="line">역시 쉽지않당.</span><br></pre></td></tr></table></figure><p>한동안 글로벌화가 진행되고 나면 여러 가지 융합과 획일성이 확대될 것이라고 대부분 생각한다고 함.<br>그를 뒷받침하는 증거로 선진국은 devloped(개발이 완료된)이라고 부르고, 개발도상국은 developing(개발 중인)으로 나누었다는 점이다.<br>선진국들은 이미 이룰 것을 다 이뤄서 끝마친 상태고, 개발도상국들은 선진국을 그저 따라잡는다는 의미를 내포하고 있다고 한다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 영어를 몰라서 선진국과 개발도상국의 의미를 그냥 뉴스나 사전만을 통해 접했는데 영어 단어로 보고 나니 체감이 확 됐다.  </span><br><span class="line">사회적으로 합의된 일반적인 통념(선진국은 더이상 발전이 없고, 개발도상국은 선진국을 따라가기만 하는...)이 무엇인지 알 수 있어 엄청난 충격이었다.</span><br><span class="line">근데 너무나 무서운 생각같다.</span><br><span class="line">이미 개발이 다 완료돼서 더이상 발전이 없는 나라에서 산다고? 나는 미국이 정말 살기 좋은 나라라고 생각했는데 그게 끝이라면? 미래가 현재와 똑같다면?</span><br><span class="line">그럼 국민들의 행복지수는 지금이 사상 최대치가 아닌가? 이 이상 행복할 수 없는 최대한계치에 도달한 거 같은데??</span><br><span class="line">개발도상국이 더 행복지수가 높다는 걸 얼핏 들었던 거 같은데 그 이유가 여기서 나오는 게 아닐까? 그들에게는 앞으로 끊임없는 발전이 있을 것이기 때문에?? (물론 모든 국민이 그렇게 생각하는 것은 아니겠지만...)</span><br><span class="line"></span><br><span class="line">난 선진국을 developed(개발이 완료된) 상태라고 생각해서 이름을 지었다는 것부터 그 이름을 지은 사람이 얼마나 쉽게 만족하는지 알 수 있을 것 같다. (정말 심각하게 표현하자면 무능하다고 까지 생각이 든다.)</span><br><span class="line">여기서 끝내버린다고? 그럼 후대의 자손들은? 우리들의 미래는? 그런 것도 생각하지 않고 저런 단어를 썼단 말인가?</span><br><span class="line">물론 선진국이라고 해서 발전이 없는 것은 아니지만 저런 단어를 보면 &quot;아 우리 할만큼 했어~&quot;라고 생각해서 금방 다른 나라에 역전될 것만 같아 불안하다.</span><br><span class="line">나는 한국이 선진국(developed)일지는 몰라도 마인드 만큼은 개발도상국(developing)을 지녔으면 좋겠다.</span><br><span class="line">나만 해도 이미 developed 상태라고 생각해서 공부를 멈추고 마땅한 노력 없이 그냥 토스에 평생 직장으로 천년만년 살아야지~ 란 생각을 가지기 시작하면 너무나 위험할 것 같다. (물론 그 안에서 다양한 챌린지를 통해 성장하긴 하겠지만...)</span><br><span class="line">아직도 주니어라고 생각하고(연차가 많지도 않고, 내가 생각한 미래와 현실 사이의 나의 기술 역량의 괴리감은 엄청나기 때문에...) 여기가 나의 최대치라고 생각하면 너무나 비참해진다.</span><br><span class="line">인생에 있어 큰 행복이나 취미도 없고 그나마 만족감을 느끼는 일과 성장에 있어서 이게 최대치라고 하면 앞으로 나는 어디서 행복을 찾는단 말인가...? (아직 자신에 대한 불만족이 너무 커서 행복하지가 않다.)</span><br><span class="line">내가 행복감을 느낄 만한게 크게 없기 때문에 그나마 행복/만족감을 느끼는 측면에서 계속 developing을 해야 내가 지속가능한 삶을 살 수 있을 것 같다.</span><br><span class="line">그걸 위해서는 끊임없이 comfort zone을 의식적으로 벗어나려고 노력을 해야할 것 같다. </span><br></pre></td></tr></table></figure><p>피터 틸(작가)은 <code>대부분의 사람은 글로벌화가 미래를 결정할 것이라고 생각하지만, 기술이 더 중요</code>하다고 말한다.<br>만약 글로벌화가 미친듯이 진행되어 중국&#x2F;인도의 인구가 미국 사람들처럼 똑같이 에너지를 쓴다면 에너지는 고갈될 것이고 지구의 환경은 더더욱 빠르게 황폐화될 것이기 때문이다.<br>또한 <code>시간이 흐른다고 해서 자연스레 새로운 기술이 나타나는 것도 아니다</code>.<br>과거 오스트랄로피테쿠스 시절을 생각해보면 얼마나 발전이 더뎠는가? 그런 사회에서 성공은 남의 것을 빼앗는 것 뿐이다. (영토 전쟁 등등)<br>그러다 점점 시간이 흐르면서 원시시대의 농경, 중세의 풍차 등등의 간헐적인 진보만 있다가 1760년대에 증기기관이 출현하면서 폭발적 진보가 있었다.<br>이런 폭발적인 진보가 1970년대까지 이어진 결과 우리는 미래는 더 진보된 미래가 돼있으리라는 사실을 믿게 되었다.<br>하지만 그런 일들은 일어나지 않았으며 최근까지의 진보는 대부분 컴퓨터&#x2F;통신 분야가 주를 이루었다.<br>저절로 세계가 더 나은 미래로 간다는 믿음은 잘못된 사실이었던 것이다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 뭐 에너지 처럼 희소성이 있다거나 지구 환경에 피해를 끼치는 요소 말고도 글로벌화의 종말은 더이상 발전없는 미래가 될 것 같기도 하다.</span><br><span class="line">지구의 모든 인구에게 글로벌화가 진행됐다면 그 이후는? 출산률이 더더욱 줄어들 게 될 미래에는?</span><br><span class="line">결국 글로벌화도 중요하지만 그보다 중요한 건 기술인 것 같다.</span><br><span class="line">그리고 그 기술을 그냥 막연하게 언젠가는 이런 세상이 오겠지~ 라고 천하태평한 마인드로 살아가는 것도 잘못된 믿음인 것 같다.</span><br><span class="line">나만해도 초등학생 때 2030년을 생각하면서 그림을 그려보라고 학교에서 시키면 날아다니는 자동차를 타겠지~ 같은 뻔한 그림을 그렸다.</span><br><span class="line">아직 2030년이 되려면 8년이 남긴 했지만 가까운 미래로 다가오자 그게 현실성이 있다고 생각이 되는가?</span><br><span class="line">결국 그런 혁신이 오려면 더 많은 시간이 걸리거나 아니면 그러한 시간을 앞당길만한 더 대단한 혁신들이 쏟아져나와야 할 것 같다.</span><br><span class="line">하지만 그런 미래는 이런 안일한 태도로는 절대 오지 않으리란 사실에는 틀림이 없는 것 같다.</span><br><span class="line">근데... 그럼 나는 어떻게 살아가야하는가?</span><br><span class="line">그냥 맨날 하던대로 자바(코틀린)/스프링(부트) 써서 개발하고 살아가는데... 미래를 혁신시킬만한 다른 기술들(오픈소스, 라이브러리/프레임워크 등등)을 만들어내야하는가?</span><br><span class="line">아니면 지금 내가 쓰고 있는 기술이라고 하더라도 그 기술들로 더 새로운 기술(비즈니스)를 창출해나가야할까?</span><br><span class="line">그것만이 답일까? 토스에서 10인분을 하도록 하는 건 혁신이 아닐까?</span><br><span class="line"></span><br><span class="line">그리고 글로벌화가 꼭 1 -&gt; N일까?에 대한 고민도 해보게 되었다.</span><br><span class="line">결국 기업이 0 -&gt; 1을 해서 국내시장을 잡아먹었다 하면 세계 시장으로 눈을 돌리게 될 것이다.</span><br><span class="line">하지만 국내에서 하던대로 1 -&gt; N이 끝날까? 그만큼 단순한 일일까?</span><br><span class="line">각 나라만의 문화와 여러가지 상황들이 있을텐데 절대 아닐 것이다.</span><br><span class="line">우리나라에서는 이게 당연한 건데 그 나라에서는 아닐 수 있다.  </span><br><span class="line">이런 걸 해결해나가는 것도 어찌보면 0 -&gt; 1이 아닐까??</span><br><span class="line">그렇게 봤을 때 1 -&gt; N 안에서도 잘게 쪼개보면 무수히 많은 0 -&gt; 1이 있지 않을까?? 싶다.</span><br><span class="line">이 책에서는 글로벌화 보다는 기술에 중심을 두고 있다보니 글로벌화에 대해 개인적으로 부정적 혹은 좀 낮게 보는 경향이 있는 것 같은데 이 또한 쉽지 않은 것 같다.</span><br><span class="line">결국 큰 그림과 인생에 있어서 마인드는 0 -&gt; 1을 끊임없이 만들어내려고 해야할테고 그 안에서 자연스레 1 -&gt; N도 이뤄내지 않을까?? 싶다.</span><br><span class="line"></span><br><span class="line">이건 여담이지만 지도를 보더라도, 해외를 나가보더라도 진짜 한국만을 가지고 생각하는 것은 우물 안 개구리이다.</span><br><span class="line">그런 관점에서 보면 1 -&gt; N만 달성했다 하더라도 진짜 대단한 것이다.</span><br><span class="line">근데 0 -&gt; 1을 이뤄내는 사람은... 정말 어떤 사람들일까?? 존경심이 생긴다.</span><br></pre></td></tr></table></figure><h3 id="신생기업과-새로운-생각"><a href="#신생기업과-새로운-생각" class="headerlink" title="신생기업과 새로운 생각"></a>신생기업과 새로운 생각</h3><p>새로운 기술은 새로운 모험, 즉 무언가를 새로 시작하며 나타나는 경우가 많다고 한다.<br><code>세상을 더 나은 곳으로 변화시킨 주체는 일종의 사명감으로 똘똘 뭉친 소규모 집단들</code>이었다.<br>큰 조직에서는 새로운 것을 개발하기가 어렵고, 관료적 계급 조직은 행동이 굼뜨고, 이해관계가 잔뜩 맞물려있는 조직은 위험을 감수하지 않는다.<br>반대편 극단인 외톨이형 천재(혼자)는 예술이나 문학의 고전을 남길지는 몰라도 산업 하나를 통째로 변화시키지는 못한다. (있다 해도 매우매우매우 드물 듯)<br>즉, 신생기업이 제대로 돌아가려면 <code>실제로 뭔가 할 수 있을 만큼 작은 규모로 유지</code>되어야 한다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 전형적인 대기업의 꼰대스러움/정치/실무역량과 관계 없는 이력서,면접 때문에 큰 조직에 대한 부정적 인식은 너무나 컸다.</span><br><span class="line">하지만 내가 1인 개발자에 대해 좀 과대평가 했던 부분도 있는 것 같다.  </span><br><span class="line">1인 개발자가 매달 게임 앱을 출시해서 광고비 같은 걸로 쏠쏠하게 돈을 번다는 걸 보고 오~ 괜찮은데? 라고 생각했는데 나의 꿈이 작았던 것 같다.</span><br><span class="line">결국 그런 사람이 이 세상에 어떤 영향을 끼쳤단 말인가? 그냥 본인 혼자 만족하는 수준에 그쳤다. (뭐 내가 모르는 영향력이 있을테지만 적어도 내가 기대하는 바 보다는 작은 것 같다.)</span><br><span class="line">처음엔 혼자 시작할지 몰라도 결국 마음이 맞고 미친 듯 헌신/몰입할 준비가 된 소수의 인원들로 똘똘 뭉쳐 키워나가야하는 것 같다.</span><br><span class="line">군중 심리인가... 사람이 많으면 누군가는 하겠지? 라고 사람들이 수동적인 자세를 취하기 마련이다.</span><br><span class="line">하지만 나 말고 할 사람이 없다면? 나라도 해야한다면? 그럼 하게 된다.</span><br><span class="line">비슷한 경험을 한 적이 있는데 바로 한 사람의 퇴사로 인해 깨닫게 되었다.</span><br><span class="line">해당 팀에서 중요 인물 한 사람이 퇴사하자 다른 인원들이 더 능동적으로 바뀌었다.  </span><br><span class="line">그 사람이 하던 업무를 내가 해야되니까... 즉 너무 인원이 많으면 그 사람들이 전부 100% 이상의 실력 발휘를 하지 못하는 것 같다. (그렇다고 그 팀이 인원이 많았던 것은 아니지만 한 사람의 커버리지가 너무 넓었던 건 아닌가 싶다.)</span><br><span class="line"> </span><br><span class="line">또한 요즘 드는 생각이 토스 정도면 대기업 아닌가? 이미 고일대로 고인 것인가?</span><br><span class="line">하지만 토스에서 제품을 만들고 그 안에서 성장과 혁신을 만들어내는 속도와 규모를 보면 전혀 그렇지 않다는 생각이 들지 않는다.</span><br><span class="line">외부에서 바라봤을 때는 매출 규모라던지, 기업 가치라던지, 인원이라던지 이런 외형적으로 보이는 요소에만 집중할 수 밖에 없는데 그런 기준에서는 분명 대기업이라고 보일지 모른다.</span><br><span class="line">하지만 조직들을 잘게 쪼개어 그 안에서 수많은 스타트업처럼 일하는 형태들로 인해 곳곳에서 성장과 혁신이 지속될 수 있는 것 같다.</span><br><span class="line">그럼에도 불구하고 토스의 찐 초창기만큼은 아닐테지만... 그래도 이정도 규모에서 이정도 속도감으로 일한다는 것은 상상하기 힘들다. </span><br></pre></td></tr></table></figure><p>그리고 좀 더 극적으로 말하면 신생기업은 <code>지금과는 다른 미래를 만들기 위한 당신의 계획을 납득시킬 수 있는 최대치의 사람</code>이라고 한다.<br>또한 <code>새로운 생각이 민첩함 보다 중요</code>하다고 하는데 규모가 작아야 새로운 생각을 더 자유롭게 할 수 있다고 한다.</p><p>그리고 이 책은 특정 지식의 기록은 아니고 메뉴얼도 아니라고 한다.<br>오히려 이 책은 <code>생각하는 연습을 해보는 자습서</code>라서 <code>여러 질문에 관한 책</code>이라고도 한다.<br><code>생각</code>이야말고 신생기업이 반드시 해야할 일이고, <code>당연시 되는 생각에 의문을 제기하고 백지상태에서 다시 사업을 생각</code>해야한다고 한다.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">나의 생각: 신생 기업이 단순히 소규모라고 해서 규모만 중요한 게 아닌 거 같다.</span><br><span class="line">마음 맞는 사람도 그만큼 중요하고 그 마음 맞는 사람이 얼마나 더 나은 미래로 이끌만큼 역량이 되고, 나의 계획을 미래의 다른 사람들에게 얼마나 납득시킬 수 있는가? 도 중요한 것 같다.</span><br><span class="line">이 사람이 나하고 마음이 잘 맞을 수 있다. 그래서 쿵짝쿵짝 잘 할 수 있다.</span><br><span class="line">하지만 그 다음은? 미래는? 사람이 더 들어오지 않을 것인가?</span><br><span class="line">그럼 내가 그 때도 여전히 새로운 사람을 계속 설득하고 있을 것인가? 아니면 팀원들이 설득할 것인가? 그리고 또 그 다음 미래에는?</span><br><span class="line">결국 이 물음에 대한 해답은 성장하는 조직에 있는 것 같다.</span><br><span class="line">내가 토스 초기에 입사했을 때 시니어 개발자(진짜 내 인생에 있어서 나에게 막대한 영향을 끼쳤고 진심으로 리스펙하는 분) 분께 늦은 시간에 코드리뷰를 요청하여 새벽까지 진행된 적이 여러 번 있었다.</span><br><span class="line">그 때마다 나는 너무 죄송하지만... 그래도 뽑아먹을 건 뽑아먹어야지?? 라는 생각이 들었고 어느날 힘드시진 않는지, 짜증나지는 않는지 여쭤보았다.</span><br><span class="line">그 분께서는 물론 피곤하고 힘들긴 하지만 &quot;성장하는 조직과 성장하는 문화&quot;를 만드는 과정이라고 생각한다고 하셨다.</span><br><span class="line">지금 내가 힘들지라도 이 사람을 성장시켜서 그 사람이 이제는 어엿한 1인분을 하게 되어 나의 일을 덜어준다면...?</span><br><span class="line">또한 거기서 멈추는 게 아니라 성장하는 문화까지 습득하여 다른 팀원들의 성장까지 돕는다면?</span><br><span class="line">그리고 그 팀원들마저도 성장하는 문화를 기여하는데 도움이 된다면?</span><br><span class="line">무한히 성장하는 조직이 되지 않을까??</span><br><span class="line">나는 내 팀이 이렇게 되길 바란다.</span><br><span class="line">내가 막 그렇게 훌륭한 개발자는 아니지만 그래도 마인드만큼은 훌륭한 개발자들을 따라가려고 한다.</span><br><span class="line">내가 리스펙하는 사람이 나에게 막대한 영향을 끼쳐서 과거 우리팀이 성장했던 것 만큼 나도 성장하는 팀과 문화를 만들어 정말 남들이 같이 일하고 싶어하는 팀, 개발 역량 쭉쭉 성장하고</span><br><span class="line">미친듯한 몰입감과 열정/호기심으로 똘똘 뭉친 사람들끼리 그런 팀/세상을 만들고 싶다는 열망으로 가득하다.</span><br><span class="line">이렇게 되기 위해서는 나의 팀원은 나보다도 더 훌륭한 사람들로 가득차야 나도 자극받고 그로 인해 긍정적인 효과들이 무한대로 늘어날 것이다.</span><br><span class="line">물론 이 와중에 이런 문화를 같이 만들어나가는 게 아니라 누리러만 오는 사람도 있을 것이다.  </span><br><span class="line">물론 업무 효율에는 단기적으로 없는 것보다 있는 것이 낫겠지만... 정말 내가 스타트업을 꾸린다고 했을 때 이런 사람을 잘 보고 걸러내야 할 것 같다.  </span><br><span class="line">그런 측면에서 내가 토스 문화를 누리기만 하는 사람은 아닌지... 약간은 뜨끔하다.</span><br><span class="line"></span><br><span class="line">그리고 이 책이야말로 정말 비판적 책읽기를 권장하고 있었는데 역시 나의 낮은 독해능력으로 인해 그 중요도를 간파하지 못했다.</span><br><span class="line">당연시 되는 생각에 의문을 제기하고... 이거 정말 중요하다.</span><br><span class="line">지금 그렇게 책을 읽고 정리하니까 20페이지 읽는데만 4시간이나 걸리는 것 같다...</span><br><span class="line">또한 비판적 책읽기를 더 넓히면 책읽기에서 그치는 게 아니라 비판적으로 사고하기로 실생활에 옮길 수도 있다.</span><br><span class="line">이걸 정말 잘 하는 사람은 토스팀 리더인 승건 님 같다.</span><br><span class="line">승건 님과 많은 대화를 해보거나 승건 님에 대해 잘 아는 것은 아니지만, 미팅을 한 번 했을 때 나는 너무나 당연하고 절대 바뀌지 않고 이걸 할려면 너무나 많은 노력이 들어 할 엄두도 못 내고 있는 내용에 대해</span><br><span class="line">&quot;왜 그래야만 하죠? 너무 이상한데요? 이게 말이나 되는 얘기인가요?&quot;라는 얘기를 들었을 때 망치로 머리를 얻어맞은 기분이었다.</span><br><span class="line">물론 나는 디테일한 사항을 알고 있어서 더 그 내용에 대한 맥락이 많아 부정적으로 생각한 경향이 없잔아 있었겠지만, 어떻게 감히 그런 상상을 하고 그걸 입밖으로 내뱉는 용기가 있는 거지?</span><br><span class="line">진짜 이 사람 대단하다... 쩐다... 라고 생각한 순간 중 한 부분이었다.</span><br><span class="line">또한 특정 일을 두고도 나는 이걸 하면 뭐 때문에 안 되고, 어떤 민원이 있을 것이며 CS가 빗발칠 것이다 등등 안 되는 이유만 수십 수백가지를 댔었다.</span><br><span class="line">하지만 우리가 계속 그러한 태도로 나오자 한 사람은 &quot;왜 자꾸 안 되는 이유만 찾냐? 그걸 되게 하려면 어떤 이슈들을 해결하면 되는지 생각해보면 좋지 않겠냐?&quot;라는 피드백을 간접적으로 들었다.</span><br><span class="line">그 당시에도 머리에 좀 충격이 왔지만, 역시나 안 되는 이유가 너무 절대적이라 행동으로 옮기지 못했다.</span><br><span class="line">하지만 어떤 결정적 이유로 인해 그 일을 해야만 했고, 최선은 아니지만 차선책을 찾아서 어찌저찌 꾸역꾸역 진행한 경험이 있다.</span><br><span class="line">개인적으로 임팩트도 컸고 굉장히 잘 한 일이라고 생각하는데 그 때는 왜 그렇게 보수적으로 생각했는지 모른다.</span><br><span class="line">물론 아직 풀어가야할 숙제들이 많이 남아있지만, 그래도 고객 경험을 개선했다는 점에는 이견이 없기 때문에 앞으로도 이렇게 좀 비판적으로 사고하고 되게 할려면 어떻게 해야하는가?에 대해 포커싱하여 생각하고 움직여야할 것 같다.</span><br></pre></td></tr></table></figure><p>음… 생각보다 시간이 많이 걸려서 나머지 파트는 언제 작성 할 수 있을지… 이런 식으로 계속 읽어나갈 수 있을지는 고민이다.<br>(매일매일이 주말이라면 이렇게 할텐데 평일에는 이렇게까지 시간이 안 날 때가 많고, 여기에만 올인을 할 수 없으므로…)</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;평상 시 독서를 거의 안 하고, 짧은 글, 짧은 영상 위주의 인스턴트 식으로 살다보니 독해능력이 엄청나게 떨어졌다.&lt;br&gt;글을 읽어도 제대로 이해하지 못하고, 한 2~3문장 이전에 읽은 글이 기억나지 않는다.&lt;br&gt;책을 읽고, 해당 책이 좋다는 사실까지는 알았는데 이 책이 그래서 하고자 하는 말은 무엇이지? 무슨 내용의 책이지?&lt;br&gt;를 남들에게 요약해서 설명해주려해도 설명할 수가 없었다.&lt;br&gt;책을 읽긴 읽었는데 그래서 뭐? 책을 읽기 전과 책을 읽은 후의 나는 어떤 변화가 있나? 어떤 발전이 있나?… 그냥 책 하나 읽었다는 자기 만족 밖에 되지 않았다.&lt;br&gt;빠르게 정보를 습득하는 것도 중요하지만, 정보가 남아있지 않다면 그 시간마저 버린 것이기 때문에 이렇게 기록이라도 하는 의식적인 노력을 들여야 조금이나마 내 자신이 개선될 것 같아 노트를 남긴다.&lt;br&gt;+로 비판적 책읽기(책에 있는 내용을 무지성으로 수용하는 게 아니라 문장 하나, 단어 하나하나가 의미하는 게 무엇인지 곱씹어보기, 작가가 헛소리 하는 건 없는지 의심해보기)를 통해 작가와 소통하며 책을 읽는 듯한 느낌을 느껴보려고 하는 것도 있음.&lt;/p&gt;
&lt;h1 id=&quot;제로-투-원-ZERO-to-ONE&quot;&gt;&lt;a href=&quot;#제로-투-원-ZERO-to-ONE&quot; class=&quot;headerlink&quot; title=&quot;제로 투 원 (ZERO to ONE)&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://book.naver.com/bookdb/book_detail.nhn?bid=21074303&quot;&gt;제로 투 원 (ZERO to ONE)&lt;/a&gt;&lt;/h1&gt;&lt;img src=&quot;/2022/01/22/book-review-zero-to-one-part-01/book-cover.jpeg&quot; class&gt;
&lt;p&gt;참고로 나는 &lt;a href=&quot;https://book.naver.com/bookdb/book_detail.nhn?bid=8377652&quot;&gt;개정되기 이전 버전&lt;/a&gt;을 읽었음.&lt;br&gt;읽게 된 계기는 회사 동료가 이 책을 읽고 가슴이 설렜다고 함.&lt;br&gt;그래서 사내에 기증된 도서에도 있길래 읽었음.&lt;br&gt;나의 난독+독해능력이 너무 딸려서 줄을 치면서(그나마 내용을 기억하기 위한 최소한의 행위&amp;#x2F;노력) 읽고 싶었지만 회사 책이라 그러지는 못함.&lt;br&gt;그러다보니 그냥 읽기만 하고 다음날 되면 전날 내용 다 까먹음.&lt;br&gt;그러다보니 내가 이 책을 읽고 있기는 한데 남들한테 이 책이 무슨 내용이고 왜 좋고 어떤 영감을 받았는지 왜 추천하는지 하나도 설명하지 못함.&lt;br&gt;그래서 2독을 결심하고 조금이나마 노력을 들여 나의 기억력 + 독해력 향상을 위해 노트에 받아적다가 팔도 아프고, 아무 노트에 대충 정리해놓다보니 나중에 잊혀질까 아까워서 그냥 블로그에 적기로 결심함.&lt;br&gt;물론 손으로 적었을 때가 노력이 제일 많이 들어가다보니 기억이나 독해력 향상에는 도움이 많이 되는 것 같지만,&lt;br&gt;노트에 적고 또 장기보존을 위해 블로그에 또 적자니 시간도 아깝고… 시간이 무한정 한 것이 아니기 때문에 걍 블로그에 적기로 결심.&lt;/p&gt;
&lt;p&gt;참고로 이 책은 &lt;code&gt;새로운 것을 창조하는 회사를 만드는 방법&lt;/code&gt;을 다루는 책임.&lt;br&gt;따라서 스타트업 창업을 생각하거나 본인의 야망을 어떻게 실현시킬지, 어떤 생각으로 일을 하거나 인생을 살아가야하는지에 대한 도움이 될만한 책이라고 생각함.&lt;br&gt;굳이 창업 안 하더라도 성공한 사람, 혁신을 이뤄낸 사람들은 어떻게 생각하고 어떻게 행동했는지 를 통해 배울 수 있는 점이 많음.&lt;/p&gt;</summary>
    
    
    
    <category term="Notes" scheme="https://perfectacle.github.io/categories/Notes/"/>
    
    <category term="독서" scheme="https://perfectacle.github.io/categories/Notes/%EB%8F%85%EC%84%9C/"/>
    
    
    <category term="독서노트" scheme="https://perfectacle.github.io/tags/%EB%8F%85%EC%84%9C%EB%85%B8%ED%8A%B8/"/>
    
    <category term="제로 투 원" scheme="https://perfectacle.github.io/tags/%EC%A0%9C%EB%A1%9C-%ED%88%AC-%EC%9B%90/"/>
    
    <category term="ZERO to ONE" scheme="https://perfectacle.github.io/tags/ZERO-to-ONE/"/>
    
  </entry>
  
  <entry>
    <title>라스베가스를 다녀오고... 5편 (feat. AWS re:Invent 2021) - 세미자 마지막 날부터 인천공항까지</title>
    <link href="https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-05/"/>
    <id>https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-05/</id>
    <published>2021-12-31T23:27:31.000Z</published>
    <updated>2025-12-09T17:06:50.317Z</updated>
    
    <content type="html"><![CDATA[<p>회사에서 좋은 기회가 생겨 <a href="https://reinvent.awsevents.com/">AWS re:invent</a>(2021&#x2F;11&#x2F;29 ~ 2021&#x2F;12&#x2F;03)에 참석할 기회가 생겼다.<br>영어도 잘 못하고, 평상시 <a href="https://aws.amazon.com/">AWS</a>를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.<br>살면서 미국에 처음 가보는 것이다보니 <code>미국에서만 할 수 있는 걸 해보자</code>라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.<br>기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.<br>쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.</p><ul><li><a href="/2021/12/31/las-vegas-aws-reinvent-01/">1편 - 인천공항에서 세미나 첫 날까지 (11&#x2F;28 ~ 11&#x2F;29)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-02/">2편 - 세미나 둘째 날 (11&#x2F;30)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-03/">3편 - 세미나 셋째 날 (12&#x2F;01)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-04/">4편 - 세미나 넷째 날 (12&#x2F;02)</a></li><li>5편 - 세미나 마지막 날부터 인천공항까지(12&#x2F;03 ~ 12&#x2F;05) - 현재 게시물</li></ul><h2 id="용기내어-한마디라도-건네보기"><a href="#용기내어-한마디라도-건네보기" class="headerlink" title="용기내어 한마디라도 건네보기"></a>용기내어 한마디라도 건네보기</h2><p>어젯 밤 re:Play 행사를 갔다오고 나서 없던 자신감이 샘솟고 좀 더 미국에서만 경험할 수 있는 것을 경험해보고 싶다는 생각에 가득찼다.<br>그러다보니 동료 한 분과 아침식사를 하면서 무조건 외국 엔지니어들과 대화를 해보겠다는 목표를 세웠다.  </p><p>일단 테이블에 앉을 때도 2명 정도 앉아있으면서 우리한테 대답해줄 거 같은 착한 사람을 물색하였다.<br>목표를 포착하고 앉아서 말없이 우리끼리만 대화를 하였다.<br>그러다 동료가 용기내어 말을 걸었고, 알고보니 그들은 United 항공사 소프트웨어 엔지니어들이었다.<br>대충 뭔 이야기를 했던 것 같은데 잘 기억은 안 나고 ‘우리 샌프란시스코에서 너네 항공사 타고 라스베가스로 왔어~’와 같은 시덥잖은 대화를 했던 것 같다.</p><p>그리고 나서 너무 비통했다…<br>왜 시덥잖은 얘기 밖에 하지 못하는 것일까…<br>그 시덥잖은 얘기마저도 왜 이리 하기 힘든 걸까…<br>글로벌 트렌드, 외국인들은 어찌 생각하는지, 그들은 어떻게 일하는지, 어떤 기술 문화를 가지고 있는지, 세계가 주목하고 있는 문제들은 무엇일지…<br>너무나 궁금했지만 차마 물어볼 수가 없었다. 물어볼 줄도 모르고 얘기해줘봤자 이해도 못할 것이기 때문이다.</p><p>이대로 가기에는 너무나 아쉬워서 밥대신 빵이랑 커피만 들고 또 목표물을 수색하였다.<br>어느정도 선해 보이는 사람들이 눈에 들어왔고 그대로 앉아서 ‘How are you?’같은 시덥잖은 안부를 물어보았다.<br>알고보니 그들은 어떤 공공기관 사람이었고 엔지니어는 아니고 매니저였다.<br>뭐 대충 한국은 정부에서 클라우드에 대한 신뢰도가 없어서 도입하기 정말 힘들다 너네 신기하다 했는데 뭐 그들도 자기네들도 정부의 제제 등등 때문에 빡세게는 못 쓴다고 했다.<br>엔지니어가 아니면 그닥 할 말이 없어서 어느 정도 얘기하다가 빠이쳤다.</p><p>이대로 가기에는 또 안타까웠다. 결국 시덥잖은 얘기 말고 한 게 없지 않은가…<br>그래서 이번에는 좀 더 전략적으로 다가갔다.<br>리인벤트 참석자들이 메고 있는 목걸이는 검은줄이면 참석자, 노란줄이면 AWS 직원이었다.<br>그래서 한 번 노란줄을 공략해보기로 했고 마침 혼자 밥먹고 있는 사람이 눈에 들어와서 두리번 거리는 척 하다 가서 앉았다.<br>또 시작은 밥먹는 척 하다가 ‘How’s Going?’ 같은 시덥잖은 안부 인사로 시작하였다.<br>그리고 대화하다보니 그는 AWS의 솔루션 아키텍트였고, 한 기업의 M&amp;A 때문에 기술적인 컨설팅 같은 걸 해주고 있다고 하였다.<br>토스페이먼츠도 LGU+의 전자결제사업부와 M&amp;A를 진행했기 때문에 공통점이 있다고 판단하여 옳다구나 싶어 허접한 영어를 막 내뱉었다.<br>그들의 구닥다리 시스템 때문에 일일이 배포하고 롤백도 수기로 하다가 장애가 난 사례를 얘기해주었다.<br><code>Server 1 deploy, server 2 deploy, server 3 deploy... oh bug has occured! server 1 rollback, server 2 rollback, then they said rollback is done! but sometimes bug still occured!</code><br>진짜 occured 어떻게 발음해야하는 건지, 장애를 버그라고 얘기하면 되는 건지, 롤백이 완료되었다는 뭐라고 얘기해야하는 건지, 여전히 장애는 발생한다는 걸 영어로 뭐라고 얘기해야하는 건지…<br>무지성으로 랩하듯 그냥 말했다, 뭐라도 그와 공감대를 형성해야 기술적인 주제로 얘기를 이어나갈 수 있을 것 같았다.<br>다행히 바디랭귀지와 서버1 서버2 서버3의 임팩트가 있었는지 그도 웃으면서 내 얘기에 공감해주었다.<br>그리고 우리가 닥친 상황(레거시 시스템을 신규 시스템으로 마이그레이션)들을 얘기하면서 <code>Strangler Fig</code> 패턴에 대해 말해주며 점진적으로 기능을 마이그레이션 하는 것에 대해 설명해주었다.<br>뭔 소린지 잘 몰랐지만 Strangler Fig 패턴에 대한 세션을 들을 수 있었는데 너무 피곤해서 안 들었던 과거가 후회되었다.<br>그리고 용기내면 이렇게 조그만 인사이트라도 얻을 수 있는 사람이 존재하는데… 영어를 한다면?? 얼마나 큰 인사이트를 얻을 수 있는 기회가 여기 라스베가스에 있었던 것일까… 정말 비통했다.</p><p>이렇게 한바탕 외국인과 얘기를 해보고 나니 정말 한국만큼 핸디캡을 가지고 사는 나라도 없는 것 같았다. (다른 아시아인들은 잘 모르겠지만…)<br>국적을 빼놓고 보면 영어를 할 줄 알면 국적은 중요하지 않았다.<br>그들은 리모트로 일하면서 서로 다른 국가에 있는 사람들과 협업하고 리인벤트에 와서도 서로의 국가가 중요한 게 아니라 그냥 대화를 하면 되는 거였다.<br>하지만 우리는 <code>Where are you from?</code> 같은 게 필수 질문이 되었다.<br>그게 뭐가 중요한가? 그들이 어떤 환경에서 일하고 어떤 생각으로 일하고 어떤 문제를 얼마나 나이스하게 푸는 것이 중요한 건데…<br>정말 한국만 빼놓고 위아더월드로 그들만의 리그가 형성된 것 같았다.<br>그리고 한국 사람들을 보면 진짜 한국사람 끼리끼리 몰려다니고 그런 문화 자체가 다른 외국인들이 다가오기 힘들게 하는 문화같아 보이기도 하였다.<br>그냥 멀리서 뭉쳐다니는 사람 보면 ‘아 한국인인가보다…’하고 생각이 들 정도였다.</p><p>한국의 문화가 유독 뭉쳐다니는 거 좋아하는 것 같은데 이런 문화는 버려야할 문화…까지는 아닌데 좀 약해져야할 필요가 있다고 본다.<br>그렇기 때문에 용기내어 누군가에게 다가가기도 힘들고, 그 조직 외에 있는 사람이 들어오기도 힘든 문화인 것 같다.<br>그리고 영어 교육 진짜 뜯어고쳐야하는 것 같다.<br>말하기&#x2F;듣기 위주로 가르쳐서 진짜 영어 할 줄만 알면 한국인들도 엄청난 메리트를 타고 나는 것이라고 본다.<br>번역기가 아무리 발달됐다고 해도 해외에서 로밍 제대로 안 터지고, 음성 인식 제대로 안 되고 그걸로 대화하다가 맥이 끊긴다.<br>그냥 관광지 가서 바디랭귀지 하는 수준 밖에 번역기는 발달되지 않은 것 같다.<br>정말 영어는 정말정말진짜진짜 중요하다는 것을 또 새삼 깨닫게 되었다.</p><h2 id="라스베가스의-한-청년-래퍼"><a href="#라스베가스의-한-청년-래퍼" class="headerlink" title="라스베가스의 한 청년 래퍼"></a>라스베가스의 한 청년 래퍼</h2><div class="video-container"><iframe src="https://www.youtube.com/embed/WzhFZdWnyYc" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>아침 식사를 마치고 세션을 들으러 가던 도중 육교에서 색소폰을 불고 있는 사람을 만나게 되었다.<br>평상시 재즈힙합도 좋아해서 이 공연도 꽤 즐겁게 들었다.<br>비트는 내 스타일이었지만 목소리는 조금 앵앵대는 느낌이 있어서 영 내 스타일은 아니었지만 굉장히 좋은 경험이었다.<br>물론 뭐라고 하는지는 못 알아들었다. (아이스크림 같은 건 들렸다.)</p><h2 id="세일즈포스-부스에-방문하다"><a href="#세일즈포스-부스에-방문하다" class="headerlink" title="세일즈포스 부스에 방문하다"></a>세일즈포스 부스에 방문하다</h2><img src="/2021/12/31/las-vegas-aws-reinvent-05/sales-force.jpeg" class=""><p>밖에서 봤을 때 굉장히 이쁘게 꾸민 부스가 있었다.<br>바로 세일즈포스였는데 세일즈포스란 기업은 평상시 관심있던 기업이 아니다보니 얘네들이 무슨 문제를 풀었는지 궁금했다. (굿즈도 받을 겸…)<br>근데 보다보니 세일즈포스가 슬랙도 인수했다는 사실을 이 때 알게 되었다.<br>대충 보니까 쇼핑몰 같은 거 만들기 쉽게하는 솔루션들이랑 뭐 여러가지 있어보였는데 크게 눈에 들어오는 건 없었다.<br>영어만 된다면 더 물어보고 싶었는데… 역시나 영어가 안되니 뭘 더 물어보고 싶어도 물어볼 수가 없었다.</p><h2 id="다시-관광모드로…"><a href="#다시-관광모드로…" class="headerlink" title="다시 관광모드로…"></a>다시 관광모드로…</h2><p>마지막 날이라 그런지 들을만한 세션이 얼마 없기도 하고 점심 장소로 이동을 하면서 주변 관광지들을 둘러보았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-05/las-vegas-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-05/las-vegas-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-05/las-vegas-03.jpeg" class=""><p>한국으로 치면 먹자골목 같은 분위기가 나는데 또 라스베가스 만의 분위기가 나서 신기했다.<br>한편으로는 평일 낮에 이런데 오는 사람들은 뭐하는 사람일까… 이 사람들도 휴가내고 놀러온 사람일까… 싶었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-05/in-n-out.jpeg" class=""><p>계속 가다보니 인앤아웃 버거집도 보였다.<br>점심 예약을 하지 않았더라면 한 번 먹어봤을 법 한데… 좀 아쉬웠다.</p><h2 id="플라밍고가-살고-있는-플라밍고-호텔"><a href="#플라밍고가-살고-있는-플라밍고-호텔" class="headerlink" title="플라밍고가 살고 있는 플라밍고 호텔"></a>플라밍고가 살고 있는 플라밍고 호텔</h2><img src="/2021/12/31/las-vegas-aws-reinvent-05/flamingo-01.jpeg" class=""><p>지나가다보니 <a href="https://www.caesars.com/flamingo-las-vegas">플라밍고 호텔</a>도 보였다.  </p><div class="video-container"><iframe src="https://www.youtube.com/embed/kdFoQXx7Cd0" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>플라밍고 호텔은 이름에서 알 수 있듯이 실제로 플라밍고를 볼 수 있다.<br>새들이 지저귀는 소리가 마치 숲속에서 지저귀는 새들의 소리 같았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-05/flamingo-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-05/flamingo-03.jpeg" class=""><p>플라밍고 호텔도 내부에 볼만한 것들이 많으니 라스베가스에 왔으면 한 번 가볼법한 것 같다.<br>이렇게 라스베가스는 호텔마다 특색이 있어서 시간이 된다면 한번 쭉 둘러보는 것도 좋은 것 같다. (공짜로 볼만한 요소들이 많다.)</p><h2 id="고든램지가-운영하는-Pub-Grill"><a href="#고든램지가-운영하는-Pub-Grill" class="headerlink" title="고든램지가 운영하는 Pub &amp; Grill"></a>고든램지가 운영하는 Pub &amp; Grill</h2><img src="/2021/12/31/las-vegas-aws-reinvent-05/pub-n-grill-01.jpeg" class=""><p>회사 동료 분이 예약해주셔서 고든램지가 운영한다는 <a href="https://www.caesars.com/caesars-palace/restaurants/gordon-ramsay-pub-and-grill">Pub &amp; Grill</a>에서 점심을 먹게 되었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-05/pub-n-grill-02.jpeg" class="" title="우리가 먹었던 점심 코스요리"><img src="/2021/12/31/las-vegas-aws-reinvent-05/pub-n-grill-03.jpeg" class="" title="Onion &amp; Ale Soup로 추정되는 요리"><p>엄청 짰다.<br>확실히 미국 음식들은 짜다.<br>같이 갔던 사람의 말로는 이거 만드려면 무슨 양파가 카라멜 색이 될 때까지 엄청 열심히 뭐 굽는대나 해야한다고 한다.<br>노력은 가상한데 그에 비해 맛은 훌륭하지 못했다. 그냥저냥… 짠 거 빼면 좀 먹을만 했던 것 같다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-05/pub-n-grill-04.jpeg" class="" title="Classic Caesar로 추정되는 요리"><p>위에 어니언 스프가 좀 짰다면 얘랑 같이 먹으면 좀 간이 맞는 듯 했다.<br>빵이 들어가있는 샐러드인데 좀 더 힘을 준 샐러드 느낌이었다.<br>다른 동료 분께서 시켜서 먹어봤는데 맛있었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-05/pub-n-grill-05.jpeg" class="" title="Petite Roasted Beef Wellington으로 추정되는 요리"><p>이게 메인 요리였을 것이다.<br>소스 담은 것부터가 힘을 잔뜩 실은 느낌이었다.<br>확실히 고기가 고급지다는 것이 느껴졌지만 역시나 짰다.<br>짠 거 빼고는 너무나 맛있었고, 덕분에 소스는 그닥 안 찍어먹었던 거 같다.<br>미국인들이 왜 이렇게 성인병에 많이 걸리는지 알게 된 것 같았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-05/pub-n-grill-06.jpeg" class="" title="Sticky Toffee Pudding으로 추정되는 요리"><p>푸딩인 줄은 모르겠고 그냥 초코빵 같은 거 위에 아이스크림이 얹어져있었다.<br>단짠단짠 조합에 부합해보이긴 하지만 이것도 몹시나 달았던 것 같았다.<br>그래도 계속 짠 걸 먹는 것에 비해 오랜만에 달달한 걸 먹으니 먹을만 했다.<br>맛은 좋았다. (좀 많이 달았던 거 같긴 하지만…)</p><h2 id="시저스-호텔과-미라지-호텔"><a href="#시저스-호텔과-미라지-호텔" class="headerlink" title="시저스 호텔과 미라지 호텔"></a>시저스 호텔과 미라지 호텔</h2><img src="/2021/12/31/las-vegas-aws-reinvent-05/caesars-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-05/caesars-02.jpeg" class=""><p>지나가다가 또 <a href="https://www.caesars.com/caesars-palace">시저스 호텔</a>이 보여서 한 방 찍어보았다.<br>로마 황제 시저를 테마로 만든 호텔인 건지 로마의 건축문화를 본따 만든 듯한 조형물들이 많이 보였다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-05/mirage.jpeg" class=""><p><a href="https://mirage.mgmresorts.com/en.html">미라지 호텔</a>도 보았는데 폭포처럼 잘 꾸며놓았다.<br>미라지 호텔은 화산쇼가 유명하다는데 그거는 눈으로는 봤는데 사진으로 남겨놓은 거는 딱히 없다.<br>실제로 미라지 호텔 건너편에서 지나가다가 보았는데도 불길 때문에 좀 따뜻하다는 느낌이 들 정도였다.</p><h2 id="이제는-우리가-헤어져야-할-시간…"><a href="#이제는-우리가-헤어져야-할-시간…" class="headerlink" title="이제는 우리가 헤어져야 할 시간…"></a>이제는 우리가 헤어져야 할 시간…</h2><img src="/2021/12/31/las-vegas-aws-reinvent-05/in-taxi.jpeg" class="" title="막상 집에가려니 아쉬워서 택시에서 한 컷 찍어보았다."><img src="/2021/12/31/las-vegas-aws-reinvent-05/in-airplane.jpeg" class="" title="비행기 안에서 뷰가 아름다워서 한 컷 남겨보았다."><img src="/2021/12/31/las-vegas-aws-reinvent-05/bad-food.jpeg" class=""><p>샌프란시스코 공항에서 경유를 위해 기다리다가 무슨 유기농 음식점? 같은 곳에 들어가서 뭔지도 모르고 수프를 시켰는데… 웬 꿀꿀이 죽이 나왔다.<br>만원도 넘었는데 돈이 너무 아까웠고 억지로 먹다가 버렸다.<br>그리고 신기한 건 미국은 분리수거를 크게 안 하는 건지 그냥 음식물도 쓰레기통에 다 버리는 것 같았다.</p><p>마지막으로 한국으로 14시간 가량의 비행을 끝으로 이번 여행을 끝마쳤다…<br>라고 생각하기도 잠시 한국에서는 또 코로나가 빵 터지면서 입국 절차도 까다로워져 여기서만 1시간 넘게 대기했다.<br>또한 해외입국자는 코로나 검사를 무조건 받아야하는데 보건소에서 이거 기다리는 것만 2시간 반을 기다렸다…<br>한국에는 새벽에 들어왔지만 막상 집에 들어가니 점심시간이 넘었고 너무나 추웠다.<br>그리고 10일 간의 자가격리 기간동안 집에만 있으니 너무 답답했고, 다행히 음성이 나와서 그 후에는 무사히 출근할 수 있었다.</p><h2 id="AWS-re-Invent를-끝마치고나서-소감-12-03-12-05"><a href="#AWS-re-Invent를-끝마치고나서-소감-12-03-12-05" class="headerlink" title="AWS re:Invent를 끝마치고나서 소감 (12&#x2F;03 ~ 12&#x2F;05)"></a>AWS re:Invent를 끝마치고나서 소감 (12&#x2F;03 ~ 12&#x2F;05)</h2><p>정말정말정말 좋은 경험이었다. (영어를 할 수 있었더라면 배가 되었겠지만…)<br>비록 기술적 인사이트는 크게 얻지 못하였다 할지라도 내 인생에 있어서 큰 성장을 한 것 같았다.  </p><p>백날 천날 영어가 중요하다… 중요하다… 라고 듣기만 하고 영어로 된 아티클도 대충 배경지식으로 때려맞추고 소스코드로 검증해보는 식으로 했지만<br>실시간으로 사람들과 소통하려고 하다보니… 이건 정말 답이 없었다.<br>영어가 됐다면 기회의 땅 미국에서 더 많은 사람들과 대화하며 많은 인사이트를 얻어낼 수 있었을텐데 한 편으로는 아쉬웠다.  </p><p>또한 미국이라는 나라와 그 나라의 문화를 체험한다는 정말 값진 경험을 하게 되었다.<br>내가 살면서 미국이란 나라를 가볼 일이 있을까… 라는 생각으로 살아갔는데 정말 수천만원 어치의 경험을 한 것 같다.<br>내가 생각했던 미국과 직접 겪어본 미국은 달랐다.<br>미국 기업에 취업해서 미국에서 살아볼 수도 있지 않을까? 라는 생각을 가진 적이 있긴 했지만 직접 경험하고 오니 난 무조건 한국에서 살겠다고 마음 먹었다.<br>땅덩어리가 넓으니 차가 없으면 살기가 너무 힘들고(대중교통을 경험하지 않아서인지 정확한 판단은 아니겠지만), 주변 편의시설까지 가는데도 너무 힘들었다.<br>우리나라는 그냥 호텔 1층에 편의점이 있거나 주변에 널린 게 편의점인데 여기는 편의점 같은 곳을 가려면 또 호텔 밖으로 걸어서 육교랑 횡단보도를 몇 번이나 건너가야 했다.<br>그리고 편의점이라 부를법한 곳에 라면도 없었고, 내 입맛에 맞는 것은 별로 없었다.<br>팁 문화도 생소하기도 하고 얼마를 줘야할지 이런 거 고민할 필요도 없는 한국 가게들이 너무나 편해보였다.<br>그리고 길거리에는 대마초 냄새를 종종 맡을 수 있었고, 도시에 군견과 경찰을 보면 그나마 치안 좋은 게 이정도인데 여기 살려면 정말 정신을 바짝 차려야하는 것 같았다.<br>이렇게 직접 경험하고 나니 한국만큼 살기 편안하고 좋은 나라는 없다는 것을 깨닫게 되고 그런 곳은 잠깐 여행만 갔다 오고 한국에서 계속 살아야겠다는 다짐을 했다.</p><p>그리고 AWS 리인벤트를 경험하고 나서 고용 문화에 대해서도 다시 생각해보게 되었다.<br>우리나라는 노인 빈곤률이 높고 일자리도 잘 취업이 되지 않는다고 한다.<br>하지만 리인벤트에 진행 안내 요원으로 일을 했던 사람을 보면 아마 단기 아르바이트일 거 같았고, 나이가 지긋하신 분들도 많았다.<br>그런 분들이라고 해서 일을 못하는 것도 아니고 친절하게 일을 하고 즐겁게 일을 하는 것을 보니 이게 진짜 노인 공경인 건가… 고령화 사회에 기업들이 이런 일자리들을 줘야하는 것이 아닌가 하는 생각이 들었다.<br>우리나라는 유교문화라고는 하지만 말만 노인 공경하는 것 같은데 이런 실질적인 부분에서 오히려 미국이 노인 공경을 잘하는 것처럼 보였다.</p><p>또한 미국인들의 문화 중에 신기했던 게 모르는 사람한테도 인사 건네고 말을 건넨다는 것이다.<br>엘레베이터에서 처음 만난 노부부가 우리 보고 굿모닝을 시전하고, aws 리인벤트 참석하는 다른 외국인들이 너네도 리인벤트 때문에 왔냐고 물어보고…<br>심지어 아침을 먹을 때도 같은 테이블에 있었던 사람들이 우리에게 먼저 말을 걸어주기도 하였다.<br>이런 게 정인가… 싶기는 하지만 한국인들이 정이 많다 뭐 이런 얘기를 하지만 나는 차라리 이런 부분에서 정이 있다는 것을 느꼈다.<br>한국에서는 주변 이웃끼리도 인사를 잘 안 하는데 미국의 이런 문화에서는 정말 이웃끼리도 잘 지낼 것 같다는 생각이 들었다.<br>그리고 한국은 괜히 뭐 잘못 하면 ‘왜 나대냐’라는 듯한 시선이 있는데 미국에서는 이런 분위기에 대해서 굉장히 자유롭고 관대한 것 같았다.<br>그러다보니 이런 문화 속에서 더 토론이나 자유로운 의견 공유가 가능한 것 같았다.<br>그리고 MBTI에서 I(내향적)와 E(외향적)이 있는데 미국인들은 죄다 E처럼 보였다.<br>행사 진행요원 할아버지와 할머니가 춤추고 재미나게 일을하는 걸 보면 정말 일을 재미있고 신나게 하는 듯 해보였다.<br>근데 얘기하는 걸 들어보면 둘은 오늘 처음 만났거나 AWS 행사에서 처음 만난 것 같았다.<br>그들은 인생도 즐겁게 살고, 일도 즐겁게 하는 듯 해 보였다.<br>어떻게 그렇게 사는 걸까? 그건 자연스레 뿌리박힌 그들의 문화(인사를 자유롭게 건네고, 말은 먼저 건네도 이상하게 보지 않는 문화)와 관련이 있지 않을까 싶었다.</p><p>한국은 정말 살기 좋은 동네이고 치안도 짱짱맨인 동네이다.<br>하지만 사람들 간에 살아가는 방식이나 문화 측면에서는 너무 보수적인 것들은 좀 버려야할 필요가 있다고 본다.<br>그래야 더 자유로운 의사소통이 되고 다양한 의견 공유를 통해 더 나은 방향으로 나아갈 수 있으리라고 본다.<br>한국 사람들이 머리는 정말 똑똑한데 그들만의 리그에 갇혀 산다는 느낌도 들어서 글로벌 트렌드도 주도한다던지 그들과 함께 어우러져 세계를 이끌어나갈 수 있는 기업과 인재들이 더욱 더 나오길 바란다.</p><p>앞으로 인생에 다시는 이런 좋은 기회와 경험들이 주어질지 모르겠지만, 앞으로 올 기회를 잡기 위해 준비된 사람이 되어야겠다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;회사에서 좋은 기회가 생겨 &lt;a href=&quot;https://reinvent.awsevents.com/&quot;&gt;AWS re:invent&lt;/a&gt;(2021&amp;#x2F;11&amp;#x2F;29 ~ 2021&amp;#x2F;12&amp;#x2F;03)에 참석할 기회가 생겼다.&lt;br&gt;영어도 잘 못하고, 평상시 &lt;a href=&quot;https://aws.amazon.com/&quot;&gt;AWS&lt;/a&gt;를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.&lt;br&gt;살면서 미국에 처음 가보는 것이다보니 &lt;code&gt;미국에서만 할 수 있는 걸 해보자&lt;/code&gt;라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.&lt;br&gt;기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.&lt;br&gt;쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-01/&quot;&gt;1편 - 인천공항에서 세미나 첫 날까지 (11&amp;#x2F;28 ~ 11&amp;#x2F;29)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-02/&quot;&gt;2편 - 세미나 둘째 날 (11&amp;#x2F;30)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-03/&quot;&gt;3편 - 세미나 셋째 날 (12&amp;#x2F;01)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-04/&quot;&gt;4편 - 세미나 넷째 날 (12&amp;#x2F;02)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;5편 - 세미나 마지막 날부터 인천공항까지(12&amp;#x2F;03 ~ 12&amp;#x2F;05) - 현재 게시물&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;용기내어-한마디라도-건네보기&quot;&gt;&lt;a href=&quot;#용기내어-한마디라도-건네보기&quot; class=&quot;headerlink&quot; title=&quot;용기내어 한마디라도 건네보기&quot;&gt;&lt;/a&gt;용기내어 한마디라도 건네보기&lt;/h2&gt;&lt;p&gt;어젯 밤 re:Play 행사를 갔다오고 나서 없던 자신감이 샘솟고 좀 더 미국에서만 경험할 수 있는 것을 경험해보고 싶다는 생각에 가득찼다.&lt;br&gt;그러다보니 동료 한 분과 아침식사를 하면서 무조건 외국 엔지니어들과 대화를 해보겠다는 목표를 세웠다.  &lt;/p&gt;
&lt;p&gt;일단 테이블에 앉을 때도 2명 정도 앉아있으면서 우리한테 대답해줄 거 같은 착한 사람을 물색하였다.&lt;br&gt;목표를 포착하고 앉아서 말없이 우리끼리만 대화를 하였다.&lt;br&gt;그러다 동료가 용기내어 말을 걸었고, 알고보니 그들은 United 항공사 소프트웨어 엔지니어들이었다.&lt;br&gt;대충 뭔 이야기를 했던 것 같은데 잘 기억은 안 나고 ‘우리 샌프란시스코에서 너네 항공사 타고 라스베가스로 왔어~’와 같은 시덥잖은 대화를 했던 것 같다.&lt;/p&gt;</summary>
    
    
    
    <category term="기타" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/"/>
    
    <category term="잡동사니" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/%EC%9E%A1%EB%8F%99%EC%82%AC%EB%8B%88/"/>
    
    
    <category term="reinvent" scheme="https://perfectacle.github.io/tags/reinvent/"/>
    
    <category term="여행" scheme="https://perfectacle.github.io/tags/%EC%97%AC%ED%96%89/"/>
    
  </entry>
  
  <entry>
    <title>라스베가스를 다녀오고... 4편 (feat. AWS re:Invent 2021) - 세미나 넷째 날</title>
    <link href="https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-04/"/>
    <id>https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-04/</id>
    <published>2021-12-31T21:28:31.000Z</published>
    <updated>2025-12-09T17:06:50.305Z</updated>
    
    <content type="html"><![CDATA[<p>회사에서 좋은 기회가 생겨 <a href="https://reinvent.awsevents.com/">AWS re:invent</a>(2021&#x2F;11&#x2F;29 ~ 2021&#x2F;12&#x2F;03)에 참석할 기회가 생겼다.<br>영어도 잘 못하고, 평상시 <a href="https://aws.amazon.com/">AWS</a>를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.<br>살면서 미국에 처음 가보는 것이다보니 <code>미국에서만 할 수 있는 걸 해보자</code>라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.<br>기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.<br>쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.</p><ul><li><a href="/2021/12/31/las-vegas-aws-reinvent-01/">1편 - 인천공항에서 세미나 첫 날까지 (11&#x2F;28 ~ 11&#x2F;29)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-02/">2편 - 세미나 둘째 날 (11&#x2F;30)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-03/">3편 - 세미나 셋째 날 (12&#x2F;01)</a></li><li>4편 - 세미나 넷째 날 (12&#x2F;02) - 현재 게시물</li><li><a href="/2021/12/31/las-vegas-aws-reinvent-05/">5편 - 세미나 마지막 날부터 인천공항까지(12&#x2F;03 ~ 12&#x2F;05)</a></li></ul><h2 id="날아서-그랜드캐니언까지"><a href="#날아서-그랜드캐니언까지" class="headerlink" title="날아서 그랜드캐니언까지"></a>날아서 그랜드캐니언까지</h2><p>라스베가스에 오기 전까지만 해도 잘 몰랐는데 라스베가스와 그랜드캐니언은 가까웠다.<br>물론 차를 타고 가면 갔다 오는데 하루 종일이 걸릴 정도라서 그닥 가깝다고 느껴지지 않을지 모르지만… 미국의 땅덩어리를 생각해보면 가까운 수준인 것 같다.<br>새벽부터 차를 타고 갈 체력도 없기도 하고… 우리는 관광이 주 목적이 아닌 AWS 리인벤트가 주 목적이기 때문에 하루를 몽땅 날려버릴 수는 없었다.<br>그리고 차를 타고 가는 것도 매우 지루하기도 하고 주변 풍경도 막상 크게 볼 것이 없다고 한다.<br>그러다보니 비용이 비싸긴 하지만… (인당 56만원 정도 냈던 것 같다.)</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/helicopter-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/helicopter-02.jpeg" class=""><p>버스를 타고 헬기장까지 이동하고 나서야 뭔가 헬기를 탄다는 게 실감이 났다.<br>나는 헬리콥터하면 영화에서 밖에 보지 못했기 때문에 뭔가 양옆이 뚫려있고, 머신건 같은 게 달려있어서 굉장히 위험하다고 생각을 했다.<br>그러다보니 신체포기 각서 같은 걸 서명하고 탑승할 줄 알았는데 그런 건 없었고, 양 옆에 문도 있어서 나름 안전하였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/self-camera.jpeg" class="" title="헬기에 탑승해서 헤드셋까지 끼고 있으니 나름 파일럿 같아 보였다."><div class="video-container"><iframe src="https://www.youtube.com/embed/jkSM4MlWsKo" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>헬기가 이륙하는 장면을 찍어보았는데 정말 이때부터 실감이 제대로 났다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/hoover-dam.jpeg" class=""><p>헬기로 후버댐을 보니 진짜 미국의 대자연의 경관을 한껏 만끽할 수 있었다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-03.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-04.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-05.jpeg" class=""><p>헬기로 이동하는 중에 절벽을 깎아 내린듯 한 비슷비슷한 풍경들이 눈에 들어왔다.<br>차로 이걸 몇시간 동안 지나갈 생각을 하면 너무 지루했을 것 같다.<br>역시 돈이 짱인 거 같다. (돈으로 시간을 살 수 있다는 말이 무엇인지 크게 체감하였다.)</p><div class="video-container"><iframe src="https://www.youtube.com/embed/QnClfLnj7jI" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>헬기에서 착륙한 후 그랜드캐니언을 한바퀴 쭉 찍어보았다. (뒤에 더 있지만 사람 얼굴들이 좀 나와서 잘랐다.)</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-03.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-04.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-05.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-06.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/grand-canyon-07.jpeg" class=""><p>주위를 삥 둘러보았는데 뭐 비슷한 광경이었다.<br>미국의 대자연… 우와… 한 1~2분 정도 체감한 것 같다.<br>그 이상의 감흥이 오지는 않았지만 뭐 그래도 한국에서 해볼 수 없는 경험이었고 자연들도 아름다웠기 때문에 나름 만족한다.<br>하지만 누가 또 오자고 하면 글쎄… 다시 올 정도는 아닌 것 같다.<br>그리고 이런 척박한 환경에 선인장도 자라고, 까마귀도 날아다니는 걸 보고 진짜 어디에든 생물이 존재는 한다는 사실도 신기했다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/breakfast.jpeg" class=""><p>아점 겸 해서 다과를 준비해줬다.<br>이것도 헬기 예약할 때 들어가있는 거긴 한데 여기선 뭐든 무서워서 이거 돈 안 내는 거냐고 물어보고 먹었다.<br>그리고 좀 느긋하게 먹고 싶었는데 헬기 기사가 시간 됐다고 싸갈 거면 싸가라고 재촉하였다. (물론 바람도 많이 불어서 좀 춥기도 하였다.)</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-06.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/in-helicopter-07.jpeg" class=""><p>돌아가는 길에도 몇컷 찍기는 했는데 이미 오면서 본 광경이기도 하고 비슷비슷해 보여서 흥미가 좀 떨어진 상태이긴 했다.</p><h2 id="다시-일상-속으로…"><a href="#다시-일상-속으로…" class="headerlink" title="다시 일상 속으로…"></a>다시 일상 속으로…</h2><p>오전에는 관광모드로 그랜드캐니언을 갔다왔다면 오후에는 라스베가스에 온 본질인 AWS 세션 듣기에 집중했다.<br>그 중에도 넷플릭스 세션들이 인사이트 얻기 좋다는 얘기를 들어서 넷플릭스의 Keeping Netflix reliable using prioritized load shedding 세션을 들었다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/TmNiHbh-6Wg" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>발표자료는 이미 2020년 11월에 넷플릭스 테크 블로그에 올라온 <a href="https://netflixtechblog.com/keeping-netflix-reliable-using-prioritized-load-shedding-6cc827b02f94">Keeping Netflix Reliable Using Prioritized Load Shedding</a>을 토대로 제작되었다.</p><p>어떻게 하면 넷플릭스가 서비스의 품질을 더 지킬 수 있는 건지에 대한 세션 발표였다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-04/netflix-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/netflix-02.jpeg" class=""><p>나는 뒷단 서비스들이 망가졌을 때 서킷브레이커를 도입하여 장애 전파를 막는 것까지만 생각하였다.<br>하지만 트래픽이 너무 과하거나 기타 등등의 사유로 API Gateway가 힘들어한다면…? 같은 상황은 생각해보지 못했다.<br>넷플릭스는 트래픽이 하도 많아져 이런 상황까지 겪어봤을테고, 무작정 서버를 증설하는 대신 다른 방법으로 문제를 해결했다. (물론 너무 심각하면 증설해야하지만)<br>트래픽의 우선순위를 부여하여 리소스가 얼만큼 남았을테니 중요하지 않은 트래픽들은 실패로 떨구고… 하는 방식을 통해 유저의 실시간 스트리밍에는 영향이 절대 없도록 했다는 내용이다.<br>영어로 진행된 세션이니만큼 100% 이해를 하지는 못했지만, 괜히 넷플릭스가 테크 기업이 된 게 아니구나… 이런 식으로까지 생각을 해서 문제 해결을 해야하는구나… 하고 깨달았다.<br>나의 경우에도 대입해보면 결제&#x2F;환불 같은 중요 트래픽은 살리고 그 나머지 트래픽은 실패로 떨굼으로써 어떻게든 결제와 환불에는 문제가 없게 끔 트래픽에 우선순위를 정할 수도 있겠구나… 하는 생각이 들었다.</p><p>그리고 세션이 끝나고 넷플릭스 엔지니어가 질문을 받는 시간을 가졌는데… 영어를 할 줄 모르지만 괜히 주변에 가서 뭐라도 하나 더 줏어 들었다.<br>이해가 되지는 않았지만 세계적인 엔지니어와 영어로 대화하는 다른 엔지니어를 보면서… 너무 부러웠다.<br>우리가 가지고 있는 문제들은 넷플릭스 엔지니어라면 어떻게 해결했을까? 그들은 어떤 문화와 사고방식을 갖고 있길래 이런 식으로까지 기술을 도입하게 된 것일까?<br>영어를 하지 못한다는 사실이 너무나 가슴이 아팠던 상황이었다…</p><h2 id="또-다시-관광모드로…"><a href="#또-다시-관광모드로…" class="headerlink" title="또 다시 관광모드로…"></a>또 다시 관광모드로…</h2><img src="/2021/12/31/las-vegas-aws-reinvent-04/crawfish.jpeg" class=""><p>저녁은 <a href="https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=tori-tours&logNo=221194196161">Hot N Juicy crawfish</a>에서 먹었다.<br>해산물이 나온다는 거 말고 아무것도 모른 채로 먹었는데 살짝 매콤하지만 맛있었다.<br>비닐 장갑을 껴도 그 사이로 국물이 슬쩍 들어오는 것도 같았고… 손에 냄새도 좀 벤다는 점이 단점인 것 같았다.<br>그리고 뭐 먹긴 하는데 메뉴가 계속 먹다보면 질리기도 하고 배가 막 엄청 부르지는 않았다.<br>그리고 TV에는 또 무슨 소 제압하기? 같은 대결을 하는지 카우보이들이 나와서 줄을 던져서 황소를 얼마나 빠른 시간 안에 제압하는지를 겨루는 방송이 나오고 있었다.<br>정말 미국은 카우보이 문화가 많이 발달한 것 같았다.<br>나는 스페인의 투우 같은 것만 생각했었는데 미국도 서부 시대에 카우보이 문화가 많이 발달했다고 한다.</p><h2 id="간지-터지는-흑인-드러머"><a href="#간지-터지는-흑인-드러머" class="headerlink" title="간지 터지는 흑인 드러머"></a>간지 터지는 흑인 드러머</h2><div class="video-container"><iframe src="https://www.youtube.com/embed/Lkc9PWMQQtQ" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>나는 개인적으로 힙합을 좋아하고 그 중에서도 드럼의 쿵치딱 거리는 소리가 좋아 붐뱁 장르를 좋아한다.<br>그러다보니 3개월 정도 드럼을 배우기도 하였고 드럼 소리를 좋아하는 편이었다.<br>근데 우연히 길을 가던 도중에 조약하지만 드럼 요소라 불릴만한 장비를 갖추고 있고… 거기다 소울풀 한 흑인이 앉아있다?<br>이건 못 참치~란 생각으로 한 곡 연주해줄 수 있냐고 물어보자 돈을 내야 연주해준다고 하였다.<br>어디서 들었는데 ‘프로는 돈으로 말한다’라는 얘기가 있었는데 딱 그 말이 떠오르면서 프로처럼 보였다.<br>그리고 팁을 주겠다 얘기하고 바로 즉흥연주가 시작되었다.<br>흑인의 드럼연주도 기가 막혔지만 진짜 간지 터지는 포인트는 백인 노인과의 합주이다.<br>나는 둘이 팀인 줄 알았다, 근데 알고보니 백인 노인도 그냥 길가던 행인 중 한명이었다.<br>내가 생각한 예술가의 이상적인 그림이었고 정말 나의 심금을 울리는 연주였다.<br>바로 당장 귀국하자마자 드럼 레슨 끊어야겠다고 생각이 들 정도였다. (하지만 아직까지 드럼 학원은 등록하지 않았다.)<br>이런 사람들이야말로 돈을 잘 벌어야하고 잘 돼야한다는 생각에 나름 팁을 두둑히 줬던 걸로 기억한다.<br>한국에도 이런 공연들이 많아졌으면 하고 나의 심금을 울릴 수 있는 이런 연주라면 그에 대응하는 대가를 지불하고 볼 용의가 얼마든지 있다.</p><h2 id="라스베가스-속-에펠탑"><a href="#라스베가스-속-에펠탑" class="headerlink" title="라스베가스 속 에펠탑"></a>라스베가스 속 에펠탑</h2><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-03.jpeg" class=""><p>조약하지만 에펠탑을 흉내낸 관광코스가 있길래 가보았다.<br>안에 들어가는 건 공짜지만 타워 위로 올라가서 구경하는 것은 돈을 내야한다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-04.jpeg" class=""><p>진짜 라스베가스에서 카지노 빼면 섭할 정도로 어딜가나 카지노가 보였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-05.jpeg" class=""><p>우리나라도 남산타워에 사랑의 자물쇠인가 뭐시기인가… 있는데 어디가 원조인지 궁금해졌다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-06.jpeg" class=""><p>에펠타워 꼭대기까지는 엘레베이터를 타고 이동하는데 이렇게 투명하게 뻥 뚫려있어서 밖이 보인다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-07.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-08.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-09.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/eiffel-tower-10.jpeg" class=""><p>에펠타워 꼭대기에서 본 뷰도 정말 멋졌다.<br>그리고 뜻밖에 다른 외국인 커플이 프로포즈하는 장면도 보았다.<br>결혼하려면 이정도 되는 근사한 곳에 와서 반지 주면서 프로포즈를 해야 결혼할 수 있는 것 같았다.<br>여자는 감동한 듯 울먹이며 남자를 끌어안았다. (이 순간 모두가 박수를 치며 축하해주었다.)<br>근데 여기서 또 재밌는게 남자&#x2F;여자 둘 만 있던 게 아니라 남자 측 엄마로 추측되는 사람도 함께 있었다는 사실이다.<br>우리나라로 치면 시어머니 앞에서 남자가 프로포즈를 한 건데… 마마보이인가? 이 생각도 살짝 들기도 하면서 문화 충격이었다.<br>한국에서 좀 과장해서 막장드라마 시나리오였다면 시어머니가 ‘네가 우리 애를 벌써부터 잡는구나 잡아?’하는 시나리오도 연출될 수 있을만한 그림이었다.<br>하여튼 미국이란 동네는 참으로 신기했다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/wtcCM90n2Ck" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>에펠타워의 하나의 장점은 벨라지오 호텔의 분수쇼를 위에서 볼 수 있다는 사실이었다.<br>땅에서 보는 분수쇼도 멋있었지만 위에서 본 분수쇼는 또 달랐다.<br>땅에서 보면 1차원 적으로 밖에 보지 못해 분수가 일렬로 나열돼있는 줄 알았는데 위에서 보니 동그란 모양의 분수도 있다는 사실을 알 수 있게 되었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/ty.jpeg" class=""><p>이런 타워 아래로 내려오면 국룰처럼 기념품 가게가 있다.<br>나는 여태까지 <a href="https://shop.ty.com/">ty</a>가 <code>T</code>hank <code>Y</code>ou의 줄임말인 줄 알았는데 브랜드 로고라는 걸 처음 알게 되었다.</p><h2 id="re-Play"><a href="#re-Play" class="headerlink" title="re:Play"></a>re:Play</h2><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-01.jpeg" class=""><p>re:Play는 AWS re:Invent에서 행사 마지막 전날 밤에 진행되는 파티 같은 행사이다.<br>진짜 이건 미쳤다. 말로 설명이 안 된다. 테크 기업에서 스케일이 큰 행사를 하기도 힘든데 이렇게 넓은 대지를 빌려 파티 문화까지 만들었다고?<br>정말 정말 이건 미쳤다고 생각이 들고 아마존이란 기업에 존경심이 생겼다. </p><div class="video-container"><iframe src="https://www.youtube.com/embed/jDjWCgoqGGs" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>입구를 따라 쭉 들어오다보면 월드 디제이 페스티벌 마냥 디제이가 신나는 음악을 흔들어 제끼고 있었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-dj-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-dj-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-dj-03.jpeg" class=""><p>그 와중에 오징어게임을 리믹스 한 음악을 틀고 있었다. 국뽕이 차오르는 순간이었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-03.jpeg" class=""><p>re:Play에는 탁구 등등 여러 놀이거리도 있었지만 우리는 장애물 피하기 같은 것과 팀먹고 연타하여 누가 제일 빠르게 누르나 같은 걸 해보았다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/MXpNtFt5pcY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>뭐니뭐니 해도 re:Play의 꽃은 디제잉인 것 같았다.<br>한국에서는 클럽 같은 곳을 한 번 밖에 가보지 않았고 재미도 없었지만, 시간이 흐른 탓인지 나름 재미있었다.<br>하지만 미국이라 그런지 이런 곳에서까지 대마초를 피는 사람이 있었고 정말 냄새가 역해서 토하는 줄 알았다.</p><p>대마초하니까 떠오른 건데 마약에 호기심이 있다가도 그 역한 냄새를 맡으면 호기심이 싹 사라진다.<br>라스베가스에서도 특정 길거리를 지나가거나 하면 항상 역한 대마초 냄새가 났다.<br>처음에는 몸 한 3주간 안 씻은 노숙자 몸에서 나는 냄새인 줄 알았는데 대마초 냄새였다.<br>정말 그정도로 역하고 미국이란 나라에 한 번 더 충격을 받게 된 계기였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-04/replay-t-shirt.jpeg" class=""><p>행사가 끝날 때 쯤 나오면 사람이 몰릴 것 같아 미리 나오면서 또 어디 줏어먹을 거 없나… 두리번 거리는 하이에나처럼 돌아다니다가 티셔츠를 득템하였다.<br>행사 막바지라 그런지 필요한 만큼 다 가져가라고 해서 진짜 한 10장은 들고 온 것 같았다.<br>2장은 집에서 잠옷으로 요긴하게 쓰고 있고, 나머지는 회사 동료들에게 뿌렸다.</p><h2 id="세미나-넷째-날까지의-소감-12-02"><a href="#세미나-넷째-날까지의-소감-12-02" class="headerlink" title="세미나 넷째 날까지의 소감 (12&#x2F;02)"></a>세미나 넷째 날까지의 소감 (12&#x2F;02)</h2><p>아침 일찍부터 스케쥴을 시작해서 밤 늦게까지 놀다보니 하루가 참 길었다.<br>확실히 그랜드캐니언을 보니 미국은 자연도 그 나라에 일부분인 것 마냥 엄청난 스케일을 자랑하였다.<br>캠핑 같은 거 좋아하는 사람한테는 천국일 거 같다는 생각이 들었다.<br>또한 넷플릭스라는 기업의 기술역량에 다시 한 번 존경심이 생겼다.<br>평상시 <a href="https://github.com/Netflix/Hystrix">Hystrix</a>니 <a href="https://github.com/Netflix/zuul">Zuul</a>이니 여러 오픈소스를 만들 정도의 기업이라 기술 중심 기업이라는 것은 어느정도 알고 있었는데 역시나 스케일이 다른 것 같았다.</p><p>그리고 넷째 날이 정말 제대로 라스베가스를 즐겼다는 생각이 들었다.<br>간지 폭발하는 흑인 드러머를 만난 건 내 인생에 있어서 잊을 수 없었다.<br>또한 re:Play라는 미친 파티를 경험하고 나서 아마존에 대한 존경심이 샘솟았다.</p><p>내일만 버티면 된다는 생각에 이제 좀 마음이 놓이는 날이었다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;회사에서 좋은 기회가 생겨 &lt;a href=&quot;https://reinvent.awsevents.com/&quot;&gt;AWS re:invent&lt;/a&gt;(2021&amp;#x2F;11&amp;#x2F;29 ~ 2021&amp;#x2F;12&amp;#x2F;03)에 참석할 기회가 생겼다.&lt;br&gt;영어도 잘 못하고, 평상시 &lt;a href=&quot;https://aws.amazon.com/&quot;&gt;AWS&lt;/a&gt;를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.&lt;br&gt;살면서 미국에 처음 가보는 것이다보니 &lt;code&gt;미국에서만 할 수 있는 걸 해보자&lt;/code&gt;라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.&lt;br&gt;기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.&lt;br&gt;쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-01/&quot;&gt;1편 - 인천공항에서 세미나 첫 날까지 (11&amp;#x2F;28 ~ 11&amp;#x2F;29)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-02/&quot;&gt;2편 - 세미나 둘째 날 (11&amp;#x2F;30)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-03/&quot;&gt;3편 - 세미나 셋째 날 (12&amp;#x2F;01)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;4편 - 세미나 넷째 날 (12&amp;#x2F;02) - 현재 게시물&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-05/&quot;&gt;5편 - 세미나 마지막 날부터 인천공항까지(12&amp;#x2F;03 ~ 12&amp;#x2F;05)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;날아서-그랜드캐니언까지&quot;&gt;&lt;a href=&quot;#날아서-그랜드캐니언까지&quot; class=&quot;headerlink&quot; title=&quot;날아서 그랜드캐니언까지&quot;&gt;&lt;/a&gt;날아서 그랜드캐니언까지&lt;/h2&gt;&lt;p&gt;라스베가스에 오기 전까지만 해도 잘 몰랐는데 라스베가스와 그랜드캐니언은 가까웠다.&lt;br&gt;물론 차를 타고 가면 갔다 오는데 하루 종일이 걸릴 정도라서 그닥 가깝다고 느껴지지 않을지 모르지만… 미국의 땅덩어리를 생각해보면 가까운 수준인 것 같다.&lt;br&gt;새벽부터 차를 타고 갈 체력도 없기도 하고… 우리는 관광이 주 목적이 아닌 AWS 리인벤트가 주 목적이기 때문에 하루를 몽땅 날려버릴 수는 없었다.&lt;br&gt;그리고 차를 타고 가는 것도 매우 지루하기도 하고 주변 풍경도 막상 크게 볼 것이 없다고 한다.&lt;br&gt;그러다보니 비용이 비싸긴 하지만… (인당 56만원 정도 냈던 것 같다.)&lt;/p&gt;
&lt;img src=&quot;/2021/12/31/las-vegas-aws-reinvent-04/helicopter-01.jpeg&quot; class&gt;</summary>
    
    
    
    <category term="기타" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/"/>
    
    <category term="잡동사니" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/%EC%9E%A1%EB%8F%99%EC%82%AC%EB%8B%88/"/>
    
    
    <category term="reinvent" scheme="https://perfectacle.github.io/tags/reinvent/"/>
    
    <category term="여행" scheme="https://perfectacle.github.io/tags/%EC%97%AC%ED%96%89/"/>
    
  </entry>
  
  <entry>
    <title>라스베가스를 다녀오고... 3편 (feat. AWS re:Invent 2021) - 세미나 셋째 날</title>
    <link href="https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-03/"/>
    <id>https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-03/</id>
    <published>2021-12-31T20:42:31.000Z</published>
    <updated>2025-12-09T17:06:50.303Z</updated>
    
    <content type="html"><![CDATA[<p>회사에서 좋은 기회가 생겨 <a href="https://reinvent.awsevents.com/">AWS re:invent</a>(2021&#x2F;11&#x2F;29 ~ 2021&#x2F;12&#x2F;03)에 참석할 기회가 생겼다.<br>영어도 잘 못하고, 평상시 <a href="https://aws.amazon.com/">AWS</a>를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.<br>살면서 미국에 처음 가보는 것이다보니 <code>미국에서만 할 수 있는 걸 해보자</code>라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.<br>기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.<br>쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.</p><ul><li><a href="/2021/12/31/las-vegas-aws-reinvent-01/">1편 - 인천공항에서 세미나 첫 날까지 (11&#x2F;28 ~ 11&#x2F;29)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-02/">2편 - 세미나 둘째 날 (11&#x2F;30)</a></li><li>3편 - 세미나 셋째 날 (12&#x2F;01) - 현재 게시물</li><li><a href="/2021/12/31/las-vegas-aws-reinvent-04/">4편 - 세미나 넷째 날 (12&#x2F;02)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-05/">5편 - 세미나 마지막 날부터 인천공항까지(12&#x2F;03 ~ 12&#x2F;05)</a></li></ul><h2 id="미국의-원할머니-보쌈이-AWS에서-발표를-한다고-12-01"><a href="#미국의-원할머니-보쌈이-AWS에서-발표를-한다고-12-01" class="headerlink" title="미국의 원할머니 보쌈이 AWS에서 발표를 한다고?? (12&#x2F;01)"></a>미국의 원할머니 보쌈이 AWS에서 발표를 한다고?? (12&#x2F;01)</h2><p>요번 리인벤트에서는 특정 서비스에 딥다이브 하기 보다는 좀 더 추상적인 ‘아키텍처’ 관점의 세션들을 많이 들어보았다.<br>내가 AWS의 서비스에 대한 이해도가 낮기도 하다보니 내 소스코드에도 적용 가능한 추상적인, 이론적인 내용들은 무엇이 있을까?하다보니<br>이벤트 드리븐, 클라우드 네이티브, 모던, next generation 뭐 이런 키워드 있는 것들을 주로 들었던 것 같다.<br>하지만 영어가 되지 않아 대부분 이해가 되지 않던 와중 나를 충격에 빠뜨린 세션이 있었다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/U5GZNt0iMZY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>Building next-gen applications with <code>event-driven</code> architectures라는 세션이었는데 이벤트 드리븐에 꽂혀서 신청했던 세션이다.<br>나는 당연히 테크 기업이 나와서 발표를 하겠거니… 라고 생각했는데 <a href="https://www.tacobell.com/">타코벨</a>에서 나와서 발표를 하였다.<br><code>잠깐만... 타코벨?? 타코... 그 멕시코 음식 파는 기업 아니야??</code><br>라는 생각이 뇌리를 스쳐지나갔다.<br>우리나라로치면 원할머니 보쌈이 AWS 리인벤트에 나와서 이벤트 드리븐 아키텍쳐로 자기네들이 가진 문제를 풀었다고 하는 것이다.<br>말이 되는가? 원할머니 보쌈은 음식이 메인이고 기껏해야 배민이나 쿠팡이츠, 요기요 같은 플랫폼 기업에 음식점 등록하고 수수료 떼는 게 끝 아닌가?<br>우리나라에서 푸드 테크기업이라고 불리면서 직접적으로 음식을 만들어 파는 곳이 있는가? 라고 했을 때 떠오르는 곳이 없었다.  </p><p>그래… 타코벨에서 AWS를 어찌저찌 썼다고 치자… 그래서 그들은 무슨 문제를 풀었던 걸까??</p><img src="/2021/12/31/las-vegas-aws-reinvent-03/tacobell-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-03/tacobell-02.jpeg" class=""><p>미국의 슈퍼볼 같은 행사의 TV 광고를 한 번 때리면 주문량이 미친 듯이 폭주한다는 것이다.<br>그래서 그들은 배달기사 &#x2F; 음식점 &#x2F; 고객 사이에서 발생하는 상호작용 사이에서 이벤트 드리븐을 적용했다는 것이다.<br>그것도 서버리스로!! 그래서 미친듯이 폭발하는 트래픽을 견뎌낼 수 있었다고 한다…</p><p>이들은 배민 같은 중간 플랫폼 사업자들을 끼지 않고 직접 배달을 하고 있었고, 음식점 포스에도 기술을 도입했다.<br>생각이나 해보자… 월드컵 경기 중간에 TV에서 네네치킨 광고를 한다고 네네치킨에서 이벤트 드리븐 아키텍쳐를 상상이나 할 수 있을까?<br>그냥 배민 같은 곳이 안 터지길 빌어야하는 것이다.  </p><p>이걸 보고 또 느낀 점이 있었다…<br>역시 사업은 글로벌로 해야하는구나… 그래야 어떤 비즈니스도 돈이 될 정도의 트래픽들이 모인다는 사실이다.<br>우리나라가 미국 정도의 인구규모만 되더라도 내수시장에서 먹고 살 수 있겠지만… 이미 한국은 저출산 시대와 그 사이에 피터지는 경쟁으로 인해 거대 플랫폼 기업들이 다 뜯어먹고 있는 시장같아 보였다.<br>미국 정도 규모에서 일부만 먹더라도… 한국에서의 10%와 미국에서의 10%는 정말 하늘과 땅 차이이기 때문에 인구가 깡패라는 점도 느꼈다.<br>우리나라가 미국 정도 인구 규모에 슈퍼볼 같이 배달이 폭주할 만한 행사들이 종종 있다면… 원할머니 보쌈에서도 이벤트 드리븐 아키텍쳐를 고민할 날이 오지 않을까??</p><p>이번 세션이 나한테 큰 충격을 준 만큼 정말 질문하고 싶은 내용이 많았다.</p><ul><li>한국에서는 단순 음식점이 테크기업이 된 사례는 없는 것으로 알고 있는데 너네는 어떻게 이런 생각을 했냐? 우버이츠 이런 거 쓸법도 한데…</li><li>서버리스? 그거 쓰면 미리 서버 배포 안 해놔도 순간 미칠듯한 트래픽 버틸 수 있니? 대부분 오토스케일링이 되기 전에 피크 치고 서버 다 뻗어서 미리 2~3배 서버 증설해놓는데 서버리스는 그럴 필요가 없는 거니?</li><li>우리는 스프링을 써서 서버리스로 소스코드 관리하면 재사용성도 떨어지고, 어플리케이션 컨텍스트 띄우느라 콜드스타트도 굉장히 심할 거 같은데… 너네는 어떻게 이런 문제를 해결했니? 스프링에는 적합하지 않다고 생각하니?</li></ul><p>세션을 들은지 한참이 지난 지금에 와서도 이렇게 질문들이 생각이 나는데… 이런 질문을 할 수 없는 나의 영어 실력이 참으로 비통했다.<br>진짜… 영어를 할 줄 아는 사람이면 나 정도는 금방 제끼겠구나… 영어가 내 앞길을 막는 날이 언젠가 올 줄 알았는데 오늘이 그날이구나… 하고 느꼈다.<br>라고 말하면서 이전 포스트에서도 말했듯이 영어공부를 열심히 하지 않는 걸 보면… 어디 해커스 학원 같은데 돈이라도 쳐발라야 돈이 아까워서 공부를 할까 싶다.</p><h2 id="점점-지쳐가는-일상들…"><a href="#점점-지쳐가는-일상들…" class="headerlink" title="점점 지쳐가는 일상들…"></a>점점 지쳐가는 일상들…</h2><p>라스베가스에 온지 4일 째가 되었다.<br>그러다보니 먹고자고 세션 듣는 것들이 일상이 되었다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-03/lunch.jpeg" class=""><p>그럼에도 불구하고 aws에서 제공하는 식단들은 너무나 물렸고, 이제는 맛도 없다고 느껴지고… 얼른 육개장 사발면 한사발 얼큰하게 때리고 싶은 마음 뿐이었다…</p><img src="/2021/12/31/las-vegas-aws-reinvent-03/reflection-room-rest.jpeg" class=""><p>시차적응이 된 것도 같지만 아침부터 세션을 듣고 호텔들을 돌아다니다보면 지치는 건 마찬가지였다.<br>세션을 들어도 이해가 잘 되지 않으니 자포자기같은 심정을 먹다보니 자연스레 체력을 좀 보충하자는 생각에 또 리플렉션 룸에서 휴식을 청했다.<br>리플렉션 룸에서 쉬면서 노트북으로 Self-paced lab도 할 수 있어서 그나마 좀 내 템포대로 진행할 수 있어 편했다.</p><h2 id="소소한-행복-찾기"><a href="#소소한-행복-찾기" class="headerlink" title="소소한 행복 찾기"></a>소소한 행복 찾기</h2><p>세션을 듣기도 더이상 지치다보니 자연스레 ‘미국에서만 할 수 있는 걸 찾아보자’란 생각에 또 AWS 부스 이곳 저곳 기웃기웃 거렸다.<br>하지만 역시 언어의 장벽에 막히고 자신감이 많이 줄어들은 상태라 많은 곳을 둘러보지는 못했다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/jmgMf3VfV_Q" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>그러다 뭔가 미국에서 밖에 할 수 없는 것이 눈에 들어왔다.<br>정확한 명칭은 뭔지는 모르겠지만 카우보이 뭐시기가 아닐까… 싶다.<br>확실히 미국은 이런 카우보이 문화가 발달한 것인지 이런 놀이문화도 있는 것이 신기했다.<br>내 앞에 여러 사람들이 10초 대 초반에 떨어지는 걸 보고 나는 더 오래 버티리라는 다짐을 하고 올라타게 되었다.<br>근데 막상 찍힌 동영상을 보니 즐기기 보다는 ‘기록을 깨겠다’라는 경쟁심으로 불타있어 보였다.<br>다른 외국인들은 한손으로 타고 소리도 지르고 즐기던데… 나는 즐기러 온 게 아닌가? 라는 생각이 들었다.<br>여기까지 와서도 어떻게든 이겨보겠다는 그런 생각에 스트레스를 날려보내려면 마음을 다르게 고쳐먹어야겠다는 생각도 들었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-03/venetian-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-03/venetian-02.jpeg" class=""><p>셋째 날도 그냥 지나가다가 또 안 찍은 것 같은 공간을 몇 개 찍어보았다.<br>셋째 날은 그냥저냥 지쳐서 크게 한 건 없던 것 같다.</p><h2 id="세미나-셋째-날까지의-소감-12-02"><a href="#세미나-셋째-날까지의-소감-12-02" class="headerlink" title="세미나 셋째 날까지의 소감 (12&#x2F;02)"></a>세미나 셋째 날까지의 소감 (12&#x2F;02)</h2><p>셋째 날에도 영어의 필요성을 절실히 체감하였지만 타코벨 세션이 정말 큰 충격을 주었다.<br>일개 음식점이라고 생각했던 기업이 테크기업이 됐다고?? 이벤트 드리븐 아키텍쳐를 고민한다고??<br>우리나라에서 감히 상상이나 할 수 있겠는가? 원할머니 보쌈이나 네네치킨 같은 곳에서…??<br>왜 미국을 기회의 땅이라고 하는 건지… 왜 미국 같은 곳에 와서 경험을 해봐야하는 건지 뼈저리게 느낀 날이었다.<br>우리나라에서는 조그만 비즈니스도 스케일이 커질 수 있고, 낙후한 산업이라고 생각했던 부분들이 미국에서는 거기마저도 기술을 도입하고 클라우드 위에서 돌아간다는 것이 신기했다.<br>영어를 못해도 이정도 깨달음을 얻을 수 있는데… 영어를 할 수 있었더라면 그들에게서 얼만큼의 인사이트들을 얻어낼 수 있을까?<br>감히 상상조차 되지 않았고, 영어 할 줄 아는 사람들이 진짜진짜 너무너무 부러웠다.</p><p>그리고 셋째 날 쯤… 되다보니 한국에 가고싶어졌다.<br>첫날에는 우와~ 라스베가스다~ 주변 풍경도 너무 삐까뻔쩍하고 멋있다~ 란 생각에 가득차있었다.<br>하지만 하루 이틀 지나다보니 그런 게 일상이 되었고, 오늘도 내일도 먹고자고세션듣고 먹고자고세션듣고 반복일 걸 생각하니 지루했다. (거기다 영어까지 못하니…)<br>남들은 여행으로 힐링을 한다지만 나는 딱히 힐링이 된다는 느낌 보다는 그냥 침대에 누워서 유튜브 보는 게 더 행복했다.<br>한편으로는 내 사비를 들여 친구들과 여행을 오면 좀 다른 느낌일까… 싶기도 했다.<br>나한테 이정도면 장기여행이고, 여행에 대한 나의 가치관을 다시 생각하게 된 계기가 된 것 같아 나중에 유럽여행에 대한 것도 고민을 좀 해봐야할 것 같다.<br>살면서 유럽도 별로 가볼 일이 없어서 가보긴 할 거 같지만 과연 내 생각만큼 즐겁고 행복할지는 이번 여행을 통해 더더욱 불확실해졌다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;회사에서 좋은 기회가 생겨 &lt;a href=&quot;https://reinvent.awsevents.com/&quot;&gt;AWS re:invent&lt;/a&gt;(2021&amp;#x2F;11&amp;#x2F;29 ~ 2021&amp;#x2F;12&amp;#x2F;03)에 참석할 기회가 생겼다.&lt;br&gt;영어도 잘 못하고, 평상시 &lt;a href=&quot;https://aws.amazon.com/&quot;&gt;AWS&lt;/a&gt;를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.&lt;br&gt;살면서 미국에 처음 가보는 것이다보니 &lt;code&gt;미국에서만 할 수 있는 걸 해보자&lt;/code&gt;라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.&lt;br&gt;기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.&lt;br&gt;쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-01/&quot;&gt;1편 - 인천공항에서 세미나 첫 날까지 (11&amp;#x2F;28 ~ 11&amp;#x2F;29)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-02/&quot;&gt;2편 - 세미나 둘째 날 (11&amp;#x2F;30)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;3편 - 세미나 셋째 날 (12&amp;#x2F;01) - 현재 게시물&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-04/&quot;&gt;4편 - 세미나 넷째 날 (12&amp;#x2F;02)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-05/&quot;&gt;5편 - 세미나 마지막 날부터 인천공항까지(12&amp;#x2F;03 ~ 12&amp;#x2F;05)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;미국의-원할머니-보쌈이-AWS에서-발표를-한다고-12-01&quot;&gt;&lt;a href=&quot;#미국의-원할머니-보쌈이-AWS에서-발표를-한다고-12-01&quot; class=&quot;headerlink&quot; title=&quot;미국의 원할머니 보쌈이 AWS에서 발표를 한다고?? (12&amp;#x2F;01)&quot;&gt;&lt;/a&gt;미국의 원할머니 보쌈이 AWS에서 발표를 한다고?? (12&amp;#x2F;01)&lt;/h2&gt;&lt;p&gt;요번 리인벤트에서는 특정 서비스에 딥다이브 하기 보다는 좀 더 추상적인 ‘아키텍처’ 관점의 세션들을 많이 들어보았다.&lt;br&gt;내가 AWS의 서비스에 대한 이해도가 낮기도 하다보니 내 소스코드에도 적용 가능한 추상적인, 이론적인 내용들은 무엇이 있을까?하다보니&lt;br&gt;이벤트 드리븐, 클라우드 네이티브, 모던, next generation 뭐 이런 키워드 있는 것들을 주로 들었던 것 같다.&lt;br&gt;하지만 영어가 되지 않아 대부분 이해가 되지 않던 와중 나를 충격에 빠뜨린 세션이 있었다.&lt;/p&gt;
&lt;div class=&quot;video-container&quot;&gt;&lt;iframe src=&quot;https://www.youtube.com/embed/U5GZNt0iMZY&quot; frameborder=&quot;0&quot; loading=&quot;lazy&quot; allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="기타" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/"/>
    
    <category term="잡동사니" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/%EC%9E%A1%EB%8F%99%EC%82%AC%EB%8B%88/"/>
    
    
    <category term="reinvent" scheme="https://perfectacle.github.io/tags/reinvent/"/>
    
    <category term="여행" scheme="https://perfectacle.github.io/tags/%EC%97%AC%ED%96%89/"/>
    
  </entry>
  
  <entry>
    <title>라스베가스를 다녀오고... 2편 (feat. AWS re:Invent 2021) - 세미나 둘째 날</title>
    <link href="https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-02/"/>
    <id>https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-02/</id>
    <published>2021-12-31T18:06:31.000Z</published>
    <updated>2025-12-09T17:06:50.296Z</updated>
    
    <content type="html"><![CDATA[<p>회사에서 좋은 기회가 생겨 <a href="https://reinvent.awsevents.com/">AWS re:invent</a>(2021&#x2F;11&#x2F;29 ~ 2021&#x2F;12&#x2F;03)에 참석할 기회가 생겼다.<br>영어도 잘 못하고, 평상시 <a href="https://aws.amazon.com/">AWS</a>를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.<br>살면서 미국에 처음 가보는 것이다보니 <code>미국에서만 할 수 있는 걸 해보자</code>라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.<br>기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.<br>쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.</p><ul><li><a href="/2021/12/31/las-vegas-aws-reinvent-01/">1편 - 인천공항에서 세미나 첫 날까지 (11&#x2F;28 ~ 11&#x2F;29)</a></li><li>2편 - 세미나 둘째 날 (11&#x2F;30) - 현재 게시물</li><li><a href="/2021/12/31/las-vegas-aws-reinvent-03/">3편 - 세미나 셋째 날 (12&#x2F;01)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-04/">4편 - 세미나 넷째 날 (12&#x2F;02)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-05/">5편 - 세미나 마지막 날부터 인천공항까지(12&#x2F;03 ~ 12&#x2F;05)</a></li></ul><h2 id="어느정도-익숙해지기-시작한-세미나-둘째-날"><a href="#어느정도-익숙해지기-시작한-세미나-둘째-날" class="headerlink" title="어느정도 익숙해지기 시작한 세미나 둘째 날"></a>어느정도 익숙해지기 시작한 세미나 둘째 날</h2><img src="/2021/12/31/las-vegas-aws-reinvent-02/morning-road.jpeg" class=""><p>베네시안 호텔에 아침부터 키노트가 있어서 이동을 하였다.<br>그래도 반복되는 길을 이틀 동안 왔다갔다 하다보니 도시의 풍경과 길들이 익숙해지기 시작했다.<br>또 신기한 것은 라스베가스 호텔 근처에서는 24시간 내내 음악 소리가 들리는 것 같았다.<br>밤에는 시끄러운 음악이 들렸던 것 같은데 아침에는 또 잔잔한 음악이었나… 여튼 분위기에 맞는 음악이 길거리에 울려퍼지는 게 신기했다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/breakfast.jpeg" class="">  <p>어제만 해도 김치나 라면이 마려웠는데 잠자고 일어나니 그새 까먹고 빵보니 또 눈이 돌아가서 두 개나 집었다.<br>약간 좀 과하게 집었나… 생각이 들어 뒤를 쳐다봤는데 외국인들도 빵은 하나만 집고 있었다.<br>평상시에 아침도 잘 먹지 않는데 두개는 역시나 과했는지 한 개 밖에 먹지 못했다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/band.jpeg" class=""><p>아침을 먹고 키노트 세션을 들으러 갔는데 대기시간에 유명한지 안 유명한지 모르겠는 밴드가 공연을 하였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/key-note.jpeg" class=""><p>키노트가 시작되어 연설을 했고 내가 샌프란시스코 - 라스베가스로 이동할 때 탔던 United 항공사라던지 나스닥 거래소라던지 이런 기업들이 어떻게 AWS를 사용해서 문제를 해결했는지 설명해주었다.<br>영어라서 뭔소린지 제대로 못 알아듣고, 그냥 그런갑다~란 생각으로 듣곤 했다.<br>나중에 알고보니 키노트는 동시통역을 제공해줬다고 한다.<br>근데 다른 키노트에서 들어보았는데 헤드셋이 너무 압박해서 귀가 아픈데 막상 주변 잡음은 다 들렸다.<br>그리고 영어를 한국어로 통역하다보니 어순이 맞지 않아 발표자가 한참 말하고 나서 한국어로 따다다다 통역을 하는 경우도 생겼고,<br>무엇보다 통역하는 사람이 엔지니어가 아닌 거 같은 게 통역의 퀄이 썩… 좋지 않았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/dj.jpeg" class=""><p>키노트가 끝나서 또 다른 세션 장소로 이동 중이었는데 아침부터 DJ는 열일하고 있었다.<br>어제 저녁에도 다른 DJ가 있었던 것 같은데 아마 몇교대를 계속 돌리는 것 같았다…</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/toss-payments.jpeg" class=""><p>그리고 칠판같은 공간에 여러 낙서가 있었고 기업을 홍보하는 듯한 문구도 있었다.<br>나는 악필이라 딱히 적지 않았고 동료 분께서 회사명을 적은 걸 기념해서 한 컷 찍어보았다.<br>(가끔 이렇게 영어 속에 다른 한글로 된 기업들의 문구를 보면 뭔가 반갑고 신기했다.)</p><h2 id="코로나-검사를-받기-위한-여정"><a href="#코로나-검사를-받기-위한-여정" class="headerlink" title="코로나 검사를 받기 위한 여정"></a>코로나 검사를 받기 위한 여정</h2><p>코시국이다보니 입국할 때도 코로나 PCR 음성 검사 확인서가 있어야했다. (물론 출국할 때도 영문으로 된 확인서가 필요하기에 한국에서 8만원 가량을 내고 민간 병원에서 진행하였다.)<br>백신 2차 접종여부에 따라 달라지지만 나는 2차 접종을 했기 때문에 출국하기 72시간 이전에 검사받은 확인서가 필요하였다.<br>금요일 저녁에 출국이기 때문에 적당히 화요일 오후에 진행하였다.<br>무료로 해주는 곳은 시간이 좀 걸려서 혹시나 출국 전까지 안 나올 가능성이 존재하여 따로 유료로 하는 곳도 알아보았는데 호텔까지 와서 검사를 해주는데 30만원 가량이 들었다.<br>리스크에 도박을 해야했지만 30만원은 좀 선넘는다는 생각에 무료로 하거나 좀 더 싸게 할 수 있는 방법을 찾아보게 되었다.<br>대부분이 드라이브 쓰루 검사 밖에 지원을 해주지 않았지만 <a href="https://book.curative.com/sites/32612">curative</a> 사이트에서 라스베가스에 Walk in(차 없이 걸어서) 검사가 가능한 곳을 찾았다.<br>혼자 리스크를 감수하기에는 좀 쫄려서 동료 한 명을 섭외하고 같이 무료로 코로나 검사 예약을 진행하였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/area15-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-02/area15-02.jpeg" class=""><p>택시를 타고 이동하였는데 이상한 자동차 전시물과 건물, 주차장 말고 코로나 검사라고 보일법한 공간이 보이지 않았다.<br>그래서 뭔가 이상하여 건물을 쭉 한바퀴 돌아도 여전히 코로나 검사 안내 표지판이 하나도 보이지 않아 직원으로 보이는 사람 아무나 붙잡고 물어보았다.<br>뭐 영어는 잘 통하지 않았지만 대충 어느 방향으로 가라 정도까지만 알아듣고 또 가다가 이해가 안 되면 주변에 있는 사람 붙잡고 물어볼 예정이었다.<br>직원이 안내한 공간으로 아무리 가도 주차장 말고 다른 큰 건물 같은 건 보이지 않았다.<br>그러다 주차장 가장 구석에 컨테이너 박스가 하나 있는 것이 보였고 거기서 코로나 검사를 진행한다는 작은 안내표시판 같은 게 있어서 그걸 보고 겨우겨우 코로나 검사를 마칠 수 있었다.<br>가끔 코로나 검사 결과가 너무 빨리 나와 72시간이라는 기준을 준수하지 못하는 경우도 있어서 일부러 해당 시간 지나서 결과가 나오게 해달라고 얘기를 하고 그 다음날 검사 결과 이메일이 날아와서 코로나 검사는 다행히 잘 끝마칠 수 있었다.</p><h2 id="세션-말고-할만한-건-뭐가-있지"><a href="#세션-말고-할만한-건-뭐가-있지" class="headerlink" title="세션 말고 할만한 건 뭐가 있지?"></a>세션 말고 할만한 건 뭐가 있지?</h2><img src="/2021/12/31/las-vegas-aws-reinvent-02/self-paced-lab.jpeg" class=""><p>세션을 계속 듣긴 듣는데 집중은 안 되고… 이해는 안 되고… 슬슬 지쳐갔다.<br>과연 세션을 무리해서 듣는 게 의미가 있을까? 라스베가스 현지에서만 할 수 있는 건 뭘까? 하고 고민하다가 찾은 게 Self-paced lab이었다.<br>들어가면 강의실에 온 거 마냥 자리에 PC(안타깝게 윈도우)들이 깔려있고 AWS 콘솔에 로그인을 하면 상황을 선택하여 AWS의 서비스들을 사용하여 해결하는 방식으로 AWS 서비스에 익숙해질 수 있게 만들어주었다.<br>들어가니 한국인 AWS 솔루션 아키텍트 사람도 있어서 간단한 대화를 나누었다. 내가 AWS를 직접 썼더라면 더 다양한 걸 물어봤을텐데 평상시 사용을 하지 않아서 궁금증이 덜 한 상태에서 만나서 별로 얘기할 껀덕지는 없었다.<br>그리고 나는 이해도가 느려서 그냥 상황 해결만 하는 것에 그치지 않고 이것 저것 설정을 바꿔보고 어떻게 동작하는지 궁금해서 뭔가 하나를 익히는데 오랜 시간이 걸리는 편이었는데 다른 일정 때문에 하나의 시나리오도 제대로 끝내지 못해 아쉬웠다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/expo-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-02/expo-02.jpeg" class=""><p>저녁 먹기 전까지 또 시간이 살짝 붕 떠서 엑스포 구경을 갔다.<br>여기서부터 진짜 영어의 필요성을 절실히 체감하였다.<br>우선 여기 있는 기업들의 이름을 처음 들어보는 것도 많았는데 그들이 풀고자 하는 문제는 무엇이고, 그들의 솔루션들을 썼을 때 얼마나 편리해지는지 궁금했다.<br>그들은 어떤 AWS 서비스들을 사용해서 문제를 해결했는지 등등 궁금한 것은 많았는데 영어가 되지 않으니 용기가 생기지 않았다.<br>그들 입장에서도 말이 통해야 설명할 맛이 나고 홍보를 할텐데 대화도 안 통하는 사람이 와서 뻘쭘하게 서있거나 제대로 질문도 못하면 뭐라고 생각할까? 란 생각이 들어 선뜻 말을 걸지 못했다.<br>그래서 그냥 낯익은 기업이 보이면 스티커 가져가도 되냐? (Can I get some stickers?)와 같은 수준의 영어만 말하고 스티커만 몇 개 수집하고 말았다.<br>진짜 영어를 하지 못한다는 게 비통하다는 걸 처음으로 깨닫게 되는 순간이었다.<br>세션 이해 못하는 것 정도야 나중에 유튜브에서 다시 보면 되겠지… 정도로 말았는데 글로벌 테크 기업에서 주된 관심사는 무엇일까? 그들은 어떻게 해결했을까? 등등<br>어떻게 보면 여기에서 밖에 얻지 못할 것 같은 정보들을 하나도 얻지 못했다.<br>역시 기회는 준비된 자에게 오고, 준비가 되지 않은 자는 이렇게 회사에서 돈을 퍼줘서 떠먹여줘도 먹지 못한다는 사실을 절실히 깨닫게 되었다.<br>(라고 말하지만 그럼에도 불구하고 한국에 와서 열심히 영어공부하지 않는 걸 보면 사람은 쉽게 바뀌지 않는 것 같다…)</p><h2 id="또-다시-관광모드로…"><a href="#또-다시-관광모드로…" class="headerlink" title="또 다시 관광모드로…"></a>또 다시 관광모드로…</h2><img src="/2021/12/31/las-vegas-aws-reinvent-02/korean-meat.jpeg" class=""><p>저녁은 <a href="https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=ks287&logNo=221201934657">진생</a>이란 곳에서 먹었다.<br>한인식당이다보니 들어가마자 TV에서 K-pop 같은 게 틀어져있었고 종업원들도 한국인이고 한국인 손님들도 많아서 뭔가 한국에 온 듯한 이질감이 들었다.<br>김치찌개 같은 얼큰한 걸 먹지 않아서 아쉬웠지만 그래도 삼겹살 같은 한국 음식을 먹었다는 것에 위안 삼았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/new-york-new-york.jpeg" class=""><p>저녁을 먹고 주변을 좀 둘러다 보다 들어가기로 했는데 <a href="https://newyorknewyork.mgmresorts.com/en.html">뉴욕뉴욕 호텔</a>을 만나게 되었다.<br>베네시안 호텔이 이탈리아 베니스를 테마로 만들어졌다면 뉴욕뉴욕 호텔은 미국의 뉴욕을 테마로 만들어진 호텔이다.<br>한국에서 비슷하게 영어마을 같은 게 있지만 이건 진짜 제대로 흉내낸 듯한 느낌이었다. (개인적으로는 제대로 흉내냈다고 느꼈지만 동료들은 그냥 어줍짢게 흉내낸 느낌이 든다고도 하였다.)</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/coca-cola-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-02/abc.jpeg" class=""><p>관광지 답게 기념품 상점들이 많았다.<br>그것도 단순한 기념품 상점이 아닌 글로벌 기업들의 기념품 상점이라고 하니 궁금하였다. (하지만 뭐 하나도 사지는 않았다.)</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/coca-cola-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-02/coca-cola-03.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-02/coca-cola-04.jpeg" class=""><p>코카콜라 기념품 샵인데 진짜 별에 별 게 다 있었다.<br>코카콜라 찐팬들이라면 눈 돌아갈테지만 나는 그정도까지는 아니고 즐겨먹는 음료이기 때문에 그냥 눈으로만 즐겼다.<br>귀여운 북극곰 인형 정도 하나 사서 조카한테 줄까 싶었지만 인형은 너무 많다고 누나가 그래서 딱히 사지는 않았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/mnms-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-02/mnms-02.jpeg" class=""><p><a href="http://www.m-ms.co.kr/">m&amp;m’s</a>라는 초콜릿인지 과자 기업의 기념품 샵도 있었다.<br>자주 먹지는 않지만 그냥 슈퍼마켓에서 종종 보던 로고라서 궁금증에 들어갔고 가족단위로 놀러온 사람들에게는 좋은 관광코스가 될 것 같았다.<br>아이들도 좋아하는 듯 보였다.<br>하지만 여기서도 뭐 딱히 사지는 않았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-02/bellagio.jpeg" class="" title="너무 얼굴이 적나라하게 나와서 모자이크처리를 했다."><p>그리고 마지막 날의 대미를 장식을 <a href="https://bellagio.mgmresorts.com/en.html">벨라지오 호텔</a>의 분수쇼를 관람하였다.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/p3BF0TF-0MQ" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>벨라지오 호텔의 분수쇼는 꼭 한 번 보는 걸 추천한다.<br>물론 계속 하는 건 아니고 30분인가 몇분 주기로 하긴 하지만 안 보고 오면 너무 아까운 쇼인 것 같다.</p><h2 id="세미나-둘째-날까지의-소감-11-30"><a href="#세미나-둘째-날까지의-소감-11-30" class="headerlink" title="세미나 둘째 날까지의 소감 (11&#x2F;30)"></a>세미나 둘째 날까지의 소감 (11&#x2F;30)</h2><p>영어의 필요성을 절실히 체감하였다.<br>기회의 땅이라는데 나는 준비가 안 돼있어서 남이 떠먹여줘도 기회를 얻지 못했다.<br>진짜 영어를 할 줄 아는 건 쇼미더머니 치트키를 쓰는 것이나 다름이 없는 것 같았다.<br>내가 아무리 기술적 역량이 뛰어난다한들 세상의 흐름에 뒤쳐지는 건 너무나 빠르게 진행이 될 것 같았다.<br>라고 말하고 한국에 와서 영어 공부를 열심히 하지 않는 걸 보면… 음… 어떻게 해야 사람이 바뀔런지 궁금하기도 하다.</p><p>또한 둘째 날부터 그나마 호텔 근방을 조금이나마 벗어나보았다.<br>코로나 검사를 하러 우버인가 리프트를 타고 근방으로 가보긴 했는데 확실히 차 없으면 미국에서는 관광이 너무 힘들 것 같았다.<br>영어도 안 되니 대중교통을 이용하여 원하는 목적지까지 가는 건 너무나 두려웠다. (로밍을 했는데 인터넷이 잘 되지 않아 지도 앱을 보고 따라가는 것도 한계가 있어보였다.)<br>그리고 호텔 주변은 그냥 일반 도심같은 느낌이 들었는데 차를 타고 조금만 이동하니 주변이 사막이라는 걸 체감할 수 있게 끔 황량한 풍경들이 조금씩 보이는 것 같았다.<br>둘째 날부터 조금씩 호텔 근방을 벗어나보고 벨라지오 분수쇼도 보고 하다보니 ‘아… 드디어 라스베가스에 왔구나…’라는 느낌이 들었다.<br>그 전까지는 근방에서만 활동하다보니 그냥 AWS 리인벤트 세션 들으러 온 기분 밖에 나지 않았는데 뭔가 주변 관광 코스라고 할법한 공간들을 돌아다녀 보니 라스베가스에 왔다는 느낌을 조금이나마 체감할 수 있었다.</p><p>그리고 잠들기 전에 또 느낀 게 하나 있다.<br>어떻게 마지막 날까지 <code>버티지?</code><br>버틴다는 생각이 들은 이유는 기름진 음식들, 반복된 패턴(일어나서 밥먹고 세션듣고 밥먹고 세션듣고 밥먹고 잠자기), 세션을 들어도 이해가 안 되니 지루함이 컸다.<br>마지막 날까지 버텨내야한다는 생각을 하다보니 점점 더 무리하게 세션을 듣는 것을 포기하고 선택과 집중을 해야겠다는 생각이 들었다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;회사에서 좋은 기회가 생겨 &lt;a href=&quot;https://reinvent.awsevents.com/&quot;&gt;AWS re:invent&lt;/a&gt;(2021&amp;#x2F;11&amp;#x2F;29 ~ 2021&amp;#x2F;12&amp;#x2F;03)에 참석할 기회가 생겼다.&lt;br&gt;영어도 잘 못하고, 평상시 &lt;a href=&quot;https://aws.amazon.com/&quot;&gt;AWS&lt;/a&gt;를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.&lt;br&gt;살면서 미국에 처음 가보는 것이다보니 &lt;code&gt;미국에서만 할 수 있는 걸 해보자&lt;/code&gt;라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.&lt;br&gt;기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.&lt;br&gt;쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-01/&quot;&gt;1편 - 인천공항에서 세미나 첫 날까지 (11&amp;#x2F;28 ~ 11&amp;#x2F;29)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2편 - 세미나 둘째 날 (11&amp;#x2F;30) - 현재 게시물&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-03/&quot;&gt;3편 - 세미나 셋째 날 (12&amp;#x2F;01)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-04/&quot;&gt;4편 - 세미나 넷째 날 (12&amp;#x2F;02)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-05/&quot;&gt;5편 - 세미나 마지막 날부터 인천공항까지(12&amp;#x2F;03 ~ 12&amp;#x2F;05)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;어느정도-익숙해지기-시작한-세미나-둘째-날&quot;&gt;&lt;a href=&quot;#어느정도-익숙해지기-시작한-세미나-둘째-날&quot; class=&quot;headerlink&quot; title=&quot;어느정도 익숙해지기 시작한 세미나 둘째 날&quot;&gt;&lt;/a&gt;어느정도 익숙해지기 시작한 세미나 둘째 날&lt;/h2&gt;&lt;img src=&quot;/2021/12/31/las-vegas-aws-reinvent-02/morning-road.jpeg&quot; class&gt;
&lt;p&gt;베네시안 호텔에 아침부터 키노트가 있어서 이동을 하였다.&lt;br&gt;그래도 반복되는 길을 이틀 동안 왔다갔다 하다보니 도시의 풍경과 길들이 익숙해지기 시작했다.&lt;br&gt;또 신기한 것은 라스베가스 호텔 근처에서는 24시간 내내 음악 소리가 들리는 것 같았다.&lt;br&gt;밤에는 시끄러운 음악이 들렸던 것 같은데 아침에는 또 잔잔한 음악이었나… 여튼 분위기에 맞는 음악이 길거리에 울려퍼지는 게 신기했다.&lt;/p&gt;</summary>
    
    
    
    <category term="기타" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/"/>
    
    <category term="잡동사니" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/%EC%9E%A1%EB%8F%99%EC%82%AC%EB%8B%88/"/>
    
    
    <category term="reinvent" scheme="https://perfectacle.github.io/tags/reinvent/"/>
    
    <category term="여행" scheme="https://perfectacle.github.io/tags/%EC%97%AC%ED%96%89/"/>
    
  </entry>
  
  <entry>
    <title>라스베가스를 다녀오고... 1편 (feat. AWS re:Invent 2021) - 인천공항에서 세미나 첫 날까지</title>
    <link href="https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-01/"/>
    <id>https://perfectacle.github.io/2021/12/31/las-vegas-aws-reinvent-01/</id>
    <published>2021-12-31T14:29:31.000Z</published>
    <updated>2025-12-09T17:06:50.281Z</updated>
    
    <content type="html"><![CDATA[<p>회사에서 좋은 기회가 생겨 <a href="https://reinvent.awsevents.com/">AWS re:invent</a>(2021&#x2F;11&#x2F;29 ~ 2021&#x2F;12&#x2F;03)에 참석할 기회가 생겼다.<br>영어도 잘 못하고, 평상시 <a href="https://aws.amazon.com/">AWS</a>를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.<br>살면서 미국에 처음 가보는 것이다보니 <code>미국에서만 할 수 있는 걸 해보자</code>라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.<br>기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.<br>쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.</p><ul><li>1편 - 인천공항에서 세미나 첫 날까지 (11&#x2F;28 ~ 11&#x2F;29) - 현재 게시물</li><li><a href="/2021/12/31/las-vegas-aws-reinvent-02/">2편 - 세미나 둘째 날 (11&#x2F;30)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-03/">3편 - 세미나 셋째 날 (12&#x2F;01)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-04/">4편 - 세미나 넷째 날 (12&#x2F;02)</a></li><li><a href="/2021/12/31/las-vegas-aws-reinvent-05/">5편 - 세미나 마지막 날부터 인천공항까지(12&#x2F;03 ~ 12&#x2F;05)</a></li></ul><h2 id="인천공항에서-라스베가스까지…-11-28"><a href="#인천공항에서-라스베가스까지…-11-28" class="headerlink" title="인천공항에서 라스베가스까지… (11&#x2F;28)"></a>인천공항에서 라스베가스까지… (11&#x2F;28)</h2><p>한국시간 기준 일요일 저녁 출발이었고, 코시국이라 인천공항은 사람이 별로 없었다.<br>하지만 미국으로 가는 항공편만 사람이 좀 북적여서 수하물을 붙이는데 30분 가량 걸렸다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/asiana-kr-to-us.jpeg" class="" title="아시아나 항공이라 그런지 저가항공과 달리 항공정보도 승객이 직접 눌러볼 수 있어서 신기했다."><img src="/2021/12/31/las-vegas-aws-reinvent-01/airline-food-01.jpeg" class=""><p>코시국이라 기내식이 없을 줄 알았는데 식욕은 거스를 수 없는 본능이기 때문인지 나왔다.<br>생애 첫 기내식이라 기대를 품고 먹었고 그냥저냥 나쁘지 않게 먹었다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-01/airline-food-02.jpeg" class=""><p>또 몇시간이 흘러 두 번째 기내식이 나왔다.<br>10시간이 넘는 비행시간이라 그런지 두 번이나 나왔는데 두 번째부터 물렸다.<br>그냥 먹고 자고 먹고 자고 마치 사육당하는 기분이었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/sfo-01.jpeg" class=""><p>바로 라스베가스로 가는 게 아니라 샌프란시스코 공항에 경유하게 되었다.<br>인천공항까지만 하더라도 미국으로 간다는 느낌이 전혀 들지 않았다.<br>한국인에게 체크인 하고, 한국인 승무원이 탑승하고, 비행기에도 대부분이 한국인이어서 미국을 간다는 것이 체감되지 않았다.<br>하지만 샌프란시스코 공항에 도착하고 나서부터는 광고판이며 간판이며 모두 영어였다.<br>또한 비행기에서도 바로 내 옆자리에 외국인이 앉아있었고, 또 한국과의 가장 큰 차이점은 승무원들의 외모였다.<br>한국은 승무원하면 ‘젊고 이쁘다’인데 미국은 ‘인종도 다양하고 연령도 다양하다’였다.<br>연세가 좀 있는 듯한 흑인 승무원 분도 계셨는데 왠지 모르게 전문성이 가득해보였다.<br>이렇듯 한국과 미국은 승무원이라는 직종에서부터도 큰 차이가 있어보였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/las-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/las-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/las-03.jpeg" class=""><p>카지노의 도시답게 라스베가스는 공항부터 카지노가 보였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/las-taxi.jpeg" class=""><p>공항에 택시들이 줄서있는 건 어딜가나 국룰인 것 같다.</p><h2 id="본격-호텔-Wynn-도착"><a href="#본격-호텔-Wynn-도착" class="headerlink" title="본격 호텔(Wynn) 도착"></a>본격 호텔(Wynn) 도착</h2><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-03.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-04.jpeg" class=""><p>우리는 <a href="https://www.wynnlasvegas.com/">Wynn Las Vegas</a> 호텔에 머무르게 되었다.<br>근데 입구에서부터 정말 압도되었고… 내부는 이미 크리스마스 장식이 너무 이쁘게 되어있었다.<br>한국에서 이런 호텔을 가본 적이 없었다보니(있는지도 모르겠지만) 여기 정말 호텔이 맞나?란 생각이 들 정도로 너무너무 근사했다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-casino-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-casino-02.jpeg" class=""><p>크리스마스 장식의 감동도 잠시… 카지노의 도시답게 호텔에는 카지노 슬롯머신들이 삐까뻔쩍하게 즐비해있다.<br>전에 일본에 놀러간 적이 있었는데 카지노와 비슷한 빠칭코를 경험 한 적이 있었다.<br>그 때 일본인들은 빠칭코에는 관심은 없고 그냥 시간을 죽이러 오는 사람들도 많아보였다.<br>약속시간까지 기다리기 애매할 때 빠칭코 가게에 가서 그냥 머신을 돌려만 놓고 핸드폰을 보는 사람들도 많았기 때문이다.<br>카지노도 그런 느낌으로 하는 걸까… 궁금증이 많았지만 겁도 나고 피곤했기 때문에 바로 시도해보지는 않았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-room-01.jpeg" class=""><p>오션뷰도 아닌 Crypto 뷰…<br>AWS Reinvent 기간이라 그런지 힐튼 호텔 광고에 crypto.com이 보이니 뭔가 오묘했다…<br>시간이 지나면 데이터독이나 기타 테크 기업들의 광고도 나왔다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-room-02.jpeg" class=""><p>방은 아쉽게도 1인실이 아닌 2인실이었다. (이것마저 1인실을 바라면 너무 도둑놈 같아 보인다.)<br>슬리퍼는 당연히 없을 것 같아서 한국에서 하나 가져왔고, 호텔에 있는 음료&#x2F;과자 같은 거 밑에 저울이 달려있어 무게가 조금이라도 달라지면 바로 과금이 된다고 했다.</p><h2 id="걸어서-베네시안-Ventian-호텔로…-feat-Midnight-Madness"><a href="#걸어서-베네시안-Ventian-호텔로…-feat-Midnight-Madness" class="headerlink" title="걸어서 베네시안(Ventian) 호텔로… (feat. Midnight Madness)"></a>걸어서 베네시안(Ventian) 호텔로… (feat. Midnight Madness)</h2><p>호텔에서 짐정리 한 후 세미나 등록을 위해 <a href="https://www.venetianlasvegas.com/">The Venetian Resort Las Vegas</a> 호텔로 이동을 하였다.<br>나도 잘 몰랐는데 라스베가스의 호텔들은 세미나나 각종 컨벤션들을 위해 사용된다고 한다.<br>호텔 안에 그런 걸 위해 별도의 공간들이 많이 마련돼있고, AWS는 단순 한 호텔이 아닌 Wynn, Venetian, Caesars Forum 등등 다양한 곳에서 진행이 되었다.<br>호텔 간 이동거리는 걸어서 한 15분 정도 걸렸던 것 같고, 그 안에 카지노도 있기 때문에 길을 헤매는 경우도 많았다.<br>그러다보니 하루에 최소 2만보는 걸었고 아침 일찍부터 듣게되면 오후에는 시차적응 + 안하던 걷기 운동을 하게 됨에 따른 피로감이 몰려와서 졸리곤 하였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-to-midnight-madness-view-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-to-midnight-madness-view-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-to-midnight-madness-view-03.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-to-midnight-madness-view-04.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-to-midnight-madness-view-05.jpeg" class=""><p>베네시안 호텔로 걸어서 약 15분 정도를 이동하였는데 그냥 길거리들이 다 삐까뻔쩍하고 관광의 도시답게 정말 잘 꾸며놓았다.<br>속으로 그래… 이게 미국이지… 이런 생각을 하면서 걸었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-03.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-04.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-05.jpeg" class=""><p>베네시안 호텔은 이탈리아의 관광도시인 베니스(Venezia)를 테마로 만든 호텔이라고 한다.<br>그래서인지 이탈리아에나 있을 법한 분위기들을 주로 연출하고 있는데 바다에서 배를 타는 듯한 느낌의 관광상품도 있는데 나중에 가족이나 연인끼리 오면 그냥 한번 해볼법 한 것 같다.  </p><img src="/2021/12/31/las-vegas-aws-reinvent-01/reinvent-registration-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/reinvent-registration-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/reinvent-registration-03.jpeg" class=""><p>베네시안 호텔에 들어가서 aws 리인벤트를 등록하러 가는데 AWS 로고가 보이고 관련된 장소들이 등장하자 뭔가 압도되는 느낌이 들었다.<br>아무리 국내에서 날고 긴다하는 테크 기업들이 있다지만 ‘글로벌 기업은 진짜 다르구나… 어떻게 이런 스케일로 행사를 진행할 수 있지??’ 이런 생각이 들었다.<br>또 한편으로 ‘나 놀러온 게 아니라 세미나 들으러 온 거였지?’ 하고 정신이 확 들기도 했다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/reinvent-registration-04.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/reinvent-registration-05.jpeg" class=""><p>Registration 부스에 가서 등록을 마치고 Swag 부스에서 AWS Reinvent 10주년 기념 후드집업도 받았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/outback.jpeg" class=""><p>등록을 마치고 미국에서의 첫끼니는 아웃백에서 먹게 되었다.<br>아웃백의 본고장인 미국에서 먹는다는 것에 매우 설렜지만 주문을 하는 것부터가 난항이었다.<br>한국 아웃백도 별로 가본 적이 없어서 메뉴도 잘 모르고 선택할 것도 많아서 선택장애가 오곤 하였는데 미국은 영어로 된 메뉴판에서 영어로 주문한다고 하니 거기서부터가 난관이었다.<br>다행히 일행 중에 영어를 잘하시는 분이 계셔서 주문을 성공적으로 마치고 아주 맛있게 먹었다.<br>또한 미국이라 그런지 양이 참 많았다. 7명이서 메뉴를 5개 시켰는데도 남을 정도였다.</p><p>아, 여담으로 아웃백은 가게를 찾아 들어가는 것부터가 또 문제였다.<br>아웃백은 2층에 있는데 2층으로 가려면 1층을 통해 갔어야했는데 1층에 또 카지노가 있어서 어디로 가야하는지부터도 찾는데 시간이 좀 걸렸었다.<br>진짜 라스베가스는 카지노 없으면 섭할 정도로 카지노는 어딜 가나 존재하는 것 같았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/midnignt-madness-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/midnignt-madness-02.jpeg" class=""><p>저녁을 먹고 AWS 리인벤트의 전야제인 <a href="https://reinvent.awsevents.com/play/">Midnignt Madness</a>에 참석하였는데<br>일반인 참여자가 올라와서 락음악에 맞추어 허공에 드럼&amp;기타질하기, OX 퀴즈 등등 같은 것이 진행되었지만 미국 블랙코메디인지 나하고는 코드가 잘 맞지 않았다.<br>그리고 한국은 잘 모르겠지만 미국은 묘기 스포츠 같은 것들이 잘 형성돼있어서인지 자전거&amp;스케이트 보드로 엄청난 퍼포먼스를 보여주었다.</p><h2 id="본격-AWS-re-Invent-시작-11-29-1일차"><a href="#본격-AWS-re-Invent-시작-11-29-1일차" class="headerlink" title="본격 AWS re:Invent 시작 (11&#x2F;29, 1일차)"></a>본격 AWS re:Invent 시작 (11&#x2F;29, 1일차)</h2><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-night-view.jpeg" class="" title="밤에는 씨티뷰인 것처럼 보인다."><img src="/2021/12/31/las-vegas-aws-reinvent-01/wynn-morning-view.jpeg" class="" title="아침에 보니 보이지 않았던 잔디들(골프장)이 보인다."><div class="video-container"><iframe src="https://www.youtube.com/embed/wqXkjH0BKR4" frameborder="0" loading="lazy" allowfullscreen></iframe></div><p>윈 호텔의 커튼은 자동으로 걷고, 칠 수 있다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/starbucks.jpeg" class=""><p>첫날은 아침을 제공해주지 않았고, 스타벅스에 가서 샌드위치랑 커피로 간단히 떼웠다.<br>본토 스타벅스라 그런지 아침부터 대기줄이 길었고, 한번 쯤 미국 스타벅스에 가본다는 자그마한 목표도 달성을 해보았다.</p><p>그리고 시간이 좀 남아서 reflection room을 돌아보았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/reflection-room-01.jpeg" class=""><p>reflection room이라는 용어를 처음 들어봐서 구글에 검색해보았을 때는 ‘와… 거울이 가득한 고요한 방에서 명상을 하는 공간인가? 심신의 안정을 찾는 공간인가?’라는 생각이 들면서 이런 공간까지 있는 진짜 대단한 행사라는 생각이 들었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/reflection-room-02.jpeg" class=""><p>하지만 실상은 그냥 공간하나 대여해서 요가매트 깔아놓고 알아서 명상&amp;요가 하는 공간이었다.<br>나는 요가나 명상을 별로 해본 적이 없다보니 실제로는 시차 적응이 안 돼서 졸릴 때 종종 리플렉션 룸에 와서 잠을 청하곤 했다. (빈백도 있어서 잠 자기 편안했다.)<br>호텔까지 가려면 또 20분 가량 걸어서 가야하다보니 엄두도 안 났는데 그래도 휴식하기 적당한 공간이라 종종 애용하였다.<br>그리고 또 놀란 게 이슬람교인지 모르겠지만 오후에 특정 시간이 되니 하나 둘 리플렉션 룸으로 오더니 특정 방향을 보고 절을 하는 것을 보고 ‘와… 찐 종교인이구나…’하고 신기했던 경험도 있다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/lunch-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/lunch-02.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/lunch-03.jpeg" class=""><p>점심부터는 AWS 측에서 제공해줘서 가까운 호텔에 가면 먹을 수 있었다.<br>아웃백을 먹을 때까지만 해도 고기나 기름진 음식이 너무 좋았고 초딩 입맛인 나한테는 너무나 좋았다.<br>하지만 아침에 스타벅스에서 샌드위치를 먹고 나서 점심에도 또 샌드위치를 먹을 생각을 하니… 너무나 물렸다.<br>쌀은 없고, 얼큰한 음식도 없어서 이때부터 조금씩 고통이었다.<br>그래도 아직은 세미나 첫날이기 때문에 먹을만 하였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/building-modern-cloud-application-01.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/building-modern-cloud-application-02.jpeg" class=""><p>세션을 듣긴 들었는데… 영어이다보니 이해 안 되는 게 태반이었다. (AWS를 안 쓰다보니 이해가 안 되는 것도 많았고…)<br>확실히 이 때부터 영어의 필요성을 체감하기 시작한 것 같다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-06.jpeg" class=""><img src="/2021/12/31/las-vegas-aws-reinvent-01/venetian-07.jpeg" class=""><p>어제는 베네시안 호텔 외부를 주로 봤다면 베네시안 호텔에서 세션을 듣다보니 베네시안 호텔 내부도 돌아다니다 어제는 못봤던 곳들도 많이 보게 되었다.<br>그러다 베네시안 호텔 2층에서 마치 하늘이 뚫려있는 듯한 공간을 만났다.<br>하지만 정말 세트장처럼 꾸며놓아서 저기서 밥을 먹게 된다면 진짜 이탈리아 베니스에 온듯한 느낌이 들 것 같았다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/leadership-session.jpeg" class=""><p>일반적인 세션 말고 리더십 세션은 오페라나 뮤지컬 공연장 같은 큰 공간에서 하였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/pho-kim-long.jpeg" class=""><p>첫날 저녁은 라스베가스에서 유명한 쌀국수 집이라는 <a href="https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=welasvegas&logNo=220965094742">Pho Kim Long</a>에 다녀왔다.<br>막상 찍고보니 음식 사진은 없고 간판만 찍었다.<br>맛의 조예가 깊지 않다보니 뭐 엄청 대단하다… 다르다… 특별하다… 라고 느끼기보다는 그냥 뭐 먹을만 했다? 맛있다? 정도였다.<br>그래도 계속되는 샌드위치&#x2F;고기 파티에서 조금은 벗어나서 색다른 음식을 먹을 수 있어 좋았다.<br>그래도 김치랑 라면이 마렵긴 마찬가지였다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/fountain.jpeg" class=""><p>대충 첫날의 일정을 마치고 돌아오면서 어디서 못 본 것 같은 분수라서 한 컷 찍었다.</p><img src="/2021/12/31/las-vegas-aws-reinvent-01/colleague-01.jpeg" class=""><p>첫날의 일정이 생각보다 빡세서 일행은 이슈를 처리하다가 중간에 잠이 들어버렸다…</p><h2 id="세미나-첫날까지의-소감-11-28-11-29"><a href="#세미나-첫날까지의-소감-11-28-11-29" class="headerlink" title="세미나 첫날까지의 소감 (11&#x2F;28 ~ 11&#x2F;29)"></a>세미나 첫날까지의 소감 (11&#x2F;28 ~ 11&#x2F;29)</h2><p>인천공항에서(11&#x2F;28)부터 세미나 첫날(11&#x2F;29)까지의 소감은 ‘이제 첫날이라고?’였다.<br>15~6시간 정도 되는 긴 비행(중간 경유시간 포함)부터 낯선 문화, 기름진 음식들, 그리고 세션을 들으러 호텔을 이리저리 이동하는 것까지…<br>아직 첫날 밖에 끝나지 않았다는 것이 믿기지 않았다.<br>인천에서 미국으로 갈 수록 시간이 느려지는데 그러다보니 한국시간(KST) 11&#x2F;28 저녁 8시 쯤에 출발해서 라스베가스 현지시간(PST) 11&#x2F;28 저녁 6시 쯤에 도착하였는데 이것도 한 몫 한 것 같긴 하다.<br>여행 가면 시간이 빨리간다는데 난 왜 이리 시간이 안 가는 거지?<br>라는 생각이 들다가 아 맞다… 나 여행온 거 아니지… 라고 다시 정신을 차리곤 하였다.<br>가장 큰 문제는 세미나에 집중하려해도 AWS 배경지식 부족 + 언어에서 오는 문제점으로 인해 세션에 집중할 수 없었다.<br>그래도 회사에서 지원까지 받았고 나 대신 열심히 일하는 동료들도 있는데… 라는 생각으로 내일부터는 좀 더 세션을 이해해야겠다고 다짐하였다.<br>그리고 너무 과하게 스케쥴을 잡다보니 피곤하고 시간에 쫓기듯 이동하다보니 점심도 제대로 못 먹고 세션을 들으러 가기도 하였다.<br>그래서 좀 템포를 조절하여 세션을 들어야겠다고 생각하였다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;회사에서 좋은 기회가 생겨 &lt;a href=&quot;https://reinvent.awsevents.com/&quot;&gt;AWS re:invent&lt;/a&gt;(2021&amp;#x2F;11&amp;#x2F;29 ~ 2021&amp;#x2F;12&amp;#x2F;03)에 참석할 기회가 생겼다.&lt;br&gt;영어도 잘 못하고, 평상시 &lt;a href=&quot;https://aws.amazon.com/&quot;&gt;AWS&lt;/a&gt;를 직접 쓰지 않은지 오래 되기도 했지만 견문을 넓히자는 차원에서 지원하여 갔다오게 되었다.&lt;br&gt;살면서 미국에 처음 가보는 것이다보니 &lt;code&gt;미국에서만 할 수 있는 걸 해보자&lt;/code&gt;라는 목표를 세우고 갔으나 많은 실패들이 있었고, 영어가 잘 안되다보니 aws reinvent 컨벤션 후기 보다는 라스베가스 여행기가 되어버린 것 같았다.&lt;br&gt;기술적인 부분에서 인사이트를 크게 얻지 못해 창피하여 aws reinvent 후기는 적지 못하고, 미국이라는 기회의 땅에 가본 경험을 휘발성 데이터로 냅두기 아까워 기억들이 더이상 날아가기 전에 이렇게라도 기록을 해둬야할 거 같아서 이 글을 쓰게 되었다.&lt;br&gt;쓰다보니 사진이 많아서인지 글이 좀 루즈해지는 감이 없잖아 있어 파트를 좀 쪼개보았다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1편 - 인천공항에서 세미나 첫 날까지 (11&amp;#x2F;28 ~ 11&amp;#x2F;29) - 현재 게시물&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-02/&quot;&gt;2편 - 세미나 둘째 날 (11&amp;#x2F;30)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-03/&quot;&gt;3편 - 세미나 셋째 날 (12&amp;#x2F;01)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-04/&quot;&gt;4편 - 세미나 넷째 날 (12&amp;#x2F;02)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/12/31/las-vegas-aws-reinvent-05/&quot;&gt;5편 - 세미나 마지막 날부터 인천공항까지(12&amp;#x2F;03 ~ 12&amp;#x2F;05)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;인천공항에서-라스베가스까지…-11-28&quot;&gt;&lt;a href=&quot;#인천공항에서-라스베가스까지…-11-28&quot; class=&quot;headerlink&quot; title=&quot;인천공항에서 라스베가스까지… (11&amp;#x2F;28)&quot;&gt;&lt;/a&gt;인천공항에서 라스베가스까지… (11&amp;#x2F;28)&lt;/h2&gt;&lt;p&gt;한국시간 기준 일요일 저녁 출발이었고, 코시국이라 인천공항은 사람이 별로 없었다.&lt;br&gt;하지만 미국으로 가는 항공편만 사람이 좀 북적여서 수하물을 붙이는데 30분 가량 걸렸다.&lt;/p&gt;
&lt;img src=&quot;/2021/12/31/las-vegas-aws-reinvent-01/asiana-kr-to-us.jpeg&quot; class title=&quot;아시아나 항공이라 그런지 저가항공과 달리 항공정보도 승객이 직접 눌러볼 수 있어서 신기했다.&quot;&gt;</summary>
    
    
    
    <category term="기타" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/"/>
    
    <category term="잡동사니" scheme="https://perfectacle.github.io/categories/%EA%B8%B0%ED%83%80/%EC%9E%A1%EB%8F%99%EC%82%AC%EB%8B%88/"/>
    
    
    <category term="reinvent" scheme="https://perfectacle.github.io/tags/reinvent/"/>
    
    <category term="여행" scheme="https://perfectacle.github.io/tags/%EC%97%AC%ED%96%89/"/>
    
  </entry>
  
  <entry>
    <title>(Spring Boot) spring-boot-configuration-processor 활용하기</title>
    <link href="https://perfectacle.github.io/2021/11/21/spring-boot-configuration-processor/"/>
    <id>https://perfectacle.github.io/2021/11/21/spring-boot-configuration-processor/</id>
    <published>2021-11-21T14:43:06.000Z</published>
    <updated>2025-12-09T17:06:50.354Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Configuration-Metadata"><a href="#Configuration-Metadata" class="headerlink" title="Configuration Metadata"></a>Configuration Metadata</h2><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html">https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html</a></p><blockquote><p>Spring Boot jars include metadata files that provide details of all supported configuration properties.<br>The files are designed to let IDE developers offer contextual help and “code completion” as users are working with <code>application.properties</code> or <code>application.yml</code> files.</p></blockquote><p>Configuration Metadata는 IDE에서 yml 혹은 properties에서 사용하는 Configuration의 자동완성을 도와주는 메타데이터이다. (소스코드에는 영향을 1도 안 미친다.)</p><img src="/2021/11/21/spring-boot-configuration-processor/configuration-metadata-auto-completion.png" class="" title="application.yml을 작성하다보면 spring 관련 configuration들은 자동완성이 잘 된다."><img src="/2021/11/21/spring-boot-configuration-processor/configuration-metadata-navigate.png" class="" title="해당 configuration에서 Command + B를 누르면 실제 Properties 클래스로 이동까지 된다."><h2 id="커스텀-Configuration-Metadata-정의"><a href="#커스텀-Configuration-Metadata-정의" class="headerlink" title="커스텀 Configuration Metadata 정의"></a>커스텀 Configuration Metadata 정의</h2><img src="/2021/11/21/spring-boot-configuration-processor/custom-property.png" class="" title="커스텀한 프로퍼티는 인식을 하지 못하는 것 같다."><img src="/2021/11/21/spring-boot-configuration-processor/turn-off-spring-boot-configuration-processor.png" class="" title="Configuration Property 클래스에서도 Spring Boot Configuration Annotation Processor가 설정돼지 않았다고 한다."><img src="/2021/11/21/spring-boot-configuration-processor/custom-spring-boot-configuration-metadata-json.png" class="" title="자동완성을 위해서는 resources&#x2F;META-INF&#x2F;spring-configuration-metadata.json을 작성하면 된다."><img src="/2021/11/21/spring-boot-configuration-processor/custom-property-auto-completion.png" class="" title="이제 자동완성 및 어떤 클래스에서 사용하고 있는지 추적까지 잘 된다."><img src="/2021/11/21/spring-boot-configuration-processor/turn-off-spring-boot-configuration-processor.png" class="" title="네비게이션은 잘 되지만 아직까지도 Spring Boot Configuration Annotation Processor가 설정돼지 않았다고 보여준다."><h2 id="자동으로-Configuration-Metadata-생성하기-spring-boot-configuration-processor"><a href="#자동으로-Configuration-Metadata-생성하기-spring-boot-configuration-processor" class="headerlink" title="자동으로 Configuration Metadata 생성하기 (spring-boot-configuration-processor)"></a>자동으로 Configuration Metadata 생성하기 (spring-boot-configuration-processor)</h2><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html#configuration-metadata.annotation-processor">https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html#configuration-metadata.annotation-processor</a></p><blockquote><p>You can easily generate your own configuration metadata file from items annotated with <code>@ConfigurationProperties</code> by using the <code>spring-boot-configuration-processor</code> jar.<br>The jar includes a Java annotation processor which is invoked as your project is compiled.</p></blockquote><p>@ConfigurationProperties 어노테이션이 붙은 클래스에 대한 Configuration Metadata File은 spring-boot-configuration-processor를 통해 생성할 수 있다고 한다.</p><p>build.gradle.kts에 <a href="https://kotlinlang.org/docs/kapt.html">kapt</a> 플러그인을 활성화시켜준다. (코틀린 컴파일러로 컴파일하기 때문에 자바로 작성한 어노테이션을 해석하지 못하기 때문)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kotlin(<span class="string">&quot;kapt&quot;</span>) version <span class="string">&quot;1.6.0&quot;</span></span><br></pre></td></tr></table></figure><p>build.gradle.kts에 아래 디펜던시들을 추가해준다. (멀티 모듈인 경우 모든 모듈에 일일이 추가하는 게 귀찮으니 루트의 build.gradle.kts에 추가해주는 것이 좋다.)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotationProcessor(<span class="string">&quot;org.springframework.boot:spring-boot-configuration-processor&quot;</span>)</span><br><span class="line">kapt(<span class="string">&quot;org.springframework.boot:spring-boot-configuration-processor&quot;</span>)</span><br></pre></td></tr></table></figure><img src="/2021/11/21/spring-boot-configuration-processor/re-run-spring-boot-configuration-processor.png" class="" title="생성된 metadata를 업데이트하려면 Spring Boot Configuration Annotation Processor를 다시 돌리라고 나온다. (하지만 몇 번이고 어노테이션 프로세서를 돌려도 해당 알림을 사라지지 않기 때문에 그냥 숨기는 걸 추천한다.)"><img src="/2021/11/21/spring-boot-configuration-processor/run-gradle-kapt-task.png" class="" title="Annotation Processor를 돌리려면 kaptKotlin 태스크를 실행시키면 된다. (자바 프로젝트에서는 compileJava 태스크를 실행시키면 된다.)"><img src="/2021/11/21/spring-boot-configuration-processor/generated-configuration-metadata-json-location.png" class="" title="annotation processor에 의해 메타데이터가 생성되었다."><img src="/2021/11/21/spring-boot-configuration-processor/generated-configuration-metadata-json.png" class="" title="description 같은 건 없지만 나름 쓸만하게 뽑혔다."><img src="/2021/11/21/spring-boot-configuration-processor/custom-property-navigate.png" class="" title="자동완성이나 네비게이션도 잘 된다."><p>다만 몇 가지 한계점이 있는데 아래와 같다.</p><ol><li>@ConfigurationProperties에 대해서만 동작하기 때문에 @Value와 같이 단순하게 사용한 경우에는 해당 configuration에 대해서 metadata가 생성되지 않는다.</li><li>properties나 yml에 정의만 해놓고 @ConfigurationProperties 클래스를 생성하지 않은 경우에는 해당 configuration에 대해서 metadata가 생성되지 않는다.</li><li>properties나 yml의 위치하는 모듈과 @ConfigurationProperties 클래스가 위치하는 모듈이 다른 경우에는 해당 configuration에 대해서 metadata가 생성되지 않는다. 소스코드가 돌아가는데는 전혀 문제가 없지만 올바른 설계인지 고민을 한 번 해보는 것이 좋다.</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Configuration-Metadata&quot;&gt;&lt;a href=&quot;#Configuration-Metadata&quot; class=&quot;headerlink&quot; title=&quot;Configuration Metadata&quot;&gt;&lt;/a&gt;Configuration Metadata&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html&quot;&gt;https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Spring Boot jars include metadata files that provide details of all supported configuration properties.&lt;br&gt;The files are designed to let IDE developers offer contextual help and “code completion” as users are working with &lt;code&gt;application.properties&lt;/code&gt; or &lt;code&gt;application.yml&lt;/code&gt; files.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Configuration Metadata는 IDE에서 yml 혹은 properties에서 사용하는 Configuration의 자동완성을 도와주는 메타데이터이다. (소스코드에는 영향을 1도 안 미친다.)&lt;/p&gt;
&lt;img src=&quot;/2021/11/21/spring-boot-configuration-processor/configuration-metadata-auto-completion.png&quot; class title=&quot;application.yml을 작성하다보면 spring 관련 configuration들은 자동완성이 잘 된다.&quot;&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="https://perfectacle.github.io/categories/Spring-Boot/"/>
    
    
    <category term="Spring Boot" scheme="https://perfectacle.github.io/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>(Spring) 외부 API의 Response 객체를 만들 때 null을 주의하자</title>
    <link href="https://perfectacle.github.io/2021/09/20/spring-web-response-deserialization-for-null/"/>
    <id>https://perfectacle.github.io/2021/09/20/spring-web-response-deserialization-for-null/</id>
    <published>2021-09-20T02:57:30.000Z</published>
    <updated>2025-12-09T17:06:50.357Z</updated>
    
    <content type="html"><![CDATA[<p>소스코드 외부 세계에서 내부 세계로 데이터를 전달하기 위해서는 미리 정해진 프로토콜 및 API를 통해 데이터를 주고받게 된다.<br>일반적으로 우리가 많이 사용하는 Restful API(혹은 HTTP API)는 대부분 json의 형태로 데이터를 주고 받게 된다.<br>그럼 json 문자열이 우리가 정의한 Response 객체로 매핑을 할 때 null을 어떻게 핸들링 해야할까에 집중해서 간단히 정리해보았다.<br>해당 포스트와 연관성이 높은 <a href="/2021/09/20/spring-web-request-deserialization-for-null">(Spring) 외부에서 호출하는 Request 객체를 만들 때 null을 주의하자</a>도 읽는 것을 추천한다.</p><h2 id="코틀린"><a href="#코틀린" class="headerlink" title="코틀린"></a>코틀린</h2><p>코틀린은 nullable을 지원하다보니 소스코드에서 null에 대한 체크를 매번하지 않아도 돼서 매우 편하다.<br>하지만 이건 우리 소스코드 내부의 사정이고 소스코드 외부에서 들어오는 데이터의 경우에는 단정지을 수 없다.<br>그 단적인 예가 네트워크를 통해 들어오는 HTTP API의 응답이다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResponseV1</span>(</span><br><span class="line">    <span class="keyword">val</span> number: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> text: String</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>이런 응답 객체가 있다고 할 때 과연 number와 text는 non-null을 100% 보장할 수 있을까??</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">ResponseTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> restTemplateBuilder: RestTemplateBuilder</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> restTemplate: RestTemplate</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> <span class="keyword">init</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> mockHttpServer = WireMockServer(wireMockConfig().dynamicPort())</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BeforeAll</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">beforeAll</span><span class="params">()</span></span> &#123;</span><br><span class="line">            mockHttpServer.start()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@AfterAll</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterAll</span><span class="params">()</span></span> &#123;</span><br><span class="line">            mockHttpServer.stop()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">setUp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">init</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">init</span> = <span class="literal">true</span></span><br><span class="line">        restTemplate = restTemplateBuilder.rootUri(<span class="string">&quot;http://localhost:<span class="subst">$&#123;mockHttpServer.port()&#125;</span>&quot;</span>).build()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> `응답 객체 전송 시에 non-<span class="literal">null</span> 필드가 누락돼있으면 RestClientException을 던진다`<span class="params">()</span></span> &#123;</span><br><span class="line">        mockHttpServer.givenThat(WireMock.any(UrlPattern.ANY).willReturn(WireMock.okJson(<span class="string">&quot;&quot;&quot;&#123;&quot;number&quot;: 13&#125;&quot;&quot;&quot;</span>)))</span><br><span class="line">        <span class="keyword">val</span> expected = HttpMessageNotReadableException::<span class="keyword">class</span>.java</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">actual</span> = assertThrows&lt;RestClientException&gt; &#123; restTemplate.getForObject(<span class="string">&quot;/&quot;</span>, ResponseV1::<span class="keyword">class</span>.java) &#125;.cause</span><br><span class="line"></span><br><span class="line">        assertThat(<span class="keyword">actual</span>).isInstanceOf(expected)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>외부 API의 응답을 모킹하기 위해 <a href="http://wiremock.org/">wiremock</a>을 사용하였다.<br>만약 외부 API의 응답 중 text 필드가 오지 않았더라면 RestClientException(cause exception은 HttpMessageNotReadableException)을 던지게 된다.  </p><p>그러면 아래와 같이 코드를 개선해볼 수 있다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResponseV2</span>(</span><br><span class="line">    number: <span class="built_in">Int</span>?,</span><br><span class="line">    text: String?</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">val</span> number = number ?: <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> text = text ?: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>우선 생성자를 전부 nullable로 정의해서 객체의 성공을 보장하고, 멤버변수는 전부 기본값을 정의해서 non-null을 보장하였다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `응답 객체 전송 시에 non-<span class="literal">null</span> 필드가 누락돼있으면 기본값이 할당된다`<span class="params">()</span></span> &#123;</span><br><span class="line">    mockHttpServer.givenThat(WireMock.any(UrlPattern.ANY).willReturn(WireMock.okJson(<span class="string">&quot;&quot;&quot;&#123;&quot;number&quot;: 13&#125;&quot;&quot;&quot;</span>)))</span><br><span class="line">    <span class="keyword">val</span> expected = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">actual</span> = restTemplate.getForObject(<span class="string">&quot;/&quot;</span>, ResponseV2::<span class="keyword">class</span>.java)?.text</span><br><span class="line"></span><br><span class="line">    assertThat(<span class="keyword">actual</span>).isEqualTo(expected)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>혹시나 Data Class를 꼭 사용해야한다면 아래와 같이도 할 수 있다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">ResponseV3</span>(</span><br><span class="line">    <span class="keyword">val</span> number: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> text: String</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">constructor</span>(number: <span class="built_in">Int</span>?, text: String?) : <span class="keyword">this</span>(</span><br><span class="line">        number = number ?: <span class="number">0</span>,</span><br><span class="line">        text = text ?: <span class="string">&quot;&quot;</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jackson은 기본 생성자를 리플렉션하여 객체를 생성하는데 기본 생성자가 없으니 객체 생성을 위해 사용할 생성자에 @JsonCreator 어노테이션을 달아주었다.</p><h2 id="자바"><a href="#자바" class="headerlink" title="자바"></a>자바</h2><p>자바에서도 똑같이 null에 대한 검증을 모두 끝마친 깔끔한 response dto 객체를 원할 것이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> number;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String text;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Request</span><span class="params">(<span class="keyword">final</span> Integer number, <span class="keyword">final</span> String text)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.number = number == <span class="literal">null</span> ? <span class="number">0</span> : number;</span><br><span class="line">        <span class="built_in">this</span>.text = text == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> :text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기본적으로 응답 객체를 수정하는 행위는 소스코드의 예측력을 떨어뜨리므로 불변객체로 만들고,<br>불변객체이므로 getter를 사용하나 필드에 직접 접근하나 재할당하지 못한다는 사실은 똑같기 때문에 불필요하게 getter 메서드를 사용하지 않고, 접근이 필요한 필드의 경우에만 public 접근 지정자를 사용하여 직접 필드를 참조하도록 하였다.<br>jackson은 기본 생성자를 리플렉션하여 객체를 생성하는데 기본 생성자가 없으니 객체 생성을 위해 사용할 생성자에 @JsonCreator 어노테이션을 달아주었다.<br>또한 클라이언트로부터 어떤 요청이 들어올지 모르니 일단 생성자에서는 전부 null을 허용하고 기본값을 할당하였다.  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;소스코드 외부 세계에서 내부 세계로 데이터를 전달하기 위해서는 미리 정해진 프로토콜 및 API를 통해 데이터를 주고받게 된다.&lt;br&gt;일반적으로 우리가 많이 사용하는 Restful API(혹은 HTTP API)는 대부분 json의 형태로 데이터를 주고 받게 된다.&lt;br&gt;그럼 json 문자열이 우리가 정의한 Response 객체로 매핑을 할 때 null을 어떻게 핸들링 해야할까에 집중해서 간단히 정리해보았다.&lt;br&gt;해당 포스트와 연관성이 높은 &lt;a href=&quot;/2021/09/20/spring-web-request-deserialization-for-null&quot;&gt;(Spring) 외부에서 호출하는 Request 객체를 만들 때 null을 주의하자&lt;/a&gt;도 읽는 것을 추천한다.&lt;/p&gt;
&lt;h2 id=&quot;코틀린&quot;&gt;&lt;a href=&quot;#코틀린&quot; class=&quot;headerlink&quot; title=&quot;코틀린&quot;&gt;&lt;/a&gt;코틀린&lt;/h2&gt;&lt;p&gt;코틀린은 nullable을 지원하다보니 소스코드에서 null에 대한 체크를 매번하지 않아도 돼서 매우 편하다.&lt;br&gt;하지만 이건 우리 소스코드 내부의 사정이고 소스코드 외부에서 들어오는 데이터의 경우에는 단정지을 수 없다.&lt;br&gt;그 단적인 예가 네트워크를 통해 들어오는 HTTP API의 응답이다.&lt;/p&gt;
&lt;figure class=&quot;highlight kotlin&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;ResponseV1&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; number: &lt;span class=&quot;built_in&quot;&gt;Int&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; text: String&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;이런 응답 객체가 있다고 할 때 과연 number와 text는 non-null을 100% 보장할 수 있을까??&lt;/p&gt;</summary>
    
    
    
    <category term="Spring" scheme="https://perfectacle.github.io/categories/Spring/"/>
    
    
    <category term="Spring" scheme="https://perfectacle.github.io/tags/Spring/"/>
    
    <category term="Jackson" scheme="https://perfectacle.github.io/tags/Jackson/"/>
    
    <category term="Web" scheme="https://perfectacle.github.io/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>(Spring) 외부에서 호출하는 Request 객체를 만들 때 null을 주의하자</title>
    <link href="https://perfectacle.github.io/2021/09/20/spring-web-request-deserialization-for-null/"/>
    <id>https://perfectacle.github.io/2021/09/20/spring-web-request-deserialization-for-null/</id>
    <published>2021-09-20T02:04:28.000Z</published>
    <updated>2025-12-09T17:06:50.357Z</updated>
    
    <content type="html"><![CDATA[<p>소스코드 외부 세계에서 내부 세계로 데이터를 전달하기 위해서는 미리 정해진 프로토콜 및 API를 통해 데이터를 주고받게 된다.<br>일반적으로 우리가 많이 사용하는 Restful API(혹은 HTTP API)는 대부분 json의 형태로 데이터를 주고 받게 된다.<br>그럼 json 문자열이 우리가 정의한 Request 객체로 매핑을 할 때 null을 어떻게 핸들링 해야할까에 집중해서 간단히 정리해보았다.<br>해당 포스트와 연관성이 높은 <a href="/2021/09/20/spring-web-response-deserialization-for-null">(Spring) 외부 API의 Response 객체를 만들 때 null을 주의하자</a>도 읽는 것을 추천한다.</p><h2 id="코틀린"><a href="#코틀린" class="headerlink" title="코틀린"></a>코틀린</h2><p>코틀린은 nullable을 지원하다보니 소스코드에서 null에 대한 체크를 매번하지 않아도 돼서 매우 편하다.<br>하지만 이건 우리 소스코드 내부의 사정이고 소스코드 외부에서 들어오는 데이터의 경우에는 단정지을 수 없다.<br>그 단적인 예가 네트워크를 통해 들어오는 HTTP API의 요청이다.  </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RequestV1</span>(</span><br><span class="line">    <span class="keyword">val</span> number: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> text: String</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">api</span><span class="params">(<span class="meta">@RequestBody</span> request: <span class="type">RequestV1</span>)</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이런 요청 객체와 API가 있다고 할 때 과연 number와 text는 non-null을 100% 보장할 수 있을까??  </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebMvcTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">ControllerTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mockMvc: MockMvc</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> `요청 객체 전송 시에 non-<span class="literal">null</span> 필드를 누락하면 HttpMessageNotReadableException 예외를 던진다`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> expected = HttpMessageNotReadableException::<span class="keyword">class</span>.java</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">actual</span> = mockMvc.post(<span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">            contentType = MediaType.APPLICATION_JSON</span><br><span class="line">            content = <span class="string">&quot;&quot;&quot;&#123;&quot;number&quot;: 13&#125;&quot;&quot;&quot;</span></span><br><span class="line">        &#125;.andExpect &#123;</span><br><span class="line">            status &#123; isBadRequest() &#125;</span><br><span class="line">        &#125;.andReturn().resolvedException</span><br><span class="line"></span><br><span class="line">        assertThat(<span class="keyword">actual</span>).isInstanceOf(expected)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>클라이언트에서 http 요청을 보낼 때 충분히 필수 필드를 누락할 수 있고, 이 때 서버에서 HttpMessageNotReadableException 예외를 던지게 된다.<br><code>org.springframework.http.converter.HttpMessageNotReadableException: JSON parse error: Cannot construct instance of ... problem: Parameter specified as non-null is null: method example.web.mvc.RequestV1.&lt;init&gt;, parameter text</code><br>기본적으로 이 경우에는 DefaultHandlerExceptionResolver에서 예외를 핸들링하여 warn 로그를 찍게 된다.<br>이런 경우에는 HttpMessageNotReadableException 보다는 MethodArgumentNotValidException 예외를 던지는 것이 더 적합해보인다.  </p><p>그러면 아래와 같이 코드를 개선해볼 수 있다.  </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RequestV2</span>(</span><br><span class="line">    number: <span class="built_in">Int</span>?,</span><br><span class="line">    text: String?</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">val</span> number = number ?: <span class="number">0</span></span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">val</span> text = text ?: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">api</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> request: <span class="type">RequestV2</span>)</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>우선 생성자를 전부 nullable로 정의해서 객체의 성공을 보장하고, 멤버변수는 전부 기본값을 정의해서 non-null을 보장하였다.<br>생성자의 인자를 기준으로 요청을 검증하는 게 아니라 이미 생성된 객체를 기준으로 검증을 하기 때문에 멤버변수에 할당된 기본값 기준으로 어노테이션을 설정해야한다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `요청 객체 전송 시에 유효하지 않은 필드가 존재하면 MethodArgumentNotValidException 예외를 던진다`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> expected = MethodArgumentNotValidException::<span class="keyword">class</span>.java</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">actual</span> = mockMvc.post(<span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">        contentType = MediaType.APPLICATION_JSON</span><br><span class="line">        content = <span class="string">&quot;&quot;&quot;&#123;&quot;number&quot;: 13&#125;&quot;&quot;&quot;</span></span><br><span class="line">    &#125;.andDo &#123; print() &#125;.andExpect &#123;</span><br><span class="line">        status &#123; isBadRequest() &#125;</span><br><span class="line">        <span class="comment">// 응답으로 어떤 필드가 유효하지 않은지 추가하려면 @ExceptionHandler를 사용하여 MethodArgumentNotValidException를 핸들링 해야한다.</span></span><br><span class="line">        content &#123; string(<span class="string">&quot;&quot;</span>) &#125;</span><br><span class="line">    &#125;.andReturn().resolvedException</span><br><span class="line"></span><br><span class="line">    assertThat(<span class="keyword">actual</span>).isInstanceOf(expected)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>혹시나 Data Class를 꼭 사용해야한다면 아래와 같이도 할 수 있다.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">RequestV3</span>(</span><br><span class="line">    <span class="meta">@field:Min</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> number: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="meta">@field:NotBlank</span></span><br><span class="line">    <span class="keyword">val</span> text: String</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">constructor</span>(number: <span class="built_in">Int</span>?, text: String?) : <span class="keyword">this</span>(</span><br><span class="line">        number = number ?: <span class="number">0</span>,</span><br><span class="line">        text = text ?: <span class="string">&quot;&quot;</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>생성자 함수가 아닌 멤버변수에 어노테이션을 설정하기 위해 @field라고 어노테이션 타겟을 명시했다.<br>(참고: <a href="https://kotlinlang.org/docs/annotations.html#annotation-use-site-targets">Annotation use-site targets</a>)<br>또한 jackson은 기본 생성자를 리플렉션하여 객체를 생성하는데 기본 생성자가 없으니 객체 생성을 위해 사용할 생성자에 @JsonCreator 어노테이션을 달아주었다.</p><h2 id="자바"><a href="#자바" class="headerlink" title="자바"></a>자바</h2><p>자바에서도 똑같이 null에 대한 검증을 모두 끝마친 깔끔한 request dto 객체를 원할 것이다.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Request</span> &#123;</span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> number;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String text;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Request</span><span class="params">(<span class="keyword">final</span> Integer number, <span class="keyword">final</span> String text)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.number = number == <span class="literal">null</span> ? <span class="number">0</span> : number;</span><br><span class="line">        <span class="built_in">this</span>.text = text == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> :text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기본적으로 요청 객체를 수정하는 행위는 소스코드의 예측력을 떨어뜨리므로 불변객체로 만들고,<br>불변객체이므로 getter를 사용하나 필드에 직접 접근하나 재할당하지 못한다는 사실은 똑같기 때문에 불필요하게 getter 메서드를 사용하지 않고, 접근이 필요한 필드의 경우에만 public 접근 지정자를 사용하여 직접 필드를 참조하도록 하였다.<br>jackson은 기본 생성자를 리플렉션하여 객체를 생성하는데 기본 생성자가 없으니 객체 생성을 위해 사용할 생성자에 @JsonCreator 어노테이션을 달아주었다.<br>또한 클라이언트로부터 어떤 요청이 들어올지 모르니 일단 생성자에서는 전부 null을 허용하고 기본값을 할당하였다.<br>생성된 요청 객체의 멤버변수에는 적절한 벨리데이션을 위한 어노테이션을 추가하면 된다.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;소스코드 외부 세계에서 내부 세계로 데이터를 전달하기 위해서는 미리 정해진 프로토콜 및 API를 통해 데이터를 주고받게 된다.&lt;br&gt;일반적으로 우리가 많이 사용하는 Restful API(혹은 HTTP API)는 대부분 json의 형태로 데이터를 주고 받게 된다.&lt;br&gt;그럼 json 문자열이 우리가 정의한 Request 객체로 매핑을 할 때 null을 어떻게 핸들링 해야할까에 집중해서 간단히 정리해보았다.&lt;br&gt;해당 포스트와 연관성이 높은 &lt;a href=&quot;/2021/09/20/spring-web-response-deserialization-for-null&quot;&gt;(Spring) 외부 API의 Response 객체를 만들 때 null을 주의하자&lt;/a&gt;도 읽는 것을 추천한다.&lt;/p&gt;
&lt;h2 id=&quot;코틀린&quot;&gt;&lt;a href=&quot;#코틀린&quot; class=&quot;headerlink&quot; title=&quot;코틀린&quot;&gt;&lt;/a&gt;코틀린&lt;/h2&gt;&lt;p&gt;코틀린은 nullable을 지원하다보니 소스코드에서 null에 대한 체크를 매번하지 않아도 돼서 매우 편하다.&lt;br&gt;하지만 이건 우리 소스코드 내부의 사정이고 소스코드 외부에서 들어오는 데이터의 경우에는 단정지을 수 없다.&lt;br&gt;그 단적인 예가 네트워크를 통해 들어오는 HTTP API의 요청이다.  &lt;/p&gt;
&lt;figure class=&quot;highlight kotlin&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;RequestV1&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; number: &lt;span class=&quot;built_in&quot;&gt;Int&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; text: String&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@RestController&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Controller&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@PostMapping&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;meta&quot;&gt;@RequestBody&lt;/span&gt; request: &lt;span class=&quot;type&quot;&gt;RequestV1&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;이런 요청 객체와 API가 있다고 할 때 과연 number와 text는 non-null을 100% 보장할 수 있을까??  &lt;/p&gt;</summary>
    
    
    
    <category term="Spring" scheme="https://perfectacle.github.io/categories/Spring/"/>
    
    
    <category term="Spring" scheme="https://perfectacle.github.io/tags/Spring/"/>
    
    <category term="Jackson" scheme="https://perfectacle.github.io/tags/Jackson/"/>
    
    <category term="Web" scheme="https://perfectacle.github.io/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>(Java) Fail Fast Iterator</title>
    <link href="https://perfectacle.github.io/2021/08/14/fail-fast-iterator/"/>
    <id>https://perfectacle.github.io/2021/08/14/fail-fast-iterator/</id>
    <published>2021-08-14T19:20:03.000Z</published>
    <updated>2025-12-09T17:06:50.189Z</updated>
    
    <content type="html"><![CDATA[<h2 id="문제상황"><a href="#문제상황" class="headerlink" title="문제상황"></a>문제상황</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, String&gt; mappings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">(<span class="keyword">final</span> CardCompanyCode cardCompanyCode)</span> &#123;</span><br><span class="line">    mappings.entrySet().forEach(e -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.getValue() != cardCompanyCode) <span class="keyword">return</span>;</span><br><span class="line">        mappings.remove(e.getKey());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>맵에서 entrySet(key&#x2F;value 쌍)을 가져와 forEach 돌면서 특정 조건에 맞으면 맵에서 요소를 삭제했더니 한 번만 요소가 삭제되고나서 ConcurrentModificationException을 던졌다.</p><p>여기서 아래와 같은 의문점이 생겼다.</p><ol><li>맵의 요소를 삭제하는 건데 왜 예외를 던질까?</li><li>왜 한 번만 요소 삭제에 성공하는 걸까?</li><li>하나의 쓰레드에서 작업했는데 왜 <code>Concurrent</code>ModificationException을 던진 걸까?</li></ol><h2 id="Fail-Fast"><a href="#Fail-Fast" class="headerlink" title="Fail Fast"></a>Fail Fast</h2><blockquote><p>In systems design, a fail-fast system is one which immediately reports at its interface any condition that is likely to indicate a failure. Fail-fast systems are usually designed to stop normal operation rather than attempt to continue a possibly flawed process. Such designs often check the system’s state at several points in an operation, so any failures can be detected early. The responsibility of a fail-fast module is detecting errors, then letting the next-highest level of the system handle them.</p></blockquote><p><a href="https://en.wikipedia.org/wiki/Fail-fast">위키피디아 Fail-fast</a>에서 따온 건데, 실패 조건에 부합한다면 바로 후속 작업 같은 걸 멈추는 걸 fail-fast라고 부르는 것 같다.<br>비슷하게 gradle에서 테스트 같은 태스크를 돌릴 때 fail-fast 옵션을 킬 수 있는데, 하나의 테스트라도 실패하면 그 뒤에 테스트들은 실행조차 하지 않고 테스트가 실패했다고 처리하는 방식이다.<br>비슷한 맥락으로 runtime에서 터질 에러를 compile-time으로 땡겨와서 에러를 잡는 것도 Fail-fast 전략이라고도 부르는 것 같다. (자바에서는 not null 타입이 없어서 NullPointerException으로 runtime에 에러가 던져졌는데 코틀린에서는 not null 타입이 생기면서 null을 넘기면 compile-time에 에러가 생겨 좀 더 빠른 실패가 보장된다던지… 등등)</p><h2 id="Fail-Fast-Iterator"><a href="#Fail-Fast-Iterator" class="headerlink" title="Fail Fast Iterator"></a>Fail Fast Iterator</h2><p>실제 내가 사용했던 Map의 구현체인 <a href="https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/util/LinkedHashMap.html">LinkedHashMap의 javadoc</a>을 보면 아래와 같이 나온다.</p><blockquote><p>The iterators returned by the iterator method of the collections returned by all of this class’s collection view methods are fail-fast: if the map is structurally modified at any time after the iterator is created, in any way except through the iterator’s own remove method, the iterator will throw a ConcurrentModificationException. Thus, in the face of concurrent modification, the iterator fails quickly and cleanly, rather than risking arbitrary, non-deterministic behavior at an undetermined time in the future.</p></blockquote><p>this class(LinkedHashMap)의 collection view를 반환하는 메서드에 의해 반환된 컬렉션의 iterator 메서드에 의해 반환된 iterators는 fail-fast라고 한다. (자바의 Collections Framework에서 View에 대한 내용은 <a href="https://softwarecave.org/2014/03/19/views-in-java-collections-framework/">https://softwarecave.org/2014/03/19/views-in-java-collections-framework/</a> 를 참조 바람)</p><p><code>mappings.entries.forEach</code><br>여기서 말하는 collection view를 반환하는 methods는 위 예시에서 entries(내부적으로 자바의 entrySet 메서드 호출)를 의미하고, forEach 메서드 안에서 내부적으로 iterator 메서드를 호출하여 iterator를 반환받고 iterating 하고 있는 것이다.</p><p>만약 map(예시에서 LinkedHashMap)이 iterator 생성 이후 구조적으로 변경(put(add)&#x2F;remove 메서드를 통해 구조가 바뀌는 경우)되는 경우에는 iterator는 ConcurrentModificationException을 던진다.<br>이를 통해 잠재적으로 동시에 Map이 수정되는 현상을 방지하며 빠르고, 깔끔하게 실패처리를 하고 있다고 한다.</p><p>Map 입장에서는 이게 멀티쓰레드 환경에서 돈 건지 아닌지 모르고, 혹시나 모를 동시성 이슈에 대비해 구조가 바뀌면 바로 ConcurrentModificationException을 던지는 것 같다.</p><p>실제 LinkedHashMap의 구현체를 보면 아래와 같다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">true</span>)) == <span class="literal">null</span> ?</span><br><span class="line">        <span class="literal">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">removeNode</span><span class="params">(<span class="type">int</span> hash, Object key, Object value,</span></span><br><span class="line"><span class="params">                               <span class="type">boolean</span> matchValue, <span class="type">boolean</span> movable)</span> &#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, index;</span><br><span class="line">      <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">          (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">          Node&lt;K,V&gt; node = <span class="literal">null</span>, e; K k; V v;</span><br><span class="line">          <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">              ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">              node = p;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                  node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">do</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                          ((k = e.key) == key ||</span><br><span class="line">                           (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                          node = e;</span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                      p = e;</span><br><span class="line">                  &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (node != <span class="literal">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                               (value != <span class="literal">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">              <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                  ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="built_in">this</span>, tab, movable);</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                  tab[index] = node.next;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                  p.next = node.next;</span><br><span class="line">              ++modCount;</span><br><span class="line">              --size;</span><br><span class="line">              afterNodeRemoval(node);</span><br><span class="line">              <span class="keyword">return</span> node;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>removeNode 메서드의 맨 아랫 부분의 조건문을 보면 실제 삭제가 발생할 때 <code>++modCount</code>를 통해 변경된 횟수를 늘리고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es;</span><br><span class="line">    <span class="keyword">return</span> (es = entrySet) == <span class="literal">null</span> ? (entrySet = <span class="keyword">new</span> <span class="title class_">EntrySet</span>()) : es;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EntrySet</span> <span class="keyword">extends</span> <span class="title class_">AbstractSet</span>&lt;Map.Entry&lt;K,V&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span>                 &#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>               &#123; HashMap.<span class="built_in">this</span>.clear(); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntryIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EntryIterator</span> <span class="keyword">extends</span> <span class="title class_">HashIterator</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;Map.Entry&lt;K,V&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.Entry&lt;K,V&gt; <span class="title function_">next</span><span class="params">()</span> &#123; <span class="keyword">return</span> nextNode(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HashIterator</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; next;        <span class="comment">// next entry to return</span></span><br><span class="line">    Node&lt;K,V&gt; current;     <span class="comment">// current entry</span></span><br><span class="line">    <span class="type">int</span> expectedModCount;  <span class="comment">// for fast-fail</span></span><br><span class="line">    <span class="type">int</span> index;             <span class="comment">// current slot</span></span><br><span class="line"></span><br><span class="line">    HashIterator() &#123;</span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">        Node&lt;K,V&gt;[] t = table;</span><br><span class="line">        current = next = <span class="literal">null</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123; <span class="comment">// advance to first entry</span></span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>entrySet 메서드를 통해 반환되는 EntrySet의 iterator 메서드는 EntryIterator를 반환하고, EntryIterator가 상속받은 HashIterator는 fast-fail을 위해 생성자에서 Map(LinkedHashMap)의 modCount를 expectedModCount 변수에 저장하고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EntryIterator</span> <span class="keyword">extends</span> <span class="title class_">HashIterator</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;Map.Entry&lt;K,V&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.Entry&lt;K,V&gt; <span class="title function_">next</span><span class="params">()</span> &#123; <span class="keyword">return</span> nextNode(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HashIterator</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">nextNode</span><span class="params">()</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        Node&lt;K,V&gt; e = next;</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">        <span class="keyword">if</span> ((next = (current = e).next) == <span class="literal">null</span> &amp;&amp; (t = table) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EntryIterator의 next 메서드는 부모 클래스인 HashIterator의 nextNode() 메서드를 호출하는데 그 안에서 객체 생성 당시의 modCount(expectedModCount)와 현재 Map(LinkedHashMap)의 modCount를 비교해서 다르면 ConcurrentModificationException을 던지고 있는 것을 볼 수 있다.<br>문제가 발생(할 가능성이 보이면)하면 후속작업을 하지 않고 바로 fail 처리(예외 던져버리기)를 해버리는 점에서 fail fast iterator라고 불리는 것 같다.</p><h2 id="문제-해결"><a href="#문제-해결" class="headerlink" title="문제 해결"></a>문제 해결</h2><p>그럼 다시 문제상황에서 어떻게 코드가 내부적으로 돌아갔을지 확인해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">(<span class="keyword">final</span> CardCompanyCode cardCompanyCode)</span> &#123;</span><br><span class="line">    mappings.entrySet().forEach(e -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.getValue() != cardCompanyCode) <span class="keyword">return</span>;</span><br><span class="line">        mappings.remove(e.getKey());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>mappings.entrySet 메서드가 호출되고, EntrySet 타입을 반환받는다.</li><li>forEach에서 반복문을 돌리기 위해 EntrySet의 iterator 메서드가 호출됨에 따라 EntryIterator를 반환받는다.</li><li>EntryIterator의 부모인 HashIterator 생성자에서는 fail-fast를 위해 현재 Map의 modCount를 expectedModCount 변수에 저장한다.</li><li>forEach 메서드 안에서는 iterator.hasNext()가 호출되고 true를 반환함에 따라 iterator.next() 메서드가 호출되고, 그 반환값은 it라는 변수에 저장된다.</li><li>조건문에 따라 Map의 remove 메서드가 호출되고 그에 따라 Map의 modCount가 1 증가한다.</li><li>또 다시 iterator.hasNext()가 호출되고 true를 반환함에 따라 iterator.next() 메서드를 호출한다.</li><li>iterator.next()에서는 HashIterator의 nextNode() 메서드가 호출되고, 객체 생성 당시의 modCount(expectedModCount)와 현재 Map의 modCount가 다르기 때문에 ConcurrentModificationException을 던진다.</li></ol><p>이 문제를 해결하기 위해서는 map.remove 메서드가 아닌 iterator.remove() 메서드를 사용해야한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HashIterator</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; p = current;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        current = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> p.key;</span><br><span class="line">        removeNode(hash(key), key, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>iterator.remove() 메서드 안에서도 실제로 removeNode(map.remove에서도 호출함) 메서드가 호출되지만, expectedModCount를 현재 modCount로 갱신하는 게 큰 차이점이다.</p><p>따라서 위 예시는 아래와 같이 바꾸면 해결된다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">(<span class="keyword">final</span> CardCompanyCode cardCompanyCode)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Iterator&lt;Map.Entry&lt;String, CardCompanyCode&gt;&gt; iterator = mappings.entrySet().iterator();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> Map.Entry&lt;String, CardCompanyCode&gt; entry = iterator.next();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entry.getValue() != cardCompanyCode) <span class="keyword">return</span>;</span><br><span class="line">        iterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Fail-Safe-Iterator-Non-Fail-Fast-Iterator"><a href="#Fail-Safe-Iterator-Non-Fail-Fast-Iterator" class="headerlink" title="Fail Safe Iterator (Non Fail Fast Iterator)"></a>Fail Safe Iterator (Non Fail Fast Iterator)</h2><p>Fail Safe Iterator라는 용어가 없지만 Fail Fast Iterator와 반대되는 개념이라고 보면 된다.</p><p>대표적으로 ConcurrentHashMap의 Collection View를 반환하는 메서드(entrySet, keySet, valueSet 등등)의 iterator 메서드가 생성하는 iterator가 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EntryIterator</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">BaseIterator</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;Map.Entry&lt;K,V&gt;&gt; &#123;</span><br><span class="line">    EntryIterator(Node&lt;K,V&gt;[] tab, <span class="type">int</span> index, <span class="type">int</span> size, <span class="type">int</span> limit,</span><br><span class="line">                  ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">        <span class="built_in">super</span>(tab, index, size, limit, map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.Entry&lt;K,V&gt; <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; p;</span><br><span class="line">        <span class="keyword">if</span> ((p = next) == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">        <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> p.key;</span><br><span class="line">        <span class="type">V</span> <span class="variable">v</span> <span class="operator">=</span> p.val;</span><br><span class="line">        lastReturned = p;</span><br><span class="line">        advance();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapEntry</span>&lt;K,V&gt;(k, v, map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConcurrentHashMap의 entrySet 메서드의 반환타입인 EntrySetView의 iterator 메서드의 반환타입인 EntryIterator의 next 메서드를 보면 ConcurrentModificationException을 던지지 않는 것을 볼 수 있다.<br>즉, fail fast iterator와 달리 새로운 요소가 추가&#x2F;삭제되더라도 끝까지 모든 요소를 순회하는 것이다.</p><p>ConcurrentHashMap에서 요소가 추가&#x2F;제거되더라도 ConcurrentModificationException을 던지지 않는 이유는 ConcurrentHashMap은 추가&#x2F;삭제 메서드에 synchronized 키워드를 사용하여 락을 잡은 후 다른 쓰레드에서 건드리지 못하도록 하기에 동시성으로부터 안전하기 때문이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> replaceNode(key, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">replaceNode</span><span class="params">(Object key, V value, Object cv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">            (f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">validated</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (validated) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">                        addCount(-<span class="number">1L</span>, -<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>즉, fail safe iterator는 요소가 추가&#x2F;삭제 되더라도 ConcurrentModificationException을 던지지 않고 모든 요소를 순회할 수 있으며 동시성 이슈로부터도 안전하다(Safe).</p><p>위와 같이 syncronized로 해결하는 케이스도 있지만, CopyOnWriteArrayList처럼 원본 collection을 카피한 후 카피한 collection으로부터 iterator를 생성하여 사용하는 fail safe iterator도 있다. (원본 collection과 생성된 iterator는 무관하기 때문에 ConcurrentModificationException을 던지지 않는다.)</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;문제상황&quot;&gt;&lt;a href=&quot;#문제상황&quot; class=&quot;headerlink&quot; title=&quot;문제상황&quot;&gt;&lt;/a&gt;문제상황&lt;/h2&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;String, String&amp;gt; mappings;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;clear&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; CardCompanyCode cardCompanyCode)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mappings.entrySet().forEach(e -&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (e.getValue() != cardCompanyCode) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        mappings.remove(e.getKey());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;맵에서 entrySet(key&amp;#x2F;value 쌍)을 가져와 forEach 돌면서 특정 조건에 맞으면 맵에서 요소를 삭제했더니 한 번만 요소가 삭제되고나서 ConcurrentModificationException을 던졌다.&lt;/p&gt;
&lt;p&gt;여기서 아래와 같은 의문점이 생겼다.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;맵의 요소를 삭제하는 건데 왜 예외를 던질까?&lt;/li&gt;
&lt;li&gt;왜 한 번만 요소 삭제에 성공하는 걸까?&lt;/li&gt;
&lt;li&gt;하나의 쓰레드에서 작업했는데 왜 &lt;code&gt;Concurrent&lt;/code&gt;ModificationException을 던진 걸까?&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Programming" scheme="https://perfectacle.github.io/categories/Programming/"/>
    
    <category term="Java" scheme="https://perfectacle.github.io/categories/Programming/Java/"/>
    
    
    <category term="Iterator" scheme="https://perfectacle.github.io/tags/Iterator/"/>
    
    <category term="Java" scheme="https://perfectacle.github.io/tags/Java/"/>
    
    <category term="Collection" scheme="https://perfectacle.github.io/tags/Collection/"/>
    
  </entry>
  
  <entry>
    <title>(JPA) Readonly 트랜잭션은 Dirty Checking을 하지 않는다</title>
    <link href="https://perfectacle.github.io/2021/08/08/readonly-transaction-doesnt-make-entity-snapshot/"/>
    <id>https://perfectacle.github.io/2021/08/08/readonly-transaction-doesnt-make-entity-snapshot/</id>
    <published>2021-08-08T23:29:33.000Z</published>
    <updated>2025-12-09T17:06:50.347Z</updated>
    
    <content type="html"><![CDATA[<h2 id="3줄-요약"><a href="#3줄-요약" class="headerlink" title="3줄 요약"></a>3줄 요약</h2><ol><li>@Transaction(readOnly &#x3D; true)로 설정하면 select 할 당시 엔티티의 스냅샷을 만들지 않는다.</li><li><a href="/2021/05/05/readonly-transaction-begin-transaction/">(JPA) Readonly 트랜잭션은 트랜잭션을 시작하지만 flush를 하지 않는다</a>에서 봤다 싶이 트랜잭션이 커밋될 때 flush를 하지 않는다.</li><li>flush를 할 필요가 없기 때문에 Dirty Checking을 할 필요가 없고, 그에 따라서 엔티티의 스냅샷도 만들지 않는 것이다.</li></ol><h2 id="엔티티-구조"><a href="#엔티티-구조" class="headerlink" title="엔티티 구조"></a>엔티티 구조</h2><p>이해를 편하게 돕기 위해 엔티티는 아래와 같은 구조를 가진다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;parents&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long no;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;helloName&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> SomeType someType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeType</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String helloName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SomeType</span><span class="params">(<span class="keyword">final</span> String helloName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.helloName = helloName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SomeType은 JPA에서 모르는 커스텀 타입이기 때문에 컨버터를 만들어주자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Converter(autoApply = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeAttributeConverter</span> <span class="keyword">implements</span> <span class="title class_">AttributeConverter</span>&lt;SomeType, String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">convertToDatabaseColumn</span><span class="params">(<span class="keyword">final</span> SomeType attribute)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> attribute.getHelloName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SomeType <span class="title function_">convertToEntityAttribute</span><span class="params">(<span class="keyword">final</span> String dbData)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SomeType</span>(dbData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>테스트 편의성을 위해 convertToEntityAttribute 메서드에 브레이크 포인트를 걸고 확인해보면 편하다.</p><h2 id="Readonly-트랜잭션이-아니면-스냅샷을-만든다-엔티티를-딥카피한다"><a href="#Readonly-트랜잭션이-아니면-스냅샷을-만든다-엔티티를-딥카피한다" class="headerlink" title="Readonly 트랜잭션이 아니면 스냅샷을 만든다 (엔티티를 딥카피한다)"></a>Readonly 트랜잭션이 아니면 스냅샷을 만든다 (엔티티를 딥카피한다)</h2><p>테스트를 위해 Repository에 Readonly 트랜잭션이 아닌 findBy 메서드를 만든다.<br>(SimpleJpaRepositroy의 findById 메서드는 readonly 트랜잭션이기 때문에 커스텀 메서드를 만들었다.)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ParentRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Parent, Long&gt; &#123;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    Parent <span class="title function_">findByNo</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> no)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 findByNo를 호출하면서 SomeAttributeConverter.convertToEntityAttribute 메서드는 몇 번 호출되는지 보자.</p><img src="/2021/08/08/readonly-transaction-doesnt-make-entity-snapshot/convert-01.png" class="" title="LoadEvent가 발생하면서 AttributeConvert가 호출되고 있다.">  <img src="/2021/08/08/readonly-transaction-doesnt-make-entity-snapshot/convert-02.png" class="" title="그 이후에 딥카피가 발생하면서 한 번 더 AttributeConvert가 호출되고 있다.">  <p><a href="https://github.com/hibernate/hibernate-orm/blob/main/hibernate-core/src/main/java/org/hibernate/engine/internal/TwoPhaseLoad.java#L339">TwoPhaseLoad.initializeEntityFromEntityEntryLoadedState 메서드</a>가 핵심이다.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( isReallyReadOnly ) &#123;</span><br><span class="line">    <span class="comment">//no need to take a snapshot - this is a</span></span><br><span class="line">    <span class="comment">//performance optimization, but not really</span></span><br><span class="line">    <span class="comment">//important, except for entities with huge</span></span><br><span class="line">    <span class="comment">//mutable property values</span></span><br><span class="line">    persistenceContext.setEntryStatus( entityEntry, Status.READ_ONLY );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//take a snapshot</span></span><br><span class="line">    TypeHelper.deepCopy(</span><br><span class="line">            hydratedState,</span><br><span class="line">            persister.getPropertyTypes(),</span><br><span class="line">            persister.getPropertyUpdateability(),</span><br><span class="line">            <span class="comment">//after setting values to object</span></span><br><span class="line">            hydratedState,</span><br><span class="line">            session</span><br><span class="line">    );</span><br><span class="line">    persistenceContext.setEntryStatus( entityEntry, Status.MANAGED );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>readonly 트랜잭션이면 성능최적화를 위해 스냅샷을 만들 필요가 없다고 하고 있고, 그게 아니면 스냅샷을 만들고 있고 그 안에서 딥카피가 수행되고 있다.</p><p><strong>여기서 핵심은 트랜잭션을 생성하지 않더라도 스냅샷(딥카피)를 만든다는 것이다.</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ParentRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Parent, Long&gt; &#123;</span><br><span class="line">    Parent <span class="title function_">findByNo</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> no)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 트랜잭션을 생성하지 않더라도 리드온리 트랜잭션은 아니기 때문에 else 구문을 탄다.</p><h2 id="Readonly-트랜잭션이면-스냅샷을-만들지-않는다"><a href="#Readonly-트랜잭션이면-스냅샷을-만들지-않는다" class="headerlink" title="Readonly 트랜잭션이면 스냅샷을 만들지 않는다"></a>Readonly 트랜잭션이면 스냅샷을 만들지 않는다</h2><p>이번에는 readonly 트랜잭션을 사용하는 <a href="https://github.com/spring-projects/spring-data-jpa/blob/main/src/main/java/org/springframework/data/jpa/repository/support/SimpleJpaRepository.java#L295">SimpleJpaRepository.findById</a> 메서드를 사용하여 스냅샷(딥카피)을 만드는지 직접 확인해보자.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleJpaRepository</span>&lt;T, ID&gt; <span class="keyword">implements</span> <span class="title class_">JpaRepositoryImplementation</span>&lt;T, ID&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;T&gt; <span class="title function_">findById</span><span class="params">(ID id)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(id, ID_MUST_NOT_BE_NULL);</span><br><span class="line"></span><br><span class="line">        Class&lt;T&gt; domainType = getDomainClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (metadata == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.ofNullable(em.find(domainType, id));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">LockModeType</span> <span class="variable">type</span> <span class="operator">=</span> metadata.getLockModeType();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; hints = getQueryHints().withFetchGraphs(em).asMap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(type == <span class="literal">null</span> ? em.find(domainType, id, hints) : em.find(domainType, id, type, hints));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위에서 보다싶이 SimpleJpaRepository는 타입에 readonly 트랜잭션이 적용돼있어서 해당 어노테이션을 오버라이딩 하지 않은 모든 메서드는 readonly 트랜잭션을 사용한다는 것을 알 수 있다.</p><img src="/2021/08/08/readonly-transaction-doesnt-make-entity-snapshot/readonly-01.png" class="" title="readonly 트랜잭션이기 때문에 스냅샷을 만들지 않는 걸 볼 수 있다."><p>이렇듯 JPA(하이버네이트)에서는 readonly 트랜잭션이면 성능최적화를 위해 엔티티의 스냅샷(딥카피)을 만들지 않는 걸 볼 수 있다.</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;3줄-요약&quot;&gt;&lt;a href=&quot;#3줄-요약&quot; class=&quot;headerlink&quot; title=&quot;3줄 요약&quot;&gt;&lt;/a&gt;3줄 요약&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;@Transaction(readOnly &amp;#x3D; true)로 설정하면 select 할 당시 엔티티의 스냅샷을 만들지 않는다.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2021/05/05/readonly-transaction-begin-transaction/&quot;&gt;(JPA) Readonly 트랜잭션은 트랜잭션을 시작하지만 flush를 하지 않는다&lt;/a&gt;에서 봤다 싶이 트랜잭션이 커밋될 때 flush를 하지 않는다.&lt;/li&gt;
&lt;li&gt;flush를 할 필요가 없기 때문에 Dirty Checking을 할 필요가 없고, 그에 따라서 엔티티의 스냅샷도 만들지 않는 것이다.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;엔티티-구조&quot;&gt;&lt;a href=&quot;#엔티티-구조&quot; class=&quot;headerlink&quot; title=&quot;엔티티 구조&quot;&gt;&lt;/a&gt;엔티티 구조&lt;/h2&gt;&lt;p&gt;이해를 편하게 돕기 위해 엔티티는 아래와 같은 구조를 가진다.&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Entity&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Table(name = &amp;quot;parents&amp;quot;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Parent&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Id&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@GeneratedValue(strategy = GenerationType.IDENTITY)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Long no;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Column(name = &amp;quot;helloName&amp;quot;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; SomeType someType;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Back-end" scheme="https://perfectacle.github.io/categories/Back-end/"/>
    
    <category term="DB" scheme="https://perfectacle.github.io/categories/Back-end/DB/"/>
    
    <category term="JPA" scheme="https://perfectacle.github.io/categories/Back-end/DB/JPA/"/>
    
    
    <category term="JPA" scheme="https://perfectacle.github.io/tags/JPA/"/>
    
  </entry>
  
</feed>
